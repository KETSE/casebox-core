Ext.namespace('CB.DB');CB.DB.defaultItemFields=[{name:'nid',type:'string'},{name:'pid',type:'int'},{name:'system',type:'int'},{name:'status'},{name:'task_status',type:'int'},{name:'template_id',type:'int'},'template_type','path','name','hl','iconCls',{name:'date',type:'date'},{name:'date_end',type:'date'},{name:'size',type:'int'},{name:'oid',type:'int'},{name:'cid',type:'int'},{name:'versions',type:'int'},{name:'cdate',type:'date'},{name:'udate',type:'date'},'case','content',{name:'has_childs',type:'bool'},{name:'acl_count',type:'int'},'cfg','cls','can','group','groupText'];Ext.define('Items',{extend:'Ext.data.Model',alias:'model.Items',fields:Ext.apply([],CB.DB.defaultItemFields)});Ext.define('DropDownListItems',{extend:'Ext.data.Model',fields:[{name:'id',type:'int'},{name:'text',type:'string'},{name:'info',type:'string'},{name:'descr',type:'string'}]});Ext.define('Notification',{extend:'Ext.data.Model',fields:[{name:'ids',type:'string'},{name:'user_id',type:'int'},{name:'object_id',type:'int'},{name:'action_id',type:'int'},{name:'expandable',type:'bool'},{name:'text',type:'string'},{name:'date_text',type:'string'},{name:'read',type:'bool'},{name:'seen',type:'bool'},'data',{name:'body',type:'string'}]});Ext.define('ContentItem',{extend:'Ext.data.Model',fields:[{name:'id',type:'int'},{name:'pid',type:'int'},'name',{name:'template_id',type:'int'},{name:'cid',type:'int'},'iconCls','user','cdate','ago_text']});Ext.define('FieldObjects',{extend:'Ext.data.Model',fields:[{name:'id'},'name',{name:'date',type:'date'},{name:'type',type:'int'},{name:'template_id',type:'int'},{name:'status',type:'int'},'iconCls','path',{name:'size',type:'int'},{name:'oid',type:'int'},{name:'cid',type:'int'},{name:'cdate',type:'date'},{name:'udate',type:'date'},'case']});Ext.define('ObjectsRecord',{extend:'Ext.data.Model',fields:[{name:'id'},'name',{name:'date',type:'date'},{name:'template_id',type:'int'},{name:'status',type:'int'},'iconCls','cfg']});Ext.define('FavoriteRecord',{extend:'Ext.data.Model',fields:[{name:'id',type:'int'},'node_id','data']});Ext.define('Generic',{extend:'Ext.data.Model',fields:[{name:'id',type:'int'},{name:'name',type:'string'},{name:'iconCls',type:'string'}]});Ext.define('Generic2',{extend:'Ext.data.Model',fields:[{name:'id',type:'string'},{name:'name',type:'string'}]});Ext.define('GenericCount',{extend:'Ext.data.Model',fields:[{name:'id',type:'string'},{name:'name',type:'string'},{name:'shortname',type:'string'},{name:'count',type:'int'}]});Ext.define('EditGridRecord',{extend:'Ext.data.Model',fields:['id','title','readonly','value','info','type','cond']});Ext.define('Facet',{extend:'Ext.data.Model',fields:['id','name',{name:'active',type:'int'},'last','items','new_items']});Ext.define('Filter',{extend:'Ext.data.Model',fields:['id','facetId','value','name']});Ext.define('AclRecord',{extend:'Ext.data.Model',fields:[{name:'id',type:'int'},{name:'user_group_id',type:'int'},'name','iconCls','allow','deny']});Ext.define('UploadRecord',{extend:'Ext.data.Model',fields:['id',{name:'group',type:'int'},'name','type',{name:'size',type:'int'},{name:'loaded',type:'int'},'pid','draftPid','dir','pathtext','file',{name:'status',type:'int'},'msg','md5',{name:'md5_verified',type:'int'},'content_id','response']});Ext.define('PhoneCode',{extend:'Ext.data.Model',fields:[{name:'code',type:'string'},{name:'name',type:'string'}]});Ext.define('Language',{extend:'Ext.data.Model',fields:[{name:'id',type:'int'},{name:'abreviation',type:'string'},{name:'name',type:'string'},{name:'long_date_format',type:'string'},{name:'short_date_format',type:'string'},{name:'time_format',type:'string'}]});Ext.define('SecurityQuestion',{extend:'Ext.data.Model',fields:[{name:'id',type:'int'},{name:'text',type:'string'}]});Ext.define('Template',{extend:'Ext.data.Model',fields:[{name:'id',type:'int'},{name:'pid',type:'int'},'type','title','iconCls',{name:"cfg",convert:function(v,r){return Ext.isEmpty(v)?{}:v;}},'info_template',{name:'visible',type:'int'}]});Ext.define('User',{extend:'Ext.data.Model',fields:[{name:'id',type:'int'},{name:'user',type:'string'},{name:'name',type:'string'},{name:'iconCls',type:'string'},{name:'photo',type:'string'}]});Ext.define('Group',{extend:'Ext.data.Model',fields:[{name:'id',type:'int'},{name:'name',type:'string'},{name:'title',type:'string'},{name:'system',type:'int'},{name:'enabled',type:'int'},'iconCls']});Ext.define('Country',{extend:'Ext.data.Model',fields:[{name:'id',type:'int'},{name:'name',type:'string'},{name:'phone_codes',type:'string'}]});Ext.define('Timezone',{extend:'Ext.data.Model',fields:[{name:'id',type:'string'},{name:'gmt_offset',type:'string'},{name:'caption',type:'string'}]});
;(function(c,e){var g=c.parse,h=[1,4,5,6,10,11];c.parse=function(b){var a,d=0;if(a=/^(\d{4}|[+\-]\d{6})(?:-?(\d{2})(?:-?(\d{2}))?)?(?:[ T]?(\d{2}):?(\d{2})(?::?(\d{2})(?:[,\.](\d{1,}))?)?(?:(Z)|([+\-])(\d{2})(?::?(\d{2}))?)?)?$/.exec(b)){b=0;for(var f;f=h[b];++b)a[f]=+a[f]||0;a[2]=(+a[2]||1)-1;a[3]=+a[3]||1;a[7]=a[7]?+(a[7]+"00").substr(0,3):0;if((a[8]===e||a[8]==="")&&(a[9]===e||a[9]===""))a=+new c(a[1],a[2],a[3],a[4],a[5],a[6],a[7]);else{if(a[8]!=="Z"&&a[9]!==e){d=a[10]*60+a[11];if(a[9]==="+")d=
0-d}a=c.UTC(a[1],a[2],a[3],a[4],a[5]+d,a[6],a[7])}}else a=g?g(b):NaN;return a}})(Date);

;(function(a){if(typeof exports==="object"){module.exports=a()}else{if(typeof define==="function"&&define.amd){define("spark-md5",a)}else{var c;try{c=window}catch(b){c=self}c.SparkMD5=a()}}}(function(c){var e=function(s,r){return(s+r)&4294967295},n=function(z,v,u,r,y,w){v=e(e(v,z),e(r,w));return e((v<<y)|(v>>>(32-y)),u)},a=function(v,u,A,z,r,y,w){return n((u&A)|((~u)&z),v,u,r,y,w)},k=function(v,u,A,z,r,y,w){return n((u&z)|(A&(~z)),v,u,r,y,w)},f=function(v,u,A,z,r,y,w){return n(u^A^z,v,u,r,y,w)},p=function(v,u,A,z,r,y,w){return n(A^(u|(~z)),v,u,r,y,w)},d=function(s,u){var t=s[0],r=s[1],w=s[2],v=s[3];t=a(t,r,w,v,u[0],7,-680876936);v=a(v,t,r,w,u[1],12,-389564586);w=a(w,v,t,r,u[2],17,606105819);r=a(r,w,v,t,u[3],22,-1044525330);t=a(t,r,w,v,u[4],7,-176418897);v=a(v,t,r,w,u[5],12,1200080426);w=a(w,v,t,r,u[6],17,-1473231341);r=a(r,w,v,t,u[7],22,-45705983);t=a(t,r,w,v,u[8],7,1770035416);v=a(v,t,r,w,u[9],12,-1958414417);w=a(w,v,t,r,u[10],17,-42063);r=a(r,w,v,t,u[11],22,-1990404162);t=a(t,r,w,v,u[12],7,1804603682);v=a(v,t,r,w,u[13],12,-40341101);w=a(w,v,t,r,u[14],17,-1502002290);r=a(r,w,v,t,u[15],22,1236535329);t=k(t,r,w,v,u[1],5,-165796510);v=k(v,t,r,w,u[6],9,-1069501632);w=k(w,v,t,r,u[11],14,643717713);r=k(r,w,v,t,u[0],20,-373897302);t=k(t,r,w,v,u[5],5,-701558691);v=k(v,t,r,w,u[10],9,38016083);w=k(w,v,t,r,u[15],14,-660478335);r=k(r,w,v,t,u[4],20,-405537848);t=k(t,r,w,v,u[9],5,568446438);v=k(v,t,r,w,u[14],9,-1019803690);w=k(w,v,t,r,u[3],14,-187363961);r=k(r,w,v,t,u[8],20,1163531501);t=k(t,r,w,v,u[13],5,-1444681467);v=k(v,t,r,w,u[2],9,-51403784);w=k(w,v,t,r,u[7],14,1735328473);r=k(r,w,v,t,u[12],20,-1926607734);t=f(t,r,w,v,u[5],4,-378558);v=f(v,t,r,w,u[8],11,-2022574463);w=f(w,v,t,r,u[11],16,1839030562);r=f(r,w,v,t,u[14],23,-35309556);t=f(t,r,w,v,u[1],4,-1530992060);v=f(v,t,r,w,u[4],11,1272893353);w=f(w,v,t,r,u[7],16,-155497632);r=f(r,w,v,t,u[10],23,-1094730640);t=f(t,r,w,v,u[13],4,681279174);v=f(v,t,r,w,u[0],11,-358537222);w=f(w,v,t,r,u[3],16,-722521979);r=f(r,w,v,t,u[6],23,76029189);t=f(t,r,w,v,u[9],4,-640364487);v=f(v,t,r,w,u[12],11,-421815835);w=f(w,v,t,r,u[15],16,530742520);r=f(r,w,v,t,u[2],23,-995338651);t=p(t,r,w,v,u[0],6,-198630844);v=p(v,t,r,w,u[7],10,1126891415);w=p(w,v,t,r,u[14],15,-1416354905);r=p(r,w,v,t,u[5],21,-57434055);t=p(t,r,w,v,u[12],6,1700485571);v=p(v,t,r,w,u[3],10,-1894986606);w=p(w,v,t,r,u[10],15,-1051523);r=p(r,w,v,t,u[1],21,-2054922799);t=p(t,r,w,v,u[8],6,1873313359);v=p(v,t,r,w,u[15],10,-30611744);w=p(w,v,t,r,u[6],15,-1560198380);r=p(r,w,v,t,u[13],21,1309151649);t=p(t,r,w,v,u[4],6,-145523070);v=p(v,t,r,w,u[11],10,-1120210379);w=p(w,v,t,r,u[2],15,718787259);r=p(r,w,v,t,u[9],21,-343485551);s[0]=e(t,s[0]);s[1]=e(r,s[1]);s[2]=e(w,s[2]);s[3]=e(v,s[3])},q=function(t){var u=[],r;for(r=0;r<64;r+=4){u[r>>2]=t.charCodeAt(r)+(t.charCodeAt(r+1)<<8)+(t.charCodeAt(r+2)<<16)+(t.charCodeAt(r+3)<<24)}return u},m=function(r){var t=[],s;for(s=0;s<64;s+=4){t[s>>2]=r[s]+(r[s+1]<<8)+(r[s+2]<<16)+(r[s+3]<<24)}return t},l=function(A){var u=A.length,r=[1732584193,-271733879,-1732584194,271733878],w,t,z,x,y,v;for(w=64;w<=u;w+=64){d(r,q(A.substring(w-64,w)))}A=A.substring(w-64);t=A.length;z=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(w=0;w<t;w+=1){z[w>>2]|=A.charCodeAt(w)<<((w%4)<<3)}z[w>>2]|=128<<((w%4)<<3);if(w>55){d(r,z);for(w=0;w<16;w+=1){z[w]=0}}x=u*8;x=x.toString(16).match(/(.*?)(.{0,8})$/);y=parseInt(x[2],16);v=parseInt(x[1],16)||0;z[14]=y;z[15]=v;d(r,z);return r},o=function(z){var t=z.length,r=[1732584193,-271733879,-1732584194,271733878],v,s,y,w,x,u;for(v=64;v<=t;v+=64){d(r,m(z.subarray(v-64,v)))}z=(v-64)<t?z.subarray(v-64):new Uint8Array(0);s=z.length;y=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(v=0;v<s;v+=1){y[v>>2]|=z[v]<<((v%4)<<3)}y[v>>2]|=128<<((v%4)<<3);if(v>55){d(r,y);for(v=0;v<16;v+=1){y[v]=0}}w=t*8;w=w.toString(16).match(/(.*?)(.{0,8})$/);x=parseInt(w[2],16);u=parseInt(w[1],16)||0;y[14]=x;y[15]=u;d(r,y);return r},j=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"],h=function(u){var t="",r;for(r=0;r<4;r+=1){t+=j[(u>>(r*8+4))&15]+j[(u>>(r*8))&15]}return t},b=function(r){var s;for(s=0;s<r.length;s+=1){r[s]=h(r[s])}return r.join("")},i=function(r){return b(l(r))},g=function(){this.reset()};if(i("hello")!=="5d41402abc4b2a76b9719d911017c592"){e=function(r,u){var t=(r&65535)+(u&65535),s=(r>>16)+(u>>16)+(t>>16);return(s<<16)|(t&65535)}}g.prototype.append=function(r){if(/[\u0080-\uFFFF]/.test(r)){r=unescape(encodeURIComponent(r))}this.appendBinary(r);return this};g.prototype.appendBinary=function(t){this._buff+=t;this._length+=t.length;var s=this._buff.length,r;for(r=64;r<=s;r+=64){d(this._state,q(this._buff.substring(r-64,r)))}this._buff=this._buff.substr(r-64);return this};g.prototype.end=function(t){var w=this._buff,v=w.length,u,s=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],r;for(u=0;u<v;u+=1){s[u>>2]|=w.charCodeAt(u)<<((u%4)<<3)}this._finish(s,v);r=!!t?this._state:b(this._state);this.reset();return r};g.prototype._finish=function(s,w){var u=w,t,v,r;s[u>>2]|=128<<((u%4)<<3);if(u>55){d(this._state,s);for(u=0;u<16;u+=1){s[u]=0}}t=this._length*8;t=t.toString(16).match(/(.*?)(.{0,8})$/);v=parseInt(t[2],16);r=parseInt(t[1],16)||0;s[14]=v;s[15]=r;d(this._state,s)};g.prototype.reset=function(){this._buff="";this._length=0;this._state=[1732584193,-271733879,-1732584194,271733878];return this};g.prototype.destroy=function(){delete this._state;delete this._buff;delete this._length};g.hash=function(t,r){if(/[\u0080-\uFFFF]/.test(t)){t=unescape(encodeURIComponent(t))}var s=l(t);return !!r?s:b(s)};g.hashBinary=function(s,r){var t=l(s);return !!r?t:b(t)};g.ArrayBuffer=function(){this.reset()};g.ArrayBuffer.prototype.append=function(r){var u=this._concatArrayBuffer(this._buff,r),t=u.length,s;this._length+=r.byteLength;for(s=64;s<=t;s+=64){d(this._state,m(u.subarray(s-64,s)))}this._buff=(s-64)<t?u.subarray(s-64):new Uint8Array(0);return this};g.ArrayBuffer.prototype.end=function(t){var w=this._buff,v=w.length,s=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],u,r;for(u=0;u<v;u+=1){s[u>>2]|=w[u]<<((u%4)<<3)}this._finish(s,v);r=!!t?this._state:b(this._state);this.reset();return r};g.ArrayBuffer.prototype._finish=g.prototype._finish;g.ArrayBuffer.prototype.reset=function(){this._buff=new Uint8Array(0);this._length=0;this._state=[1732584193,-271733879,-1732584194,271733878];return this};g.ArrayBuffer.prototype.destroy=g.prototype.destroy;g.ArrayBuffer.prototype._concatArrayBuffer=function(u,s){var t=u.length,r=new Uint8Array(t+s.byteLength);r.set(u);r.set(new Uint8Array(s),t);return r};g.ArrayBuffer.hash=function(r,s){var t=o(new Uint8Array(r));return !!s?t:b(t)};return g}));
;Ext.namespace('Ext.ux');Ext.define('Ext.ux.fileMD5',{extend:'Ext.util.Observable',chunkSize:2097152,constructor:function(){this.blobSlice=File.prototype.slice||File.prototype.mozSlice||File.prototype.webkitSlice;this.fileReader=new FileReader();this.fileReader.onload=this.frOnload.bind(this);this.fileReader.onerror=this.frOnerror.bind(this);Ext.ux.fileMD5.superclass.constructor.apply(this,arguments);},getMD5:function(file){this.file=file;this.chunks=Math.ceil(this.file.size/this.chunkSize);this.currentChunk=0;this.spark=new SparkMD5.ArrayBuffer();this.md5=null;this.loadNext();},frOnload:function(e){this.spark.append(e.target.result);this.currentChunk++;if(this.currentChunk<this.chunks){this.loadNext();}else{this.md5=this.spark.end();delete this.spark;this.fireEvent('done',this,this.md5);}},frOnerror:function(){delete this.spark;return null;},loadNext:function(){var start=this.currentChunk*this.chunkSize,end=((start+this.chunkSize)>=this.file.size)?this.file.size:start+this.chunkSize;this.fileReader.readAsArrayBuffer(this.blobSlice.call(this.file,start,end));}});;Ext.namespace('Ext.ux');Ext.ux.WebkitEntriesIterator={iterateEntries:function(entries,callback,scope){this.direcotoriesCount=0;this.result=[];this.callback=scope?callback.bind(scope):callback;this.readEntries(entries);},readEntries:function(entries,fromSubfolder){if(fromSubfolder){this.direcotoriesCount--;}
for(var i=0;i<entries.length;i++){if(!Ext.isEmpty(entries[i])){if(entries[i].isDirectory){this.direcotoriesCount++;var directoryReader=entries[i].createReader();this.getAllEntries(directoryReader,this.readEntries.bind(this));}else{this.result.push(entries[i]);}}}
if(this.direcotoriesCount===0){this.convertEntriesToFiles();}},getAllEntries:function(directoryReader,callback){var entries=[];var readEntries=function(){directoryReader.readEntries(function(results){if(!results.length){entries.sort();this.direcotoriesCount--;callback(entries,true);}else{entries=entries.concat(Array.prototype.slice.call(results||[],0));readEntries();}},this.errorHandler);};readEntries();},errorHandler:function(e){console.log('FileSystem API error code: '+e.code);},convertEntriesToFiles:function(){this.convertedFiles=0;var fn=function(f){f.fullPath=this.result[this.convertedFiles].fullPath;this.result[this.convertedFiles]=f;this.convertedFiles++;if(this.convertedFiles==this.result.length){this.callback(this.result);}};for(var i=0;i<this.result.length;i++){this.result[i].file(fn.bind(this));}}};;Ext.ns('Ext.calendar.data');Ext.calendar.data.EventMappings={EventId:{name:'EventId',mapping:'id',type:'int'},CalendarId:{name:'CalendarId',mapping:'cid',type:'int'},Title:{name:'Title',mapping:'title',type:'string'},StartDate:{name:'StartDate',mapping:'start',type:'date',dateFormat:'c'},EndDate:{name:'EndDate',mapping:'end',type:'date',dateFormat:'c'},Location:{name:'Location',mapping:'loc',type:'string'},Notes:{name:'Notes',mapping:'notes',type:'string'},Url:{name:'Url',mapping:'url',type:'string'},IsAllDay:{name:'IsAllDay',mapping:'ad',type:'boolean'},Reminder:{name:'Reminder',mapping:'rem',type:'string'},IsNew:{name:'IsNew',mapping:'n',type:'boolean'},template_id:{name:'template_id',type:'int'},task_status:{name:'task_status',type:'string'},iconCls:{name:'iconCls',type:'string'},cls:{name:'cls',type:'string'},category_id:{name:'category_id',type:'string'}};;Ext.define('Ext.calendar.data.EventModel',{extend:'Ext.data.Model',requires:['Ext.calendar.data.EventMappings'],identifier:'sequential',statics:{reconfigure:function(){var me=this,Mappings=Ext.calendar.data.EventMappings;me.prototype.idProperty=Mappings.EventId.name||'id';me.replaceFields(Ext.Object.getValues(Mappings),true);return me;}}},function(){this.reconfigure();});;Ext.ns('Ext.calendar.data');Ext.calendar.data.CalendarMappings={CalendarId:{name:'CalendarId',mapping:'id',type:'int'},Title:{name:'Title',mapping:'title',type:'string'},Description:{name:'Description',mapping:'desc',type:'string'},ColorId:{name:'ColorId',mapping:'color',type:'int'},IsHidden:{name:'IsHidden',mapping:'hidden',type:'boolean'}};;Ext.define('Ext.calendar.data.CalendarModel',{extend:'Ext.data.Model',requires:['Ext.calendar.data.CalendarMappings'],identifier:'sequential',statics:{reconfigure:function(){var me=this,Mappings=Ext.calendar.data.CalendarMappings;me.prototype.idProperty=Mappings.CalendarId.name||'id';me.replaceFields(Ext.Object.getValues(Mappings),true);return me;}}},function(){this.reconfigure();});;Ext.define('Ext.calendar.data.MemoryCalendarStore',{extend:'Ext.data.Store',model:'Ext.calendar.data.CalendarModel',requires:['Ext.data.proxy.Memory','Ext.data.reader.Json','Ext.data.writer.Json','Ext.calendar.data.CalendarModel','Ext.calendar.data.CalendarMappings'],proxy:{type:'memory',reader:{type:'json',rootProperty:'calendars'},writer:{type:'json'}},autoLoad:true,initComponent:function(){var me=this,calendarData=Ext.calendar.data;me.sorters=me.sorters||[{property:calendarData.CalendarMappings.Title.name,direction:'ASC'}];me.idProperty=me.idProperty||calendarData.CalendarMappings.CalendarId.name||'id';me.fields=calendarData.CalendarModel.prototype.fields.getRange();me.callParent(arguments);}});;Ext.define('Ext.calendar.data.MemoryEventStore',{extend:'Ext.data.Store',model:'Ext.calendar.data.EventModel',requires:['Ext.data.proxy.Memory','Ext.data.reader.Json','Ext.data.writer.Json','Ext.calendar.data.EventModel','Ext.calendar.data.EventMappings'],proxy:{type:'memory',reader:{type:'json',rootProperty:'evts'},writer:{type:'json'}},constructor:function(config){this.callParent(arguments);this.sorters=this.sorters||[{property:Ext.calendar.data.EventMappings.StartDate.name,direction:'ASC'}];this.idProperty=this.idProperty||Ext.calendar.data.EventMappings.EventId.mapping||'id';this.fields=Ext.calendar.data.EventModel.getFields();this.onCreateRecords=Ext.Function.createInterceptor(this.onCreateRecords,this.interceptCreateRecords);this.initRecs();},interceptCreateRecords:function(records,operation,success){if(success){var i=0,rec,len=records.length;for(;i<len;i++){records[i].data[Ext.calendar.data.EventMappings.EventId.name]=records[i].id;}}},initRecs:function(){this.each(function(rec){rec.store=this;rec.phantom=false;},this);},onProxyLoad:function(operation){var me=this,records;if(me.data&&me.data.length>0){me.totalCount=me.data.length;records=me.data.items;}
else{var resultSet=operation.getResultSet(),successful=operation.wasSuccessful();records=operation.getRecords();if(resultSet){me.totalCount=resultSet.total;}
if(successful){me.loadRecords(records,operation);}}
me.loading=false;me.fireEvent('load',me,records,successful);}});;Ext.define('Ext.calendar.util.Date',{singleton:true,diffDays:function(start,end){var day=1000*60*60*24,clear=Ext.Date.clearTime,diff=clear(end,true).getTime()-clear(start,true).getTime();return Math.ceil(diff/day);},copyTime:function(fromDt,toDt){var dt=Ext.Date.clone(toDt);dt.setHours(fromDt.getHours(),fromDt.getMinutes(),fromDt.getSeconds(),fromDt.getMilliseconds());return dt;},compare:function(dt1,dt2,precise){if(precise!==true){dt1=Ext.Date.clone(dt1);dt1.setMilliseconds(0);dt2=Ext.Date.clone(dt2);dt2.setMilliseconds(0);}
return dt2.getTime()-dt1.getTime();},isMidnight:function(dt){return dt.getHours()===0&&dt.getMinutes()===0&&dt.getSeconds()===0&&dt.getMilliseconds()===0;},maxOrMin:function(max){var dt=(max?0:Number.MAX_VALUE),i=0,args=arguments[1],ln=args.length;for(;i<ln;i++){dt=Math[max?'max':'min'](dt,args[i].getTime());}
return new Date(dt);},max:function(){return this.maxOrMin.apply(this,[true,arguments]);},min:function(){return this.maxOrMin.apply(this,[false,arguments]);},today:function(){return Ext.Date.clearTime(new Date());},add:function(dt,o){if(!o){return dt;}
var ExtDate=Ext.Date,dateAdd=ExtDate.add,newDt=ExtDate.clone(dt);if(o.years){newDt=dateAdd(newDt,ExtDate.YEAR,o.years);}
if(o.months){newDt=dateAdd(newDt,ExtDate.MONTH,o.months);}
if(o.weeks){o.days=(o.days||0)+(o.weeks*7);}
if(o.days){newDt=dateAdd(newDt,ExtDate.DAY,o.days);}
if(o.hours){newDt=dateAdd(newDt,ExtDate.HOUR,o.hours);}
if(o.minutes){newDt=dateAdd(newDt,ExtDate.MINUTE,o.minutes);}
if(o.seconds){newDt=dateAdd(newDt,ExtDate.SECOND,o.seconds);}
if(o.millis){newDt=dateAdd(newDt,ExtDate.MILLI,o.millis);}
return o.clearTime?ExtDate.clearTime(newDt):newDt;}});;Ext.define('Ext.calendar.util.WeekEventRenderer',{requires:['Ext.calendar.util.Date'],statics:{getEventRow:function(id,week,index){var indexOffset=1,evtRow,wkRow=Ext.get(id+'-wk-'+week);if(wkRow){var table=wkRow.child('.ext-cal-evt-tbl',true);evtRow=table.tBodies[0].childNodes[index+indexOffset];if(!evtRow){evtRow=Ext.core.DomHelper.append(table.tBodies[0],'<tr></tr>');}}
return Ext.get(evtRow);},render:function(o){var w=0,grid=o.eventGrid,dt=Ext.Date.clone(o.viewStart),eventTpl=o.tpl,max=o.maxEventsPerDay!=undefined?o.maxEventsPerDay:999,weekCount=o.weekCount<1?6:o.weekCount,dayCount=o.weekCount==1?o.dayCount:7,cellCfg,row;for(;w<weekCount;w++){if(!grid[w]||grid[w].length==0){if(weekCount==1){row=this.getEventRow(o.id,w,0);cellCfg={tag:'td',cls:'ext-cal-ev',id:o.id+'-empty-0-day-'+Ext.Date.format(dt,'Ymd'),html:'&#160;'};if(dayCount>1){cellCfg.colspan=dayCount;}
Ext.core.DomHelper.append(row,cellCfg);}
dt=Ext.calendar.util.Date.add(dt,{days:7});}else{var d=0,wk=grid[w],startOfWeek=Ext.Date.clone(dt),endOfWeek=Ext.calendar.util.Date.add(startOfWeek,{days:dayCount,millis:-1});for(;d<dayCount;d++){if(wk[d]){var ev=0,emptyCells=0,skipped=0,day=wk[d],ct=day.length,evt;for(;ev<ct;ev++){evt=day[ev];if(!evt&&(ev<max)){row=this.getEventRow(o.id,w,ev);cellCfg={tag:'td',cls:'ext-cal-ev',id:o.id+'-empty-'+ct+'-day-'+Ext.Date.format(dt,'Ymd')};Ext.core.DomHelper.append(row,cellCfg);}
if(!evt){continue;}
if(ev>=max){skipped++;continue;}
if(!evt.isSpan||evt.isSpanStart){var item=evt.data||evt.event.data;item._weekIndex=w;item._renderAsAllDay=item[Ext.calendar.data.EventMappings.IsAllDay.name]||evt.isSpanStart;item.spanLeft=item[Ext.calendar.data.EventMappings.StartDate.name].getTime()<startOfWeek.getTime();item.spanRight=item[Ext.calendar.data.EventMappings.EndDate.name].getTime()>endOfWeek.getTime();item.spanCls=(item.spanLeft?(item.spanRight?'ext-cal-ev-spanboth':'ext-cal-ev-spanleft'):(item.spanRight?'ext-cal-ev-spanright':''));row=this.getEventRow(o.id,w,ev);cellCfg={tag:'td',cls:'ext-cal-ev',cn:eventTpl.apply(o.templateDataFn(item))};var diff=Ext.calendar.util.Date.diffDays(dt,item[Ext.calendar.data.EventMappings.EndDate.name])+1,cspan=Math.min(diff,dayCount-d);if(cspan>1){cellCfg.colspan=cspan;}
Ext.core.DomHelper.append(row,cellCfg);}}
if(ev>max){row=this.getEventRow(o.id,w,max);Ext.core.DomHelper.append(row,{tag:'td',cls:'ext-cal-ev-more',id:'ext-cal-ev-more-'+Ext.Date.format(dt,'Ymd'),cn:{tag:'a',html:'+'+skipped+' more...'}});}
if(ct<o.evtMaxCount[w]){row=this.getEventRow(o.id,w,ct);if(row){cellCfg={tag:'td',cls:'ext-cal-ev',id:o.id+'-empty-'+(ct+1)+'-day-'+Ext.Date.format(dt,'Ymd')};var rowspan=o.evtMaxCount[w]-ct;if(rowspan>1){cellCfg.rowspan=rowspan;}
Ext.core.DomHelper.append(row,cellCfg);}}}else{row=this.getEventRow(o.id,w,0);if(row){cellCfg={tag:'td',cls:'ext-cal-ev',id:o.id+'-empty-day-'+Ext.Date.format(dt,'Ymd')};if(o.evtMaxCount[w]>1){cellCfg.rowSpan=o.evtMaxCount[w];}
Ext.core.DomHelper.append(row,cellCfg);}}
dt=Ext.calendar.util.Date.add(dt,{days:1});}}}}}});;Ext.define('Ext.calendar.dd.StatusProxy',{extend:'Ext.dd.StatusProxy',animRepair:true,moveEventCls:'ext-cal-dd-move',addEventCls:'ext-cal-dd-add',childEls:['ghost','message'],renderTpl:['<div class="'+Ext.baseCSSPrefix+'dd-drop-icon"></div>'+'<div class="ext-dd-ghost-ct">'+'<div id="{id}-ghost" data-ref="ghost" class="'+Ext.baseCSSPrefix+'dd-drag-ghost"></div>'+'<div id="{id}-message" data-ref="message" class="'+Ext.baseCSSPrefix+'dd-msg"></div>'+'</div>'],update:function(html){this.callParent(arguments);var el=this.ghost.dom.firstChild;if(el){Ext.fly(el).setHeight('auto');}},updateMsg:function(msg){this.message.update(msg);}});;Ext.define('Ext.calendar.dd.DragZone',{extend:'Ext.dd.DragZone',requires:['Ext.calendar.dd.StatusProxy','Ext.calendar.data.EventMappings'],ddGroup:'CalendarDD',eventSelector:'.ext-cal-evt',constructor:function(el,config){if(!Ext.calendar._statusProxyInstance){Ext.calendar._statusProxyInstance=new Ext.calendar.dd.StatusProxy();}
this.proxy=Ext.calendar._statusProxyInstance;this.callParent(arguments);},getDragData:function(e){var t=e.getTarget(this.eventSelector,3);if(t){var rec=this.view.getEventRecordFromEl(t);return{type:'eventdrag',ddel:t,eventStart:rec.data[Ext.calendar.data.EventMappings.StartDate.name],eventEnd:rec.data[Ext.calendar.data.EventMappings.EndDate.name],proxy:this.proxy};}
t=this.view.getDayAt(e.getX(),e.getY());if(t.el){return{type:'caldrag',start:t.date,proxy:this.proxy};}
return null;},onInitDrag:function(x,y){if(this.dragData.ddel){var ghost=this.dragData.ddel.cloneNode(true),child=Ext.fly(ghost).down('dl');Ext.fly(ghost).setWidth('auto');if(child){child.setHeight('auto');}
this.proxy.update(ghost);this.onStartDrag(x,y);}
else if(this.dragData.start){this.onStartDrag(x,y);}
this.view.onInitDrag();return true;},afterRepair:function(){if(Ext.enableFx&&this.dragData.ddel){Ext.fly(this.dragData.ddel).highlight(this.hlColor||'c3daf9');}
this.dragging=false;},getRepairXY:function(e){if(this.dragData.ddel){return Ext.fly(this.dragData.ddel).getXY();}},afterInvalidDrop:function(e,id){Ext.select('.ext-dd-shim').hide();}});;Ext.define('Ext.calendar.dd.DropZone',{extend:'Ext.dd.DropZone',requires:['Ext.calendar.util.Date','Ext.calendar.data.EventMappings'],ddGroup:'CalendarDD',eventSelector:'.ext-cal-evt',shims:[],getTargetFromEvent:function(e){var dragOffset=this.dragOffset||0,y=e.getY()-dragOffset,d=this.view.getDayAt(e.getX(),y);return d.el?d:null;},onNodeOver:function(n,dd,e,data){var D=Ext.calendar.util.Date,start=data.type=='eventdrag'?n.date:D.min(data.start,n.date),end=data.type=='eventdrag'?D.add(n.date,{days:D.diffDays(data.eventStart,data.eventEnd)}):D.max(data.start,n.date);if(!this.dragStartDate||!this.dragEndDate||(D.diffDays(start,this.dragStartDate)!=0)||(D.diffDays(end,this.dragEndDate)!=0)){this.dragStartDate=start;this.dragEndDate=D.add(end,{days:1,millis:-1,clearTime:true});this.shim(start,end);var range=Ext.Date.format(start,'n/j');if(D.diffDays(start,end)>0){range+='-'+Ext.Date.format(end,'n/j');}
var msg=Ext.util.Format.format(data.type=='eventdrag'?this.moveText:this.createText,range);data.proxy.updateMsg(msg);}
return this.dropAllowed;},shim:function(start,end){this.currWeek=-1;this.DDMInstance.notifyOccluded=true;var dt=Ext.Date.clone(start),i=0,shim,box,D=Ext.calendar.util.Date,cnt=D.diffDays(dt,end)+1;Ext.each(this.shims,function(shim){if(shim){shim.isActive=false;}});while(i++<cnt){var dayEl=this.view.getDayEl(dt);if(dayEl){var wk=this.view.getWeekIndex(dt);shim=this.shims[wk];if(!shim){shim=this.createShim();this.shims[wk]=shim;}
if(wk!=this.currWeek){shim.boxInfo=dayEl.getBox();this.currWeek=wk;}
else{box=dayEl.getBox();shim.boxInfo.right=box.right;shim.boxInfo.width=box.right-shim.boxInfo.x;}
shim.isActive=true;}
dt=D.add(dt,{days:1});}
Ext.each(this.shims,function(shim){if(shim){if(shim.isActive){shim.show();shim.setBox(shim.boxInfo);}
else if(shim.isVisible()){shim.hide();}}});},createShim:function(){if(!this.shimCt){this.shimCt=Ext.get('ext-dd-shim-ct');if(!this.shimCt){this.shimCt=document.createElement('div');this.shimCt.id='ext-dd-shim-ct';Ext.getBody().appendChild(this.shimCt);}}
var el=document.createElement('div');el.className='ext-dd-shim';this.shimCt.appendChild(el);el=Ext.get(el);el.setVisibilityMode(2);return el;},clearShims:function(){Ext.each(this.shims,function(shim){if(shim){shim.hide();}});this.DDMInstance.notifyOccluded=false;},onContainerOver:function(dd,e,data){return this.dropAllowed;},onCalendarDragComplete:function(){delete this.dragStartDate;delete this.dragEndDate;this.clearShims();},onNodeDrop:function(n,dd,e,data){if(n&&data){if(data.type=='eventdrag'){var rec=this.view.getEventRecordFromEl(data.ddel),dt=Ext.calendar.util.Date.copyTime(rec.data[Ext.calendar.data.EventMappings.StartDate.name],n.date);this.view.onEventDrop(rec,dt);this.onCalendarDragComplete();return true;}
if(data.type=='caldrag'){this.view.onCalendarEndDrag(this.dragStartDate,this.dragEndDate,Ext.bind(this.onCalendarDragComplete,this));return true;}}
this.onCalendarDragComplete();return false;},onContainerDrop:function(dd,e,data){this.onCalendarDragComplete();return false;}});;Ext.define('Ext.calendar.dd.DayDragZone',{extend:'Ext.calendar.dd.DragZone',requires:['Ext.calendar.data.EventMappings'],ddGroup:'DayViewDD',resizeSelector:'.ext-evt-rsz',getDragData:function(e){var startDateName=Ext.calendar.data.EventMappings.StartDate.name,endDateName=Ext.calendar.data.EventMappings.EndDate.name,t,p,rec;t=e.getTarget(this.resizeSelector,2,true);if(t){p=t.parent(this.eventSelector);rec=this.view.getEventRecordFromEl(p);return{type:'eventresize',ddel:p.dom,eventStart:rec.get(startDateName),eventEnd:rec.get(endDateName),proxy:this.proxy};}
t=e.getTarget(this.eventSelector,3);if(t){rec=this.view.getEventRecordFromEl(t);return{type:'eventdrag',ddel:t,eventStart:rec.get(startDateName),eventEnd:rec.get(endDateName),proxy:this.proxy};}
t=this.view.getDayAt(e.getX(),e.getY());if(t.el){return{type:'caldrag',dayInfo:t,proxy:this.proxy};}
return null;}});;Ext.define('Ext.calendar.dd.DayDropZone',{extend:'Ext.calendar.dd.DropZone',requires:['Ext.calendar.util.Date'],ddGroup:'DayViewDD',onNodeOver:function(n,dd,e,data){var dt,box,endDt,text=this.createText,curr,start,end,evtEl,dayCol;if(data.type=='caldrag'){if(!this.dragStartMarker){this.dragStartMarker=n.el.parent().createChild({style:'position:absolute;'});this.dragStartMarker.setBox(n.timeBox);this.dragCreateDt=n.date;}
box=this.dragStartMarker.getBox();box.height=Math.ceil(Math.abs(e.xy[1]-box.y)/n.timeBox.height)*n.timeBox.height;if(e.xy[1]<box.y){box.height+=n.timeBox.height;box.y=box.y-box.height+n.timeBox.height;endDt=Ext.Date.add(this.dragCreateDt,Ext.Date.MINUTE,30);}
else{n.date=Ext.Date.add(n.date,Ext.Date.MINUTE,30);}
this.shim(this.dragCreateDt,box);curr=Ext.calendar.util.Date.copyTime(n.date,this.dragCreateDt);this.dragStartDate=Ext.calendar.util.Date.min(this.dragCreateDt,curr);this.dragEndDate=endDt||Ext.calendar.util.Date.max(this.dragCreateDt,curr);dt=Ext.Date.format(this.dragStartDate,'g:ia-')+Ext.Date.format(this.dragEndDate,'g:ia');}
else{evtEl=Ext.get(data.ddel);dayCol=evtEl.parent().parent();box=evtEl.getBox();box.width=dayCol.getWidth();if(data.type=='eventdrag'){if(this.dragOffset===undefined){this.dragOffset=n.timeBox.y-box.y;box.y=n.timeBox.y-this.dragOffset;}
else{box.y=n.timeBox.y;}
dt=Ext.Date.format(n.date,'n/j g:ia');box.x=n.el.getX();this.shim(n.date,box);text=this.moveText;}
if(data.type=='eventresize'){if(!this.resizeDt){this.resizeDt=n.date;}
box.x=dayCol.getX();box.height=Math.ceil(Math.abs(e.xy[1]-box.y)/n.timeBox.height)*n.timeBox.height;if(e.xy[1]<box.y){box.y-=box.height;}
else{n.date=Ext.Date.add(n.date,Ext.Date.MINUTE,30);}
this.shim(this.resizeDt,box);curr=Ext.calendar.util.Date.copyTime(n.date,this.resizeDt);start=Ext.calendar.util.Date.min(data.eventStart,curr);end=Ext.calendar.util.Date.max(data.eventStart,curr);data.resizeDates={StartDate:start,EndDate:end};dt=Ext.Date.format(start,'g:ia-')+Ext.Date.format(end,'g:ia');text=this.resizeText;}}
data.proxy.updateMsg(Ext.util.Format.format(text,dt));return this.dropAllowed;},shim:function(dt,box){Ext.each(this.shims,function(shim){if(shim){shim.isActive=false;shim.hide();}});var shim=this.shims[0];if(!shim){shim=this.createShim();this.shims[0]=shim;}
shim.isActive=true;shim.show();shim.setBox(box);this.DDMInstance.notifyOccluded=true;},onNodeDrop:function(n,dd,e,data){var rec;if(n&&data){if(data.type=='eventdrag'){rec=this.view.getEventRecordFromEl(data.ddel);this.view.onEventDrop(rec,n.date);this.onCalendarDragComplete();delete this.dragOffset;return true;}
if(data.type=='eventresize'){rec=this.view.getEventRecordFromEl(data.ddel);this.view.onEventResize(rec,data.resizeDates);this.onCalendarDragComplete();delete this.resizeDt;return true;}
if(data.type=='caldrag'){Ext.destroy(this.dragStartMarker);delete this.dragStartMarker;delete this.dragCreateDt;this.view.onCalendarEndDrag(this.dragStartDate,this.dragEndDate,Ext.bind(this.onCalendarDragComplete,this));return true;}}
this.onCalendarDragComplete();return false;}});;Ext.define('Ext.calendar.form.field.CalendarCombo',{extend:'Ext.form.field.ComboBox',alias:'widget.calendarpicker',requires:['Ext.calendar.data.CalendarMappings'],fieldLabel:'Calendar',triggerAction:'all',queryMode:'local',forceSelection:true,selectOnFocus:true,defaultCls:'ext-color-default',initComponent:function(){this.valueField=Ext.calendar.data.CalendarMappings.CalendarId.name;this.displayField=Ext.calendar.data.CalendarMappings.Title.name;this.listConfig=Ext.apply(this.listConfig||{},{getInnerTpl:this.getListItemTpl});this.callParent(arguments);},getListItemTpl:function(displayField){return'<div class="x-combo-list-item ext-color-{'+Ext.calendar.data.CalendarMappings.CalendarId.name+'}"><div class="ext-cal-picker-icon">&#160;</div>{'+displayField+'}</div>';},afterRender:function(){this.callParent(arguments);this.wrap=this.el.down('.x-form-text-wrap');this.wrap.addCls('ext-calendar-picker');this.icon=Ext.core.DomHelper.append(this.wrap,{tag:'div',cls:'ext-cal-picker-icon ext-cal-picker-mainicon'});},getStyleClass:function(value){var val=value;if(!Ext.isEmpty(val)){if(Ext.isArray(val)){val=val[0];}
return'ext-color-'+(val.data?val.data[Ext.calendar.data.CalendarMappings.CalendarId.name]:val);}
return'';},setValue:function(value){if(!value&&this.store.getCount()>0){value=this.store.getAt(0).data[Ext.calendar.data.CalendarMappings.CalendarId.name];}
if(this.wrap&&value){var currentClass=this.getStyleClass(this.getValue()),newClass=this.getStyleClass(value);this.wrap.replaceCls(currentClass,newClass);}
this.callParent(arguments);}});;Ext.define('Ext.calendar.form.field.DateRange',{extend:'Ext.form.FieldContainer',alias:'widget.daterangefield',requires:['Ext.form.field.Date','Ext.form.field.Time','Ext.form.Label','Ext.form.field.Checkbox','Ext.layout.container.Column'],toText:'to',allDayText:'All day',singleLine:true,dateFormat:'n/j/Y',timeFormat:Ext.Date.use24HourTime?'G:i':'g:i A',fieldLayout:'hbox',defaults:{margin:'0 5 0 0'},initComponent:function(){var me=this;me.addCls('ext-dt-range');if(me.singleLine){me.layout=me.fieldLayout;me.items=me.getFieldConfigs();}
else{me.items=[{xtype:'container',layout:me.fieldLayout,items:[me.getStartDateConfig(),me.getStartTimeConfig(),me.getDateSeparatorConfig()]},{xtype:'container',layout:me.fieldLayout,items:[me.getEndDateConfig(),me.getEndTimeConfig(),me.getAllDayConfig()]}];}
me.callParent(arguments);me.initRefs();},initRefs:function(){var me=this;me.startDate=me.down('#'+me.id+'-start-date');me.startTime=me.down('#'+me.id+'-start-time');me.endTime=me.down('#'+me.id+'-end-time');me.endDate=me.down('#'+me.id+'-end-date');me.allDay=me.down('#'+me.id+'-allday');me.toLabel=me.down('#'+me.id+'-to-label');me.startDate.validateOnChange=me.endDate.validateOnChange=false;me.startDate.isValid=me.endDate.isValid=function(){var me=this,valid=Ext.isDate(me.getValue());if(!valid){me.focus();}
return valid;};},getFieldConfigs:function(){var me=this;return[me.getStartDateConfig(),me.getStartTimeConfig(),me.getDateSeparatorConfig(),me.getEndTimeConfig(),me.getEndDateConfig(),me.getAllDayConfig()];},getStartDateConfig:function(){return{xtype:'datefield',itemId:this.id+'-start-date',format:this.dateFormat,width:100,listeners:{'blur':{fn:function(){this.onFieldChange('date','start');},scope:this}}};},getStartTimeConfig:function(){return{xtype:'timefield',itemId:this.id+'-start-time',hidden:this.showTimes===false,labelWidth:0,hideLabel:true,width:90,format:this.timeFormat,listeners:{'select':{fn:function(){this.onFieldChange('time','start');},scope:this}}};},getEndDateConfig:function(){return{xtype:'datefield',itemId:this.id+'-end-date',format:this.dateFormat,hideLabel:true,width:100,listeners:{'blur':{fn:function(){this.onFieldChange('date','end');},scope:this}}};},getEndTimeConfig:function(){return{xtype:'timefield',itemId:this.id+'-end-time',hidden:this.showTimes===false,labelWidth:0,hideLabel:true,width:90,format:this.timeFormat,listeners:{'select':{fn:function(){this.onFieldChange('time','end');},scope:this}}};},getDuration:function(){var me=this,start=me.getDT('start'),end=me.getDT('end');return end.getTime()-start.getTime();},getAllDayConfig:function(){return{xtype:'checkbox',itemId:this.id+'-allday',hidden:this.showTimes===false||this.showAllDay===false,boxLabel:this.allDayText,margin:'2 5 0 0',handler:this.onAllDayChange,scope:this};},onAllDayChange:function(chk,checked){Ext.suspendLayouts();this.startTime.setDisabled(checked).setVisible(!checked);this.endTime.setDisabled(checked).setVisible(!checked);Ext.resumeLayouts(true);},getDateSeparatorConfig:function(){return{xtype:'label',itemId:this.id+'-to-label',text:this.toText,margin:'4 5 0 0'};},isSingleLine:function(){var me=this;if(me.calculatedSingleLine===undefined){if(me.singleLine=='auto'){var ownerCtEl=me.ownerCt.getEl(),w=me.ownerCt.getWidth()-ownerCtEl.getPadding('lr'),el=ownerCtEl.down('.x-panel-body');if(el){w-=el.getPadding('lr');}
el=ownerCtEl.down('.x-form-item-label');if(el){w-=el.getWidth()-el.getPadding('lr');}
me.calculatedSingleLine=w<=me.singleLineMinWidth?false:true;}
else{me.calculatedSingleLine=me.singleLine!==undefined?me.singleLine:true;}}
return me.calculatedSingleLine;},onFieldChange:function(type,startend){this.checkDates(type,startend);this.fireEvent('change',this,this.getValue());},checkDates:function(type,startend){var me=this,startField=me.down('#'+me.id+'-start-'+type),endField=me.down('#'+me.id+'-end-'+type),startValue=me.getDT('start'),endValue=me.getDT('end');if(!startValue||!endValue){return;}
if(startValue>endValue){if(startend=='start'){endField.setValue(startValue);}else{startField.setValue(endValue);me.checkDates(type,'start');}}
if(type=='date'){me.checkDates('time',startend);}},getValue:function(){var eDate=Ext.calendar.util.Date,start=this.getDT('start'),end=this.getDT('end'),allDay=this.allDay.getValue();if(Ext.isDate(start)&&Ext.isDate(end)&&start.getTime()!==end.getTime()){if(!allDay&&eDate.isMidnight(start)&&eDate.isMidnight(end)){allDay=true;end=eDate.add(end,{days:-1});}}
return[start,end,allDay];},getDT:function(startend){var time=this[startend+'Time'].getValue(),dt=this[startend+'Date'].getValue();if(Ext.isDate(dt)){dt=Ext.Date.format(dt,this[startend+'Date'].format);}
else{return null;}
if(time&&time!==''){time=Ext.Date.format(time,this[startend+'Time'].format);var val=Ext.Date.parseDate(dt+' '+time,this[startend+'Date'].format+' '+this[startend+'Time'].format);return val;}
return Ext.Date.parseDate(dt,this[startend+'Date'].format);},setValue:function(v){if(!v){return;}
if(Ext.isArray(v)){this.setDT(v[0],'start');this.setDT(v[1],'end');this.allDay.setValue(!!v[2]);}
else if(Ext.isDate(v)){this.setDT(v,'start');this.setDT(v,'end');this.allDay.setValue(false);}
else if(v[Ext.calendar.data.EventMappings.StartDate.name]){this.setDT(v[Ext.calendar.data.EventMappings.StartDate.name],'start');if(!this.setDT(v[Ext.calendar.data.EventMappings.EndDate.name],'end')){this.setDT(v[Ext.calendar.data.EventMappings.StartDate.name],'end');}
this.allDay.setValue(!!v[Ext.calendar.data.EventMappings.IsAllDay.name]);}},setDT:function(dt,startend){if(dt&&Ext.isDate(dt)){this[startend+'Date'].setValue(dt);this[startend+'Time'].setValue(Ext.Date.format(dt,this[startend+'Time'].format));return true;}},isDirty:function(){var dirty=false;if(this.rendered&&!this.disabled){this.items.each(function(item){if(item.isDirty()){dirty=true;return false;}});}
return dirty;},onDisable:function(){this.delegateFn('disable');},onEnable:function(){this.delegateFn('enable');},reset:function(){this.delegateFn('reset');},delegateFn:function(fn){this.items.each(function(item){if(item[fn]){item[fn]();}});},beforeDestroy:function(){Ext.destroy(this.fieldCt);this.callParent(arguments);},getRawValue:Ext.emptyFn,setRawValue:Ext.emptyFn});;Ext.define('Ext.calendar.form.field.ReminderCombo',{extend:'Ext.form.field.ComboBox',alias:'widget.reminderfield',fieldLabel:'Reminder',queryMode:'local',triggerAction:'all',forceSelection:true,displayField:'desc',valueField:'value',initComponent:function(){this.store=this.store||new Ext.data.ArrayStore({fields:['value','desc'],idIndex:0,data:[['','None'],['0','At start time'],['5','5 minutes before start'],['15','15 minutes before start'],['30','30 minutes before start'],['60','1 hour before start'],['90','1.5 hours before start'],['120','2 hours before start'],['180','3 hours before start'],['360','6 hours before start'],['720','12 hours before start'],['1440','1 day before start'],['2880','2 days before start'],['4320','3 days before start'],['5760','4 days before start'],['7200','5 days before start'],['10080','1 week before start'],['20160','2 weeks before start']]});this.callParent();},initValue:function(){if(this.value!==undefined){this.setValue(this.value);}
else{this.setValue('');}
this.originalValue=this.getValue();}});;Ext.define('Ext.calendar.form.EventDetails',{extend:'Ext.form.Panel',alias:'widget.eventeditform',requires:['Ext.calendar.form.field.DateRange','Ext.calendar.form.field.ReminderCombo','Ext.calendar.data.EventMappings','Ext.calendar.form.field.CalendarCombo'],fieldDefaults:{msgTarget:'side',labelWidth:65},title:'Event Form',titleTextAdd:'Add Event',titleTextEdit:'Edit Event',bodyStyle:'background:transparent;padding:20px 20px 10px;',border:false,buttonAlign:'center',autoHeight:true,cls:'ext-evt-edit-form',newId:10000,layout:{type:'hbox',align:'stretch'},initComponent:function(){this.titleField=new Ext.form.Text({fieldLabel:'Title',name:Ext.calendar.data.EventMappings.Title.name,emptyText:'Event Title',allowBlank:false,anchor:'90%'});this.dateRangeField=new Ext.calendar.form.field.DateRange({fieldLabel:'When',singleLine:false,anchor:'90%'});this.reminderField=new Ext.calendar.form.field.ReminderCombo({name:'Reminder',anchor:'70%'});this.notesField=new Ext.form.TextArea({fieldLabel:'Notes',name:Ext.calendar.data.EventMappings.Notes.name,grow:true,growMax:150,anchor:'100%'});this.locationField=new Ext.form.Text({fieldLabel:'Location',name:Ext.calendar.data.EventMappings.Location.name,anchor:'100%'});this.urlField=new Ext.form.Text({fieldLabel:'Web Link',name:Ext.calendar.data.EventMappings.Url.name,anchor:'100%'});var leftFields=[this.titleField,this.dateRangeField,this.reminderField],rightFields=[this.notesField,this.locationField,this.urlField];if(this.calendarStore){this.calendarField=new Ext.calendar.form.field.CalendarCombo({store:this.calendarStore,anchor:'70%',name:Ext.calendar.data.EventMappings.CalendarId.name});leftFields.splice(2,0,this.calendarField);}
this.items=[{id:'left-col',flex:0.65,layout:'anchor',border:false,items:leftFields},{id:'right-col',flex:0.35,layout:'anchor',border:false,items:rightFields}];this.fbar=[{cls:'ext-del-btn',itemId:this.id+'-del-btn',text:'Delete Event',scope:this,handler:this.onDelete,minWidth:150},{text:L.Save,scope:this,handler:this.onSave},{text:'Cancel',scope:this,handler:this.onCancel}];this.callParent(arguments);},loadRecord:function(rec){this.form.reset().loadRecord.apply(this.form,arguments);this.activeRecord=rec;this.dateRangeField.setValue(rec.data);if(this.calendarStore){this.form.setValues({'calendar':rec.data[Ext.calendar.data.EventMappings.CalendarId.name]});}
if(rec.phantom){this.setTitle(this.titleTextAdd);this.down('#'+this.id+'-del-btn').hide();}
else{this.setTitle(this.titleTextEdit);this.down('#'+this.id+'-del-btn').show();}
this.titleField.focus();},updateRecord:function(){var dates=this.dateRangeField.getValue(),M=Ext.calendar.data.EventMappings,rec=this.activeRecord,fs=rec.fields,dirty=false;rec.beginEdit();Ext.Array.each(fs,function(f){var field=this.form.findField(f.name);if(field){var value=field.getValue();if(value.getGroupValue){value=value.getGroupValue();}
else if(field.eachItem){value=[];field.eachItem(function(item){value.push(item.getValue());});}
rec.set(f.name,value);}},this);rec.set(M.StartDate.name,dates[0]);rec.set(M.EndDate.name,dates[1]);rec.set(M.IsAllDay.name,dates[2]);dirty=rec.dirty;rec.endEdit();return dirty;},setStartDate:function(d){var me=this,duration=me.dateRangeField.getDuration();me.dateRangeField.setDT(d,'start');me.dateRangeField.setDT(new Date(me.dateRangeField.getDT('start').getTime()+duration),'end');},setEndDate:function(d){this.dateRangeField.setDT(d,'end');},onCancel:function(){this.cleanup(true);this.fireEvent('eventcancel',this,this.activeRecord);},cleanup:function(hide){if(this.activeRecord&&this.activeRecord.dirty){this.activeRecord.reject();}
delete this.activeRecord;if(this.form.isDirty()){this.form.reset();}},onSave:function(){if(!this.form.isValid()){return;}
if(!this.updateRecord()){this.onCancel();return;}
this.fireEvent(this.activeRecord.phantom?'eventadd':'eventupdate',this,this.activeRecord);},onDelete:function(){this.fireEvent('eventdelete',this,this.activeRecord);}});;Ext.define('Ext.calendar.form.EventWindow',{extend:'Ext.window.Window',alias:'widget.eventeditwindow',requires:['Ext.form.Panel','Ext.calendar.util.Date','Ext.calendar.data.EventModel','Ext.calendar.data.EventMappings'],constructor:function(config){var formPanelCfg={xtype:'form',fieldDefaults:{msgTarget:'side',labelWidth:65},frame:false,bodyStyle:'background:transparent;padding:5px 10px 10px;',bodyBorder:false,border:false,items:[{itemId:'title',name:Ext.calendar.data.EventMappings.Title.name,fieldLabel:'Title',xtype:'textfield',allowBlank:false,emptyText:'Event Title',anchor:'100%'},{xtype:'daterangefield',itemId:'date-range',name:'dates',anchor:'100%',fieldLabel:'When'}]};if(config.calendarStore){this.calendarStore=config.calendarStore;delete config.calendarStore;formPanelCfg.items.push({xtype:'calendarpicker',itemId:'calendar',name:Ext.calendar.data.EventMappings.CalendarId.name,anchor:'100%',store:this.calendarStore});}
this.callParent([Ext.apply({titleTextAdd:'Add Event',titleTextEdit:'Edit Event',width:600,autocreate:true,border:true,closeAction:'hide',modal:false,resizable:false,buttonAlign:'left',savingMessage:'Saving changes...',deletingMessage:'Deleting event...',layout:'fit',defaultFocus:'title',onEsc:function(key,event){event.target.blur();this.onCancel();},fbar:[{xtype:'tbtext',text:'<a href="#" id="tblink">Edit Details...</a>'},'->',{itemId:'delete-btn',text:'Delete Event',disabled:false,handler:this.onDelete,scope:this,minWidth:150,hideMode:'offsets'},{text:'Save',disabled:false,handler:this.onSave,scope:this},{text:'Cancel',disabled:false,handler:this.onCancel,scope:this}],items:formPanelCfg},config)]);},newId:10000,initComponent:function(){this.callParent();this.formPanel=this.items.items[0];},afterRender:function(){this.callParent();this.el.addCls('ext-cal-event-win');Ext.get('tblink').on('click',this.onEditDetailsClick,this);this.titleField=this.down('#title');this.dateRangeField=this.down('#date-range');this.calendarField=this.down('#calendar');this.deleteButton=this.down('#delete-btn');},onEditDetailsClick:function(e){e.stopEvent();this.updateRecord(this.activeRecord,true);this.fireEvent('editdetails',this,this.activeRecord,this.animateTarget);},show:function(o,animateTarget){var me=this,anim=(Ext.isIE8&&Ext.isStrict)?null:animateTarget,M=Ext.calendar.data.EventMappings,data={};this.callParent([anim,function(){me.titleField.focus(true);}]);this.deleteButton[o.data&&o.data[M.EventId.name]?'show':'hide']();var rec,f=this.formPanel.form;if(o.data){rec=o;this.setTitle(rec.phantom?this.titleTextAdd:this.titleTextEdit);f.loadRecord(rec);}
else{this.setTitle(this.titleTextAdd);var start=o[M.StartDate.name],end=o[M.EndDate.name]||Ext.calendar.util.Date.add(start,{hours:1});data[M.StartDate.name]=start;data[M.EndDate.name]=end;data[M.IsAllDay.name]=!!o[M.IsAllDay.name]||start.getDate()!=Ext.calendar.util.Date.add(end,{millis:1}).getDate();rec=new Ext.calendar.data.EventModel(data);f.reset();f.loadRecord(rec);}
if(this.calendarStore){this.calendarField.setValue(rec.data[M.CalendarId.name]);}
this.dateRangeField.setValue(rec.data);this.activeRecord=rec;return this;},roundTime:function(dt,incr){incr=incr||15;var m=parseInt(dt.getMinutes(),10);return dt.add('mi',incr-(m%incr));},onCancel:function(){this.cleanup(true);this.fireEvent('eventcancel',this);},cleanup:function(hide){if(this.activeRecord&&this.activeRecord.dirty){this.activeRecord.reject();}
delete this.activeRecord;if(hide===true){this.hide();}},updateRecord:function(record,keepEditing){var fields=record.getFields(),values=this.formPanel.getForm().getValues(),name,M=Ext.calendar.data.EventMappings,obj={};Ext.Array.each(fields,function(f){name=f.name;if(name in values){obj[name]=values[name];}});var dates=this.dateRangeField.getValue();obj[M.StartDate.name]=dates[0];obj[M.EndDate.name]=dates[1];obj[M.IsAllDay.name]=dates[2];record.beginEdit();record.set(obj);if(!keepEditing){record.endEdit();}
return this;},onSave:function(){if(!this.formPanel.form.isValid()){return;}
if(!this.updateRecord(this.activeRecord)){this.onCancel();return;}
this.fireEvent(this.activeRecord.phantom?'eventadd':'eventupdate',this,this.activeRecord,this.animateTarget);this.activeRecord.commit();},onDelete:function(){this.fireEvent('eventdelete',this,this.activeRecord,this.animateTarget);}});;Ext.define('Ext.calendar.template.BoxLayout',{extend:'Ext.XTemplate',requires:['Ext.calendar.util.Date'],constructor:function(config){Ext.apply(this,config);var weekLinkTpl=this.showWeekLinks?'<div id="{weekLinkId}" class="ext-cal-week-link">{weekNum}</div>':'';this.callParent(['<tpl for="weeks">','<div id="{[this.id]}-wk-{[xindex-1]}" class="ext-cal-wk-ct" style="top:{[this.getRowTop(xindex, xcount)]}%; height:{[this.getRowHeight(xcount)]}%;">',weekLinkTpl,'<table class="ext-cal-bg-tbl" cellpadding="0" cellspacing="0">','<tbody>','<tr>','<tpl for=".">','<td id="{[this.id]}-day-{date:date("Ymd")}" class="{cellCls}">&#160;</td>','</tpl>','</tr>','</tbody>','</table>','<table class="ext-cal-evt-tbl" cellpadding="0" cellspacing="0">','<tbody>','<tr>','<tpl for=".">','<td id="{[this.id]}-ev-day-{date:date("Ymd")}" class="{titleCls}"><div>{title}</div></td>','</tpl>','</tr>','</tbody>','</table>','</div>','</tpl>',{getRowTop:function(i,ln){return((i-1)*(100/ln));},getRowHeight:function(ln){return 100/ln;}}]);},applyTemplate:function(o){Ext.apply(this,o);var w=0,title='',first=true,isToday=false,showMonth=false,prevMonth=false,nextMonth=false,weeks=[[]],dt=Ext.Date.clone(this.viewStart),thisMonth=this.startDate.getMonth();for(;w<this.weekCount||this.weekCount==-1;w++){if(dt>this.viewEnd){break;}
weeks[w]=[];for(var d=0;d<this.dayCount;d++){isToday=dt.getTime()===Ext.calendar.util.Date.today().getTime();showMonth=first||(dt.getDate()==1);prevMonth=(dt.getMonth()<thisMonth)&&this.weekCount==-1;nextMonth=(dt.getMonth()>thisMonth)&&this.weekCount==-1;if(dt.getDay()==1){weeks[w].weekNum=this.showWeekNumbers?Ext.Date.format(dt,'W'):'&#160;';weeks[w].weekLinkId='ext-cal-week-'+Ext.Date.format(dt,'Ymd');}
if(showMonth){if(isToday){title=this.getTodayText();}
else{title=Ext.Date.format(dt,this.dayCount==1?'l, F j, Y':(first?'M j, Y':'M j'));}}
else{var dayFmt=(w==0&&this.showHeader!==true)?'D j':'j';title=isToday?this.getTodayText():Ext.Date.format(dt,dayFmt);}
weeks[w].push({title:title,date:Ext.Date.clone(dt),titleCls:'ext-cal-dtitle '+(isToday?' ext-cal-dtitle-today':'')+
(w==0?' ext-cal-dtitle-first':'')+
(prevMonth?' ext-cal-dtitle-prev':'')+
(nextMonth?' ext-cal-dtitle-next':''),cellCls:'ext-cal-day '+(isToday?' ext-cal-day-today':'')+
(d==0?' ext-cal-day-first':'')+
(prevMonth?' ext-cal-day-prev':'')+
(nextMonth?' ext-cal-day-next':'')});dt=Ext.calendar.util.Date.add(dt,{days:1});first=false;}}
return this.applyOut({weeks:weeks},[]).join('');},getTodayText:function(){var dt=Ext.Date.format(new Date(),'l, F j, Y'),fmt,todayText=this.showTodayText!==false?this.todayText:'',timeText=this.showTime!==false?' <span id="'+this.id+'-clock" class="ext-cal-dtitle-time">'+
Ext.Date.format(new Date(),'g:i a')+'</span>':'',separator=todayText.length>0||timeText.length>0?' &mdash; ':'';if(this.dayCount==1){return dt+separator+todayText+timeText;}
fmt=this.weekCount==1?'D j':'j';return todayText.length>0?todayText+timeText:Ext.Date.format(new Date(),fmt)+timeText;}},function(){this.createAlias('apply','applyTemplate');});;Ext.define('Ext.calendar.template.DayBody',{extend:'Ext.XTemplate',requires:['Ext.calendar.util.Date'],constructor:function(config){Ext.apply(this,config);this.callParent(['<table class="ext-cal-bg-tbl" cellspacing="0" cellpadding="0">','<tbody>','<tr height="1">','<td class="ext-cal-gutter"></td>','<td colspan="{dayCount}">','<div class="ext-cal-bg-rows">','<div class="ext-cal-bg-rows-inner">','<tpl for="times">','<div class="ext-cal-bg-row">','<div class="ext-cal-bg-row-div ext-row-{[xindex]}"></div>','</div>','</tpl>','</div>','</div>','</td>','</tr>','<tr>','<td class="ext-cal-day-times">','<tpl for="times">','<div class="ext-cal-bg-row">','<div class="ext-cal-day-time-inner">{.}</div>','</div>','</tpl>','</td>','<tpl for="days">','<td class="ext-cal-day-col">','<div class="ext-cal-day-col-inner">','<div id="{[this.id]}-day-col-{.:date("Ymd")}" class="ext-cal-day-col-gutter"></div>','</div>','</td>','</tpl>','</tr>','</tbody>','</table>']);},applyTemplate:function(o){this.today=Ext.calendar.util.Date.today();this.dayCount=this.dayCount||1;var i=0,days=[],dt=Ext.Date.clone(o.viewStart),times=[];for(;i<this.dayCount;i++){days[i]=Ext.calendar.util.Date.add(dt,{days:i});}
dt=Ext.Date.clearTime(new Date('5/26/1972'));for(i=0;i<24;i++){times.push(Ext.Date.format(dt,'ga'));dt=Ext.calendar.util.Date.add(dt,{hours:1});}
return this.applyOut({days:days,dayCount:days.length,times:times},[]).join('');},apply:function(values){return this.applyTemplate.apply(this,arguments);}});;Ext.define('Ext.calendar.template.DayHeader',{extend:'Ext.XTemplate',requires:['Ext.calendar.template.BoxLayout'],constructor:function(config){Ext.apply(this,config);this.allDayTpl=new Ext.calendar.template.BoxLayout(config);this.allDayTpl.compile();this.callParent(['<div class="ext-cal-hd-ct">','<table class="ext-cal-hd-days-tbl" cellspacing="0" cellpadding="0">','<tbody>','<tr>','<td class="ext-cal-gutter"></td>','<td class="ext-cal-hd-days-td"><div class="ext-cal-hd-ad-inner">{allDayTpl}</div></td>','<td class="ext-cal-gutter-rt"></td>','</tr>','</tobdy>','</table>','</div>']);},applyTemplate:function(o){return this.applyOut({allDayTpl:this.allDayTpl.apply(o)},[]).join('');},apply:function(values){return this.applyTemplate.apply(this,arguments);}});;Ext.define('Ext.calendar.template.Month',{extend:'Ext.XTemplate',requires:['Ext.calendar.template.BoxLayout'],constructor:function(config){Ext.apply(this,config);this.weekTpl=new Ext.calendar.template.BoxLayout(config);this.weekTpl.compile();var weekLinkTpl=this.showWeekLinks?'<div class="ext-cal-week-link-hd">&#160;</div>':'';this.callParent(['<div class="ext-cal-inner-ct {extraClasses}">','<div class="ext-cal-hd-ct ext-cal-month-hd">',weekLinkTpl,'<table class="ext-cal-hd-days-tbl" cellpadding="0" cellspacing="0">','<tbody>','<tr>','<tpl for="days">','<th class="ext-cal-hd-day{[xindex==1 ? " ext-cal-day-first" : ""]}" title="{.:date("l, F j, Y")}">{.:date("D")}</th>','</tpl>','</tr>','</tbody>','</table>','</div>','<div class="ext-cal-body-ct">{weeks}</div>','</div>']);},applyTemplate:function(o){var days=[],weeks=this.weekTpl.apply(o),dt=o.viewStart,D=Ext.calendar.util.Date;for(var i=0;i<7;i++){days.push(D.add(dt,{days:i}));}
var extraClasses=this.showHeader===true?'':'ext-cal-noheader';if(this.showWeekLinks){extraClasses+=' ext-cal-week-links';}
return this.applyOut({days:days,weeks:weeks,extraClasses:extraClasses},[]).join('');},apply:function(values){return this.applyTemplate.apply(this,arguments);}});;Ext.define('Ext.calendar.view.AbstractCalendar',{extend:'Ext.Component',alias:'widget.calendarview',requires:['Ext.calendar.util.Date','Ext.calendar.data.EventMappings'],startDay:0,spansHavePriority:false,trackMouseOver:true,enableFx:true,enableAddFx:true,enableUpdateFx:false,enableRemoveFx:true,enableDD:true,monitorResize:true,ddCreateEventText:'Create event for {0}',ddMoveEventText:'Move event to {0}',ddResizeEventText:'Update event to {0}',weekCount:1,dayCount:1,eventSelector:'.ext-cal-evt',eventOverClass:'ext-evt-over',eventElIdDelimiter:'-evt-',dayElIdDelimiter:'-day-',getEventBodyMarkup:Ext.emptyFn,getEventTemplate:Ext.emptyFn,initComponent:function(){this.setStartDate(this.startDate||new Date());this.callParent(arguments);},afterRender:function(){this.callParent(arguments);this.renderTemplate();if(this.store){this.setStore(this.store,true);}
this.el.on({'mouseover':this.onMouseOver,'mouseout':this.onMouseOut,'click':this.onClick,scope:this});this.el.unselectable();if(this.enableDD&&this.initDD){this.initDD();}
this.on('eventsrendered',this.forceSize);Ext.defer(this.forceSize,100,this);},forceSize:function(){if(this.el&&this.el.down){var hd=this.el.down('.ext-cal-hd-ct'),bd=this.el.down('.ext-cal-body-ct');if(bd==null||hd==null){return;}
var headerHeight=hd.getHeight(),sz=this.el.parent().getSize();bd.setHeight(sz.height-headerHeight);}},refresh:function(){this.prepareData();this.renderTemplate();this.renderItems();},getWeekCount:function(){var days=Ext.calendar.util.Date.diffDays(this.viewStart,this.viewEnd);return Math.ceil(days/this.dayCount);},prepareData:function(){var lastInMonth=Ext.Date.getLastDateOfMonth(this.startDate),w=0,d,dt=Ext.Date.clone(this.viewStart),weeks=this.weekCount<1?6:this.weekCount;this.eventGrid=[[]];this.allDayGrid=[[]];this.evtMaxCount=[];var evtsInView=this.store.queryBy(function(rec){return this.isEventVisible(rec.data);},this);for(;w<weeks;w++){this.evtMaxCount[w]=0;if(this.weekCount==-1&&dt>lastInMonth){break;}
this.eventGrid[w]=this.eventGrid[w]||[];this.allDayGrid[w]=this.allDayGrid[w]||[];for(d=0;d<this.dayCount;d++){if(evtsInView.getCount()>0){var evts=evtsInView.filterBy(function(rec){var startDt=Ext.Date.clearTime(rec.data[Ext.calendar.data.EventMappings.StartDate.name],true),startsOnDate=dt.getTime()==startDt.getTime(),spansFromPrevView=(w==0&&d==0&&(dt>rec.data[Ext.calendar.data.EventMappings.StartDate.name]));return startsOnDate||spansFromPrevView;},this);this.sortEventRecordsForDay(evts);this.prepareEventGrid(evts,w,d);}
dt=Ext.calendar.util.Date.add(dt,{days:1});}}
this.currentWeekCount=w;},prepareEventGrid:function(evts,w,d){var me=this,row=0,max=me.maxEventsPerDay?me.maxEventsPerDay:999;evts.each(function(evt){var M=Ext.calendar.data.EventMappings,days=Ext.calendar.util.Date.diffDays(Ext.calendar.util.Date.max(me.viewStart,evt.data[M.StartDate.name]),Ext.calendar.util.Date.min(me.viewEnd,evt.data[M.EndDate.name]))+1;if(days>1||Ext.calendar.util.Date.diffDays(evt.data[M.StartDate.name],evt.data[M.EndDate.name])>1){me.prepareEventGridSpans(evt,me.eventGrid,w,d,days);me.prepareEventGridSpans(evt,me.allDayGrid,w,d,days,true);}else{row=me.findEmptyRowIndex(w,d);me.eventGrid[w][d]=me.eventGrid[w][d]||[];me.eventGrid[w][d][row]=evt;if(evt.data[M.IsAllDay.name]){row=me.findEmptyRowIndex(w,d,true);me.allDayGrid[w][d]=me.allDayGrid[w][d]||[];me.allDayGrid[w][d][row]=evt;}}
if(me.evtMaxCount[w]<me.eventGrid[w][d].length){me.evtMaxCount[w]=Math.min(max+1,me.eventGrid[w][d].length);}
return true;});},prepareEventGridSpans:function(evt,grid,w,d,days,allday){var w1=w,d1=d,row=this.findEmptyRowIndex(w,d,allday),dt=Ext.Date.clone(this.viewStart);var start={event:evt,isSpan:true,isSpanStart:true,spanLeft:false,spanRight:(d==6)};grid[w][d]=grid[w][d]||[];grid[w][d][row]=start;while(--days){dt=Ext.calendar.util.Date.add(dt,{days:1});if(dt>this.viewEnd){break;}
if(++d1>6){d1=0;w1++;row=this.findEmptyRowIndex(w1,0);}
grid[w1]=grid[w1]||[];grid[w1][d1]=grid[w1][d1]||[];grid[w1][d1][row]={event:evt,isSpan:true,isSpanStart:(d1==0),spanLeft:(w1>w)&&(d1%7==0),spanRight:(d1==6)&&(days>1)};}},findEmptyRowIndex:function(w,d,allday){var grid=allday?this.allDayGrid:this.eventGrid,day=grid[w]?grid[w][d]||[]:[],i=0,ln=day.length;for(;i<ln;i++){if(day[i]==null){return i;}}
return ln;},renderTemplate:function(){if(this.tpl){this.el.select('*').destroy();this.tpl.overwrite(this.el,this.getParams());this.lastRenderStart=Ext.Date.clone(this.viewStart);this.lastRenderEnd=Ext.Date.clone(this.viewEnd);}},disableStoreEvents:function(){this.monitorStoreEvents=false;},enableStoreEvents:function(refresh){this.monitorStoreEvents=true;if(refresh===true){this.refresh();}},onResize:function(){this.callParent(arguments);this.refresh();},onInitDrag:function(){this.fireEvent('initdrag',this);},onEventDrop:function(rec,dt){if(Ext.calendar.util.Date.compare(rec.data[Ext.calendar.data.EventMappings.StartDate.name],dt)===0){return;}
var diff=dt.getTime()-rec.data[Ext.calendar.data.EventMappings.StartDate.name].getTime();rec.set(Ext.calendar.data.EventMappings.StartDate.name,dt);rec.set(Ext.calendar.data.EventMappings.EndDate.name,Ext.calendar.util.Date.add(rec.data[Ext.calendar.data.EventMappings.EndDate.name],{millis:diff}));this.fireEvent('eventmove',this,rec);},onCalendarEndDrag:function(start,end,onComplete){if(start&&end){this.dragPending=true;var o={};o[Ext.calendar.data.EventMappings.StartDate.name]=start;o[Ext.calendar.data.EventMappings.EndDate.name]=end;this.fireEvent('rangeselect',this,o,Ext.bind(this.onCalendarEndDragComplete,this,[onComplete]));}},onCalendarEndDragComplete:function(onComplete){onComplete();this.dragPending=false;},onUpdate:function(ds,rec,operation){if(this.monitorStoreEvents===false){return;}
if(operation==Ext.data.Record.COMMIT){this.refresh();if(this.enableFx&&this.enableUpdateFx){this.doUpdateFx(this.getEventEls(rec.data[Ext.calendar.data.EventMappings.EventId.name]),{scope:this});}}},doUpdateFx:function(els,o){this.highlightEvent(els,null,o);},onAdd:function(ds,records,index){if(this.monitorStoreEvents===false){return;}
var rec=records[0];this.tempEventId=rec.id;this.refresh();if(this.enableFx&&this.enableAddFx){this.doAddFx(this.getEventEls(rec.data[Ext.calendar.data.EventMappings.EventId.name]),{scope:this});}},doAddFx:function(els,o){els.fadeIn(Ext.apply(o,{duration:2000}));},onRemove:function(ds,recs){var name=Ext.calendar.data.EventMappings.EventId.name,i,len,rec,els;if(this.monitorStoreEvents===false){return;}
for(i=0,len=recs.length;i<len;i++){rec=recs[i];if(this.enableFx&&this.enableRemoveFx){els=this.getEventEls(rec.get(name));if(els.getCount()>0){this.doRemoveFx(els,{remove:true,scope:this,callback:this.refresh});}}
else{this.getEventEls(rec.get(name)).remove();this.refresh();}}},doRemoveFx:function(els,o){els.fadeOut(o);},highlightEvent:function(els,color,o){if(this.enableFx){var c;!(Ext.isIE||Ext.isOpera)?els.highlight(color,o):els.each(function(el){el.highlight(color,Ext.applyIf({attr:'color'},o));c=el.down('.ext-cal-evm');if(c){c.highlight(color,o);}},this);}},getEventIdFromEl:function(el){el=Ext.get(el);var id=el.id.split(this.eventElIdDelimiter)[1],lastHypen=id.lastIndexOf('-');if(lastHypen>-1){id=id.substr(0,lastHypen);}
return id;},getEventId:function(eventId){if(eventId===undefined&&this.tempEventId){eventId=this.tempEventId;}
return eventId;},getEventSelectorCls:function(eventId,forSelect){var prefix=forSelect?'.':'';return prefix+this.id+this.eventElIdDelimiter+this.getEventId(eventId);},getEventEls:function(eventId){var els=Ext.select(this.getEventSelectorCls(this.getEventId(eventId),true),false,this.el.dom);return new Ext.CompositeElement(els);},isToday:function(){var today=Ext.Date.clearTime(new Date()).getTime();return this.viewStart.getTime()<=today&&this.viewEnd.getTime()>=today;},onDataChanged:function(store){this.refresh();},isEventVisible:function(evt){var M=Ext.calendar.data.EventMappings,data=evt.data||evt,start=this.viewStart.getTime(),end=this.viewEnd.getTime(),evStart=data[M.StartDate.name].getTime(),evEnd=data[M.EndDate.name].getTime();evEnd=Ext.calendar.util.Date.add(data[M.EndDate.name],{seconds:-1}).getTime();return this.rangesOverlap(start,end,evStart,evEnd);},rangesOverlap:function(start1,end1,start2,end2){var startsInRange=(start1>=start2&&start1<=end2),endsInRange=(end1>=start2&&end1<=end2),spansRange=(start1<=start2&&end1>=end2);return(startsInRange||endsInRange||spansRange);},isOverlapping:function(evt1,evt2){var ev1=evt1.data?evt1.data:evt1,ev2=evt2.data?evt2.data:evt2,M=Ext.calendar.data.EventMappings,start1=ev1[M.StartDate.name].getTime(),end1=Ext.calendar.util.Date.add(ev1[M.EndDate.name],{seconds:-1}).getTime(),start2=ev2[M.StartDate.name].getTime(),end2=Ext.calendar.util.Date.add(ev2[M.EndDate.name],{seconds:-1}).getTime();if(end1<start1){end1=start1;}
if(end2<start2){end2=start2;}
return(start1<=end2&&end1>=start2);},getDayEl:function(dt){return Ext.get(this.getDayId(dt));},getDayId:function(dt){if(Ext.isDate(dt)){dt=Ext.Date.format(dt,'Ymd');}
return this.id+this.dayElIdDelimiter+dt;},getStartDate:function(){return this.startDate;},setStartDate:function(start,refresh){this.startDate=Ext.Date.clearTime(start);this.setViewBounds(start);this.store.load({params:{start:Ext.Date.format(this.viewStart,'m-d-Y'),end:Ext.Date.format(this.viewEnd,'m-d-Y')}});if(refresh===true){this.refresh();}
this.fireEvent('datechange',this,this.startDate,this.viewStart,this.viewEnd);},setViewBounds:function(startDate){var start=startDate||this.startDate,offset=start.getDay()-this.startDay,Dt=Ext.calendar.util.Date;switch(this.weekCount){case 0:case 1:this.viewStart=this.dayCount<7?start:Dt.add(start,{days:-offset,clearTime:true});this.viewEnd=Dt.add(this.viewStart,{days:this.dayCount||7});this.viewEnd=Dt.add(this.viewEnd,{seconds:-1});return;case-1:start=Ext.Date.getFirstDateOfMonth(start);offset=start.getDay()-this.startDay;this.viewStart=Dt.add(start,{days:-offset,clearTime:true});var end=Dt.add(start,{months:1,seconds:-1});this.viewEnd=Dt.add(end,{days:6-end.getDay()});return;default:this.viewStart=Dt.add(start,{days:-offset,clearTime:true});this.viewEnd=Dt.add(this.viewStart,{days:this.weekCount*7,seconds:-1});}},getViewBounds:function(){return{start:this.viewStart,end:this.viewEnd};},sortEventRecordsForDay:function(evts){if(evts.length<2){return;}
evts.sortBy(Ext.bind(function(evtA,evtB){var a=evtA.data,b=evtB.data,M=Ext.calendar.data.EventMappings;if(a[M.IsAllDay.name]){return-1;}
else if(b[M.IsAllDay.name]){return 1;}
if(this.spansHavePriority){var diff=Ext.calendar.util.Date.diffDays;if(diff(a[M.StartDate.name],a[M.EndDate.name])>0){if(diff(b[M.StartDate.name],b[M.EndDate.name])>0){if(a[M.StartDate.name].getTime()==b[M.StartDate.name].getTime()){return b[M.EndDate.name].getTime()-a[M.EndDate.name].getTime();}
return a[M.StartDate.name].getTime()-b[M.StartDate.name].getTime();}
return-1;}
else if(diff(b[M.StartDate.name],b[M.EndDate.name])>0){return 1;}
return a[M.StartDate.name].getTime()-b[M.StartDate.name].getTime();}
else{return a[M.StartDate.name].getTime()-b[M.StartDate.name].getTime();}},this));},moveTo:function(dt,noRefresh){if(Ext.isDate(dt)){this.setStartDate(dt);if(noRefresh!==false){this.refresh();}
return this.startDate;}
return dt;},moveNext:function(noRefresh){return this.moveTo(Ext.calendar.util.Date.add(this.viewEnd,{days:1}));},movePrev:function(noRefresh){var days=Ext.calendar.util.Date.diffDays(this.viewStart,this.viewEnd)+1;return this.moveDays(-days,noRefresh);},moveMonths:function(value,noRefresh){return this.moveTo(Ext.calendar.util.Date.add(this.startDate,{months:value}),noRefresh);},moveWeeks:function(value,noRefresh){return this.moveTo(Ext.calendar.util.Date.add(this.startDate,{days:value*7}),noRefresh);},moveDays:function(value,noRefresh){return this.moveTo(Ext.calendar.util.Date.add(this.startDate,{days:value}),noRefresh);},moveToday:function(noRefresh){return this.moveTo(new Date(),noRefresh);},setStore:function(store,initial){if(!initial&&this.store){this.store.un("datachanged",this.onDataChanged,this);this.store.un("add",this.onAdd,this);this.store.un("remove",this.onRemove,this);this.store.un("update",this.onUpdate,this);this.store.un("clear",this.refresh,this);}
if(store){store.on("datachanged",this.onDataChanged,this);store.on("add",this.onAdd,this);store.on("remove",this.onRemove,this);store.on("update",this.onUpdate,this);store.on("clear",this.refresh,this);}
this.store=store;if(store&&store.getCount()>0){this.refresh();}},getEventRecord:function(id){var idx=this.store.find(Ext.calendar.data.EventMappings.EventId.name,id);return this.store.getAt(idx);},getEventRecordFromEl:function(el){return this.getEventRecord(this.getEventIdFromEl(el));},getParams:function(){return{viewStart:this.viewStart,viewEnd:this.viewEnd,startDate:this.startDate,dayCount:this.dayCount,weekCount:this.weekCount,title:this.getTitle()};},getTitle:function(){return Ext.Date.format(this.startDate,'F Y');},onClick:function(e,t){var el=e.getTarget(this.eventSelector,5);if(el){var id=this.getEventIdFromEl(el);this.fireEvent('eventclick',this,this.getEventRecord(id),el);return true;}},onMouseOver:function(e,t){if(this.trackMouseOver!==false&&(this.dragZone==undefined||!this.dragZone.dragging)){if(!this.handleEventMouseEvent(e,t,'over')){this.handleDayMouseEvent(e,t,'over');}}},onMouseOut:function(e,t){if(this.trackMouseOver!==false&&(this.dragZone==undefined||!this.dragZone.dragging)){if(!this.handleEventMouseEvent(e,t,'out')){this.handleDayMouseEvent(e,t,'out');}}},handleEventMouseEvent:function(e,t,type){var el=e.getTarget(this.eventSelector,5,true),rel,els,evtId;if(el){rel=Ext.get(e.getRelatedTarget());if(el==rel||el.contains(rel)){return true;}
evtId=this.getEventIdFromEl(el);if(this.eventOverClass){els=this.getEventEls(evtId);els[type=='over'?'addCls':'removeCls'](this.eventOverClass);}
this.fireEvent('event'+type,this,this.getEventRecord(evtId),el);return true;}
return false;},getDateFromId:function(id,delim){var parts=id.split(delim);return parts[parts.length-1];},handleDayMouseEvent:function(e,t,type){t=e.getTarget('td',3);if(t){if(t.id&&t.id.indexOf(this.dayElIdDelimiter)>-1){var dt=this.getDateFromId(t.id,this.dayElIdDelimiter),rel=Ext.get(e.getRelatedTarget()),relTD,relDate;if(rel){relTD=rel.is('td')?rel:rel.up('td',3);relDate=relTD&&relTD.id?this.getDateFromId(relTD.id,this.dayElIdDelimiter):'';}
if(!rel||dt!=relDate){var el=this.getDayEl(dt);if(el&&this.dayOverClass!=''){el[type=='over'?'addCls':'removeCls'](this.dayOverClass);}
this.fireEvent('day'+type,this,Ext.Date.parseDate(dt,"Ymd"),el);}}}},renderItems:function(){throw'This method must be implemented by a subclass';},destroy:function(){this.callParent(arguments);if(this.el){this.el.un('contextmenu',this.onContextMenu,this);}
Ext.destroy(this.editWin,this.eventMenu,this.dragZone,this.dropZone);}});;Ext.define('Ext.calendar.view.MonthDayDetail',{extend:'Ext.Component',alias:'widget.monthdaydetailview',requires:['Ext.XTemplate','Ext.calendar.util.Date','Ext.calendar.view.AbstractCalendar'],afterRender:function(){this.tpl=this.getTemplate();this.callParent(arguments);this.el.on({click:this.view.onClick,mouseover:this.view.onMouseOver,mouseout:this.view.onMouseOut,scope:this.view});},getTemplate:function(){if(!this.tpl){this.tpl=new Ext.XTemplate('<div class="ext-cal-mdv x-unselectable">','<table class="ext-cal-mvd-tbl" cellpadding="0" cellspacing="0">','<tbody>','<tpl for=".">','<tr><td class="ext-cal-ev">{markup}</td></tr>','</tpl>','</tbody>','</table>','</div>');}
this.tpl.compile();return this.tpl;},update:function(dt){this.date=dt;this.refresh();},refresh:function(){if(!this.rendered){return;}
var eventTpl=this.view.getEventTemplate(),templateData=[],evts=this.store.queryBy(function(rec){var thisDt=Ext.Date.clearTime(this.date,true).getTime(),recStart=Ext.Date.clearTime(rec.data[Ext.calendar.data.EventMappings.StartDate.name],true).getTime(),startsOnDate=(thisDt==recStart),spansDate=false;if(!startsOnDate){var recEnd=Ext.Date.clearTime(rec.data[Ext.calendar.data.EventMappings.EndDate.name],true).getTime();spansDate=recStart<thisDt&&recEnd>=thisDt;}
return startsOnDate||spansDate;},this);evts.each(function(evt){var item=evt.data,M=Ext.calendar.data.EventMappings;item._renderAsAllDay=item[M.IsAllDay.name]||Ext.calendar.util.Date.diffDays(item[M.StartDate.name],item[M.EndDate.name])>0;item.spanLeft=Ext.calendar.util.Date.diffDays(item[M.StartDate.name],this.date)>0;item.spanRight=Ext.calendar.util.Date.diffDays(this.date,item[M.EndDate.name])>0;item.spanCls=(item.spanLeft?(item.spanRight?'ext-cal-ev-spanboth':'ext-cal-ev-spanleft'):(item.spanRight?'ext-cal-ev-spanright':''));templateData.push({markup:eventTpl.apply(this.getTemplateEventData(item))});},this);this.tpl.overwrite(this.el,templateData);this.fireEvent('eventsrendered',this,this.date,evts.getCount());},getTemplateEventData:function(evt){var data=this.view.getTemplateEventData(evt);data._elId='dtl-'+data._elId;return data;}});;Ext.define('Ext.calendar.view.Month',{extend:'Ext.calendar.view.AbstractCalendar',alias:'widget.monthview',requires:['Ext.XTemplate','Ext.calendar.template.Month','Ext.calendar.util.WeekEventRenderer','Ext.calendar.view.MonthDayDetail'],showTime:true,showTodayText:true,todayText:'Today',showHeader:false,showWeekLinks:false,showWeekNumbers:false,weekLinkOverClass:'ext-week-link-over',daySelector:'.ext-cal-day',moreSelector:'.ext-cal-ev-more',weekLinkSelector:'.ext-cal-week-link',weekCount:-1,dayCount:7,moreElIdDelimiter:'-more-',weekLinkIdDelimiter:'ext-cal-week-',operaLT11:Ext.isOpera&&(parseInt(Ext.operaVersion)<11),initDD:function(){var cfg={view:this,createText:this.ddCreateEventText,moveText:this.ddMoveEventText,ddGroup:'MonthViewDD'};this.dragZone=new Ext.calendar.dd.DragZone(this.el,cfg);this.dropZone=new Ext.calendar.dd.DropZone(this.el,cfg);},onDestroy:function(){Ext.destroy(this.ddSelector);Ext.destroy(this.dragZone);Ext.destroy(this.dropZone);this.callParent(arguments);},afterRender:function(){if(!this.tpl){this.tpl=new Ext.calendar.template.Month({id:this.id,showTodayText:this.showTodayText,todayText:this.todayText,showTime:this.showTime,showHeader:this.showHeader,showWeekLinks:this.showWeekLinks,showWeekNumbers:this.showWeekNumbers});}
this.tpl.compile();this.addCls('ext-cal-monthview ext-cal-ct');this.callParent(arguments);},onResize:function(){var me=this;me.callParent(arguments);me.maxEventsPerDay=me.getMaxEventsPerDay();if(me.monitorResize){me.refresh();}},forceSize:function(){if(this.showWeekLinks&&this.el){var hd=this.el.down('.ext-cal-hd-days-tbl'),bgTbl=this.el.select('.ext-cal-bg-tbl'),evTbl=this.el.select('.ext-cal-evt-tbl'),wkLinkW=this.el.down('.ext-cal-week-link').getWidth(),w=this.el.getWidth()-wkLinkW;hd.setWidth(w);bgTbl.setWidth(w);evTbl.setWidth(w);}
this.callParent(arguments);},initClock:function(){if(Ext.fly(this.id+'-clock')!==null){this.prevClockDay=new Date().getDay();if(this.clockTask){Ext.TaskManager.stop(this.clockTask);}
this.clockTask=Ext.TaskManager.start({run:function(){var el=Ext.fly(this.id+'-clock'),t=new Date();if(t.getDay()==this.prevClockDay){if(el){el.update(Ext.Date.format(t,'g:i a'));}}
else{this.prevClockDay=t.getDay();this.moveTo(t);}},scope:this,interval:1000});}},getEventBodyMarkup:function(){if(!this.eventBodyMarkup){this.eventBodyMarkup=['{Title}','<tpl if="_isReminder">','<i class="ext-cal-ic ext-cal-ic-rem">&#160;</i>','</tpl>','<tpl if="_isRecurring">','<i class="ext-cal-ic ext-cal-ic-rcr">&#160;</i>','</tpl>','<tpl if="spanLeft">','<i class="ext-cal-spl">&#160;</i>','</tpl>','<tpl if="spanRight">','<i class="ext-cal-spr">&#160;</i>','</tpl>'].join('');}
return this.eventBodyMarkup;},getEventTemplate:function(){if(!this.eventTpl){var tpl,body=this.getEventBodyMarkup();tpl=!(Ext.isIE7m||this.operaLT11)?new Ext.XTemplate('<div id="{_elId}" class="{_selectorCls} {_colorCls} {spanCls} ext-cal-evt ext-cal-evr {cls}" style="{style}">',body,'</div>'):new Ext.XTemplate('<tpl if="_renderAsAllDay">','<div id="{_elId}" class="{_selectorCls} {spanCls} {_colorCls} {_operaLT11} ext-cal-evo {cls}" style="{style}">','<div class="ext-cal-evm">','<div class="ext-cal-evi">','</tpl>','<tpl if="!_renderAsAllDay">','<div id="{_elId}" class="{_selectorCls} {_colorCls} {_operaLT11} ext-cal-evt ext-cal-evr {cls}" style="{style}">','</tpl>',body,'<tpl if="_renderAsAllDay">','</div>','</div>','</tpl>','</div>');tpl.compile();this.eventTpl=tpl;}
return this.eventTpl;},getTemplateEventData:function(evt){var M=Ext.calendar.data.EventMappings,selector=this.getEventSelectorCls(evt[M.EventId.name]),title=evt[M.Title.name];return Ext.applyIf({_selectorCls:selector,_colorCls:'ext-color-'+(evt[M.CalendarId.name]?evt[M.CalendarId.name]:'default')+(evt._renderAsAllDay?'-ad':''),_elId:selector+'-'+evt._weekIndex,_isRecurring:evt.Recurrence&&evt.Recurrence!='',_isReminder:evt[M.Reminder.name]&&evt[M.Reminder.name]!='',Title:(evt[M.IsAllDay.name]?'':Ext.Date.format(evt[M.StartDate.name],'g:ia '))+(!title||title.length==0?'(No title)':title),_operaLT11:this.operaLT11?'ext-operaLT11':''},evt);},refresh:function(){if(this.detailPanel){this.detailPanel.hide();}
this.callParent(arguments);if(this.showTime!==false){this.initClock();}},renderItems:function(){Ext.calendar.util.WeekEventRenderer.render({eventGrid:this.allDayOnly?this.allDayGrid:this.eventGrid,viewStart:this.viewStart,tpl:this.getEventTemplate(),maxEventsPerDay:this.getMaxEventsPerDay(),id:this.id,templateDataFn:Ext.bind(this.getTemplateEventData,this),evtMaxCount:this.evtMaxCount,weekCount:this.weekCount,dayCount:this.dayCount});this.fireEvent('eventsrendered',this);},getDayEl:function(dt){return Ext.get(this.getDayId(dt));},getDayId:function(dt){if(Ext.isDate(dt)){dt=Ext.Date.format(dt,'Ymd');}
return this.id+this.dayElIdDelimiter+dt;},getWeekIndex:function(dt){var el=this.getDayEl(dt).up('.ext-cal-wk-ct');return parseInt(el.id.split('-wk-')[1],10);},getDaySize:function(contentOnly){var box=this.el.getBox(),padding=this.getViewPadding(),w=(box.width-padding.width)/this.dayCount,h=(box.height-padding.height)/this.getWeekCount();if(contentOnly){var hd=this.el.select('.ext-cal-dtitle').last().parent('tr');h=hd?h-hd.getHeight(true):h;}
return{height:h,width:w};},getEventHeight:function(){if(!this.eventHeight){var evt=this.el.select('.ext-cal-evt').first();if(evt){this.eventHeight=evt.parent('td').getHeight();}
else{return 16;}}
return this.eventHeight;},getMaxEventsPerDay:function(){var dayHeight=this.getDaySize(true).height,eventHeight=this.getEventHeight(),max=Math.max(Math.floor((dayHeight-eventHeight)/eventHeight),0);return max;},getViewPadding:function(sides){sides=sides||'tlbr';var top=sides.indexOf('t')>-1,left=sides.indexOf('l')>-1,right=sides.indexOf('r')>-1,height=this.showHeader&&top?this.el.select('.ext-cal-hd-days-tbl').first().getHeight():0,width=0;if(this.isHeaderView){if(left){width=this.el.select('.ext-cal-gutter').first().getWidth();}
if(right){width+=this.el.select('.ext-cal-gutter-rt').first().getWidth();}}
else if(this.showWeekLinks&&left){width=this.el.select('.ext-cal-week-link').first().getWidth();}
return{height:height,width:width}},getDayAt:function(x,y){var box=this.el.getBox(),daySize=this.getDaySize(),dayL=Math.floor(((x-box.x)/daySize.width)),dayT=Math.floor(((y-box.y)/daySize.height)),days=(dayT*7)+dayL,dt=Ext.calendar.util.Date.add(this.viewStart,{days:days});return{date:dt,el:this.getDayEl(dt)};},moveNext:function(){return this.moveMonths(1);},movePrev:function(){return this.moveMonths(-1);},onInitDrag:function(){this.callParent(arguments);if(this.dayOverClass){Ext.select(this.daySelector).removeCls(this.dayOverClass);}
if(this.detailPanel){this.detailPanel.hide();}},onMoreClick:function(dt){if(!this.detailPanel){this.detailPanel=Ext.create('Ext.Panel',{id:this.id+'-details-panel',title:Ext.Date.format(dt,'F j'),layout:'fit',floating:true,renderTo:Ext.getBody(),tools:[{type:'close',handler:function(e,t,p){p.ownerCt.hide();}}],items:{xtype:'monthdaydetailview',id:this.id+'-details-view',date:dt,view:this,store:this.store,listeners:{'eventsrendered':Ext.bind(this.onDetailViewUpdated,this)}}});}
else{this.detailPanel.setTitle(Ext.Date.format(dt,'F j'));}
this.detailPanel.getComponent(this.id+'-details-view').update(dt);},onDetailViewUpdated:function(view,dt,numEvents){var p=this.detailPanel,dayEl=this.getDayEl(dt),box=dayEl.getBox();p.setWidth(Math.max(box.width,220));p.show();p.getEl().alignTo(dayEl,'t-t?');},onHide:function(){this.callParent(arguments);if(this.detailPanel){this.detailPanel.hide();}},onClick:function(e,t){if(this.detailPanel){this.detailPanel.hide();}
if(Ext.calendar.view.Month.superclass.onClick.apply(this,arguments)){return;}
if(this.dropZone){this.dropZone.clearShims();}
var el=e.getTarget(this.weekLinkSelector,3),dt,parts;if(el){dt=el.id.split(this.weekLinkIdDelimiter)[1];this.fireEvent('weekclick',this,Ext.Date.parseDate(dt,'Ymd'));return;}
el=e.getTarget(this.moreSelector,3);if(el){dt=el.id.split(this.moreElIdDelimiter)[1];this.onMoreClick(Ext.Date.parseDate(dt,'Ymd'));return;}
el=e.getTarget('td',3);if(el){if(el.id&&el.id.indexOf(this.dayElIdDelimiter)>-1){parts=el.id.split(this.dayElIdDelimiter);dt=parts[parts.length-1];this.fireEvent('dayclick',this,Ext.Date.parseDate(dt,'Ymd'),false,Ext.get(this.getDayId(dt)));return;}}},handleDayMouseEvent:function(e,t,type){var el=e.getTarget(this.weekLinkSelector,3,true);if(el&&this.weekLinkOverClass){el[type=='over'?'addCls':'removeCls'](this.weekLinkOverClass);return;}
this.callParent(arguments);}});;Ext.define('Ext.calendar.view.DayHeader',{extend:'Ext.calendar.view.Month',alias:'widget.dayheaderview',requires:['Ext.calendar.template.DayHeader'],weekCount:1,dayCount:1,allDayOnly:true,monitorResize:false,afterRender:function(){if(!this.tpl){this.tpl=new Ext.calendar.template.DayHeader({id:this.id,showTodayText:this.showTodayText,todayText:this.todayText,showTime:this.showTime});}
this.tpl.compile();this.addCls('ext-cal-day-header');this.callParent(arguments);},forceSize:Ext.emptyFn,refresh:function(){this.callParent(arguments);this.recalcHeaderBox();},recalcHeaderBox:function(){var tbl=this.el.down('.ext-cal-evt-tbl'),h=tbl.getHeight();this.el.setHeight(h+7);this.el.down('.ext-cal-hd-ad-inner').setHeight(h+5);this.el.down('.ext-cal-bg-tbl').setHeight(h+5);},moveNext:function(noRefresh){return this.moveDays(this.dayCount,noRefresh);},movePrev:function(noRefresh){return this.moveDays(-this.dayCount,noRefresh);},onClick:function(e,t){var el=e.getTarget('td',3),parts,dt;if(el){if(el.id&&el.id.indexOf(this.dayElIdDelimiter)>-1){parts=el.id.split(this.dayElIdDelimiter);dt=parts[parts.length-1];this.fireEvent('dayclick',this,Ext.Date.parseDate(dt,'Ymd'),true,Ext.get(this.getDayId(dt)));return;}}
this.callParent(arguments);}});;Ext.define('Ext.calendar.view.DayBody',{extend:'Ext.calendar.view.AbstractCalendar',alias:'widget.daybodyview',requires:['Ext.XTemplate','Ext.calendar.template.DayBody','Ext.calendar.data.EventMappings','Ext.calendar.dd.DayDragZone','Ext.calendar.dd.DayDropZone'],dayColumnElIdDelimiter:'-day-col-',initDD:function(){var cfg={createText:this.ddCreateEventText,moveText:this.ddMoveEventText,resizeText:this.ddResizeEventText};this.el.ddScrollConfig={vthresh:Ext.isIE||Ext.isOpera?100:40,hthresh:-1,frequency:50,increment:100,ddGroup:'DayViewDD'};this.dragZone=new Ext.calendar.dd.DayDragZone(this.el,Ext.apply({view:this,containerScroll:true},cfg));this.dropZone=new Ext.calendar.dd.DayDropZone(this.el,Ext.apply({view:this},cfg));},refresh:function(){var top=this.el.getScroll().top;this.prepareData();this.renderTemplate();this.renderItems();if(this.scrollReady){this.scrollTo(top);}},scrollTo:function(y,defer){defer=defer||(Ext.isIE||Ext.isOpera);if(defer){Ext.defer(function(){this.el.scrollTo('top',y,true);this.scrollReady=true;},10,this);}
else{this.el.scrollTo('top',y,true);this.scrollReady=true;}},afterRender:function(){if(!this.tpl){this.tpl=new Ext.calendar.template.DayBody({id:this.id,dayCount:this.dayCount,showTodayText:this.showTodayText,todayText:this.todayText,showTime:this.showTime});}
this.tpl.compile();this.addCls('ext-cal-body-ct');this.callParent(arguments);this.scrollTo(7*42);},forceSize:Ext.emptyFn,onEventResize:function(rec,data){var D=Ext.calendar.util.Date,start=Ext.calendar.data.EventMappings.StartDate.name,end=Ext.calendar.data.EventMappings.EndDate.name;if(D.compare(rec.data[start],data.StartDate)===0&&D.compare(rec.data[end],data.EndDate)===0){return;}
rec.set(start,data.StartDate);rec.set(end,data.EndDate);this.fireEvent('eventresize',this,rec);},getEventBodyMarkup:function(){if(!this.eventBodyMarkup){this.eventBodyMarkup=['{Title}','<tpl if="_isReminder">','<i class="ext-cal-ic ext-cal-ic-rem">&#160;</i>','</tpl>','<tpl if="_isRecurring">','<i class="ext-cal-ic ext-cal-ic-rcr">&#160;</i>','</tpl>'].join('');}
return this.eventBodyMarkup;},getEventTemplate:function(){if(!this.eventTpl){this.eventTpl=!(Ext.isIE||Ext.isOpera)?new Ext.XTemplate('<div id="{_elId}" class="{_selectorCls} {_colorCls} ext-cal-evt ext-cal-evr {cls}" style="left: {_left}%; width: {_width}%; top: {_top}px; height: {_height}px;{style}">','<div class="ext-evt-bd">',this.getEventBodyMarkup(),'</div>','<div class="ext-evt-rsz"><div class="ext-evt-rsz-h">&#160;</div></div>','</div>'):new Ext.XTemplate('<div id="{_elId}" class="ext-cal-evt {_selectorCls} {_colorCls}-x {cls}" style="left: {_left}%; width: {_width}%; top: {_top}px;{style}">','<div class="ext-cal-evb">&#160;</div>','<dl style="height: {_height}px;" class="ext-cal-evdm">','<dd class="ext-evt-bd">',this.getEventBodyMarkup(),'</dd>','<div class="ext-evt-rsz"><div class="ext-evt-rsz-h">&#160;</div></div>','</dl>','<div class="ext-cal-evb">&#160;</div>','</div>');this.eventTpl.compile();}
return this.eventTpl;},getEventAllDayTemplate:function(){if(!this.eventAllDayTpl){var tpl,body=this.getEventBodyMarkup();tpl=!(Ext.isIE||Ext.isOpera)?new Ext.XTemplate('<div id="{_elId}" class="{_selectorCls} {_colorCls} {spanCls} ext-cal-evt ext-cal-evr" style="left: {_left}%; width: {_width}%; top: {_top}px; height: {_height}px;">',body,'</div>'):new Ext.XTemplate('<div id="{_elId}" class="ext-cal-evt" style="left: {_left}%; width: {_width}%; top: {_top}px; height: {_height}px;">','<div class="{_selectorCls} {spanCls} {_colorCls} ext-cal-evo">','<div class="ext-cal-evm">','<div class="ext-cal-evi">',body,'</div>','</div>','</div></div>');tpl.compile();this.eventAllDayTpl=tpl;}
return this.eventAllDayTpl;},getTemplateEventData:function(evt){var selector=this.getEventSelectorCls(evt[Ext.calendar.data.EventMappings.EventId.name]),data={},M=Ext.calendar.data.EventMappings;this.getTemplateEventBox(evt);data._selectorCls=selector;data._colorCls='ext-color-'+(evt[M.CalendarId.name]||'0')+(evt._renderAsAllDay?'-ad':'');data._elId=selector+(evt._weekIndex?'-'+evt._weekIndex:'');data._isRecurring=evt.Recurrence&&evt.Recurrence!='';data._isReminder=evt[M.Reminder.name]&&evt[M.Reminder.name]!='';var title=evt[M.Title.name];data.Title=(evt[M.IsAllDay.name]?'':Ext.Date.format(evt[M.StartDate.name],'g:ia '))+(!title||title.length==0?'(No title)':title);return Ext.applyIf(data,evt);},getTemplateEventBox:function(evt){var heightFactor=0.7,start=evt[Ext.calendar.data.EventMappings.StartDate.name],end=evt[Ext.calendar.data.EventMappings.EndDate.name],startMins=start.getHours()*60+start.getMinutes(),endMins=end.getHours()*60+end.getMinutes(),diffMins=endMins-startMins;evt._left=0;evt._width=100;evt._top=Math.round(startMins*heightFactor);evt._height=Math.max((diffMins*heightFactor),15);},renderItems:function(){var day=0,evts=[],ev,d,ct,item,i,j,l,emptyCells,skipped,evt,evt2,overlapCols,prevCol,colWidth,evtWidth,markup,target;for(;day<this.dayCount;day++){ev=emptyCells=skipped=0;d=this.eventGrid[0][day];ct=d?d.length:0;for(;ev<ct;ev++){evt=d[ev];if(!evt){continue;}
item=evt.data||evt.event.data;if(item._renderAsAllDay){continue;}
Ext.apply(item,{cls:'ext-cal-ev',_positioned:true});evts.push({data:this.getTemplateEventData(item),date:Ext.calendar.util.Date.add(this.viewStart,{days:day})});}}
i=j=overlapCols=prevCol=0;l=evts.length;for(;i<l;i++){evt=evts[i].data;evt2=null;prevCol=overlapCols;for(j=0;j<l;j++){if(i==j){continue;}
evt2=evts[j].data;if(this.isOverlapping(evt,evt2)){evt._overlap=evt._overlap==undefined?1:evt._overlap+1;if(i<j){if(evt._overcol===undefined){evt._overcol=0;}
evt2._overcol=evt._overcol+1;overlapCols=Math.max(overlapCols,evt2._overcol);}}}}
for(i=0;i<l;i++){evt=evts[i].data;if(evt._overlap!==undefined){colWidth=100/(overlapCols+1);evtWidth=100-(colWidth*evt._overlap);evt._width=colWidth;evt._left=colWidth*evt._overcol;}
markup=this.getEventTemplate().apply(evt);target=this.id+'-day-col-'+Ext.Date.format(evts[i].date,'Ymd');Ext.get(target).select('*').destroy();Ext.core.DomHelper.append(target,markup);}
this.fireEvent('eventsrendered',this);},getDayEl:function(dt){return Ext.get(this.getDayId(dt));},getDayId:function(dt){if(Ext.isDate(dt)){dt=Ext.Date.format(dt,'Ymd');}
return this.id+this.dayColumnElIdDelimiter+dt;},getDaySize:function(){var box=this.el.down('.ext-cal-day-col-inner').getBox();return{height:box.height,width:box.width};},getDayAt:function(x,y){var xoffset=this.el.down('.ext-cal-day-times').getWidth(),viewBox=this.el.getBox(),daySize=this.getDaySize(false),relX=x-viewBox.x-xoffset,dayIndex=Math.floor(relX/daySize.width),scroll=this.el.getScroll(),row=this.el.down('.ext-cal-bg-row'),rowH=row.getHeight()/2,relY=y-viewBox.y-rowH+scroll.top,rowIndex=Math.max(0,Math.ceil(relY/rowH)),mins=rowIndex*30,dt=Ext.calendar.util.Date.add(this.viewStart,{days:dayIndex,minutes:mins}),el=this.getDayEl(dt),timeX=x;if(el){timeX=el.getX();}
return{date:dt,el:el,timeBox:{x:timeX,y:(rowIndex*21)+viewBox.y-scroll.top,width:daySize.width,height:rowH}};},onClick:function(e,t){if(this.dragPending||Ext.calendar.view.DayBody.superclass.onClick.apply(this,arguments)){return;}
if(e.getTarget('.ext-cal-day-times',3)!==null){return;}
var el=e.getTarget('td',3);if(el){if(el.id&&el.id.indexOf(this.dayElIdDelimiter)>-1){var dt=this.getDateFromId(el.id,this.dayElIdDelimiter);this.fireEvent('dayclick',this,Ext.Date.parseDate(dt,'Ymd'),true,Ext.get(this.getDayId(dt,true)));return;}}
var day=this.getDayAt(e.getX(),e.getY());if(day&&day.date){this.fireEvent('dayclick',this,day.date,false,null);}}});;Ext.define('Ext.calendar.view.Day',{extend:'Ext.container.Container',alias:'widget.dayview',requires:['Ext.calendar.view.AbstractCalendar','Ext.calendar.view.DayHeader','Ext.calendar.view.DayBody'],showTime:true,showTodayText:true,todayText:'Today',ddCreateEventText:'Create event for {0}',ddMoveEventText:'Move event to {0}',dayCount:1,initComponent:function(){this.dayCount=this.dayCount>7?7:this.dayCount;var cfg=Ext.apply({},this.initialConfig);cfg.showTime=this.showTime;cfg.showTodatText=this.showTodayText;cfg.todayText=this.todayText;cfg.dayCount=this.dayCount;cfg.wekkCount=1;var header=Ext.applyIf({xtype:'dayheaderview',id:this.id+'-hd'},cfg);var body=Ext.applyIf({xtype:'daybodyview',id:this.id+'-bd'},cfg);this.items=[header,body];this.addCls('ext-cal-dayview ext-cal-ct');this.callParent(arguments);},afterRender:function(){this.callParent(arguments);this.header=Ext.getCmp(this.id+'-hd');this.body=Ext.getCmp(this.id+'-bd');this.body.on('eventsrendered',this.forceSize,this);},refresh:function(){this.header.refresh();this.body.refresh();},forceSize:function(){Ext.defer(function(){var ct=this.el.up('.x-panel-body'),hd=this.el.down('.ext-cal-day-header'),h=ct.getHeight()-hd.getHeight();this.el.down('.ext-cal-body-ct').setHeight(h);},10,this);},onResize:function(){this.callParent(arguments);this.forceSize();},getViewBounds:function(){return this.header.getViewBounds();},getStartDate:function(){return this.header.getStartDate();},setStartDate:function(dt){this.header.setStartDate(dt,true);this.body.setStartDate(dt,true);},renderItems:function(){this.header.renderItems();this.body.renderItems();},isToday:function(){return this.header.isToday();},moveTo:function(dt,noRefresh){this.header.moveTo(dt,noRefresh);return this.body.moveTo(dt,noRefresh);},moveNext:function(noRefresh){this.header.moveNext(noRefresh);return this.body.moveNext(noRefresh);},movePrev:function(noRefresh){this.header.movePrev(noRefresh);return this.body.movePrev(noRefresh);},moveDays:function(value,noRefresh){this.header.moveDays(value,noRefresh);return this.body.moveDays(value,noRefresh);},moveToday:function(noRefresh){this.header.moveToday(noRefresh);return this.body.moveToday(noRefresh);}});;Ext.define('Ext.calendar.view.Week',{extend:'Ext.calendar.view.Day',alias:'widget.weekview',dayCount:7});;Ext.define('Ext.calendar.CalendarPanel',{extend:'Ext.panel.Panel',alias:'widget.calendarpanel',requires:['Ext.layout.container.Card','Ext.calendar.view.Day','Ext.calendar.view.Week','Ext.calendar.view.Month','Ext.calendar.form.EventDetails','Ext.calendar.data.EventMappings'],showDayView:true,showWeekView:true,showMonthView:true,showNavBar:true,todayText:'Today',showTodayText:true,showTime:true,dayText:'Day',weekText:'Week',monthText:'Month',layout:'card',startDate:new Date(),initComponent:function(){this.tbar={cls:'ext-cal-toolbar',border:true,items:['->',{id:this.id+'-tb-prev',handler:this.onPrevClick,scope:this,iconCls:'x-tbar-page-prev'}]};this.viewCount=0;if(this.showDayView){this.tbar.items.push({id:this.id+'-tb-day',text:this.dayText,handler:this.onDayClick,scope:this,toggleGroup:'tb-views'});this.viewCount++;}
if(this.showWeekView){this.tbar.items.push({id:this.id+'-tb-week',text:this.weekText,handler:this.onWeekClick,scope:this,toggleGroup:'tb-views'});this.viewCount++;}
if(this.showMonthView||this.viewCount==0){this.tbar.items.push({id:this.id+'-tb-month',text:this.monthText,handler:this.onMonthClick,scope:this,toggleGroup:'tb-views'});this.viewCount++;this.showMonthView=true;}
this.tbar.items.push({id:this.id+'-tb-next',handler:this.onNextClick,scope:this,iconCls:'x-tbar-page-next'});this.tbar.items.push('->');var idx=this.viewCount-1;this.activeItem=this.activeItem===undefined?idx:(this.activeItem>idx?idx:this.activeItem);if(this.showNavBar===false){delete this.tbar;this.addCls('x-calendar-nonav');}
this.callParent();if(this.showDayView){var day=Ext.apply({xtype:'dayview',title:this.dayText,showToday:this.showToday,showTodayText:this.showTodayText,showTime:this.showTime},this.dayViewCfg);day.id=this.id+'-day';day.store=day.store||this.eventStore;this.initEventRelay(day);this.add(day);}
if(this.showWeekView){var wk=Ext.applyIf({xtype:'weekview',title:this.weekText,showToday:this.showToday,showTodayText:this.showTodayText,showTime:this.showTime},this.weekViewCfg);wk.id=this.id+'-week';wk.store=wk.store||this.eventStore;this.initEventRelay(wk);this.add(wk);}
if(this.showMonthView){var month=Ext.applyIf({xtype:'monthview',title:this.monthText,showToday:this.showToday,showTodayText:this.showTodayText,showTime:this.showTime,listeners:{'weekclick':{fn:function(vw,dt){this.showWeek(dt);},scope:this}}},this.monthViewCfg);month.id=this.id+'-month';month.store=month.store||this.eventStore;this.initEventRelay(month);this.add(month);}
this.add(Ext.applyIf({xtype:'eventeditform',id:this.id+'-edit',calendarStore:this.calendarStore,listeners:{'eventadd':{scope:this,fn:this.onEventAdd},'eventupdate':{scope:this,fn:this.onEventUpdate},'eventdelete':{scope:this,fn:this.onEventDelete},'eventcancel':{scope:this,fn:this.onEventCancel}}},this.editViewCfg));},initEventRelay:function(cfg){cfg.listeners=cfg.listeners||{};cfg.listeners.afterrender={fn:function(c){this.relayEvents(c,['eventsrendered','eventclick','eventover','eventout','dayclick','eventmove','datechange','rangeselect','eventdelete','eventresize','initdrag']);},scope:this,single:true};},afterRender:function(){this.callParent(arguments);this.body.addCls('x-cal-body');Ext.defer(function(){this.updateNavState();this.fireViewChange();},10,this);},onLayout:function(){this.callParent();if(!this.navInitComplete){this.updateNavState();this.navInitComplete=true;}},onEventAdd:function(form,rec){rec.data[Ext.calendar.data.EventMappings.IsNew.name]=false;this.hideEditForm();this.eventStore.add(rec);this.eventStore.sync();this.fireEvent('eventadd',this,rec);},onEventUpdate:function(form,rec){this.hideEditForm();rec.commit();this.eventStore.sync();this.fireEvent('eventupdate',this,rec);},onEventDelete:function(form,rec){this.hideEditForm();this.eventStore.remove(rec);this.eventStore.sync();this.fireEvent('eventdelete',this,rec);},onEventCancel:function(form,rec){this.hideEditForm();this.fireEvent('eventcancel',this,rec);},showEditForm:function(rec){this.preEditView=this.layout.getActiveItem().id;this.setActiveView(this.id+'-edit');this.layout.getActiveItem().loadRecord(rec);return this;},hideEditForm:function(){if(this.preEditView){this.setActiveView(this.preEditView);delete this.preEditView;}
return this;},setActiveView:function(id){var l=this.layout,tb=this.getDockedItems('toolbar')[0];if(tb){tb[id===this.id+'-edit'?'hide':'show']();}
Ext.suspendLayouts();l.setActiveItem(id);this.activeView=l.getActiveItem();if(id!==this.id+'-edit'){if(id!==this.preEditView){l.activeItem.setStartDate(this.startDate,true);}
this.updateNavState();}
Ext.resumeLayouts(true);this.fireViewChange();},fireViewChange:function(){if(this.layout&&this.layout.getActiveItem){var view=this.layout.getActiveItem();if(view&&view.getViewBounds){var vb=view.getViewBounds();var info={activeDate:view.getStartDate(),viewStart:vb.start,viewEnd:vb.end};}
this.fireEvent('viewchange',this,view,info);}},updateNavState:function(){if(this.showNavBar!==false){var item=this.layout.activeItem,suffix=item.id.split(this.id+'-')[1],btn=Ext.getCmp(this.id+'-tb-'+suffix);if(btn){btn.toggle(true);}}},setStartDate:function(dt){this.layout.activeItem.setStartDate(dt,true);this.updateNavState();this.fireViewChange();},showWeek:function(dt){this.setActiveView(this.id+'-week');this.setStartDate(dt);},onPrevClick:function(){this.startDate=this.layout.activeItem.movePrev();this.updateNavState();this.fireViewChange();},onNextClick:function(){this.startDate=this.layout.activeItem.moveNext();this.updateNavState();this.fireViewChange();},onDayClick:function(){this.setActiveView(this.id+'-day');},onWeekClick:function(){this.setActiveView(this.id+'-week');},onMonthClick:function(){this.setActiveView(this.id+'-month');},getActiveView:function(){return this.layout.activeItem;}});;Ext.namespace('CB');Ext.define('CB.Login',{extend:'Ext.Window',title:L.Authorization,plain:true,closable:false,iconCls:'icon-key',id:'CBLoginWindow',modal:true,frame:true,autoHeight:true,width:315,closeAction:'close',border:false,resizable:false,buttonAlign:'center',initComponent:function(){Ext.apply(this,{items:[{xtype:'form',border:false,layout:'table',layoutConfig:{columns:2,padding:0},autoHeight:true,monitorValid:true,items:[{html:'<img id="logo" style="padding-top: -15px" src="css/i/CaseBox-Logo_briefcase.png"/>',cls:'taC',border:false,width:130},{xtype:'fieldset',border:false,defaults:{width:150},padding:0,defaultType:'textfield',labelAlign:'top',bodyStyle:'padding: 10px 5px 0 5px',items:[{name:'username',fieldLabel:L.User},{name:'password',fieldLabel:L.Password,inputType:'password'}]},{border:false,colspan:2,cls:'taC fwB cR',html:'&nbsp;',name:'infoPanel',xtype:'panel'}],buttons:[{text:L.Login,handler:this.doLogin,scope:this,formBind:true}]}],keys:[{key:13,fn:this.doLogin,scope:this}]});this.on('afterrender',this.doShow);this.callParent(arguments);},doShow:function(w){var lku=Ext.util.Cookies.get('lastUser');var user=w.down('[name="username"]');var pass=w.down('[name="password"]');user.setValue(lku);pass.reset();if(Ext.isEmpty(lku)){user.focus(true,550);}else{pass.focus(true,550);}},doLogin:function(){var user=this.child('[name="username"]'),pass=this.child('[name="password"]');if(!user.isValid()||!pass.isValid()){return false;}
CB_User.login(user.getValue(),pass.getValue(),this.processLoginResponse);},processLoginResponse:function(response,e){var lw=Ext.getCmp('CBLoginWindow'),r=e.result;if(r&&(r.success===true)){if(App.loginData&&(App.loginData.id!=response.user.id)){return window.location.reload();}
App.config=response.config;App.loginData=response.user;lw.close();}else{ip=lw.child('[name="infoPanel"]');ip.body.update(response.msg);}}});Ext.define('CB.VerifyPassword',{extend:'Ext.Window',title:L.Verify,plain:true,iconCls:'icon-key',modal:true,frame:true,autoHeight:true,width:320,closeAction:'close',border:false,resizable:false,buttonAlign:'center',initComponent:function(){Ext.apply(this,{items:[{xtype:'form',border:false,autoHeight:true,monitorValid:true,items:[{xtype:'fieldset',border:false,defaults:{anchor:'100%'},layout:'anchor',defaultType:'textfield',labelAlign:'left',bodyStyle:'padding: 10px 5px 0 5px',items:[{name:'username',fieldLabel:L.User,xtype:'displayfield',value:getUserDisplayName()},{name:'password',fieldLabel:L.Password,inputType:'password',enableKeyEvents:true,keys:[{key:13,fn:this.doVerify,scope:this}],listeners:{afterrender:function(){this.focus();}}}]},{border:false,bodyCls:'taC fwB cR',html:'&nbsp;',name:'infoPanel',xtype:'panel',hidden:true,bodyStyle:'padding:5px'}],buttons:[{text:L.Verify,handler:this.doVerify,scope:this,formBind:true}]}],listeners:{scope:this,afterrender:function(){var nav=Ext.create('Ext.util.KeyNav',this.getEl(),{scope:this,enter:this.doVerify});}}});this.on('show',this.doShow,this);this.callParent(arguments);},doShow:function(w){var pass=this.down('[name="password"]');pass.reset();},doVerify:function(){var pass=this.down('[name="password"]');if(!pass.isValid()){return false;}
CB_User.verifyPassword(pass.getValue(),this.processVerifyResponse,this);},processVerifyResponse:function(response,e){var r=e.result,ip,pass;if(r&&(r.success===true)){this.success=true;this.close();}else{ip=this.down('[name="infoPanel"]');ip.show();ip.body.update(response.msg);pass=this.down('[name="password"]');pass.reset();pass.focus(true,550);}}});;Ext.namespace('CB');Ext.define('CB.GenericForm',{extend:'Ext.FormPanel',scrollable:false,closable:true,border:false,bodyStyle:'padding: 10px',title:'Generic window',monitorValid:true,data:{},initComponent:function(){this.callParent(arguments);this.enableBubble('savesuccess');this.on('beforeclose',this.onBeforeClose,this);this.on('afterrender',this.loadData,this);this.on('change',this.setDirty,this);},setDirty:function(isDirty){this._isDirty=(isDirty!==false);},_lockEdit:function(){if(this.lockEdit){return this.lockEdit();}},_unlockEdit:function(){if(this.unlockEdit){return this.unlockEdit();}
this.doClose();},onBeforeClose:function(){if(this._confirmedClosing||!this._isDirty){this.getEl().mask(L.Closing+' ...','x-mask-loading');if(!Ext.isNumber(this.data.id)){this.doClose();}else{this._unlockEdit();}
return false;}
Ext.Msg.show({title:L.Confirmation,msg:L.SavingChangedDataMessage,icon:Ext.Msg.QUESTION,buttons:Ext.Msg.YESNOCANCEL,scope:this,fn:function(b,text,opt){switch(b){case'yes':this._confirmedClosing=true;this.saveForm();break;case'no':this._confirmedClosing=true;this._unlockEdit();break;}}});return false;},doClose:function(){Ext.destroy(this);},loadData:function(){if(isNaN(this.data.id)){this.data.id=Ext.isEmpty(this.data.id)?Ext.id():this.data.id;this._setFormValues();this.setDirty(true);this.getEl().unmask();return;}
this.getForm().load({params:{id:this.data.id},scope:this,success:this.processLoadResponse,failure:this.processLoadResponse.bind(this)});},getTitle:function(){var rez='<'+L.noName+'>';if(!Ext.isEmpty(this.data.name)){rez=this.data.name;}else if(!isNaN(this.data.id)){rez='<'+L.noName+'> (id: '+this.data.id+')';}
return Ext.util.Format.htmlEncode(rez);},updateFormTitle:function(){var t='';if(this.data&&!Ext.isEmpty(this.data.date_start)){t=Ext.Date.format(Date.parse(this.data.date_start.substr(0,10),'Y-m-d'),App.dateFormat)+'. ';}
t+=this.data.new_title?Ext.util.Format.htmlEncode(this.data.new_title):this.getTitle();this.setTitle(App.shortenString(t,35));var i=Ext.valueFrom(this.data.iconCls,Ext.valueFrom(this.iconCls,''));if(i==='icon-loading'){i='';}
if(Ext.isEmpty(i)&&this.getIconClass){i=this.getIconClass();}
this.setIconCls(i);},getIconClass:Ext.emptyFn,processLoadResponse:function(f,e){this.getEl().unmask();var r=e.result;if(!r||(r.success!==true)){if(App.hideFailureAlerts){this.doClose();return;}
Ext.Msg.confirm(L.Error,Ext.valueFrom(e.msg,L.readDataErrorMessage),function(b){if(b==='yes'){this.loadData();}else{this.doClose();}},this);return;}
if(!Ext.isDefined(r.data)){return;}
this.data=r.data;if(this.onFormLoaded){this.onFormLoaded(f,e);}
if(Ext.isDefined(this.data.already_opened_by)){Ext.Msg.show({title:L.ActionOpeningConfirmation,msg:this.data.already_opened_by,buttons:Ext.Msg.YESNO,fn:function(b){if(b==='yes'){this.enable();this._setFormValues();this._lockEdit();}else{this._unlockEdit();}},scope:this,animEl:this.getEl(),icon:Ext.MessageBox.QUESTION});return;}
this._setFormValues();},_setFormValues:function(){this.updateFormTitle();if(this.setFormValues){this.setFormValues();}
this.setDirty(false);},_getFormValues:function(){if(this.getFormValues){this.getFormValues();}},saveForm:function(){if(!this.getForm().isValid()){return;}
this.getEl().mask(L.SavingChanges+' ...','x-mask-loading');this._getFormValues();this.getForm().submit({clientValidation:true,params:{data:Ext.encode(this.data),close:this._confirmedClosing,forcedSave:this._forcedSave},scope:this,success:this.onSaveSuccess,failure:this.onSaveFailure});},onSaveSuccess:function(f,a){if(Ext.isDefined(a.result.data)){this.data=a.result.data;}
if(this.onFormLoaded){this.onFormLoaded(f,a);}
if(Ext.isDefined(a.result.title)){this.title=a.result.title;}
this._setFormValues();this.fireEvent('savesuccess',this,a);if(this._confirmedClosing){return this.doClose();}
this.getEl().unmask();},onSaveFailure:function(form,action){this.getEl().unmask();if(Ext.isDefined(action.result.already_opened_by)){Ext.Msg.show({title:L.SavingDataConfirmation,msg:action.result.already_opened_by,buttons:Ext.Msg.YESNO,fn:function(b){if(b==='yes'){this._forcedSave=1;this.saveForm();}else{this.getEl().unmask();this._confirmedClosing=0;}},scope:this,animEl:this.getEl(),icon:Ext.MessageBox.QUESTION});}else{this.fireEvent('savefail',this,action);App.formSubmitFailure(form,action);}}});;CB.ObjectsFieldCommonFunctions={detectStore:function(){var source=Ext.isEmpty(this.cfg.source)?'tree':this.cfg.source;switch(source){case'thesauri':this.store=this.getThesauriStore();break;case'users':case'groups':case'usersgroups':this.store=CB.DB.usersGroupsSearchStore;break;default:this.objectsStore=this.getObjectsStore();this.store=new Ext.data.DirectStore({autoLoad:false,autoDestroy:true,restful:false,remoteSort:true,model:'FieldObjects',pageSize:Ext.valueFrom(this.cfg.rows,50),proxy:{type:'direct',paramsAsHash:true,api:{read:CB_Browser.getObjectsForField},reader:{type:'json',successProperty:'success',rootProperty:'data',messageProperty:'msg'},listeners:{load:function(proxy,obj,opt){for(var i=0;i<obj.result.data.length;i++){obj.result.data[i].date=date_ISO_to_local_date(obj.result.data[i].date);}}}},sortInfo:{field:'name',direction:'ASC'},listeners:{scope:this,beforeload:function(store,o){if(this.data){if(!Ext.isEmpty(this.data.fieldRecord)){store.proxy.extraParams.fieldId=this.data.fieldRecord.get('id');}
Ext.copyTo(store.proxy.extraParams,this.data,['objectId','pidValue','path','objFields','duplicationIndexes']);}},load:function(store,recs,options){Ext.each(recs,function(r){r.set('iconCls',getItemIcon(r.data));},this);}}});}
if(Ext.isEmpty(this.store)){this.store=new Ext.data.ArrayStore({idIndex:0,model:'Generic',data:[]});}
if(Ext.isEmpty(this.store.getTexts)){this.store.getTexts=getStoreNames;}
if(this.cfg.sort){var field='order',dir='asc';switch(this.cfg.sort){case'asc':field='name';break;case'desc':field='name';dir='desc';break;}
this.store.sort(field,dir);}},getObjectsStore:function(){if(this.cfg.source==='thesauri'){return this.getThesauriStore();}
if(Ext.isEmpty(this.data)){return;}
if(this.data.ownerCt){return this.data.ownerCt.objectsStore;}
if(this.data.grid){var a=this.data.grid.refOwner||this.data.grid.findParentByType(CB.Objects);if(!Ext.isEmpty(a)){return a.objectsStore;}}},getThesauriStore:function(){var thesauriId=this.cfg.thesauriId;if(this.cfg.thesauriId==='dependent'){fieldName=this.data.record.store.fields.findIndex('name','field_id');fieldName=(fieldName<0)?'id':'field_id';var pri=this.data.record.store.findBy(function(r){return((r.get(fieldName)==this.data.record.get('pid'))&&(r.get('duplicate_id')==this.data.record.get('duplicate_id')));},this);if(pri>-1){thesauriId=this.data.pidValue;}}
if(!isNaN(thesauriId)){return getThesauriStore(thesauriId);}}};Ext.define('CB.ObjectsComboField',{extend:'Ext.form.ComboBox',forceSelection:true,triggerAction:'all',lazyRender:true,queryMode:'remote',editable:true,displayField:'name',valueField:'id',minChars:3,constructor:function(config){this.data=Ext.valueFrom(config.data,{});this.cfg=this.data.fieldRecord?Ext.apply({},Ext.valueFrom(this.data.fieldRecord.data.cfg,{})):Ext.valueFrom(this.config.config,{});this.store=[];Ext.apply(this,CB.ObjectsFieldCommonFunctions);Ext.copyTo(this,this.cfg,'editable');this.detectStore();switch(this.cfg.renderer){case'listObjIcons':this.tpl=Ext.create('Ext.XTemplate','<tpl for=".">','<div class="x-boundlist-item icon-padding {iconCls} bgpLT">{name}</div>','</tpl>');break;case'listGreenIcons':this.tpl=Ext.create('Ext.XTemplate','<tpl for=".">','<div class="x-boundlist-item icon-padding {[ values.id ? \'icon-element\': \'\' ]}">{name}</div>','</tpl>');break;}
this.callParent(arguments);},initComponent:function(){var mode='local';if(this.store.proxy){mode='remote';this.store.proxy.extraParams=Ext.clone(this.cfg);if(!Ext.isEmpty(this.data.objectId)){this.store.proxy.extraParams.objectId=this.data.objectId;}
if(!Ext.isEmpty(this.data.pidValue)){this.store.proxy.extraParams.pidValue=this.data.pidValue;}
if(!Ext.isEmpty(this.data.path)){this.store.proxy.extraParams.path=this.data.path;}
this.store.on('beforeload',this.onBeforeLoadStore,this);this.store.on('load',this.onStoreLoad,this);this.store.load();}
var customIcon=(this.cfg.renderer==='listGreenIcons')?'icon-element':'';var plugins=[];Ext.apply(this,{mode:mode,store:this.store,iconClsField:'iconCls',customIcon:customIcon,listeners:{scope:this,beforeselect:function(combo,record,index){if(Ext.isEmpty(this.objectsStore)){return;}
this.objectsStore.checkRecordExistance(record.data);},select:this.onValueSelect,beforedestroy:function(){this.store.un('beforeload',this.onBeforeLoadStore,this);this.store.un('load',this.onStoreLoad,this);}}});this.callParent(arguments);},onBeforeLoadStore:function(st,options){options.params=Ext.apply({},this.cfg,options.params);},onValueSelect:function(combo,record,eOpts){combo.setCaretPosition(0);},setValue:function(v){var value,values=Ext.Array.from(v);if(v==this.nullRecord){this.callParent([null]);return;}
v=[];for(var i=0;i<values.length;i++){if(!Ext.isEmpty(values[i])){value=(values[i]&&values[i].isModel)?values[i].get(this.valueField):values[i];v.push(value);}}
this.callParent([v]);var text=this.store.getTexts(v),r=this.findRecordByValue(v);if(r){this.objectsStore.checkRecordExistance(r.data);}
if(Ext.isEmpty(text)&&this.objectsStore){r=this.objectsStore.findRecord('id',v,0,false,false,true);if(r){if(this.icon){this.icon.className='ux-icon-combo-icon '+r.get('iconCls');}
text=this.objectsStore.getTexts(v);}}
this.setRawValue(text);},onStoreLoad:function(store,recs,options){Ext.each(recs,function(r){r.set('iconCls',getItemIcon(r.data));},this);this.nullRecord=Ext.create(store.getModel().getName(),{id:0,name:''});store.insert(0,this.nullRecord);if(Ext.isEmpty(this.lastQuery)&&!Ext.isEmpty(this.value)){this.setValue(this.value);}},updateStore:function(){var oldStore=this.store;this.detectStore();this.bindStore(this.store);if(oldStore&&oldStore.autoDestroy){oldStore.destroy();}}});Ext.define('CB.ObjectsTriggerField',{extend:'Ext.Panel',bodyStyle:'border: 1px solid #b5b8c8',cls:'x-form-field',isFormField:true,delimiter:'<br />',initComponent:function(){if(Ext.isEmpty(this.config)){this.config={};}
this.cfg=this.data.fieldRecord?Ext.apply({},Ext.valueFrom(this.data.fieldRecord.data.cfg,{})):Ext.valueFrom(this.config.config,{});this.triggerIconCls='icon-element';var tpl='<tpl for=".">{[ (xindex == 0) ? "" : "'+this.delimiter+'"]}{name}</tpl>';switch(this.cfg.renderer){case'listGreenIcons':tpl='<ul><tpl for="."><li class="icon-padding16 icon-element">{name}</li></tpl></ul>';this.triggerIconCls='icon-element';break;case'listObjIcons':tpl='<ul><tpl for="."><li class="icon-padding16 {iconCls}">{name}</li></tpl></ul>';this.triggerIconCls='icon-arrow-split-090';break;}
Ext.apply(this,CB.ObjectsFieldCommonFunctions);this.trigger=new Ext.Button({iconCls:this.triggerIconCls,cls:'fr ',style:'margin:-1px -2px ',scope:this,handler:this.onTriggerClick});this.dataView=new Ext.DataView({emptyText:L.empty,overItemCls:'field-over',itemSelector:'li',style:'margin: 3px; white-space: normal',tpl:tpl,data:[]});Ext.apply(this,{items:[this.trigger,this.dataView],listeners:{scope:this,afterrender:this.afterrender}});this.callParent(arguments);},afterrender:function(){this.setValue(this.value);},setValue:function(v){this.value=[];var store=this.getObjectsStore(),data=[],i;if(!Ext.isEmpty(v)){if(!Ext.isArray(v)){v=String(v).split(',');}
for(i=0;i<v.length;i++){this.value.push(v[i]);}}
if(store){for(i=0;i<this.value.length;i++){var r=store.findRecord('id',this.value[i],0,false,false,true);if(r){data.push(r.data);}}}
if(this.dataView.rendered){this.dataView.update(data);}else{this.dataView.data=data;}},getValue:function(){return this.value.join(',');},onTriggerClick:function(e){if(this.cfg.source==='thesauri'){this.form=new CB.ObjectsSelectionPopupList({data:this.data,value:this.getValue(),listeners:{scope:this,setvalue:this.onSetValue}});}else{this.form=new CB.ObjectsSelectionForm({data:this.data,value:this.getValue(),listeners:{scope:this,setvalue:this.onSetValue}});}
this.form.show();},onSetValue:function(data){if(!Ext.isString(data)){var selectedValue=[];Ext.each(data,function(i){selectedValue.push(i.id);},this);data=selectedValue.join(',');}
var oldValue=this.getValue();if(data==oldValue){return;}
this.setValue(data);this.fireEvent('change',data,oldValue);}});Ext.define('CB.ObjectsSelectionForm',{extend:'Ext.Window',height:400,width:500,modal:true,layout:'border',title:L.Associate,constructor:function(config){this.data=config.data;this.cfg=this.data.fieldRecord?Ext.apply({},Ext.valueFrom(this.data.fieldRecord.data.cfg,{})):Ext.applyIf(Ext.valueFrom(config.config,{}),{multiValued:false});this.callParent(arguments);},initComponent:function(){Ext.apply(this,CB.ObjectsFieldCommonFunctions);this.detectStore();if(this.data.fieldRecord){this.title=Ext.valueFrom(this.data.fieldRecord.get('title'),this.title);}
var sm=new Ext.selection.CheckboxModel({injectCheckbox:'first',checkOnly:true,toggleOnClick:true,mode:(this.cfg.multiValued?'SIMPLE':'SINGLE'),listeners:{scope:this,select:this.onRowSelect,deselect:this.onRowDeselect}});var columns=[{dataIndex:'name',header:L.Name,width:300,scope:this,renderer:function(v,m,r,ri,ci,s){var selected=!Ext.isEmpty(this.resultPanel.config.store.findRecord('id',r.get('id'),0,false,false,true));switch(this.cfg.renderer){case'listGreenIcons':m.css='icon-grid-column '+((!selected)?'icon-element-off':'icon-element');break;case'listObjIcons':m.css='icon-grid-column '+r.get('iconCls');break;}
return v;}}];if(!Ext.isEmpty(this.cfg.fields)){if(!Ext.isArray(this.cfg.fields)){this.cfg.fields=this.cfg.fields.split(',');}
for(var i=0;i<this.cfg.fields.length;i++){var fieldName=this.cfg.fields[i].trim();switch(fieldName){case'name':break;case'date':columns.push({header:L.Date,width:120,dataIndex:'date',format:App.dateFormat+' '+App.timeFormat,renderer:App.customRenderers.datetime});this.width+=120;break;case'path':columns.push({header:L.Path,width:150,dataIndex:'path',renderer:App.customRenderers.titleAttribute});this.width+=150;break;case'project':columns.push({header:L.Project,width:150,dataIndex:'case',renderer:App.customRenderers.titleAttribute});break;case'size':columns.push({header:L.Size,width:80,dataIndex:'size',renderer:App.customRenderers.filesize});this.width+=80;break;case'cid':columns.push({header:L.Creator,width:200,dataIndex:'cid',renderer:App.customRenderers.userName});this.width+=200;break;case'oid':columns.push({header:L.Owner,width:200,dataIndex:'oid',renderer:App.customRenderers.userName});this.width+=200;break;case'cdate':columns.push({header:L.CreatedDate,width:120,dataIndex:'cdate',xtype:'datecolumn',format:App.dateFormat+' '+App.timeFormat});this.width+=120;break;case'udate':columns.push({header:L.UpdatedDate,width:120,dataIndex:'udate',xtype:'datecolumn',format:App.dateFormat+' '+App.timeFormat});this.width+=120;break;}}}
this.width=Math.min(this.width,1024);if(this.cfg.showDate===true){columns.push({dataIndex:'date',width:50,renderer:App.customRenderers.datetime});}
this.grid=new Ext.grid.GridPanel({region:'center',border:false,store:this.store,scrollable:true,columns:columns,viewConfig:{markDirty:false,stripeRows:false},selModel:sm,listeners:{scope:this,rowclick:this.onRowClick,rowdblclick:this.onRowDblClick},bbar:new Ext.PagingToolbar({store:this.store,displayInfo:true,hidden:true})});this.resultPanel=new Ext.DataView({region:'south',border:false,cls:'bgcW btg p10',autoHeight:true,hidden:!this.cfg.multiValued,tpl:new Ext.XTemplate('<span class="fwB">'+L.Value+':</span><ul class="clean"><tpl for=".">','<li class="lh20 icon-padding16 '+((this.cfg.renderer==='listGreenIcons')?'icon-element':'{iconCls}')+'"> &nbsp; {name} <span style="display: inline-block; width: 14px"><span class="buttons"><a href="#" class="icon-close-light" style="display:inline-block; width: 20px;text-decoration: none" title="'+L.Remove+'">&nbsp; &nbsp;</a></span></span></li>','</tpl></ul>',{compiled:true}),store:new Ext.data.JsonStore({model:'Generic',proxy:{type:'memory',reader:{type:'json'}}}),itemSelector:'li',overItemCls:'item-over',listeners:{scope:this,itemclick:this.onRemoveItemClick}});Ext.apply(this,{defaults:{border:false},border:false,buttonAlign:'left',items:[{xtype:'panel',region:'center',layout:'border',items:[{xtype:'panel',region:'north',height:22,layout:'hbox',border:false,items:[{xtype:'textfield',anchor:'100%',flex:1,emptyText:L.Search,triggerClass:'x-form-search-trigger',enableKeyEvents:true,scope:this,onTriggerClick:function(){this.scope.onGridReloadTask();},listeners:{scope:this,specialkey:function(ed,ev){if(ev.getKey()==ev.ENTER){this.onGridReloadTask();}}}}]},this.grid,this.resultPanel]}],listeners:{scope:this,show:function(){this.store.removeAll();if((!Ext.isDefined(this.cfg.autoLoad))||(this.cfg.autoLoad===true)){this.onGridReloadTask();}
this.triggerField.focus(false,400);},facetchange:function(o,ev){ev.stopPropagation();this.onGridReloadTask();},beforedestroy:function(){if(this.qt)this.qt.destroy();}},buttons:['->',{text:Ext.MessageBox.buttonText.ok,iconCls:'icon-tick',scope:this,handler:this.onOkClick},{text:L.Cancel,iconCls:'icon-cancel',scope:this,handler:this.destroy}]});this.callParent(arguments);this.store.on('load',this.onLoad,this);this.triggerField=this.query('textfield')[0];},onGridReloadTask:function(){if(!this.gridReloadTask){this.gridReloadTask=new Ext.util.DelayedTask(this.processGridReload,this);}
this.gridReloadTask.delay(500);},processGridReload:function(){this.store.proxy.extraParams=this.getSearchParams();this.store.reload(this.store.extraParams);},onBeforeLoad:function(store,records,options){},getSearchParams:function(){var result=Ext.clone(this.cfg);result.query=this.triggerField.getValue();if(!Ext.isEmpty(this.data.objectId)){result.objectId=this.data.objectId;}
if(!Ext.isEmpty(this.data.path)){result.path=this.data.path;}
return result;},onLoad:function(store,records,options){var el=this.getEl();if(Ext.isEmpty(records)){this.grid.getEl().mask(L.noData);}else{el=this.grid.getEl();if(el){this.grid.getEl().unmask();}
var currentValue=this.getValue();var selectedRecords=[];this.selectValueOnLoad=true;currentValue=currentValue.split(',');Ext.each(records,function(r){r.set('iconCls',getItemIcon(r.data));if(currentValue.indexOf(r.get('id')+'')>=0){selectedRecords.push(r);}},this);if(!Ext.isEmpty(selectedRecords)){this.grid.getSelectionModel().select(selectedRecords);}
this.selectValueOnLoad=false;}},onSelectionChange:function(sm,selection){},onRowClick:function(g,record,tr,ri,e,eOpts){var el=Ext.get(e.getTarget());if(!el||!el.hasCls('open-object')){return;}
var r=g.getStore().getAt(ri);if(!this.qt){this.qt=new Ext.QuickTip({autoHeight:true,autoWidth:true,autoHide:true,dismissDelay:0,closable:true,draggable:true,target:this,cls:'fs11',iconCls:r.get('iconCls'),headerCfg:{cls:'icon-padding',style:'height:20px'},title:r.get('name'),html:'<span class="icon-padding icon-loading">'+L.LoadingData+'</span>'});}else{this.qt.hide();this.qt.setTitle(r.get('name'),r.get('iconCls'));if(this.qt.contact_id!=r.get('id')){this.qt.update('<span class="icon-padding icon-loading">'+L.LoadingData+'</span>');}}
this.qt.showAt(e.getXY());},onRowDblClick:function(g,record,tr,ri,e,eOpts){var sm=this.grid.getSelectionModel();if(sm.isSelected(record)){sm.deselect(record);}else{sm.select(ri,this.cfg.multiValued);}},onRowSelect:function(sm,record,index,eOpts){if(!this.selectValueOnLoad){this.resultPanel.config.store.loadData([record.data],true);}},onRowDeselect:function(sm,record,index,eOpts){var r=this.resultPanel.config.store.findRecord('id',record.get('id'),0,false,false,true);if(r){this.resultPanel.config.store.remove(r);}},onRemoveItemClick:function(cmp,record,item,index,e,eOpts){var el=Ext.get(e.getTarget());if(!el.dom.classList.contains('icon-close-light')){return;}
var r=this.resultPanel.config.store.getAt(index),gridRecord=this.grid.store.findRecord('id',r.get('id'),0,false,false,true);this.resultPanel.config.store.removeAt(index);if(gridRecord){this.grid.getSelectionModel().deselect([gridRecord]);}},getValue:function(){var rez=[];if(this.resultPanel&&this.resultPanel.config.store){this.resultPanel.config.store.each(function(r){rez.push(r.data.id);},this);}
return rez.join(',');},setData:function(data){if(!this.cfg.multiValued){return;}
if(Ext.isEmpty(data)){data=[];}
if(this.resultPanel){this.resultPanel.config.store.removeAll();Ext.each(data,function(d){d.id=parseInt(d.id,10);var u=Ext.create(this.resultPanel.config.store.getModel().getName(),d);this.resultPanel.config.store.add(u);},this);}},getData:function(){var rez=[];this.resultPanel.config.store.each(function(r){rez.push(r.data);},this);return rez;},onOkClick:function(){if(!this.cfg.multiValued){this.resultPanel.config.store.removeAll();var s=this.grid.getSelectionModel().getSelection();if(s&&(s.length>0)){var r=s[0],u=Ext.create(this.resultPanel.config.store.getModel().getName(),r.data);this.resultPanel.config.store.add(u);}}
var newValue=this.getData();var objStore=this.getObjectsStore();if(objStore){Ext.each(newValue,function(d){objStore.checkRecordExistance(d);},this);}
this.fireEvent('setvalue',newValue,this);this.close();}});Ext.define('CB.ObjectsSelectionPopupList',{extend:'Ext.Window',bodyBorder:false,closable:true,closeAction:'destroy',hideCollapseTool:true,layout:'fit',maximizable:false,minimizable:false,modal:true,plain:true,stateful:true,value:[],title:L.ChooseValues,store:new Ext.data.ArrayStore({autoDestory:true,idIndex:0,model:'Generic2',data:[]}),minWidth:350,minHeight:250,height:350,initComponent:function(){if(Ext.isEmpty(this.config.config)){this.config.config={};}
this.data=this.config.data;this.cfg=this.data.fieldRecord?Ext.apply({},Ext.valueFrom(this.data.fieldRecord.data.cfg,{})):this.config.config;Ext.apply(this,CB.ObjectsFieldCommonFunctions);this.detectStore();this.cm=[{header:' ',dataIndex:'id',width:15,fixed:true,resizable:false,scope:this,renderer:function(value,metaData,record,rowIndex,colIndex,store){if(record.get('header_row')==1)return;metaData.css=(this.value.indexOf(value+'')>=0)?'icon-element':'icon-element-off';}},{header:L.Value,dataIndex:'name',width:270,renderer:function(value,metaData,record,rowIndex,colIndex,store){metaData.css='wsn '+(record.get('icon')?record.get('icon')+' icon-padding':'');return value;}}];if(!Ext.isEmpty(this.cfg.showDate))
this.cm.push({header:L.Date,width:60,dataIndex:this.cfg.showDate,format:App.dateFormat,renderer:App.customRenderers.date});this.trigger=new Ext.form.field.Text({triggerClass:'x-form-search-trigger',border:false,emptyText:L.Filter,enableKeyEvents:true,onTriggerClick:function(e){this.doFilter(e);}.bind(this),tabIndex:1,listeners:{scope:this,keyup:function(f,e){this.doFilter(e);},specialkey:function(f,e){switch(e.getKey()){case e.DOWN:case e.TAB:this.focusGrid();break;case e.ENTER:f.onTriggerClick();}}}});this.grid=new Ext.grid.GridPanel({border:false,style:'background-color: white',stripeRows:true,store:this.store,minColumnWidth:5,columns:this.cm,tbar:[this.trigger],viewConfig:{forceFit:true,enableRowBody:true,getRowClass:function(r,rowIndex,rp,ds){rp.body=(r.get('header_row')==1)?r.get('name'):'';return(rp.body?'x-grid3-row-with-body':'');}},hideHeaders:true,selModel:new Ext.selection.RowModel({singleSelect:true}),tabIndex:2,listeners:{scope:this,rowclick:this.toggleElementSelection,keypress:function(e){if((e.getKey()==e.SPACE)&&(!e.hasModifier())){e.stopPropagation();this.toggleElementSelection();}}}});Ext.apply(this,{buttonAlign:'left',items:this.grid,keys:[{key:"\r\n",fn:this.doSubmit,scope:this},{key:Ext.event.Event.ESC,fn:this.doClose,scope:this}],buttons:[{text:L.ClearSelection,handler:this.doClearSelection,scope:this,tabIndex:6},'->',{text:Ext.MessageBox.buttonText.ok,handler:this.doSubmit,scope:this,tabIndex:3},{text:L.Cancel,handler:this.doClose,scope:this,tabIndex:4}]});this.callParent(arguments);this.on('beforeshow',this.onBeforeShowEvent,this);this.on('resize',function(win,w,h){this.trigger.setWidth(w-17);});},focusGrid:function(){this.grid.focus();if(this.grid.getStore().getCount()>0){var r=this.grid.getSelectionModel().getSelected();if(!r){r=this.grid.getStore().getAt(0);}
this.grid.getSelectionModel().select([r]);this.grid.getView().focusRow(this.grid.getStore().indexOf(r));}},toggleElementSelection:function(g,ri,e){var r=this.grid.getSelectionModel().getSelected();if(!r||(r.get('header_row')==1)){return;}
var id=r.get('id')+'';if(this.value.indexOf(id)<0){this.value.push(id);}else{this.value.remove(id);}
this.grid.getView().refresh(false);this.grid.getView().focusRow(this.grid.getStore().indexOf(r));},onBeforeShowEvent:function(){this.trigger.setValue('');this.trigger.focus(true,350);if(!Ext.isArray(this.value))this.value=Ext.isEmpty(this.value)?[]:String(this.value).split(',');this.doFilter();this.setTitle(this.title);if(this.iconCls)this.setIconCls(this.iconCls);this.width=350+(this.grid.getColumnModel().getColumnCount()-2)*100;this.setWidth(this.width);},doFilter:function(e){var criterias=[{fn:function(rec){return!Ext.isEmpty(rec.get('id'));},scope:this}],v=this.trigger.getValue();if(!Ext.isEmpty(v)){criterias.push({property:'name',value:v,anyMatch:true,caseSensitive:false});}
if(Ext.isEmpty(criterias)){this.grid.store.clearFilter();}else{this.grid.store.filter(criterias);}},doClearSelection:function(){this.value=[];this.grid.getView().refresh(false);},doSubmit:function(){this.grid.store.clearFilter();var newValue=this.value.join(',');this.fireEvent('setvalue',newValue,this);this.close();}});;Ext.namespace('CB.browser');CB.browser.Actions={deleteSelection:function(selection,callback,scope){if(Ext.isEmpty(selection)||!Ext.isArray(selection)){plog('Wrong slection given for deleteSelection',selection);return;}
this.lastArguments=arguments;Ext.Msg.confirm(L.DeleteConfirmation,(selection.length==1)?L.DeleteConfirmationMessage+' "'+selection[0].name+'"?':L.DeleteSelectedConfirmationMessage,this.onDeleteSelection,this);},onDeleteSelection:function(btn,e){if(btn!=='yes'){this.processDelete(false,e);return;}
var selection=this.lastArguments[0];if(Ext.isEmpty(selection)){return;}
var ids=[];for(var i=0;i<selection.length;i++){ids.push(Ext.valueFrom(selection[i].nid,selection[i].id));}
CB_BrowserView['delete'](ids,this.processDelete,this);},processDelete:function(r,e){var args=this.lastArguments,callback=args[1],scope=args[2];if(callback){if(scope){callback=Ext.Function.bind(callback,scope);}
callback(r,e);}
if(r&&(r.success===true)){App.mainViewPort.fireEvent('objectsdeleted',r.ids,e);}}};;Ext.namespace('CB.browser');Ext.define('CB.browser.Tree',{extend:'Ext.tree.TreePanel',alias:'widget.CBBrowserTree',rootVisible:false,scrollable:true,containerScroll:true,animate:false,lines:false,useArrows:true,border:false,bodyBoder:false,style:{border:'0'},bodyStyle:{border:'0'},hideToolbar:true,stateful:false,stateId:'btree',initComponent:function(){if(Ext.isEmpty(this.data)){this.data={};}
this.actions={edit:new Ext.Action({text:L.Edit,scope:this,handler:this.onEditClick}),expand:new Ext.Action({text:L.Expand,scope:this,handler:this.onExpandClick}),collapse:new Ext.Action({text:L.Collapse,scope:this,handler:this.onCollapseClick}),cut:new Ext.Action({text:L.Cut,scope:this,disabled:true,handler:this.onCutClick}),copy:new Ext.Action({text:L.Copy,scope:this,disabled:true,handler:this.onCopyClick}),paste:new Ext.Action({text:L.Paste,scope:this,disabled:true,handler:this.onPasteClick}),pasteShortcut:new Ext.Action({text:L.PasteShortcut,scope:this,disabled:true,handler:this.onPasteShortcutClick}),reload:new Ext.Action({iconCls:'icon-refresh',text:L.Reload,disabled:true,scope:this,handler:this.onReloadClick}),'delete':new Ext.Action({text:L.Delete,iconCls:'i-trash',disabled:true,scope:this,handler:this.onDeleteClick}),rename:new Ext.Action({text:L.Rename,disabled:true,scope:this,handler:this.onRenameClick}),star:new Ext.Action({iconCls:'i-star',text:L.Star,scope:this,handler:this.onStarClick}),unstar:new Ext.Action({iconCls:'i-unstar',text:L.Unstar,scope:this,handler:this.onUnstarClick}),permissions:new Ext.Action({text:L.Permissions,iconCls:'icon-key',scope:this,disabled:true,handler:this.onPermissionsClick})};this.createItem=new Ext.menu.Item({text:L.Create,hideOnClick:false,menu:[]});this.editor=new Ext.Editor({field:{xtype:'textfield',allowBlank:false,selectOnFocus:true}});this.editor.on('beforecomplete',this.onBeforeEditComplete,this);var rootConfig=Ext.valueFrom(this.config.data.rootNode,{});rootConfig=Ext.apply({nid:Ext.valueFrom(this.rootId,''),expanded:true,editable:false,leaf:false,iconCls:'icon-folder'},rootConfig);rootConfig.text=Ext.valueFrom(rootConfig.text,rootConfig.name);this.store=Ext.create('Ext.data.TreeStore',{root:rootConfig,proxy:{type:'direct',directFn:CB_BrowserTree.getChildren,paramsAsHash:true,extraParams:{from:'tree'}},listeners:{scope:this,beforeload:function(store,record,eOpts){var path=record.config.node?record.config.node.getPath('nid'):'';var p={path:path};Ext.apply(store.proxy.extraParams,p);}}});Ext.apply(this,{header:false,hideHeaders:true,viewConfig:{cls:'browser-tree',border:false,bodyBoder:false,scrollable:true,idProperty:'nid',loadMask:false,plugins:{ptype:'CBDDTree',idProperty:'nid'}},columns:{items:[{xtype:'treecolumn',dataIndex:'text',renderer:function(value,metaData,record,rowIndex,colIndex,store,view){metaData.tdCls=record.get('cls')+' x-grid-item-gray';return value;}}],defaults:{flex:1}},listeners:{scope:this,afterrender:this.restoreTreeState,beforeitemappend:this.onBeforeNodeAppend,dblclick:this.onDblClick,itemcontextmenu:this.onContextMenu,beforedestroy:this.onBeforeDestroy,itemkeydown:this.onItemKeyDown},selModel:new Ext.selection.TreeModel({allowDeselect:false,listeners:{scope:this,focuschange:this.onNodeFocusChange,selectionchange:this.onSelectionChange}})});this.callParent(arguments);if(!isNaN(this.rootId)){CB_BrowserTree.getRootProperties(this.rootId,function(r,e){Ext.apply(this.getRootNode().data,r.data);this.onBeforeNodeAppend(this,null,this.getRootNode());},this);}
this.enableBubble(['createobject']);App.clipboard.on('pasted',this.onClipboardAction,this);App.mainViewPort.on('savesuccess',this.onObjectsSaved,this);App.mainViewPort.on('fileuploaded',this.onObjectsSaved,this);App.mainViewPort.on('taskupdated',this.onObjectsSaved,this);App.mainViewPort.on('taskcreated',this.onObjectsSaved,this);App.mainViewPort.on('objectsdeleted',this.onObjectsDeleted,this);App.on('objectchanged',this.onObjectsSaved,this);},onItemKeyDown:function(tree,record,item,index,e,eOpts){switch(e.getKey()){case e.X:if(e.ctrlKey&&!e.shiftKey&&!e.altKey){e.stopEvent();this.onCutClick();}
break;case e.C:if(e.ctrlKey&&!e.shiftKey&&!e.altKey){e.stopEvent();this.onCopyClick();}
break;case e.V:if(e.ctrlKey&&!e.shiftKey&&!e.altKey){e.stopEvent();this.onPasteClick();}else if(e.ctrlKey&&!e.shiftKey&&e.altKey){e.stopEvent();this.onPasteShortcutClick();}
break;case e.DELETE:if(!e.ctrlKey&&!e.shiftKey&&!e.altKey){e.stopEvent();this.onDeleteClick();}
break;case e.F2:if(!e.ctrlKey&&!e.shiftKey&&!e.altKey){e.stopEvent();this.onRenameClick();}
break;case e.R:case e.F2:if((!e.ctrlKey&&!e.altKey)||(e.ctrlKey&&(e.getKey()==e.R))){e.stopEvent();this.onReloadClick();}
break;}},onBeforeNodeAppend:function(parent,node){node.data.system=Ext.Number.from(node.data.system,0);node.set('text',node.data.name);if(Ext.isEmpty(node.data.iconCls)){if(node.data.cfg&&node.data.cfg.iconCls){node.set('iconCls',node.data.cfg.iconCls);}else{node.set('iconCls',getItemIcon(node.data));}}
node.data.editable=false;node.draggable=(node.data.system===0);if(node.data.acl_count>0){node.set('cls','node-has-acl');}},onBeforeDestroy:function(p){App.clipboard.un('pasted',this.onClipboardAction,this);App.mainViewPort.un('objectsdeleted',this.onObjectsDeleted,this);},onClipboardAction:function(pids){this.getRootNode().cascadeBy({before:function(n){if(pids.indexOf(n.data.nid)>=0){this.store.reload({node:n});}},scope:this});},onObjectsSaved:function(form,e){if(!this.rendered){return;}
var n=this.getRootNode(),data=form.pid?form:form.data;data=Ext.valueFrom(data,{});if(n){n.cascadeBy({before:function(n){if(n.data.nid==data.pid){this.store.reload({node:n});}},scope:this});}},onNodeFocusChange:function(sm,oldR,newR,eOpts){this.lastFocusedRecord=Ext.valueFrom(newR,oldR);},onSelectionChange:function(sm,selection,ev){var node=Ext.isEmpty(selection)?null:selection[0];if(Ext.isEmpty(node)){this.actions.edit.setHidden(true);this.actions.cut.setDisabled(true);this.actions.copy.setDisabled(true);this.actions.paste.setDisabled(true);this.actions.pasteShortcut.setDisabled(true);this.actions['delete'].setDisabled(true);this.actions.rename.setDisabled(true);this.actions.reload.setDisabled(true);this.actions.permissions.setDisabled(true);}else{var canOpen=true;this.actions.edit.setHidden(!canOpen);var canExpand=(!node.isExpanded()&&((!node.loaded)||node.hasChildNodes()));this.actions.expand.setHidden(!canExpand);var canCollapse=node.isExpanded()&&node.hasChildNodes();this.actions.collapse.setHidden(!canCollapse);if(this.contextMenu){this.contextMenu.items.getAt(3).setVisible(canOpen||canExpand||canCollapse);}
var canCopy=(node.data.system===0);this.actions.cut.setDisabled(!canCopy);this.actions.copy.setDisabled(!canCopy);var canPaste=!App.clipboard.isEmpty()&&App.clipboard.containShortcutsOnly()&&(node.data.system===0);this.actions.paste.setDisabled(!canPaste);var canPasteShortcut=!App.clipboard.isEmpty()&&!App.clipboard.containShortcutsOnly()&&(node.data.system===0);this.actions.pasteShortcut.setDisabled(!canPasteShortcut);var canDelete=(node.data.system===0);this.actions['delete'].setDisabled(!canDelete);var canRename=(node.data.system===0);this.actions.rename.setDisabled(!canRename);this.actions.reload.setDisabled(false);this.actions.permissions.setDisabled(!Ext.isNumeric(node.data.nid)||(node.data.nid<1));}
this.fireEvent('selectionchanged');},onContextMenu:function(tree,record,item,index,e,eOpts){if(Ext.isEmpty(this.contextMenu)){this.contextMenu=new Ext.menu.Menu({items:[this.actions.edit,'-',this.actions.cut,this.actions.copy,this.actions.paste,this.actions.pasteShortcut,'-',this.actions.reload,this.actions['delete'],this.actions.rename,this.actions.star,this.actions.unstar,'-',this.createItem,'-',this.actions.permissions]});}
e.stopEvent();this.contextMenu.node=record;var canStar=!App.Favorites.isStarred(record.data.nid);this.actions.star.setHidden(!canStar);this.actions.unstar.setHidden(canStar);this.contextMenu.showAt(e.getXY());},updateCreateMenu:function(menuConfig){updateMenu(this.createItem,menuConfig,this.onCreateObjectClick,this);},onCreateObjectClick:function(b,e){var data=Ext.clone(b.config.data);data.pid=this.contextMenu.node.data.nid;data.path=this.contextMenu.node.getPath('nid');data.pathtext=this.contextMenu.node.getPath('text');var tr=CB.DB.templates.getById(data.template_id);if(tr&&(Ext.valueFrom(tr.get('cfg').editMethod,tr.get('cfg').createMethod)==='inline')){CB_Objects.create(data,this.processCreateInlineObject,this);}else{this.fireEvent('createobject',data,e);}},processCreateInlineObject:function(r,e){this.getEl().unmask();if(!r||(r.success!==true)){return;}
r.data.nid=Ext.valueFrom(r.data.nid,r.data.id);delete r.data.id;this.root.cascadeBy({before:function(node){if(node.data.nid==r.data.pid){if(!node.loaded){if(node.isSelected()){node.expand(false,false,function(pn){var n=pn.findChild('nid',r.data.nid);if(n){this.startEditing(n);}},this);}}else{r.data.loaded=true;node.expand();n=node.appendChild(r.data);this.startEditing(n);}}},scope:this});},onDblClick:function(b,e){var n=this.getSelectionModel().getSelection()[0];if(Ext.isEmpty(n)){return;}
if(App.isFolder(n.data.template_id)){return;}
this.onEditClick(b,e);},onEditClick:function(b,e){var n=this.getSelectionModel().getSelection()[0];if(Ext.isEmpty(n)){return;}
var tab=App.activateBrowserTab();tab.editObject({id:n.data.nid,template_id:n.data.template_id});},onExpandClick:function(b,e){var n=this.getSelectionModel().getSelection()[0];n.expand(false,false,function(n){},this);},onCollapseClick:function(b,e){var n=this.getSelectionModel().getSelection()[0];n.collapse();},getState:function(){var rez={paths:[]};if(this.collapsed){rez.collapsed=true;}
rez.width=this.getWidth();var p,ok,s=this.getSelectionModel().getSelection(),n=Ext.isEmpty(s)?this.lastFocusedRecord:s[0];if(!Ext.isEmpty(n)&&this.allParentsExpanded(n)){rez.selected=n.getPath('nid');}
this.getRootNode().cascadeBy({before:function(n){if(n.isExpanded()&&this.allParentsExpanded(n)){rez.paths.push(n.getPath('nid'));}},scope:this});return rez;},allParentsExpanded:function(node){var rez=true,p=node.parentNode;while(!Ext.isEmpty(p)&&rez){rez=p.isExpanded();p=p.parentNode;}
return rez;},restoreTreeState:function(){var state=this.deferredState?this.deferredState:Ext.state.Manager.getProvider().get(this.stateId);if(this.getView().getNodeContainer()){this.applyState(state);delete this.deferredState;}else{this.deferredState=state;Ext.Function.defer(this.restoreTreeState,1000,this);}},applyState:function(state){if(!this.rendered||Ext.isEmpty(state)){return;}
if(!Ext.isEmpty(state.paths)){this.expandPaths(state.paths);}
if(!Ext.isEmpty(state.selected)&&(state.selected!=='/0')){this.selectPath(state.selected,'nid','/',function(success,lastNode){if(!success){var nid=state.selected.split('/').pop(),r=this.store.findRecord('nid',nid,0,false,false,true);if(r){this.getSelectionModel().select([r]);}}},this);}},expandPaths:function(paths){this.expandingPath=true;var expandIds=[];for(var i=0;i<paths.length;i++){var ids=paths[i].split('/');for(var j=0;j<ids.length;j++){if(!Ext.isEmpty(ids[j])&&(expandIds.indexOf(ids[j])<0)){expandIds.push(ids[j]);}}}
if(!Ext.isEmpty(expandIds)){this.expandingIds=expandIds;this.recursiveExpandIds();}else{delete this.expandingPath;}},recursiveExpandIds:function(){if(Ext.isEmpty(this.expandingIds)){delete this.expandingPath;this.enableStateSave();return;}
var id=this.expandingIds.shift(),rec=this.store.findRecord('nid',id,0,false,false,true);node=rec?this.store.getNodeById(rec.get('id')):null;if(node){node.expand(false,this.recursiveExpandIds,this);}else{this.recursiveExpandIds();}},enableStateSave:function(){this.stateful=true;this.addStateEvents(['afteritemexpand','afteritemcollapse','beforedestroy','selectionchange','savestate']);},onCutClick:function(b,e){if(this.actions.cut.isDisabled()){return;}
this.onCopyClick(b,e);App.clipboard.setAction('move');},onCopyClick:function(b,e){var n=this.selModel.getSelection()[0];if(Ext.isEmpty(n)||this.actions.copy.isDisabled()){return;}
App.clipboard.set({id:n.data.nid,name:n.data.name,system:n.data.system,type:n.data.type,iconCls:n.data.iconCls},'copy');},onPasteClick:function(b,e){var n=this.selModel.getSelection()[0];if(Ext.isEmpty(n)||this.actions.paste.isDisabled()){return;}
App.clipboard.paste(n.data.nid);},onPasteShortcutClick:function(b,e){var n=this.selModel.getSelection()[0];if(Ext.isEmpty(n)||this.actions.pasteShortcut.isDisabled()){return;}
App.clipboard.paste(n.data.nid,'shortcut');},onPermissionsClick:function(b,e){var n=this.selModel.getSelection()[0];if(Ext.isEmpty(n)||this.actions.permissions.isDisabled()){return;}
App.mainViewPort.openPermissions(n.data.nid);},onRenameClick:function(b,e){this.startEditing(this.getSelectionModel().getSelection()[0]);},onReloadClick:function(b,e){var node=this.getSelectionModel().getSelection()[0];if(node&&!node.isExpanded()){node.expand();}else{this.store.reload({node:node});}},startEditing:function(node){Ext.Function.defer(function(){this.editor.editNode=node;this.editor.startEdit(this.getView().getNode(node),Ext.util.Format.htmlDecode(node.data.name));},10,this);},onBeforeEditComplete:function(editor,newVal,oldVal){var n=editor.editNode;n.set('text',Ext.util.Format.htmlEncode(newVal));if(newVal===oldVal){return;}
editor.cancelEdit();this.getEl().mask(L.Processing,'x-mask-loading');CB_BrowserTree.rename({path:n.getPath('nid'),name:newVal},this.processRename,this);return false;},processRename:function(r,e){this.getEl().unmask();if(!r||(r.success!==true)){return;}
this.getRootNode().cascadeBy({before:function(n){if(n.data.nid==r.data.id){n.data.name=r.data.newName;n.set('text',r.data.newName);}},scope:this});this.fireEvent('afterrename',this,r,e);},onDeleteClick:function(b,e){Ext.Msg.confirm(L.DeleteConfirmation,L.DeleteConfirmationMessage+' "'+this.getSelectionModel().getSelection()[0].data.text+'"?',this.onDelete,this);},onDelete:function(btn){if(btn!=='yes'){return;}
this.getEl().mask(L.Processing+' ...','x-mask-loading');CB_BrowserTree['delete'](this.getSelectionModel().getSelection()[0].getPath('nid'),this.processDelete,this);},processDelete:function(r,e){this.getEl().unmask();App.mainViewPort.onProcessObjectsDeleted(r,e);},onObjectsDeleted:function(ids){var sm=this.getSelectionModel(),deleteNodes=[];this.getRootNode().cascadeBy({before:function(n){if(ids.indexOf(n.data.nid)>=0){if(sm.isSelected(n)){var nn=n.isLast()?(n.isFirst()?n.parentNode:n.previousSibling):n.nextSibling;sm.select([nn]);}
deleteNodes.push(n);}},scope:this});for(var i=0;i<deleteNodes.length;i++){deleteNodes[i].remove(true);}},onStarClick:function(b,e){var n=this.contextMenu.node,d=n.data,data={id:d.nid,name:d.name,iconCls:d.iconCls,pathText:d.path,path:n.getPath('nid','/')};App.Favorites.setStarred(data);},onUnstarClick:function(b,e){App.Favorites.setUnstarred(this.contextMenu.node.data.nid);}});;Ext.namespace('CB.browser');Ext.define('CB.browser.ViewContainer',{extend:'Ext.Panel',xtype:'CBBrowserViewContainer',title:'Browser',iconCls:'icon-folder',closable:true,border:false,layout:'fit',params:{descendants:false},defaultToolbarItems:['->','reload','apps','-','more'],initComponent:function(){var pageSize=Ext.valueFrom(App.loginData.cfg.max_rows,50);this.instanceId=Ext.id();this.actions={edit:new Ext.Action({text:L.Edit,itemId:'edit',scope:this,handler:this.onEditClick}),reload:new Ext.Action({iconCls:'im-refresh',itemId:'reload',scale:'medium',tooltip:L.Reload,scope:this,handler:this.onReloadClick}),contextReload:new Ext.Action({iconCls:'icon-refresh',text:L.Reload,scope:this,handler:this.onReloadClick}),upload:new Ext.Action({text:L.Upload,itemId:'upload',scale:'medium',iconCls:'im-upload',scope:this,handler:this.onUploadClick}),download:new Ext.Action({text:L.Download,itemId:'download',scale:'medium',iconCls:'im-download',hidden:true,disabled:true,hideParent:false,scope:this,handler:this.onDownloadClick}),contextDownload:new Ext.Action({text:L.Download,iconCls:'i-download',hidden:true,scope:this,handler:this.onDownloadClick}),contextPreview:new Ext.Action({text:L.Preview,hidden:true,scope:this,handler:this.onContextPreviewClick}),cut:new Ext.Action({text:L.Cut,itemId:'cut',scope:this,disabled:true,handler:this.onCutClick}),copy:new Ext.Action({text:L.Copy,itemId:'copy',scope:this,disabled:true,handler:this.onCopyClick}),paste:new Ext.Action({text:L.Paste,itemId:'paste',scope:this,disabled:true,handler:this.onPasteClick}),pasteShortcut:new Ext.Action({text:L.PasteShortcut,itemId:'pasteshortcut',scope:this,disabled:true,handler:this.onPasteShortcutClick}),'delete':new Ext.Action({qtip:L.Delete,text:L.Delete,itemId:'delete',iconCls:'im-trash',scale:'medium',hidden:true,disabled:true,hideParent:false,scope:this,handler:this.onDeleteClick}),contextDelete:new Ext.Action({text:L.Delete,iconCls:'i-trash',disabled:true,hideParent:false,scope:this,handler:this.onDeleteClick}),contextRename:new Ext.Action({text:L.Rename,iconCls:'i-rename',scope:this,handler:this.onRenameClick}),contextExport:new Ext.Action({iconCls:'i-table-export',text:L.Export,scope:this,handler:this.onExportClick}),star:new Ext.Action({iconCls:'i-star',text:L.Star,scope:this,handler:this.onStarClick}),unstar:new Ext.Action({iconCls:'i-unstar',text:L.Unstar,scope:this,handler:this.onUnstarClick}),restore:new Ext.Action({text:L.Restore,itemId:'restore',iconCls:'im-restore',scale:'medium',hidden:true,disabled:true,hideParent:false,scope:this,handler:this.onRestoreClick}),permissions:new Ext.Action({text:L.Permissions,itemId:'permissions',iconCls:'icon-key',scope:this,disabled:true,handler:this.onPermissionsClick}),preview:new Ext.Action({itemId:'preview',scale:'medium',iconCls:'im-preview',scope:this,hidden:true,disabled:true,handler:this.onPreviewClick}),webdavlink:new Ext.Action({text:L.WebDAVLink,itemId:'webdavlink',scope:this,handler:this.onWebDAVLinkClick}),permalink:new Ext.Action({text:L.Permalink,itemId:'permalink',scope:this,handler:this.onPermalinkClick})};this.descendantsCheckItem=Ext.create({xtype:'menucheckitem',text:L.Descendants,checked:(this.params.descendants===true),listeners:{scope:this,checkchange:this.onDescendantsCheckChange}});this.tbarMoreMenu=new Ext.menu.Menu({items:[{text:L.Rows,menu:[{xtype:'menucheckitem',text:25,group:'gvrc',checked:(pageSize==25),scope:this,handler:this.onRowCountChangeClick},{xtype:'menucheckitem',text:50,group:'gvrc',checked:(pageSize==50),scope:this,handler:this.onRowCountChangeClick},{xtype:'menucheckitem',text:100,group:'gvrc',checked:(pageSize==100),scope:this,handler:this.onRowCountChangeClick},{xtype:'menucheckitem',text:200,group:'gvrc',checked:(pageSize==200),scope:this,handler:this.onRowCountChangeClick}]},this.descendantsCheckItem,this.actions.contextExport]});this.buttonCollection=new Ext.util.MixedCollection();this.buttonCollection.addAll([new Ext.Button({qtip:L.Views,itemId:'apps',arrowVisible:false,iconCls:'im-apps',scale:'medium',menu:[]}),new Ext.Button({qtip:L.New,text:L.New,itemId:'create',iconCls:'im-create',disabled:true,scale:'medium',menu:[]}),new Ext.Button(this.actions.reload),new Ext.Button(this.actions.upload),new Ext.Button(this.actions.download),new Ext.Button({text:L.Clipboard,itemId:'edit',iconCls:'im-assignment',scale:'medium',menu:[this.actions.cut,this.actions.copy,this.actions.paste,this.actions.pasteShortcut]}),new Ext.Button(this.actions.preview),new Ext.Button(this.actions.restore),new Ext.Button(this.actions['delete']),new Ext.Button({qtip:L.More,itemId:'more',arrowVisible:false,iconCls:'im-points',scale:'medium',menu:this.tbarMoreMenu})]);this.viewToolbar=new Ext.Toolbar({border:false,style:'background: #ffffff',defaults:{scale:'medium'},items:[],listeners:{scope:this,afterlayout:function(c){var ic=c.items.getCount();for(var i=0;i<ic;i++){if(c.items.getAt(i).disabled){c.items.getAt(i).hide();}}}}});this.objectPanel=new CB.object.ViewContainer({region:'east',header:false,width:250,split:{size:3,collapsible:false,style:'background-color: #dfe8f6'},collapsible:true,collapseMode:'mini',stateful:true,stateId:'mopp',listeners:{scope:this,expand:function(){this.actions.preview.setDisabled(true);this.actions.preview.setHidden(true);},collapse:function(){this.actions.preview.setDisabled(false);this.actions.preview.setHidden(false);}},onCloseClick:Ext.Function.bind(this.onCloseRightPanelClick,this)});this.store=new Ext.data.DirectStore({autoLoad:false,autoDestroy:true,remoteSort:true,sortOnLoad:false,extraParams:{},pageSize:pageSize,model:'Items',proxy:new Ext.data.DirectProxy({paramsAsHash:true,directFn:CB_BrowserView.getChildren,reader:{type:'json',successProperty:'success',idProperty:'nid',rootProperty:'data',messageProperty:'msg'}}),loadPage:function(page,options){var store=this.store,size=store.getPageSize();store.currentPage=page;options=Ext.apply({page:page,start:(page-1)*size,rows:size,},options);this.changeSomeParams(options);}.bind(this),listeners:{scope:this,beforeload:this.onBeforeStoreLoad,load:this.onStoreLoad}});this.store.proxy.reader.readRecords=Ext.Function.createInterceptor(this.store.proxy.reader.readRecords,CB.DB.convertJsonReaderDates);var getPropertyHandler=this.getProperty.bind(this);this.cardContainer=new Ext.Panel({layout:'card',activeItem:0,border:false,tbar:this.viewToolbar,items:[new CB.browser.view.Grid({border:false,refOwner:this,store:this.store,showObjectPropertiesPanel:true,getProperty:getPropertyHandler}),new CB.browser.view.Calendar({border:false,refOwner:this,store:this.store,showFilterPanel:true,getProperty:getPropertyHandler,listeners:{scope:this,openobject:this.onObjectsOpenEvent}}),new CB.browser.view.Charts({border:false,refOwner:this,addDivider:true,store:this.store,getProperty:getPropertyHandler}),new CB.browser.view.Pivot({refOwner:this,border:false,store:this.store,getProperty:getPropertyHandler}),new CB.browser.view.ActivityStream({border:false,refOwner:this,store:this.store,showObjectPropertiesPanel:true,getProperty:getPropertyHandler}),new CB.browser.view.Map({border:false,refOwner:this,store:this.store,showObjectPropertiesPanel:false,getProperty:getPropertyHandler}),new CB.browser.view.Dashboard({border:false,refOwner:this,store:this.store,showObjectPropertiesPanel:false,getProperty:getPropertyHandler})],listeners:{scope:this,add:function(o,c,idx){if(c.isXType('CBBrowserViewInterface')){var b=this.buttonCollection.get('apps');if(c.addDivider===true){b.menu.add('-');}
b.menu.add({text:c.title,iconCls:c.iconCls,scope:this,viewIndex:idx,handler:this.onCardItemChangeClick});}},selectionchange:this.onObjectsSelectionChange,objectopen:this.onObjectsOpenEvent}});this.notificationsView=new CB.notifications.View({});this.loadParamsTask=new Ext.util.DelayedTask(this.loadParams,this);App.fireEvent('browserinit',this);Ext.apply(this,{cls:'x-panel-white',items:[{layout:'border',border:false,tbarCssClass:'x-panel-gray',items:[{layout:'card',activeItem:0,itemId:'containersPanel',border:false,region:'center',items:[this.cardContainer,this.notificationsView]},this.objectPanel]}],listeners:{scope:this,render:function(){this.onSetToolbarItems(null);},changeparams:this.changeSomeParams,settoolbaritems:this.onSetToolbarItems,reload:this.onReloadClick,itemcontextmenu:this.onItemContextMenu}});this.callParent(arguments);this.containersPanel=this.items.getAt(0).items.getAt(0);this.notificationsView=this.containersPanel.items.getAt(1);this.enableBubble(['viewloaded','fileupload','filedownload','createobject']);App.mainViewPort.on('objectsdeleted',this.onObjectsDeleted,this);App.clipboard.on('change',this.onClipboardChange,this);App.clipboard.on('pasted',this.onClipboardAction,this);App.on('objectsaction',this.onObjectsAction,this);App.on('objectchanged',this.onObjectChanged,this);App.on('filesuploaded',this.onClipboardAction,this);},onBeforeDestroy:function(p){App.clipboard.un('change',this.onClipboardChange,this);App.clipboard.un('pasted',this.onClipboardAction,this);App.un('objectsaction',this.onObjectsAction,this);App.un('filesuploaded',this.onClipboardAction,this);},getProperty:function(propertyName){if(propertyName==='nid'){propertyName='id';}
if(this.folderProperties&&this.folderProperties[propertyName]){return this.folderProperties[propertyName];}
return null;},onSetToolbarItems:function(buttonsArray){if(!this.getEl().isVisible(true)){return;}
var i,b;this.viewToolbar.suspendLayout=true;while(this.viewToolbar.items.getCount()>0){b=this.viewToolbar.items.getAt(0);b.hide();this.viewToolbar.remove(b,b.isXType('tbseparator'));}
if(buttonsArray===null){buttonsArray=this.defaultToolbarItems;}
if(buttonsArray.indexOf('more')<0){buttonsArray.push('more');}
if(buttonsArray.indexOf('apps')<0){buttonsArray.push('apps');}
if(buttonsArray.indexOf('preview')<0){buttonsArray.push('preview');}
buttonsArray.splice(1,0,'restore');var idx=buttonsArray.indexOf('->');if(!Ext.isEmpty(this.pluginButtons)){for(i=0;i<this.pluginButtons.length;i++){buttonsArray.splice(++idx,0,this.pluginButtons[i]);}
buttonsArray.splice(++idx,0,'-');}
for(i=0;i<buttonsArray.length;i++){if((buttonsArray[i]==='-')||(buttonsArray[i]==='->')){this.viewToolbar.add(buttonsArray[i]);}else{b=this.buttonCollection.get(buttonsArray[i]);if(b){this.viewToolbar.add(b);if(!b.disabled){b.show();}}}}
this.updateToolbarButtons();this.viewToolbar.hideInutilSeparators();this.viewToolbar.suspendLayout=false;this.viewToolbar.doLayout();},onCardItemChangeClick:function(b,e){delete this.params.view;delete this.params.start;delete this.params.page;delete this.params.from;this.onSetToolbarItems(null);this.setActiveView(b.viewIndex);this.userViewSet=true;this.store.clearing=true;this.store.removeAll();this.onReloadClick();},onReloadClick:function(){var av=this.getActiveView();if(av.onContainerReloadClick){av.onContainerReloadClick(this.params);}
if(Ext.isEmpty(this.reloadTask)){this.reloadTask=new Ext.util.DelayedTask(this.reloadView,this);}
this.reloadTask.delay(100);},getActiveView:function(){return this.cardContainer.getLayout().activeItem;},setAvailableViews:function(viewIds){if(Ext.isEmpty(viewIds)||!Ext.isArray(viewIds)){viewIds=['grid','charts','pivot','activityStream'];}
for(var i=0;i<viewIds.length;i++){viewIds[i]='CBBrowserView'+Ext.util.Format.capitalize(viewIds[i]);}
var b=this.buttonCollection.get('apps');b.menu.items.each(function(i,idx,count){if(i.viewIndex!==undefined){i.setVisible(viewIds.indexOf(this.cardContainer.items.getAt(i.viewIndex).getXType())>-1);}},this);},setActiveView:function(indexOrName,viewParams){var layout=this.cardContainer.getLayout(),rez=null;if(Ext.isNumeric(indexOrName)){rez=this.cardContainer.items.getAt(indexOrName);}else{var viewName='CBBrowserView'+Ext.util.Format.capitalize(indexOrName);this.cardContainer.items.each(function(i,idx){if(i.getXType()==viewName){rez=i;}},this);}
if(!Ext.isEmpty(rez)){if(rez!==layout.activeItem){if(viewParams){rez.viewParams=viewParams;}
rez=layout.setActiveItem(rez);var showObjPanel=(rez&&(rez.showObjectPropertiesPanel===true)),showPreviewButton=showObjPanel&&(this.objectPanel.getCollapsed()!==false);this.actions.preview.setDisabled(!showPreviewButton);this.actions.preview.setHidden(!showPreviewButton);this.objectPanel.setVisible(showObjPanel);App.mainViewPort.onToggleFilterPanelClick({pressed:(rez.showFilterPanel===true)});}}
return rez;},reloadView:function(){this.store.load(this.params);},processLoadedParams:function(){var result=Ext.valueFrom(this.store.proxy.reader.rawData,{});var ep=this.store.proxy.extraParams;this.path=ep.path;this.folderProperties=Ext.apply({},result.folderProperties);this.folderProperties.system=parseInt(this.folderProperties.system,10);this.folderProperties.type=parseInt(this.folderProperties.type,10);this.folderProperties.pathtext=result.pathtext;if(!this.isRequestFromObjectChange){this.containersPanel.setActiveItem(this.cardContainer);var proxy=this.store.proxy;App.controller.onVCViewLoaded(proxy,Ext.valueFrom(proxy.reader.rawData,{}),proxy.extraParams);}else{delete this.isRequestFromObjectChange;}
this.descendantsCheckItem.setChecked(ep.descendants===true,true);this.setAvailableViews(result.availableViews);if(!this.userViewSet){if(!Ext.isEmpty(result.view)){if(Ext.isPrimitive(result.view)){result.view={type:result.view};}
this.setActiveView(result.view.type,result.view);}else{if(this.params&&this.params.view){this.setActiveView(this.params.view);}else{this.setActiveView('grid');}}}
this.fireEvent('viewloaded',this.store.proxy,result,ep);this.updateCreateMenuItems(this.buttonCollection.get('create'));this.updateToolbarButtons();var showPreviewButton=((this.objectPanel.getCollapsed()!==false)&&(this.getActiveView().showObjectPropertiesPanel===true)),pa=this.actions.preview;pa.setDisabled(!showPreviewButton);pa.setHidden(!showPreviewButton);if(App.mainFilterPanel){App.mainFilterPanel.updateFacets(result.facets,ep);}},onBeforeStoreLoad:function(store,operation,eOpts){var options={facets:'general'};Ext.apply(options,Ext.valueFrom(this.params,{}));var vp=this.getActiveView().getViewParams(options);if((vp===false)||(!Ext.isEmpty(vp)&&(vp.from==='calendar')&&(Ext.isEmpty(vp.dateStart)||Ext.isEmpty(vp.dateEnd)))){return false;}
Ext.apply(options,vp);if(this.params&&this.params.from&&(this.params.from!=='tree')){options.from=this.params.from;}
var ep=store.proxy.extraParams,lastSearchId=false,currentSearchId=false;if(ep.search&&ep.search.template_id){lastSearchId=ep.search.template_id;}
if(options.search&&options.search.template_id){currentSearchId=options.search.template_id;}
if((ep.id!=options.id)||(lastSearchId!=currentSearchId)){delete this.userViewSet;delete options.dateStart;delete options.dateEnd;}else if(this.userViewSet){options.userViewChange=true;}
var page=Ext.valueFrom(options.page,1);store.currentPage=page;options.page=page;if(!Ext.isDefined(options.start)){options.start=(page-1)*store.pageSize;}
store.proxy.extraParams=options;},onStoreLoad:function(store,recs,options){this.getEl().unmask();delete store.clearing;delete this.params.setMaxRows;this.processLoadedParams();Ext.each(recs,function(r){var cfg=Ext.valueFrom(r.get('cfg'),{});r.data.iconCls=Ext.isEmpty(cfg.iconCls)?getItemIcon(r.data):cfg.iconCls;},this);},sameParams:function(params1,params2){if(Ext.isEmpty(params1)&&Ext.isEmpty(params2)){return true;}
if(Ext.isEmpty(params1)){params1={};}
if(Ext.isEmpty(params2)){params2={};}
var path1=Ext.valueFrom(params1.path,''),path2=Ext.valueFrom(params2.path,'');while((path1.length>0)&&(path1[0]==='/')){path1=path1.substr(1);}
while((path2.length>0)&&(path2[0]==='/')){path2=path2.substr(1);}
if((params1.path!=params2.path)||!Ext.isDefined(params1.path)){return false;}
if((Ext.Number.from(params1.start,0)!=Ext.Number.from(params2.start,0))){return false;}
if((Ext.Number.from(params1.page,0)!=Ext.Number.from(params2.page,0))){return false;}
if((!Ext.isEmpty(params1.descendants)||!Ext.isEmpty(params2.descendants))&&(params1.descendants!=params2.descendants)){return false;}
if((!Ext.isEmpty(params1.query)||!Ext.isEmpty(params2.query))&&(params1.query!=params2.query)){return false;}
if((!Ext.isEmpty(params1.filters)||!Ext.isEmpty(params2.filters))&&(params1.filters!=params2.filters)){return false;}
if((!Ext.isEmpty(params1.dateStart)||!Ext.isEmpty(params2.dateStart))&&(params1.dateStart!=params2.dateStart)){return false;}
if((!Ext.isEmpty(params1.dateEnd)||!Ext.isEmpty(params2.dateEnd))&&(params1.dateEnd!=params2.dateEnd)){return false;}
if((!Ext.isEmpty(params1.view)||!Ext.isEmpty(params2.view))&&(params1.view!=params2.view)){return false;}
if((!Ext.isEmpty(params1.search)||!Ext.isEmpty(params2.search))&&(Ext.encode(params1.search)!=Ext.encode(params2.search))){return false;}
return true;},changeParams:function(params,e){if(e&&e.stopPropagation){e.stopPropagation();}
this.setParams(params);},changeSomeParams:function(paramsSubset){var p=Ext.apply({},this.params);if(!Ext.isDefined(paramsSubset.start)){if(Ext.isDefined(paramsSubset.page)){paramsSubset.start=(paramsSubset.page-1)*this.store.pageSize;}else{paramsSubset.page=1;paramsSubset.start=0;}}
if(!Ext.isEmpty(paramsSubset.view)){delete this.userViewSet;}
Ext.apply(p,paramsSubset);this.setParams(p);},setParams:function(params){while(!Ext.isEmpty(params.path)&&(params.path[0]==='/')){params.path=params.path.substr(1);}
while(!Ext.isEmpty(params.path)&&(params.path[params.path.length-1]==='/')){params.path=params.path.substr(0,params.path.length-1);}
if(Ext.isEmpty(params.path)){params.path='/';}
if(!Ext.isEmpty(this.params.query)){params.lastQuery=this.params.query;}else if(!Ext.isEmpty(this.params.search)){params.lastQuery=this.params.search;}
var newParams=Ext.decode(Ext.encode(params));var sameParams=this.sameParams(this.params,newParams);this.loadParamsTask.cancel();this.requestParams=newParams;this.loadParamsTask.delay(100);},loadParams:function(){if(Ext.isEmpty(this.requestParams.forceLoad)&&this.sameParams(this.params,this.requestParams)){this.containersPanel.setActiveItem(this.cardContainer);return;}
this.params=Ext.clone(this.requestParams);delete this.requestParams;delete this.params.forceLoad;this.reloadView();},updateCreateMenuItems:function(menuButton){var menu=this.folderProperties?this.folderProperties.menu:[];updateMenu(menuButton,menu,this.onCreateObjectClick,this);menuButton.setDisabled(menuButton.menu.items.getCount()<1);},updateToolbarButtons:function(){var ai=this.getActiveView(),selection=ai.getSelectedItems?ai.getSelectedItems():[],fp=Ext.valueFrom(this.folderProperties,{}),acceptChildren=CB.DB.templates.acceptChildren(fp.template_id),inRecycleBin=this.inRecycleBin(),inGridView=ai.isXType('CBBrowserViewGrid'),inSearchMode=!Ext.isEmpty(this.params.query);this.actions.restore.setHidden(!inRecycleBin||!inGridView);this.actions.restore.setDisabled(!inRecycleBin||!inGridView||Ext.isEmpty(selection));this.actions.upload.setHidden(!acceptChildren||inRecycleBin||!inGridView||inSearchMode);this.buttonCollection.get('create').setVisible(!inRecycleBin&&inGridView);this.buttonCollection.get('edit').setVisible(!inRecycleBin&&inGridView);this.buttonCollection.get('more').setVisible(inGridView);if(Ext.isEmpty(selection)){this.actions.edit.setDisabled(true);this.actions.cut.setDisabled(true);this.actions.copy.setDisabled(true);this.actions.download.setDisabled(true);this.actions.download.hide();this.actions.contextPreview.setDisabled(true);this.actions.contextPreview.hide();this.actions.contextDownload.setDisabled(true);this.actions.contextDownload.hide();this.actions['delete'].setDisabled(true);this.actions['delete'].hide();this.actions.contextDelete.setDisabled(true);this.actions.webdavlink.setDisabled(true);this.actions.webdavlink.hide();this.actions.permalink.setDisabled(true);this.actions.permalink.hide();this.actions.restore.setDisabled(true);this.actions.restore.hide();this.actions.permissions.setDisabled(isNaN(fp.id));}else{var firstObjId=Ext.valueFrom(selection[0].nid,selection[0].id),firstObjType=CB.DB.templates.getType(selection[0].template_id),firstFileEditor=(firstObjType==='file')?detectFileEditor(selection[0].name):false;this.actions.cut.setDisabled(false);this.actions.copy.setDisabled(false);this.actions.edit.setDisabled((firstObjType==='file')&&(firstFileEditor===false));this.actions.contextPreview.setDisabled(false);this.actions.contextPreview.show();var canDownload=true;for(var i=0;i<selection.length;i++){if(CB.DB.templates.getType(selection[i].template_id)!=='file'){canDownload=false;}}
this.actions.download.setDisabled(!canDownload);this.actions.contextDownload.setDisabled(!canDownload);if(canDownload){this.actions.download.show();this.actions.contextDownload.show();}else{this.actions.download.hide();this.actions.contextDownload.hide();}
this.actions['delete'].setDisabled(inRecycleBin);this.actions.contextDelete.setDisabled(inRecycleBin);this.actions.webdavlink.setDisabled(firstObjType!=='file');this.actions.webdavlink.setHidden(firstObjType!=='file'||(firstFileEditor!=='webdav'));if(!inRecycleBin&&inGridView){this.actions['delete'].show();}
this.actions.permissions.setDisabled(isNaN(firstObjId));}
this.viewToolbar.hideInutilSeparators();},onRowCountChangeClick:function(b,e){this.params.setMaxRows=true;this.params.rows=b.text;this.store.setPageSize(b.text);this.store.reload();},getSelection:function(){return this.getActiveView().currentSelection;},getSelectionIds:function(){var rez=[],selection=this.getSelection();if(!Ext.isEmpty(selection)){for(var i=0;i<selection.length;i++){rez.push(selection[i].nid);}}
return rez;},onObjectsSelectionChange:function(objectsDataArray){this.getActiveView().currentSelection=objectsDataArray;this.updateToolbarButtons();},inRecycleBin:function(){return(String(Ext.valueFrom(this.folderProperties,{}).path).indexOf('-recycleBin')>-1);},editObject:function(objectData){this.objectPanel.edit(objectData);},onObjectsOpenEvent:function(objectData,e){if(e&&e.stopEvent){e.stopEvent();}
var data=Ext.apply({},objectData),templateType=CB.DB.templates.getType(data.template_id);if(!Ext.isEmpty(data.nid)){data.id=data.nid;}
if(templateType==='file'){switch(detectFileEditor(data.name)){case'text':case'html':data.view='edit';default:App.openObjectWindow(data);break;}
return;}else{var cfg=CB.DB.templates.getProperty(data.template_id,'cfg');if(cfg&&(cfg.leaf===true)){data.view='edit';App.openObjectWindow(data);return;}}
var path=this.folderProperties.path;if(path.substr(-1,1)!=='/'){path+='/';}
path+=data.nid;path=Ext.valueFrom(objectData.targetPath,path);this.changeSomeParams({path:path,query:null,descendants:false,search:null});},onFiltersChange:function(filters){this.changeSomeParams({filters:filters});},onSearchQuery:function(query,e){this.changeSomeParams({query:query});},onSetOwnerClick:function(b,e){var ids=this.getSelectionIds();if(!Ext.isEmpty(ids)){CB_Objects.setOwnership({ids:ids,userId:b.userId},this.processSetOwnership,this);}},processSetOwnership:function(r,e){if(r&&r.success){this.onReloadClick();}},onCreateObjectClick:function(b,e){var ep=this.store.proxy.extraParams,fp=Ext.valueFrom(this.folderProperties,{});Ext.apply(b.config.data,{pid:fp.id,pids:fp.path,path:fp.pathtext});if(ep.search){b.config.data.search=ep.search;}
this.fireEvent('createobject',Ext.clone(b.config.data));},onUploadClick:function(b,e){this.fireEvent('fileupload',{pid:Ext.valueFrom(this.folderProperties.id,this.folderProperties.path),uploadType:b.config.uploadType},e);},onDownloadClick:function(b,e){var ids=this.getSelectionIds();if(!Ext.isEmpty(ids)){this.fireEvent('filedownload',ids,false,e);}},onContextPreviewClick:function(b,e){var ids=[];var selection=this.getSelection();if(Ext.isEmpty(selection)){return;}
var data=Ext.clone(selection[0]);data.id=data.nid;App.openObjectWindow(data);},onDeleteClick:function(b,e){var selection=this.getSelection();if(Ext.isEmpty(selection)){return;}
if(selection[0].isFavorite===true){this.onUnstarClick();this.onReloadClick();}else{this.getEl().mask(L.Processing+' ...','x-mask-loading');CB.browser.Actions.deleteSelection(selection,this.processDelete,this);}},processDelete:function(r,e){this.getEl().unmask();},onObjectsDeleted:function(ids,e){this.store.deleteIds(ids);},onRenameClick:function(b,e){this.getActiveView().onRenameClick(b,e);},onRestoreClick:function(){var ids=this.getSelectionIds();if(!Ext.isEmpty(ids)){this.getEl().mask(L.Processing+' ...','x-mask-loading');CB_Browser.restore(ids,this.processRestore,this);}},processRestore:function(r,e){this.getEl().unmask();if(!r||(r.success!==true)){Ext.Msg.alert(L.ErrorOccured);return;}
this.onReloadClick();},onCutClick:function(buttonOrKey,e){if(this.actions.cut.isDisabled()){return;}
this.onCopyClick(buttonOrKey,e);App.clipboard.setAction('move');},onCopyClick:function(buttonOrKey,e){if(this.actions.copy.isDisabled()){return;}
var rez=[],selection=this.getSelection();if(Ext.isEmpty(selection)){return;}
for(var i=0;i<selection.length;i++){rez.push({id:selection[i].nid,name:selection[i].name,system:selection[i].system,type:selection[i].type,iconCls:selection[i].iconCls});}
App.clipboard.set(rez,'copy');},onPasteClick:function(buttonOrKey,e){if(this.actions.paste.isDisabled()){return;}
App.clipboard.paste(this.folderProperties.id,null);},onPasteShortcutClick:function(buttonOrKey,e){if(this.actions.pasteShortcut.isDisabled()){return;}
App.clipboard.paste(this.folderProperties.id,'shortcut');},onPermissionsClick:function(b,e){if(this.actions.permissions.isDisabled()){return;}
var selection=this.getSelection(),id=Ext.isEmpty(selection)?this.folderProperties.id:Ext.valueFrom(selection[0].nid,selection[0].id);App.mainViewPort.openPermissions(id);},onEditClick:function(b,e){var selection=this.getSelection();if(!Ext.isEmpty(selection)){var p=Ext.apply({},selection[0]);p.id=p.nid;switch(detectFileEditor(p.name)){case'webdav':App.openWebdavDocument(p);break;default:this.editObject(p);break;}}},onClipboardChange:function(cb){this.actions.paste.setDisabled(App.clipboard.isEmpty());this.actions.pasteShortcut.setDisabled(App.clipboard.isEmpty());},onClipboardAction:function(pids){if(pids.indexOf(this.folderProperties.id)>=0){this.onReloadClick();}},onObjectChanged:function(objData,component){var idx=this.store.findExact('nid',String(objData.id)),fp=Ext.valueFrom(this.folderProperties,{});if((idx>=0)||isNaN(fp.id)||(objData.pid==fp.id)){this.isRequestFromObjectChange=true;this.onReloadClick();}},onObjectsAction:function(action,r,e){if(Ext.isEmpty(r.processedIds)){return;}
switch(action){case'copy':case'shortcut':if(r.targetId==this.folderProperties.id){this.onReloadClick();}
break;case'move':if(r.targetId==this.folderProperties.id){this.onReloadClick();}else{this.store.deleteIds(r.processedIds);}
break;case'create':break;case'update':break;case'delete':break;}},onItemContextMenu:function(e){e.stopEvent();if(!this.contextMenu){this.createItem=new Ext.menu.Item({text:L.Create,hideOnClick:false,menu:[]});this.setOwnerItem=new Ext.menu.Item({text:L.SetOwner,hideOnClick:false,menu:getMenuUserItems(this.onSetOwnerClick,this)});this.createItemSeparator=new Ext.menu.Separator();this.contextMenu=new Ext.menu.Menu({items:[this.actions.edit,this.actions.contextPreview,this.actions.contextDownload,'-',this.actions.cut,this.actions.copy,this.actions.paste,this.actions.pasteShortcut,'-',this.actions.contextReload,this.actions.contextDelete,this.actions.contextRename,this.actions.star,this.actions.unstar,this.actions.webdavlink,this.actions.permalink,this.setOwnerItem,'-',this.createItem,this.createItemSeparator,this.actions.permissions]});}
var s=this.getSelection(),hasSelection=!Ext.isEmpty(s);this.setOwnerItem.setHidden(!hasSelection);this.createItem.setHidden(hasSelection);this.createItemSeparator.setHidden(hasSelection);if(!hasSelection){updateMenu(this.createItem,this.folderProperties.menu,this.onCreateObjectClick,this);this.createItem.setDisabled(this.createItem.menu.items.getCount()<1);}
if(s&&(s.length==1)){var canStar=!App.Favorites.isStarred(s[0].nid);this.actions.star.setHidden(!canStar);this.actions.unstar.setHidden(canStar);}else{this.actions.star.setHidden(true);this.actions.unstar.setHidden(true);}
this.contextMenu.showAt(e.getXY());},onExportClick:function(b,e){this.fireEvent('exportrecords',this,e);},onDescendantsCheckChange:function(cb,checked,eOpts){this.changeSomeParams({descendants:checked,start:0});},onCloseRightPanelClick:function(b,e){this.objectPanel.collapse();this.actions.preview.show();},onPreviewClick:function(b,e){this.objectPanel.expand();this.actions.preview.hide();},onWebDAVLinkClick:function(b,e){var selection=this.getSelection();if(!Ext.isEmpty(selection)){var data=Ext.clone(selection[0]);data.id=data.nid;App.openWebdavDocument(data,false);}},onPermalinkClick:function(b,e){var selection=this.getSelection();if(!Ext.isEmpty(selection)){window.prompt('Copy to clipboard: Ctrl+C, Enter',window.location.origin+'/c/'+App.config.coreName+'/view/'+selection[0].nid+'/');}},onStarClick:function(b,e){var d=this.getSelection()[0],data={id:d.nid,name:d.name,iconCls:d.iconCls,pathText:this.folderProperties.pathtext,path:this.folderProperties.path+'/'+d.nid};App.Favorites.setStarred(data);},onUnstarClick:function(b,e){App.Favorites.setUnstarred(this.getSelection()[0].nid);}});;Ext.namespace('CB.browser.view');Ext.define('CB.browser.view.Interface',{extend:'Ext.Container',border:false,xtype:'CBBrowserViewInterface',viewName:'none',initComponent:function(){this.callParent(arguments);this.enableBubble(['changeparams','selectionchange','objectopen','settoolbaritems']);},getViewParams:function(){var rez={from:this.viewName};return rez;},detectSorter:function(params){var rez=null;if(params&&params.sort){var sortersGroup=CB.facet.Base.prototype.sorters[params.sort];if(sortersGroup){var dir=Ext.valueFrom(params.direction,'asc');if(dir){rez=sortersGroup[dir];}}}
return rez;}});;Ext.namespace('CB.browser.view');Ext.define('CB.browser.view.Grid',{extend:'CB.browser.view.Interface',border:false,xtype:'CBBrowserViewGrid',initComponent:function(){var editor=new Ext.form.TextField({selectOnFocus:true});editor._setValue=editor.setValue;editor.setValue=function(v){v=Ext.util.Format.htmlDecode(v);this._setValue(v);};var columns=[{header:'ID',width:80,dataIndex:'nid',sort:this.columnSortOverride,groupable:false},{header:L.Name,width:300,dataIndex:'name',renderer:function(v,m,r,ri,ci,s){m.css='icon-grid-column-top '+r.get('iconCls');if(r.get('acl_count')>0){m.css+=' node-has-acl';}
m.attr=Ext.isEmpty(v)?'':"title=\""+v+"\"";var rez='<span class="n">'+Ext.valueFrom(r.get('hl'),v)+'</span>';if((this.hideArrows!==true)&&r.get('has_childs')){rez+=' <span class="fs9">&hellip;</span>';}
return rez;},editor:editor,sort:this.columnSortOverride},{header:L.Path,width:150,dataIndex:'path',renderer:function(v,m,r,ri,ci,s){m.attr=Ext.isEmpty(v)?'':'title="'+Ext.util.Format.stripTags(v).replace(/"/g,"&quot;")+'"';return v;},sort:this.columnSortOverride},{header:L.Project,width:150,dataIndex:'case',renderer:function(v,m,r,ri,ci,s){m.attr=Ext.isEmpty(v)?'':'title="'+Ext.util.Format.stripTags(v).replace(/"/g,"&quot;")+'"';return v;},sort:this.columnSortOverride},{header:L.Date,width:120,dataIndex:'date',format:App.dateFormat+' '+App.timeFormat,renderer:function(v,m,r,ri,ci,s){return App.customRenderers.datetime(v,false);},sort:this.columnSortOverride},{header:L.Size,width:80,dataIndex:'size',renderer:App.customRenderers.filesize,sort:this.columnSortOverride},{header:L.Creator,width:200,dataIndex:'cid',renderer:function(v){return CB.DB.usersStore.getName(v);},sort:this.columnSortOverride},{header:L.Owner,width:200,dataIndex:'oid',renderer:function(v){return CB.DB.usersStore.getName(v);},sort:this.columnSortOverride},{header:L.UpdatedBy,width:200,dataIndex:'uid',renderer:function(v){return CB.DB.usersStore.getName(v);},sort:this.columnSortOverride},{header:L.CommentedBy,width:200,dataIndex:'comment_user_id',renderer:function(v){return CB.DB.usersStore.getName(v);},sort:this.columnSortOverride},{header:L.CreatedDate,width:120,dataIndex:'cdate',xtype:'datecolumn',format:App.dateFormat+' '+App.timeFormat,sort:this.columnSortOverride},{header:L.UpdatedDate,width:120,dataIndex:'udate',xtype:'datecolumn',format:App.dateFormat+' '+App.timeFormat,sort:this.columnSortOverride},{header:L.CommentedDate,width:120,dataIndex:'comment_date',xtype:'datecolumn',format:App.dateFormat+' '+App.timeFormat,sort:this.columnSortOverride}];var sm=(this.config.selModel)?this.config.selModel:new Ext.selection.RowModel({mode:'MULTI',allowDeselect:true});this.grid=new Ext.grid.Panel({loadMask:false,cls:'folder-grid',border:false,bodyStyle:{border:0},store:this.store,getProperty:this.getProperty,defaultColumns:Ext.apply([],columns),columns:columns,features:[{ftype:'cbGridViewGrouping',disabled:true,groupHeaderTpl:['{columnName}: {[Ext.valueFrom(values.children[0].get(\'groupText\'), values.children[0].get(\'group\'))]}']}],viewConfig:{forceFit:false,loadMask:false,stripeRows:false,emptyText:L.NoData,deferInitialRefresh:false,listeners:{scope:this,containermousedown:function(view,e,eOpts){var g=this.grid,sm=g.getSelectionModel(),t=e.getTarget();if((sm.selType!=='checkboxmodel')&&t){t=Ext.get(t);var s=t.getViewSize();if((e.pageX<t.getLeft()+s.width)&&(e.pageY<t.getTop()+s.height)){this.grid.getSelectionModel().deselectAll();}}}},plugins:[{ptype:'CBPluginDDFilesDropZone',pidPropety:'nid',dropZoneConfig:{text:L.GridDDMgs,onScrollerDragDrop:this.onScrollerDragDrop,scope:this}},{ptype:'CBDDGrid',idProperty:'nid',dropZoneConfig:{text:L.GridDDMgs,onContainerOver:Ext.Function.bind(this.ddOnContainerOver,this),onContainerDrop:Ext.Function.bind(this.ddOnContainerDrop,this)}}]},selModel:sm,listeners:{scope:this,columnhide:this.saveGridState,columnshow:this.saveGridState,keydown:this.onKeyDown,rowclick:this.onRowClick,rowdblclick:this.onRowDblClick,selectionchange:this.onSelectionChange,columnmove:this.saveGridState,columnresize:this.saveGridState,groupchange:this.saveGridState,sortchange:function(){this.saveGridState();},itemcontextmenu:this.onItemContextMenu,containercontextmenu:this.onContainerContextMenu},keys:[{key:Ext.event.Event.DOWN,ctrl:false,shift:false,stopEvent:true,fn:this.onDownClick,scope:this},{key:[10,13],alt:false,ctrl:false,shift:false,stopEvent:true,fn:this.onEnterKeyPress,scope:this},{key:Ext.event.Event.F2,alt:false,ctrl:false,stopEvent:true,fn:this.onRenameClick,scope:this}],bbar:{xtype:'CBBrowserViewGridPagingToolbar',store:this.store,hidden:!Ext.isEmpty(this.hideBottomBar),doRefresh:this.onReloadClick.bind(this)},plugins:[{ptype:'cellediting',clicksToEdit:1,listeners:{scope:this,beforeedit:function(e){if(!this.allowRename){return false;}
delete this.allowRename;return true;},edit:function(editor,context,eOpts){var encodedValue=Ext.util.Format.htmlEncode(context.value);context.record.set('name',encodedValue);if(encodedValue==context.originalValue){return;}
this.renamedOriginalValue=context.originalValue;this.renamedRecord=context.record;CB_BrowserView.rename({path:context.record.get('nid'),name:context.value},function(r,e){if(!r||(r.success!==true)){this.renamedRecord.set('name',this.renamedOriginalValue);delete this.renamedOriginalValue;delete this.renamedRecord;return;}
this.renamedRecord.set('name',r.data.newName);delete this.renamedOriginalValue;delete this.renamedRecord;App.fireEvent('objectchanged',{id:parseInt(r.data.id,10),pid:this.refOwner.folderProperties.id},e);},this);}}}]});this.grid.view.on('refresh',function(view){view.scrollTo(0,0,false);},this);Ext.apply(this,{title:L.Explorer,header:false,layout:'fit',viewName:'grid',items:[this.grid]});this.callParent(arguments);this.store.on('beforeload',this.onBeforeStoreLoad,this);this.store.on('load',this.onStoreLoad,this);this.enableBubble(['reload','itemcontextmenu']);},columnSortOverride:function(direction){var me=this,grid=me.up('tablepanel'),store=grid.store;if(store.remoteSort){grid.userSort=1;}else{}
Ext.grid.column.Column.prototype.sort.apply(this,arguments);},updateToolbarButtons:function(){this.refOwner.fireEvent('settoolbaritems',['create','upload','download','-','edit','delete','->','reload','apps','-','more']);},onBeforeStoreLoad:function(store,operation,eOpts){this.savedSelection=this.getSelectedItems();this.grid.getSelectionModel().suspendEvents();},onStoreLoad:function(store,recs,successful,options){if(!this.rendered||!this.getEl().isVisible(true)||(successful!==true)){return;}
delete this.grid.userSort;var hadSelection=false,prevSelectedId=0,prevSelectedPid=0,locateId=Ext.valueFrom(this.refOwner.params,{}).locatingObject;if(!Ext.isEmpty(this.savedSelection)){hadSelection=true;prevSelectedId=this.savedSelection[0].nid;prevSelectedPid=this.savedSelection[0].pid;}
if(!Ext.isEmpty(locateId)){this.savedSelection=[{nid:locateId}];}
if(!Ext.isEmpty(this.savedSelection)){this.selectItems(this.savedSelection);}
this.grid.getSelectionModel().resumeEvents(true);if(Ext.isEmpty(locateId)){var haveSelection=this.grid.getSelectionModel().hasSelection(),currSelectedId=haveSelection?this.grid.getSelection()[0].get('nid'):0,currSelectedPid=Ext.valueFrom(this.refOwner.folderProperties,{}).id;if((prevSelectedPid!=currSelectedPid)||(haveSelection&&(prevSelectedId!=currSelectedId))){this.fireSelectionChangeEvent();}}else{delete this.refOwner.params.locatingObject;}
this.updateToolbarButtons();var noRecords=Ext.isEmpty(recs),params=options.request?options.request.config.params:{},filters=params.filters,emptyFilters=Ext.isEmpty(filters)||Ext.Object.isEmpty(filters),emptyText=(emptyFilters&&Ext.isEmpty(params.query)&&Ext.isEmpty(params.search))?L.GridEmptyText:L.NoResultsFound;this.grid.view.emptyText='<div class="gv-empty-text"><div class="middle"><div class="inner">'+emptyText+'</div></div></div>';this.grid.view.refresh();},ddOnContainerOver:function(source,e,data){var d,currentPid=this.refOwner.folderProperties.id,rez=source.dropAllowed;for(var i=0;i<data.records.length;i++){d=data.records[i].data;if(d['pid']==currentPid){rez=source.dropNotAllowed;}}
return rez;},ddOnContainerDrop:function(source,e,data){if(this.ddOnContainerOver(source,e,data)==source.dropAllowed){this.onScrollerDragDrop(this.refOwner.folderProperties,source,e,data);}},onScrollerDragDrop:function(targetData,source,e,data){var d,sourceData=[];for(var i=0;i<data.records.length;i++){d=data.records[i].data;sourceData.push({id:d['nid'],name:d['name'],path:d['path'],template_id:d['template_id']});}
App.DD.execute({action:e,targetData:this.refOwner.folderProperties,sourceData:sourceData});},getSelectedItems:function(){var s=this.grid.getSelectionModel().getSelection();for(var i=0;i<s.length;i++){s[i]=s[i].data;}
return s;},selectItems:function(itemsArray){if(itemsArray&&itemsArray.length){var rs=[],r,j=0,l=itemsArray.length;for(;j<l;j++){r=this.store.findRecord('nid',itemsArray[j].nid);if(r){rs.push(r);}}
if(rs.length){this.grid.getSelectionModel().select(rs,false,true);}}
delete this.savedSelection;},fireSelectionChangeEvent:function(){this.fireEvent('selectionchange',this.getSelectedItems());},onKeyDown:function(e){if([9,38,40].indexOf(e.getKey())>-1){this.userAction=true;}},onRowClick:function(g,ri,e){this.userAction=true;this.fireSelectionChangeEvent();},onRowDblClick:function(g,record,tr,rowIndex,e,eOpts){this.fireEvent('objectopen',g.store.getAt(rowIndex).data);},onSelectionChange:function(){if(!App.mouseDown||(App.lastMouseButton!==0)){this.fireSelectionChangeEvent();}},onEnterKeyPress:function(key,e){if(this.grid.selModel.hasSelection()){var s=this.grid.selModel.getSelections();this.onRowDblClick(this.grid,this.store.indexOf(s[0]),e);}},onDownClick:function(key,e){if(!this.grid.selModel.hasSelection()||(this.grid.store.getCount()<1)){return false;}
this.grid.selModel.select(0);},onRenameClick:function(b,e){if(!this.grid.selModel.hasSelection()){return;}
this.grid.editingPlugin.cancelEdit();this.allowRename=true;var selection=this.grid.selModel.getSelection(),valueCol=this.grid.headerCt.child('[dataIndex="name"]'),colIdx=valueCol.getIndex();if(!Ext.isEmpty(selection)){this.grid.editingPlugin.startEdit(selection[0],colIdx);}},onReloadClick:function(){this.fireEvent('reload',this);},saveGridState:function(){if(this.store.clearing||(this.grid.disableStateSave&&Ext.isEmpty(this.store.proxy.extraParams.userGroup))){return false;}
var state=this.grid.getState();if(!Ext.isEmpty(state.group)){if(Ext.isEmpty(state.group.property)){state.group.property=this.store.getGroupField();}}
CB_State_DBProvider.saveGridViewState({params:this.refOwner.params,state:state});return state;},getViewParams:function(){var rez=this.callParent(arguments);if(this.grid.userSort){rez.userSort=1;}
return rez;},onItemContextMenu:function(grid,record,item,index,e,eOpts){this.fireEvent('itemcontextmenu',e);},onContainerContextMenu:function(grid,e,eOpts){this.fireEvent('itemcontextmenu',e);}});;Ext.namespace('CB.browser.view');Ext.define('CB.browser.view.ActivityStream',{extend:'CB.browser.view.Interface',xtype:'CBBrowserViewActivityStream',border:false,tbarCssClass:'x-panel-white',initComponent:function(){var tpl=new Ext.XTemplate('<div class="taC"><table class="activity-stream">','<tpl for=".">','<tpl if="lastAction">','<tr class="as-record">','    <td>','      <div class="as-item">','        <table class="action">','          <tr>','            <td class="action-icon">{[this.getTitleIcon(values)]}</td>','            <td class="action-title">{[this.getTitle(values)]}</td>','          </tr>','          <tr>','            <td class="action-text" colspan="2">','               <table>','                  <tr>','                    <td>{[this.getContent(values)]}</td>','                 </tr>','               </table>','            </td>','          </tr>','        </table>','      </div>','      <div class="action-comments" id="as-record-{nid}">','      </div>','    </td>','</tr>','</tpl>','</tpl>','</table>{[this.getNextButton(this, values)]}</div>',{getTitleIcon:function(r){var uid=r.lastAction.uids[0],us=CB.DB.usersStore,rez='<img class="i40" src="'+
App.config.photoPath+uid+'.jpg?32='+
us.getPhotoParam(uid)+'" title="'+
us.getName(uid)
+'">';return rez;},getTitle:function(r){var rez='<div class="action-title-text">',la=r.lastAction,us=CB.DB.usersStore,users=[];for(var i=0;i<la.uids.length;i++){users.push(' <b>'+us.getName(la.uids[i])+'</b> ');}
switch(users.length){case 0:break;case 1:rez+=users[0];break;case 2:rez+=users[0]+L.and+users[1];break;case 3:rez+=users[0]+', '+users[1]+L.and+users[2];break;default:rez+=users[0]+', '+users[1]+L.and+' '+Ext.valueFrom(L.NNOthers,'{count} others').replace('{count}',users.length-1);}
switch(la.type){case'copy':rez+=' '+Ext.valueFrom(L['copied'],la.type);break;case'comment':rez+=' '+Ext.valueFrom(L[la.type+'ed'],la.type);break;default:rez+=' '+Ext.valueFrom(L[la.type+'d'],la.type);}
rez+=' <a class="click open-obj" nid="'+r.nid+'">'+r.name+'</a></div>';rez+=' <div class="as-ago-time">'+la.agoText+'</div>';return rez;},getContent:function(r){return r['diff'];},getNextButton:Ext.bind(function(){var rez='<div class="asNext click" style="display:none"><span>'+
L.Next+' </span><span class="dIB i16 i-arrow-right"></span></div>';return rez;},this)});this.dataView=new Ext.DataView({tpl:tpl,store:this.store,deferInitialRefresh:false,itemSelector:'tr.as-record',focusCls:'',scrollable:true,listeners:{scope:this,selectionchange:this.onSelectionChange,beforecontainermousedown:this.onBeforeContainerMouseDown}});Ext.apply(this,{title:L.ActivityStream,viewName:'activityStream',header:false,layout:'fit',style:'background-color: #e9eaed',items:[this.dataView],listeners:{scope:this,activate:this.onActivate}});this.store.on('load',this.onStoreLoad,this,{defer:300});this.callParent(arguments);},updateToolbarButtons:function(){this.refOwner.fireEvent('settoolbaritems',['create','upload','download','-','edit','delete','->','reload','apps','-','more']);},onSelectionChange:function(view,selected,eOpts){var recs=[];for(var i=0;i<selected.length;i++){recs.push(selected[i].data);}
if(!Ext.isEmpty(recs)){this.fireEvent('selectionchange',recs);}},onStoreLoad:function(store,records,successful,eOpts){var visible=this.getEl().isVisible(true);if(visible){this.addCommentPlugins();}},addCommentPlugins:function(){var ready=(this.store.getCount()===0);this.store.each(function(r){var id=r.get('nid'),recEl=Ext.get('as-record-'+id);ready=ready||!Ext.isEmpty(recEl);if(r.data.lastAction&&!Ext.isEmpty(recEl)){var c=Ext.create('CBObjectPluginComments',{params:{id:id},header:false,renderTo:'as-record-'+id,showAddLabel:'label',commentFieldConfig:{xtype:'CBFieldCommentLight'}});c.onLoadData(r.data.comments);}},this);if(ready){var el=this.dataView.getEl().down('.asNext'),s=this.store,p=s.proxy,start=Ext.valueFrom(p.extraParams.start,0),total=p.reader.rawData.total,rez='';if(el&&(total>0)&&(start+s.getCount()<total)){el.setStyle('display','inherit');}
this.dataView.scrollTo(0,0,false);}else{Ext.defer(this.addCommentPlugins,200,this);}},onBeforeContainerMouseDown:function(dv,e,eOpts){var el=e.getTarget('.asNext');if(el){e.stopEvent();this.fireEvent('changeparams',{start:Ext.valueFrom(this.store.proxy.extraParams.start,0)+this.store.getCount()});}},onContainerReloadClick:function(params){delete params.start;delete params.page;},onActivate:function(){this.fireEvent('settoolbaritems',[,'->','reload','apps','-','more']);}});;Ext.namespace('CB.browser.view.grid.toolbar');Ext.define('CB.browser.view.grid.toolbar.Paging',{extend:'Ext.toolbar.Paging',xtype:'CBBrowserViewGridPagingToolbar',border:false,displayInfo:true,displayMsg:'{0} - {1} of {2}',initComponent:function(){var me=this;this._getPagingItems=this.getPagingItems;this.getPagingItems=this.getCustomizedPaginItems;this.setCustomItems();me.callParent();this.enableBubble('exportrecords');},getCustomizedPaginItems:function(){var rez=this._getPagingItems();rez.shift();rez.pop();rez.pop();rez.pop();rez.splice(1,1);rez.splice(4,1);return rez;},setCustomItems:function(){var me=this;},onGridReconfigure:function(grid,store,columns,oldStore,oldColumns,eOpts){clog('columns',arguments);}});;Ext.namespace('CB.browser.view.grid.feature');Ext.define('CB.browser.view.grid.feature.Grouping',{extend:'Ext.grid.feature.Grouping',alias:'feature.cbGridViewGrouping',storeExtraParams:{},init:function(){this.callParent(arguments);var me=this,view=me.view,store=view.store;store.on('beforeload',this.onBeforeStoreLoad,this);store.on('load',this.onStoreLoad,this,{delay:200});},onStoreLoad:function(store,operation,eOpts){delete store.proxy.extraParams.userGroup;delete this.storeExtraParams.userGroup;},onBeforeStoreLoad:function(store,operation,eOpts){Ext.apply(store.proxy.extraParams,this.storeExtraParams);},onGroupMenuItemClick:function(menuItem,e){var me=this,menu=menuItem.parentMenu,hdr=menu.activeHeader,sgf,view=me.view,store=view.store;if(hdr&&store.remoteSort){sgf=hdr.dataIndex;this.groupTitle=hdr.text;this.storeExtraParams={userGroup:1,sourceGroupField:sgf};hdr.dataIndex='group';}
this.callParent(arguments);if(hdr){hdr.dataIndex=sgf;}},setupRowData:function(record,idx,rowValues){this.callParent(arguments);if(rowValues.isFirstRow){if(this.refreshData.header){this.lastColumnTitle=this.refreshData.header.text;}
rowValues.groupInfo.columnName=this.lastColumnTitle;}},getGroupedHeader:function(groupField){var rez=this.callParent([Ext.valueFrom(this.storeExtraParams.sourceGroupField,groupField)]);return rez;},disable:function(){var me=this,view=me.view,store=view.store;store.remoteSort=false;this.callParent(arguments);store.remoteSort=true;}});;Ext.namespace('CB.browser.view');Ext.define('CB.browser.view.CalendarPanel',{extend:'CB.browser.view.Interface',border:false,closable:true,layout:'fit',initComponent:function(){this.view=new CB.browser.view.Calendar();Ext.apply(this,{items:this.view});this.callParent(arguments);}});Ext.define('CB.Calendar',{extend:'Ext.calendar.CalendarPanel',activeItem:2,border:false,monthViewCfg:{showHeader:true,showWeekLinks:true,showWeekNumbers:false},showNavBar:true,params:{},initComponent:function(){this.calendarStore=Ext.create('Ext.calendar.data.MemoryCalendarStore',{data:{"calendars":[{id:1,title:"CaseBox"}]}});this.eventStore=Ext.create('Ext.calendar.data.MemoryEventStore',{autoLoad:false,autoDestroy:true});this.eventsReloadTask=new Ext.util.DelayedTask(this.doReloadEventsStore,this);Ext.apply(this,{listeners:{scope:this,eventclick:function(vw,rec,el){this.showEditWindow(rec,el);this.clearMsg();},eventover:function(vw,rec,el){},eventout:function(vw,rec,el){},eventadd:function(cp,rec){this.showMsg('Event '+rec.data.Title+' was added');},eventupdate:function(cp,rec){this.showMsg('Event '+rec.data.Title+' was updated');},eventdelete:function(cp,rec){this.eventStore.remove(rec);this.showMsg('Event '+rec.data.Title+' was deleted');},eventcancel:function(cp,rec){},viewchange:function(p,vw,dateInfo){if(this.getEl().isVisible(true)!==true){return;}
if(this.editWin){this.editWin.hide();}
if(dateInfo!==null){this.updateTitle(dateInfo,vw);this.eventsReloadTask.delay(200);}},dayclick:function(vw,dt,ad,el){this.showEditWindow({StartDate:dt,IsAllDay:ad},el);this.clearMsg();},initdrag:function(vw){}}});this.callParent(arguments);this.enableBubble(['objectopen','changeparams','reload']);},doReloadEventsStore:function(){this.allowedReload=true;if(Ext.isEmpty(this.getLayout().activeItem)){return;}
var bounds=this.getLayout().activeItem.getViewBounds();var p={};bounds.end.setHours(23);bounds.end.setMinutes(59);bounds.end.setSeconds(59);bounds.end.setMilliseconds(999);p.dateStart=Ext.Date.format(bounds.start,'Y-m-d')+'T00:00:00.000Z';p.dateEnd=Ext.Date.format(bounds.end,'Y-m-d')+'T23:59:59.999Z';Ext.apply(this.params,p);this.fireEvent('reload',this);},showEditWindow:function(rec,animateTarget){if(Ext.isEmpty(rec.data)){return;}
var s=[{nid:rec.data.EventId,template_id:rec.data.template_id,name:rec.data.Title}];this.fireEvent('selectionchange',s);},showMsg:function(msg){},clearMsg:function(){},updateTitle:function(dateInfo,view){if(Ext.isEmpty(this.titleItem)){return;}
if(Ext.isEmpty(view)){view=this.getLayout().activeItem;dateInfo=view.getViewBounds();}else if(Ext.isEmpty(dateInfo)){dateInfo=view.getViewBounds();}
var sd=dateInfo.viewStart,ed=dateInfo.viewEnd,ad=dateInfo.activeDate,text='';switch(view.xtype){case'dayview':text=Ext.Date.format(ad,'F j, Y');break;case'weekview':if(sd.getFullYear()==ed.getFullYear()){if(sd.getMonth()==ed.getMonth()){text=Ext.Date.format(sd,'F j')+' - '+Ext.Date.format(ed,'j, Y');}else{text=Ext.Date.format(sd,'F j')+' - '+Ext.Date.format(ed,'F j, Y');}}else{text=Ext.Date.format(sd,'F j, Y')+' - '+Ext.Date.format(ed,'F j, Y');}
break;case'monthview':text=Ext.Date.format(ad,'F Y');break;}
this.titleItem.text=text;this.titleItem.setText(text);}});Ext.define('CB.browser.view.Calendar',{extend:'CB.browser.view.Interface',xtype:'CBBrowserViewCalendar',layout:'border',closable:true,border:false,tbarCssClass:'x-panel-white',folderProperties:{},initComponent:function(){this.titleItem=new Ext.toolbar.TextItem({id:'caltitle',cls:'calendar-title',text:'<span style="font-size: 16px; font-weight: bold; color: #333"> &nbsp; </span>'});var viewGroup=Ext.id();this.coloringCombo=new Ext.form.ComboBox({xtype:'combo',itemId:'coloringCombo',selectedFacetIndex:0,forceSelection:true,editable:false,triggerAction:'all',lazyRender:true,queryMode:'local',fieldLabel:L.ColoringBy,labelWidth:'auto',style:'margin-right: 10px',store:new Ext.data.JsonStore({model:'Generic2'}),displayField:'name',valueField:'id',listeners:{scope:this,select:this.onColoringComboChange}});this.calendar=new CB.Calendar({titleItem:this.titleItem,region:'center',border:false,showNavBar:false,listeners:{scope:this,rangeselect:this.onRangeSelect,dayclick:this.onDayClick,selectionchange:this.onSelectionChange,eventmove:function(vw,rec){this.updateRecordDatesRemotely(rec);},eventresize:function(vw,rec){this.updateRecordDatesRemotely(rec);},viewchange:function(cmp,view){var BC=this.refOwner.buttonCollection;BC.get(view.xtype).setPressed(true);}}});if(this.store){this.store.on('load',this.onMainStoreLoad,this);}
this.refOwner.buttonCollection.addAll(new Ext.Button({text:L.Day,itemId:'dayview',enableToggle:true,allowDepress:false,scale:'medium',toggleGroup:'cv'+viewGroup,scope:this.calendar,handler:this.calendar.onDayClick}),new Ext.Button({text:L.Week,itemId:'weekview',enableToggle:true,allowDepress:false,scale:'medium',toggleGroup:'cv'+viewGroup,scope:this.calendar,handler:this.calendar.onWeekClick}),new Ext.Button({text:L.Month,itemId:'monthview',enableToggle:true,allowDepress:false,scale:'medium',toggleGroup:'cv'+viewGroup,pressed:true,scope:this.calendar,handler:this.calendar.onMonthClick}),new Ext.Button({itemId:'calprev',iconCls:'im-arr-l',scale:'medium',scope:this.calendar,handler:this.calendar.onPrevClick}),new Ext.Button({itemId:'calnext',iconCls:'im-arr-r',scale:'medium',scope:this.calendar,handler:this.calendar.onNextClick}),this.titleItem,this.coloringCombo);Ext.apply(this,{title:L.Calendar,items:this.calendar,listeners:{scope:this,activate:this.onActivate}});this.callParent(arguments);this.enableBubble(['createobject','reload']);},getViewParams:function(){var p={from:'calendar',selectedColoring:this.selectedColoring};Ext.apply(p,this.calendar.params);return p;},onMainStoreLoad:function(store,records,options){var el=this.getEl();if(Ext.isEmpty(el)||!el.isVisible(true)){return;}
this.loadColoringFacets();var data=[];store.each(function(r){var d=r.data;d.date=Ext.valueFrom(d.date,d.date_end);var sd=App.customRenderers.datetime(d.date);var ed=App.customRenderers.datetime(d.date_end);var ad=((sd.length<11)&&(ed.length<11));if(!Ext.isEmpty(d.date)){data.push({EventId:d.nid,IsAllDay:ad,category_id:d.category_id,CalendarId:1,StartDate:d.date,EndDate:Ext.valueFrom(d.date_end,d.date),task_status:d.task_status,template_id:d.template_id,Title:d.name,cls:d.cls,style:d.style});}},this);this.calendar.eventStore.loadData(data);},loadColoringFacets:function(){var rawData=this.store.proxy.reader.rawData,vp=Ext.valueFrom(rawData.view,{}),coloring=Ext.valueFrom(vp.coloring,[]),data=[];if(Ext.isEmpty(this.selectedColoring)){this.selectedColoring=vp.defaultColoring;}
Ext.iterate(rawData.facets,function(key,val,o){if(coloring.indexOf(val.f)>-1){data.push({id:val.f,name:val.title});if(Ext.isEmpty(this.selectedColoring)){this.selectedColoring=val.f;}}},this);this.coloringCombo.store.loadData(data);this.coloringCombo.setValue(this.selectedColoring);this.coloringCombo.setHidden(this.coloringCombo.store.getCount()<2);},onColoringComboChange:function(c,rec,eOpts){this.selectedColoring=c.getValue();this.fireEvent('reload',this);},onChangeViewClick:function(){},onRangeSelect:function(c,range,callback){var allday=((Ext.Date.format(range.StartDate,'H:i:s')==='00:00:00')&&(Ext.Date.format(range.EndDate,'H:i:s')==='23:59:59'))?1:-1;var prefix=(allday==1)?'date':'datetime';var data={pid:this.refOwner.folderProperties.id,template_id:App.config.default_task_template,data:{allday:{value:allday,childs:{}}}};data.data.allday.childs[prefix+'_start']=range.StartDate;data.data.allday.childs[prefix+'_end']=range.EndDate;this.fireEvent('createobject',data);callback();},onDayClick:function(c,date,ad,el){var allday=(Ext.Date.format(date,'H:i:s')==='00:00:00')?1:-1;var prefix=(allday==1)?'date':'datetime';var data={pid:this.refOwner.folderProperties.id,template_id:App.config.default_task_template,data:{allday:{value:allday,childs:{date_start:date}}}};data.data.allday.childs[prefix+'_start']=date;this.fireEvent('createobject',data);},onActivate:function(){this.fireEvent('settoolbaritems',[,'calprev','calnext','caltitle','->','coloringCombo','dayview','weekview','monthview','-','reload','apps','-','more']);this.calendar.fireViewChange();},onSelectionChange:function(selection){if(selection){var data=Ext.isArray(selection)?data=selection[0]:selection;this.fireEvent('openobject',data);}},updateRecordDatesRemotely:function(record){var dateEnd=date_local_to_ISO_string(record.get('EndDate'));if(this.store){var r=this.store.findRecord('nid',record.get('EventId'),0,false,true,true);if(r){if(Ext.isEmpty(r.get('date_end'))){dateEnd=null;}}}
CB_Tasks.updateDates({id:record.get('EventId'),date_start:date_local_to_ISO_string(record.get('StartDate')),date_end:date_local_to_ISO_string(dateEnd)},function(r,e){if(!r||(r.success!==true)){this.reject();}else{this.commit();}},record);}});;Ext.namespace('CB.browser.view');Ext.define('CB.browser.view.Charts',{extend:'CB.browser.view.Interface',xtype:'CBBrowserViewCharts',border:false,tbarCssClass:'x-panel-white',layout:'border',params:{from:'charts',facets:'general'},initComponent:function(){this.instanceId=this.refOwner.instanceId;this.facetsCombo=new Ext.form.ComboBox({xtype:'combo',itemId:'facetscombo',forceSelection:true,triggerAction:'all',lazyRender:true,queryMode:'local',fieldLabel:'Facets',cls:'fs12',labelWidth:'auto',editable:false,store:new Ext.data.JsonStore({model:'Generic2',data:[]}),displayField:'name',valueField:'id',listeners:{scope:this,select:this.onFacetChange}});this.sortButton=new Ext.Button({itemId:'chartsSortButton',scale:'medium',iconCls:'im-sort',style:'margin-left: 10px',text:'',menu:[{text:L.SortByNameAsc,sort:'name',direction:'asc',scope:this,handler:this.onSortButtonClick},{text:L.SortByNameDesc,sort:'name',direction:'desc',scope:this,handler:this.onSortButtonClick},{text:L.SortByCountAsc,sort:'count',direction:'asc',scope:this,handler:this.onSortButtonClick},{text:L.SortByCountDesc,sort:'count',direction:'desc',scope:this,handler:this.onSortButtonClick}]});this.showLegendMenuItem=Ext.create({xtype:'menucheckitem',text:L.ShowLegend,checked:true,listeners:{scope:this,checkchange:this.onShowLegendClick}});this.refOwner.buttonCollection.addAll(new Ext.Button({text:L.Bar,itemId:'barchart',scale:'medium',enableToggle:true,allowDepress:false,toggleGroup:'cv'+this.instanceId,scope:this,handler:this.onChangeChartClick}),new Ext.Button({text:L.Column,itemId:'columnchart',scale:'medium',enableToggle:true,allowDepress:false,toggleGroup:'cv'+this.instanceId,scope:this,handler:this.onChangeChartClick}),new Ext.Button({text:L.Pie,scale:'medium',itemId:'piechart',enableToggle:true,allowDepress:false,toggleGroup:'cv'+this.instanceId,scope:this,handler:this.onChangeChartClick}),this.facetsCombo,this.sortButton,new Ext.Button({text:L.Options,itemId:'CVOptionsButton',scale:'medium',menu:[this.showLegendMenuItem]}));this.chartBlock=new CB.widget.block.Chart({region:'center',scrollable:true,border:false,listeners:{scope:this,itemclick:this.onChartItemClick}});Ext.apply(this,{title:L.Charts,header:false,layout:'fit',items:[this.chartBlock],listeners:{scope:this,activate:this.onActivate}});this.callParent(arguments);this.currentButton=this.refOwner.buttonCollection.get('barchart');this.selectedFacets=[];this.store.on('load',this.onStoreLoad,this);},getViewParams:function(){return this.params;},onActivate:function(){this.selectedFacets=[];this.fireEvent('settoolbaritems',['facetscombo','chartsSortButton','->','barchart','columnchart','piechart','-','CVOptionsButton','-','reload','apps','-','more']);},onChangeChartClick:function(b,e){this.chartData.charts=[b.itemId.split('chart').shift()];this.onChangeChart();this.chartBlock.changeCharts(this.chartData.charts);},onChangeChart:function(){var BC=this.refOwner.buttonCollection,ch=this.chartData.charts;BC.get('barchart').toggle(ch.indexOf('bar')>-1,true);BC.get('columnchart').toggle(ch.indexOf('column')>-1,true);BC.get('piechart').toggle(ch.indexOf('pie')>-1,true);},onStoreLoad:function(store,recs,successful,eOpts){if(!this.rendered||!this.getEl().isVisible(true)||(successful!==true)){return;}
this.loadRemoteData(store.proxy.reader.rawData);},loadRemoteData:function(rd){var selectedValues={charts:['bar']};rd.sorter=this.detectSorter((rd.sort&&rd.direction)?rd:Ext.valueFrom(rd.view,{}));if(this.chartData){if(this.selectedFacets){selectedValues={facet:this.selectedFacets[0]};}
selectedValues.charts=this.chartData.charts;}
this.chartData=this.chartBlock.loadData(rd,selectedValues);this.selectedFacets=[this.chartData.facet];this.loadAvailableFacets(rd.facets);this.onChangeChart();},loadAvailableFacets:function(facets){var data=[];Ext.iterate(facets,function(key,val,o){data.push({id:key,name:Ext.htmlDecode(Ext.valueFrom(val['title'],L['facet_'+key]))});},this);var st=this.facetsCombo.store;st.removeAll();st.loadData(data);this.facetsCombo.setValue(this.selectedFacets[0]);},onChartItemClick:function(o,event){var params={view:'grid',filters:Ext.apply({},this.store.extraParams.filters)};var filterBy=this.facetsCombo.getValue();params['filters'][filterBy]=[{f:filterBy,mode:'OR',values:[o.storeItem.get('id')]}];this.fireEvent('changeparams',params);},onFacetChange:function(combo,records,index){var record=Ext.isArray(records)?records[0]:records;this.selectedFacets[0]=record.get('id');this.loadRemoteData(this.store.proxy.reader.rawData);},onSortButtonClick:function(b,e){var rd=this.store.proxy.reader.rawData;rd.sort=b.sort;rd.direction=b.direction;this.loadRemoteData(rd);this.sortButton.setText(b.text);},detectSorter:function(params){if(Ext.isEmpty(params.sort)){params.sort='name';}
if(Ext.isEmpty(params.direction)){params.direction='asc';}
var translationIndex='SortBy'+Ext.String.capitalize(params.sort)+Ext.String.capitalize(params.direction);this.sortButton.setText(L[translationIndex]);return this.callParent(arguments);},onShowLegendClick:function(cb,checked,eOpts){this.chartBlock.setLegendVisible(checked);this.chartBlock.changeCharts(this.chartData.charts);}});;Ext.namespace('CB.browser.view');Ext.define('CB.browser.view.Dashboard',{extend:'CB.browser.view.Interface',xtype:'CBBrowserViewDashboard',border:false,tbarCssClass:'x-panel-white',scrollable:true,initComponent:function(){Ext.apply(this,{title:L.Dashboard,viewName:'dashboard',header:false,layout:{type:'table',columns:1,tableAttrs:{style:{width:'100%'}}},defaults:{bodyPadding:5,cellCls:'vaT taC'},items:[],listeners:{scope:this,activate:this.onActivate}});this.store.on('load',this.onStoreLoad,this,{defer:300});this.callParent(arguments);},updateToolbarButtons:function(){this.refOwner.fireEvent('settoolbaritems',['->','reload','apps','-','more']);},onStoreLoad:function(store,records,successful,eOpts){var visible=this.getEl().isVisible(true);if(!visible){return;}
var rd=store.proxy.reader.rawData,vc=rd.view;this.rawData=rd;this.removeAll(true);this.getLayout().columns=Ext.valueFrom(vc.columns,1);this.addItems();this.updateLayout();},addItems:function(){var vc=this.rawData.view;Ext.iterate(vc.items,function(k,v){var className='CB.widget.block.Base',cfg={params:v,data:this.rawData.blockData[k]};if(!Ext.isEmpty(v.tpl)){className='CB.widget.block.Template';}else if(['map','pivot','chart','grid'].indexOf(v.type)>-1){className='CB.widget.block.'+Ext.String.capitalize(v.type);}
Ext.copyTo(cfg,v,'title,cellCls,rowspan,colspan,width,height,minWidth,minHeight,maxWidth,maxHeight');this.add(Ext.create(className,cfg));},this);},onActivate:function(){this.fireEvent('settoolbaritems',['->','reload','apps','-','more']);}});;Ext.namespace('CB.browser.view');Ext.define('CB.browser.view.Map',{extend:'CB.browser.view.Interface',xtype:'CBBrowserViewMap',border:false,tbarCssClass:'x-panel-white',viewParams:{},initComponent:function(){this.mapPanel=Ext.create('CB.LeafletPanel',{listeners:{scope:this,mapready:this.onMapReady}});Ext.apply(this,{title:L.Map,viewName:'map',header:false,layout:'fit',style:'background-color: #e9eaed',items:[this.mapPanel],listeners:{scope:this,activate:this.onActivate}});this.store.on('load',this.onStoreLoad,this,{defer:300});this.callParent(arguments);},updateToolbarButtons:function(){this.refOwner.fireEvent('settoolbaritems',['->','reload','apps','-','more']);},onStoreLoad:function(store,records,successful,eOpts){var visible=this.getEl().isVisible(true);},addItems:function(){var ready=(this.store.getCount()===0);this.store.each(function(r){var v=r.data[this.viewParams.field];if(Ext.isString(v)){var a=v.split(','),marker=LL.marker([a[0],a[1]],{icon:LL.icon({iconUrl:'/css/i/marker.png',iconSize:[25,41],iconAnchor:[12,40],popupAnchor:[0,-35]})}).addTo(this.mapPanel.map);marker.bindPopup(r.get('name'));}},this);},onActivate:function(){this.fireEvent('settoolbaritems',['->','reload','apps','-','more']);if(this.mapReady){this.onMapReady(this.mapPanel);}},onMapReady:function(p){p.setViewConfig(Ext.valueFrom(this.viewParams,{}));this.mapReady=true;this.addItems();}});;Ext.namespace('CB.browser.view');Ext.define('CB.browser.view.Pivot',{extend:'CB.browser.view.Interface',xtype:'CBBrowserViewPivot',border:false,tbarCssClass:'x-panel-white',layout:'border',scrollable:true,initComponent:function(){this.params=Ext.apply({from:'pivot'},this.params||{});this.rowsCombo=new Ext.form.ComboBox({xtype:'combo',itemId:'PVrowsCombo',selectedFacetIndex:0,forceSelection:true,editable:false,triggerAction:'all',lazyRender:true,queryMode:'local',fieldLabel:L.Rows,labelWidth:'auto',style:'margin-right: 10px',store:new Ext.data.JsonStore({model:'Generic2'}),displayField:'name',valueField:'id',listeners:{scope:this,select:this.onFacetChange}});this.colsCombo=new Ext.form.ComboBox({xtype:'combo',itemId:'PVcolsCombo',selectedFacetIndex:1,forceSelection:true,editable:false,triggerAction:'all',lazyRender:true,queryMode:'local',fieldLabel:L.Columns,labelWidth:'auto',store:new Ext.data.JsonStore({model:'Generic2'}),displayField:'name',valueField:'id',listeners:{scope:this,select:this.onFacetChange}});this.showLegendMenuItem=Ext.create({xtype:'menucheckitem',text:L.ShowLegend,checked:true,listeners:{scope:this,checkchange:this.onShowLegendClick}});this.refOwner.buttonCollection.addAll(new Ext.form.Label({text:'Stats',itemId:'PVStatsLabel'}),new Ext.Button({text:'Stats',itemId:'PVStatsButton',scale:'medium',menu:[]}),new Ext.Button({text:L.View,itemId:'PVViewButton',scale:'medium',menu:[{qtip:L.Pivot,text:L.Pivot,itemId:'PVtable',scale:'medium',chart:'table',scope:this,handler:this.onChangeChartButtonClick},{qtip:L.ChartArea,text:L.Bar,itemId:'PVbarchart',scale:'medium',chart:'stackedBars',scope:this,handler:this.onChangeChartButtonClick},{qtip:L.ChartArea,text:L.Column,itemId:'PVcolumnchart',scale:'medium',chart:'stackedColumns',scope:this,handler:this.onChangeChartButtonClick}]}),new Ext.Button({text:L.Options,itemId:'PVOptionsButton',scale:'medium',menu:[this.showLegendMenuItem,{text:L.Export,scope:this,handler:this.onExportButtonClick}]}),this.colsCombo,this.rowsCombo);this.chartBlock=new CB.widget.block.Pivot({region:'center',scrollable:true,border:false,listeners:{scope:this,filterclick:this.onTableCellFilterClick}});Ext.apply(this,{title:L.Pivot,header:false,items:this.chartBlock,listeners:{scope:this,activate:this.onActivate,deactivate:this.onDeactivate}});this.callParent(arguments);this.enableBubble(['reload']);this.selectedFacets=[];this.store.on('load',this.onStoreLoad,this);},getViewParams:function(){this.params.selectedFacets=this.selectedFacets;this.params.selectedStat=this.selectedStat;return this.params;},onActivate:function(){this.selectedFacets=[];delete this.chartData;delete this.selectedStat;this.fireEvent('settoolbaritems',['PVrowsCombo','PVcolsCombo','->','PVStatsLabel','PVStatsButton','-','PVViewButton','-','PVOptionsButton','-','reload','apps','-','more']);},onDeactivate:function(){this.chartBlock.changeCharts([]);},onChangeChartButtonClick:function(b,e){this.chartData.charts=[b.config.chart];this.onChangeChart();},onChangeChart:function(){var BC=this.refOwner.buttonCollection,ch=this.chartData.charts,vb=BC.get('PVViewButton');this.chartBlock.setLegendVisible(this.showLegendMenuItem.checked);this.chartBlock.changeCharts(ch);},onStoreLoad:function(store,recs,successful,eOpts){if(!this.rendered||!this.getEl().isVisible(true)||(successful!==true)){return;}
var rd=store.proxy.reader.rawData,selectedValues={};if(this.chartData){if(this.selectedFacets){selectedValues={xfield:this.selectedFacets[0],yfield:this.selectedFacets[1]};}
selectedValues.charts=this.chartData.charts;}
this.chartData=this.chartBlock.loadData(rd,selectedValues);this.selectedFacets=[this.chartData.xField,this.chartData.yField];this.loadAvailableFacets(rd.facets);this.updateStatsMenu();this.onChangeChart();},loadAvailableFacets:function(facets){var data=[];Ext.iterate(facets,function(key,val,o){if(Ext.isEmpty(this.selectedFacets)){this.selectedFacets=[key];}else if(this.selectedFacets.length<2){this.selectedFacets[1]=key;}
data.push({id:key,name:Ext.valueFrom(val['title'],L['facet_'+key])});},this);this.rowsCombo.store.loadData(data);this.colsCombo.store.loadData(data);this.rowsCombo.setValue(this.selectedFacets[0]);this.colsCombo.setValue(this.selectedFacets[1]);},updateStatsMenu:function(){var BC=this.refOwner.buttonCollection,b=BC.get('PVStatsButton'),l=BC.get('PVStatsLabel'),d=this.chartData;this.statsEnabled=d.view&&!Ext.isEmpty(d.view.stats);b.setHidden(!this.statsEnabled);l.setHidden(!this.statsEnabled);if(this.statsEnabled){if(!this.selectedStat){if(d.view&&d.view.selectedStat){this.selectedStat=d.view.selectedStat;}else{this.selectedStat={};}}
if(Ext.isEmpty(this.selectedStat.field)){this.selectedStat.field='';}
if(Ext.isEmpty(this.selectedStat.type)){this.selectedStat.type='min';}
var menu=b.getMenu(),statsFunctions=['min','max','sum','count','missing'],items=[],checked,stats=d.view.stats;if(!Ext.isArray(stats)){stats=[stats];}
stats.unshift({title:L.none,field:''});for(var i=0;i<stats.length;i++){checked=(this.selectedStat.field==stats[i].field);if(checked){this.selectedStat.title=stats[i].title;}
items.push({xtype:'menucheckitem',group:'StatsField',text:stats[i].title,field:stats[i].field,checked:checked,scope:this,handler:this.onStatFieldChangeClick});}
items.push('-');for(i=0;i<statsFunctions.length;i++){items.push({xtype:'menucheckitem',group:'StatsType',text:statsFunctions[i],checked:(this.selectedStat.type==statsFunctions[i]),scope:this,handler:this.onStatTypeChangeClick});}
menu.removeAll();menu.add(items);this.updateStatsButtonCaption();}},onStatFieldChangeClick:function(b,e){this.selectedStat.field=b.field;this.selectedStat.title=b.text;this.updateStatsButtonCaption();this.fireEvent('reload',this);},onStatTypeChangeClick:function(b,e){this.selectedStat.type=b.text;this.updateStatsButtonCaption();this.fireEvent('reload',this);},updateStatsButtonCaption:function(){var BC=this.refOwner.buttonCollection,b=BC.get('PVStatsButton'),ss=this.selectedStat,txt='';if(ss){txt=Ext.isEmpty(ss.field)?ss.title:(ss.type+' ('+ss.title+')');}
b.setText(txt);},onFacetChange:function(combo,records,index){var record=Ext.isArray(records)?records[0]:records;this.selectedFacets[combo.selectedFacetIndex]=record.get('id');this.fireEvent('reload',this);},onTableCellFilterClick:function(filter){var params={view:'grid',from:'grid',userViewChange:true,filters:Ext.apply({},this.store.extraParams.filters)};if(!Ext.isEmpty(filter[0])){params['filters'][this.selectedFacets[0]]=[{f:this.selectedFacets[0],mode:'OR',values:[filter[0]]}];}
if(!Ext.isEmpty(filter[1])){params['filters'][this.selectedFacets[1]]=[{f:this.selectedFacets[1],mode:'OR',values:[filter[1]]}];}
this.fireEvent('changeparams',params);},onShowLegendClick:function(cb,checked,eOpts){this.chartBlock.setLegendVisible(checked);this.chartBlock.changeCharts(this.chartData.charts);},onExportButtonClick:function(b,e){var html='<html><head><meta charset="UTF-8"><body>'+
this.chartBlock.getHtml()+'</body></html>';el=document.createElement('a');el.href='data:text/html;charset=utf-8,'+encodeURIComponent(html);el.target='_blank';el.download='PivotView.html';el.click();}});;Ext.namespace('CB');Ext.define('CB.VerticalEditGrid',{extend:'Ext.grid.GridPanel',alias:['CBVerticalEditGrid','widget.CBVerticalEditGrid'],border:false,root:'data',cls:'spacy-rows edit-grid',scrollable:true,autoHeight:true,plugins:[],initComponent:function(){var parentWindow=this.getBubbleTarget();if(parentWindow.helperTree){this.helperTree=parentWindow.helperTree;}else{this.helperTree=new CB.VerticalEditGridHelperTree();}
this.initRenderers();this.initColumns();var viewCfg={autoFill:false,deferInitialRefresh:false,stripeRows:true,markDirty:false,getRowClass:function(record,index,rowParams,store){var rez='';if(record.get('type')==='H'){rez='group-titles-colbg';var node=this.grid.helperTree.getNode(record.get('id'));if(node&&!Ext.isEmpty(node.data.templateRecord.get('cfg').css)){rez+=' '+node.data.templateRecord.get('cfg').css;}}
return rez;},plugins:[{ptype:'CBDDGrid',enableDrop:true,dropZoneConfig:{onNodeOver:this.onNodeDragOver.bind(this),onNodeDrop:this.onNodeDrop.bind(this)}}]};if(this.viewConfig){Ext.apply(viewCfg,this.viewConfig);}
var plugins=Ext.apply([],Ext.valueFrom(this.plugins,[]));plugins.push({ptype:'cellediting',clicksToEdit:1,listeners:{scope:this,beforeedit:this.onBeforeEditProperty,edit:this.onAfterEditProperty},onSpecialKey:this.onCellEditingSpecialKey});Ext.apply(this,{store:new Ext.data.JsonStore({model:'EditGridRecord',proxy:{type:'memory',reader:{type:'json',idProperty:'id',messageProperty:'msg'}},listeners:{scope:this,update:function(store,record,operation){if(operation!=Ext.data.Record.EDIT){return;}
var node=this.helperTree.getNode(record.get('id'));node.data.value['value']=record.get('value');node.data.value['info']=record.get('info');node.data.value['cond']=record.get('cond');}}}),columns:Ext.apply([],this.gridColumns),selType:'cellmodel',header:false,listeners:{scope:this,keypress:function(e){if((e.getKey()==e.ENTER)&&(!e.hasModifier())){this.onFieldTitleDblClick();}},celldblclick:this.onFieldTitleDblClick,cellclick:this.onCellClick,cellcontextmenu:this.onPopupMenu},stateful:true,stateId:Ext.valueFrom(this.stateId,'veg'),stateEvents:['columnhide','columnmove','columnresize','columnschanged','columnshow'],viewConfig:viewCfg,editors:{iconcombo:function(){return new Ext.form.ComboBox({editable:true,name:'iconCls',hiddenName:'iconCls',tpl:'<tpl for="."><div class="x-boundlist-item icon-padding16 {name}">{name}</div></tpl>',store:CB.DB.templatesIconSet,valueField:'name',displayField:'name',iconClsField:'name',triggerAction:'all',queryMode:'local'});}},plugins:plugins});this.enableBubble(['change','fileupload','filedownload','filesdelete','loaded','saveobject']);this.callParent(arguments);},initRenderers:function(){this.renderers={iconcombo:App.customRenderers.iconcombo,H:function(){return'';},title:function(v,meta,record,row_idx,col_idx,store){var id=record.get('id');var n=this.helperTree.getNode(id);if(Ext.isString(v)){v=Ext.util.Format.htmlEncode(v);}
if(!n){return v;}
var tr=n.data.templateRecord;if(tr.get('type')==='H'){meta.css='vgh';if(tr.get('cfg').style){meta.tdStyle=tr.get('cfg').style;}}else{meta.css='bgcLG vaT';meta.style='margin-left: '+(n.getDepth()-1)+'0px';if(tr.get('cfg').readOnly===true){meta.css+=' cG';}
if(tr.get('cfg').required&&Ext.isEmpty(record.data.value)){meta.css+=' cRequired';v+=' *';}}
if(!Ext.isEmpty(tr.get('cfg').hint)){meta.tdAttr=' title="'+tr.get('cfg').hint+'"';}
if(this.helperTree.isDuplicate(id)){if(this.helperTree.canDuplicate(id)&&this.helperTree.isLastDuplicate(id)){v='<img name="add_duplicate" title="'+L.addDuplicateField+'" class="fr duplicate-plus" src="'+Ext.BLANK_IMAGE_URL+'" / >'+v;}else{var idx=this.helperTree.getDuplicateIndex(id)+1;v='<img title="'+L.duplicate+' '+idx+'" class="fr vc'+idx+'" src="'+Ext.BLANK_IMAGE_URL+'" / >'+v;}}
return v;},value:function(v,meta,record,row_idx,col_idx,store){var n=this.helperTree.getNode(record.get('id'));if(Ext.isString(v)){v=Ext.util.Format.htmlEncode(v);}
if(!n){return v;}
var tr=n.data.templateRecord;if((tr.get('type')=='H')&&tr.get('cfg').style){meta.tdStyle=tr.get('cfg').style;}
if(record.get('valid')===false){meta.css=' x-form-invalid-field-default';meta.tdAttr='data-errorqtip="<ul class=\'x-list-plain\'><li>'+Ext.form.field.Base.prototype.invalidText+'</li></ul>"';}else{if(tr.get('cfg').required&&Ext.isEmpty(v)){meta.css=' x-form-invalid-field-default';meta.tdAttr='data-errorqtip="<ul class=\'x-list-plain\'><li>'+Ext.form.TextField.prototype.blankText+'</li></ul>"';}else{meta.css='';meta.tdAttr='data-errorqtip=""';}}
if(this.renderers&&this.renderers[tr.get('type')]){return this.renderers[tr.get('type')](v,this);}
if(!Ext.isEmpty(tr.get('cfg').height)){meta.style+='min-height:'+tr.get('cfg').height+'px';}
var renderer=App.getCustomRenderer(tr.get('type'));if(Ext.isEmpty(renderer)){return v;}
meta.fieldConfig=tr.get('cfg');return renderer(v,meta,record,row_idx,col_idx,store,this);}};},initColumns:function(){this.gridColumns=[{header:L.Property,sortable:false,dataIndex:'title',stateId:'title',editable:false,scope:this,size:100,renderer:this.renderers.title},{header:L.Value,itemId:'value',sortable:false,dataIndex:'value',stateId:'value',editor:new Ext.form.TextField(),scope:this,flex:1,resizable:true,renderer:this.renderers.value},{header:L.Additionally,sortable:false,dataIndex:'info',stateId:'info',editor:new Ext.form.TextField(),size:200,hideable:false}];},onNodeDragOver:function(targetEl,source,e,data){var rez=source.dropNotAllowed;var record=this.view.getRecord(targetEl);var recs=data.records;if(Ext.isEmpty(record)||Ext.isEmpty(recs)||isNaN(Ext.Number.from(recs[0].data.nid,recs[0].data.id))){return rez;}
rez=(record.get('type')==='_objects')?source.dropAllowed:source.dropNotAllowed;return rez;},onNodeDrop:function(targetEl,source,e,sourceData){if(this.onNodeDragOver(targetEl,source,e,sourceData)==source.dropAllowed){var record=this.view.getRecord(targetEl),recs=sourceData.records;if(record){var bt=this.view.grid.getBubbleTarget();var node=this.helperTree.getNode(record.get('id'));var tr=node.data.templateRecord;var oldValue=node.data.value.value;var v=toNumericArray(oldValue);var id,idx=null;for(var i=0;i<recs.length;i++){id=Ext.Number.from(recs[i].data.nid,recs[i].data.id);idx=v.indexOf(id);if(idx>=0){v.splice(idx,1);}else{v.push(id);if(bt.objectsStore){bt.objectsStore.checkRecordExistance(recs[i].data);}}}
var newValue=v.join(',');record.set('value',newValue);this.fireEvent('change',tr.get('name'),newValue,oldValue);}
return true;}
return false;},onCellClick:function(g,td,cellIndex,record,tr,rowIndex,e,eOpts){var el=e.getTarget();if(el){switch(el.name){case'add_duplicate':this.onDuplicateFieldClick();break;}}},onPopupMenu:function(gridView,el,colIndex,record,rowEl,rowIndex,ev,eOpts){ev.preventDefault();switch(this.columns[colIndex].dataIndex){case'title':this.showTitlePopupMenu(this,rowIndex,colIndex,ev);break;}},showTitlePopupMenu:function(grid,rowIndex,cellIndex,e){var r=grid.getStore().getAt(rowIndex);this.popupForRow=rowIndex;if(!this.titlePopupMenu){this.titlePopupMenu=new Ext.menu.Menu({items:[{text:L.addDuplicateField,scope:this,handler:this.onDuplicateFieldClick},{text:L.delDuplicateField,scope:this,handler:this.onDeleteDuplicateFieldClick}]});}
this.titlePopupMenu.items.getAt(0).setDisabled(!this.helperTree.canDuplicate(r.get('id')));this.titlePopupMenu.items.getAt(1).setDisabled(this.helperTree.isFirstDuplicate(r.get('id')));this.titlePopupMenu.showAt(e.getXY());},onFieldTitleDblClick:function(gridView,td,cellIndex,record,tr,rowIndex,e,eOpts){var sm=this.getSelectionModel();var fieldName=this.columns[cellIndex].dataIndex;if(fieldName==='title'){this.editingPlugin.startEdit(record,1);}},getBubbleTarget:function(){if(!this.parentWindow){this.parentWindow=this.findParentByType('CBGenericForm')||this.refOwner;}
return this.parentWindow;},reload:function(){this.data={};this.newItem=true;var pw=this.getBubbleTarget();if(Ext.isDefined(pw.data)){this.newItem=isNaN(pw.data.id);if(Ext.isDefined(pw.data[this.root])){this.data=pw.data[this.root];}}
this.template_id=Ext.valueFrom(pw.data.template_id,this.template_id);if(isNaN(this.template_id)){return Ext.Msg.alert('Error','No template id specified in data for "'+pw.title+'" window.');}
this.template_id=parseInt(this.template_id,10);this.templateStore=Ext.clone(CB.DB['template'+this.template_id]);var idx=CB.DB.templates.findExact('id',this.template_id);if(idx>=0){var tc=CB.DB.templates.getAt(idx).get('cfg');var infoCol=this.headerCt.child('[dataIndex="info"]');var colRequired=((tc.infoColumn===true)||((Ext.isEmpty(infoCol))&&(!Ext.isEmpty(App.config.template_info_column))));var newConfig=Ext.apply([],this.gridColumns);if(!Ext.isEmpty(infoCol)&&!colRequired){if(!colRequired){newConfig.pop();}
if(this.stateful){var state=Ext.state.Manager.get(this.stateId);if(state&&state.columns){Ext.iterate(newConfig,function(c){if(state.columns[c.dataIndex]){Ext.apply(c,state.columns[c.dataIndex]);}},this);}}
this.reconfigure(this.store,newConfig);}}
if(!pw.helperTree){this.helperTree.newItem=this.newItem;this.helperTree.loadData(this.data,this.templateStore);}
this.syncRecordsWithHelper();this.fireEvent('loaded',this);},syncRecordsWithHelper:function(){if(!this.store){return;}
var nodesList=this.helperTree.queryNodeListBy(this.helperNodesFilter.bind(this)),ids=this.store.collect('id'),update=false,i,idx,id,r;for(i=0;i<nodesList.length;i++){id=nodesList[i].data.id;idx=ids.indexOf(id);if(idx<0){update=true;}else{ids.splice(idx,1);r=this.store.getById(id);if(r&&nodesList[i].data.value.value!==r.data.value){r.data.value=nodesList[i].data.value.value;}}}
if(!update&&Ext.isEmpty(ids)){return;}
if(this.store&&this.store.suspendEvents){this.store.suspendEvents(true);}
this.store.removeAll(false);var records=[];for(i=0;i<nodesList.length;i++){var attr=nodesList[i].data;r=attr.templateRecord;records.push(Ext.create(this.store.getModel().getName(),{id:attr.id,title:r.get('title'),readonly:((r.get('type')==='H')||(r.get('cfg').readOnly==1)),value:Ext.isNumeric(attr.value.value)?parseFloat(attr.value.value,10):attr.value.value,info:attr.value.info,type:r.get('type'),cond:attr.value.cond,valid:attr.valid}));}
this.store.resumeEvents();this.store.add(records);return true;},helperNodesFilter:function(node){var r=node.data.templateRecord;if(Ext.isEmpty(r)){return false;}
if(Ext.isArray(this.hideTemplateFields)){var a=this.hideTemplateFields;if((a.indexOf(r.get('name'))>-1)||(a.indexOf(r.get('id'))>-1)||(a.indexOf(r.get('id')+'')>-1)){return false;}}
return((r.get('type')!=='G')&&((r.get('cfg').showIn!=='top')||((r.get('cfg').showIn==='top')&&this.includeTopFields))&&(r.get('cfg').showIn!=='tabsheet')&&(node.data.visible!==false));},readValues:function(){if(!Ext.isDefined(this.data)){this.data={};}
this.data=this.helperTree.readValues();var w=this.getBubbleTarget();if(Ext.isDefined(w.data)){w.data[this.root]=this.data;}},onBeforeEditProperty:function(editor,context,eOpts){var node=this.helperTree.getNode(context.record.get('id'));if(!node){return false;}
var tr=node.data.templateRecord;if((tr.get('type')==='H')||(tr.get('cfg').readOnly==1)){return false;}
if(context.field!=='value'){return;}
delete context.grid.pressedSpecialKey;var pw=this.findParentByType(CB.GenericForm,false)||this.refOwner;var t=tr.get('type');if(pw&&!Ext.isEmpty(pw.data)){context.objectId=pw.data.id;context.path=pw.data.path;}
if((Ext.isDefined(tr.get('cfg').dependency))&&!Ext.isEmpty(tr.get('pid'))){context.pidValue=this.helperTree.getParentValue(context.record.get('id'),tr.get('pid'));}
if((t==='time')&&!Ext.isEmpty(context.value)){var a=context.value.split(':');a.pop();context.value=a.join(':');}
var col=context.column,previousEditor=col.getEditor(),recordId=context.record.get('id');if(this.editors&&this.editors[t]){col.setEditor(this.editors[t](this));}else{context.fieldRecord=this.helperTree.getNode(recordId).data.templateRecord;context.duplicationIndexes=this.helperTree.getDuplicationIndexes(recordId);if(Ext.isObject(context.fieldRecord.get('cfg')['source'])){var fields=context.fieldRecord.get('cfg')['source'].requiredFields;if(!Ext.isEmpty(fields)){if(!Ext.isArray(fields)){fields=fields.split(',');}
context.objFields={};var currentData=this.helperTree.readValues();for(var i=0;i<fields.length;i++){var f=fields[i].trim();if(!Ext.isEmpty(currentData[f])){context.objFields[f]=currentData[f];}}}}
var te=App.getTypeEditor(t,context);this.attachKeyListeners(te);if(te){col.setEditor(te);}}
var currentEditor=col.getEditor();if(previousEditor&&(previousEditor!=currentEditor)){Ext.destroy(previousEditor);}},gainFocus:function(position){var sm=this.getSelectionModel(),navModel=this.getNavigationModel(),lastFocused=navModel.getLastFocused(),rez=Ext.clone(lastFocused);if(lastFocused&&!isNaN(lastFocused.rowIdx)){if(position==='next'){if(lastFocused.colIdx<(this.visibleColumnManager.columns.length-1)){rez.colIdx++;}else{if(lastFocused.rowIdx<(this.store.getCount()-1)){rez.rowIdx++;rez.colIdx=1;}else{rez=null;}}}
var cell=Ext.isEmpty(rez)?lastFocused:rez;sm.select({row:cell.rowIdx,column:cell.colIdx});navModel.setPosition(cell.rowIdx,cell.colIdx);navModel.focusPosition(cell);}
return rez;},addKeyMaps:function(c){var map=new Ext.KeyMap(c.getEl(),[{key:"s",ctrl:true,shift:false,scope:this,stopEvent:true,fn:this.onSaveObjectEvent}]);},attachKeyListeners:function(comp){if(Ext.isEmpty(comp)||!Ext.isObject(comp)){return;}
comp.on('afterrender',this.addKeyMaps,this);},onCellEditingSpecialKey:function(ed,field,e){var key=e.getKey();switch(key){case e.TAB:ed.completeEdit();var pos=ed.grid.gainFocus('next');if(pos){e.stopEvent();this.startEditByPosition({row:pos.rowIdx,column:pos.colIdx});}
break;case e.ENTER:case e.ESC:ed.grid.pressedSpecialKey=key;break;}},onSaveObjectEvent:function(key,event){if(this.editingPlugin.editing){this.editingPlugin.completeEdit();}
this.fireEvent('saveobject',this,event);},onAfterEditProperty:function(editor,context,eOpts){var nodeId=context.record.get('id'),node=this.helperTree.getNode(nodeId),tr=node.data.templateRecord;if(context.field==='value'){if(!Ext.isEmpty(context.value)&&context.fieldRecord){switch(context.fieldRecord.get('type')){case'time':if(Ext.isPrimitive(context.value)){var format=Ext.valueFrom(tr.get('cfg').format,App.timeFormat);context.value=Ext.Date.parse(context.value,format);}
context.value=Ext.Date.format(context.value,'H:i:s');context.record.set('value',context.value);break;case'_objects':if(Ext.isArray(context.value)){context.value=context.value.join(',');context.record.set('value',context.value);}
break;}}
var validator=tr.get('cfg').validator;if(!Ext.isEmpty(validator)){if(!Ext.isDefined(CB.Validators[validator])){plog('Undefined field validator: '+validator);}else{node.data.valid=Ext.isEmpty(context.value)||CB.Validators[validator](context.value);context.record.set('valid',node.data.valid);}}
if(context.value!=context.originalValue){this.helperTree.resetChildValues(nodeId);}
var fe=context.column.field;if(fe.getValueRecords){var records=fe.getValueRecords();for(var i=0;i<records.length;i++){this.refOwner.objectsStore.checkRecordExistance(records[i].data);}}}
if(context.value!=context.originalValue){this.fireEvent('change',tr.get('name'),context.value,context.originalValue);}
this.fireEvent('savescroll',this);if(!this.syncRecordsWithHelper()){this.getView().refresh();}else{this.fireEvent('restorescroll',this);}
if(this.pressedSpecialKey){this.gainFocus();}},getFieldValue:function(field_id,duplication_id){var result=null;this.store.each(function(r){if((r.get('field_id')==field_id)&&(r.get('duplicate_id')==duplication_id)){result=r.get('value');return false;}},this);return result;},setFieldValue:function(fieldName,value){var helperTreeNode=this.helperTree.setFieldValue(fieldName,value);if(Ext.isEmpty(helperTreeNode)){return;}
var recordIndex=this.store.findExact('id',helperTreeNode.data.id);if(recordIndex>=0){this.store.getAt(recordIndex).set('value',value);}},onDuplicateFieldClick:function(b){var r=this.getSelectionModel().getSelection()[0];if(Ext.isEmpty(r)){return;}
this.fireEvent('savescroll',this);this.helperTree.duplicate(r.get('id'));this.syncRecordsWithHelper();this.fireEvent('restorescroll',this);this.fireEvent('change');},onDeleteDuplicateFieldClick:function(b){var r=this.getSelectionModel().getSelection()[0];if(Ext.isEmpty(r)){return;}
this.fireEvent('savescroll',this);this.helperTree.deleteDuplicate(r.get('id'));this.syncRecordsWithHelper();this.fireEvent('restorescroll',this);this.fireEvent('change');},isValid:function(){var rez=true;delete this.invalidRecord;this.store.each(function(r){var n=this.helperTree.getNode(r.get('id'));if((r.get('valid')===false)||(n.data.templateRecord.get('cfg').required&&Ext.isEmpty(r.get('value')))){this.invalidRecord=r;rez=false;}
return rez;},this);return rez;},focusInvalidRecord:function(){var view=this.getView();if(this.invalidRecord){Ext.get(view.getRow(this.invalidRecord)).scrollIntoView(view.getEl(),null,true);Ext.Msg.alert(L.Error,L.FillFieldMsg.replace('{fieldName}',this.invalidRecord.get('title')));}}});;Ext.namespace('CB');Ext.define('CB.VerticalSearchEditGrid',{extend:'CB.VerticalEditGrid',alias:'CBVerticalSearchEditGrid',xtype:'CBVerticalSearchEditGrid',initComponent:function(){this.initRenderers=Ext.Function.createSequence(this.initRenderers,this.newInitRenderers,this);this.initColumns=Ext.Function.createSequence(this.initColumns,this.newInitColumns,this);this.oldOnBeforeEditProperty=this.onBeforeEditProperty;this.onBeforeEditProperty=this.newOnBeforeEditProperty;this.callParent(arguments);Ext.apply(this,{stateId:'vseg'});},newInitRenderers:function(){this.renderers.condition=Ext.Function.bind(function(v,meta,record,row_idx,col_idx,store){var st=this.getConditionsStore(record.get('type'));var idx=st.findExact('id',v);if(idx>=0){return st.getAt(idx).get('name');}
return'';},this);},newInitColumns:function(){this.gridColumns.splice(1,0,{header:L.Condition,width:50,dataIndex:'cond',editor:new Ext.form.TextField(),hidden:true,editable:true,scope:this,renderer:this.renderers.condition});},newOnBeforeEditProperty:function(editor,context,eOpts){if(context.field!=='cond'){return this.oldOnBeforeEditProperty(editor,context,eOpts);}
if(context.record.get('type')==='H'){context.cancel=true;return;}
var ed=new Ext.form.ComboBox({enableKeyEvents:true,forceSelection:true,triggerAction:'all',lazyRender:true,queryMode:'local',displayField:'name',valueField:'id',store:this.getConditionsStore(context.record.get('type')),listConfig:{minWidth:130}});this.attachKeyListeners(ed);context.column.setEditor(ed);},getConditionsStore:function(type){var cond=[];switch(type){case'H':break;case'int':case'float':case'date':case'datetime':cond=[{id:'=',name:L.condNumEq},{id:'<=',name:L.condNumLt},{id:'>=',name:L.condNumGt},{id:'!=',name:L.condNumNe}];break;case'_objects':case'combo':case'iconcombo':case'timeunits':case'_sex':cond=[{id:'<=',name:L.condSetLt},{id:'>=',name:L.condSetGt},{id:'=',name:L.condSetEq},{id:'!=',name:L.condSetNe}];break;case'_auto_title':case'varchar':case'text':case'memo':case'html':cond=[{id:'contain',name:L.condTxtContain},{id:'start',name:L.condTxtBegin},{id:'end',name:L.condTxtEnd},{id:'not',name:L.condTxtNc},{id:'=',name:L.condTxtEq},{id:'!=',name:L.condTxtNe}];break;case'checkbox':cond=[{id:'=',name:L.condCbEq},{id:'!=',name:l.condCbNe}];break;}
return new Ext.data.JsonStore({autoLoad:true,autoDestroy:true,model:'Generic2',data:cond,proxy:{type:'memory',reader:{type:'json'}}});}});;Ext.namespace('CB');Ext.define('CB.PasteFromWord',{extend:'Ext.Window',autoHeight:true,autoShow:true,bodyBorder:false,closable:true,closeAction:'hide',hideCollapseTool:true,layout:'fit',maximizable:false,minimizable:false,modal:true,plain:true,resizable:true,stateful:false,title:L.PasteFromWord,width:530,initComponent:function(){Ext.apply(this,{items:[{xtype:'htmleditor',bodyBorder:false,border:false,anchor:'100% -125'}],buttons:[{text:L.Insert,handler:this.doSubmit,scope:this},{text:L.Cancel,handler:this.doClose,scope:this}]});this.callParent(arguments);this.editor=this.items.getAt(0);this.on('afterrender',this.doShow);this.on('activate',this.doShow);},doShow:function(w){this.editor.setValue('');},doSubmit:function(w){var text_source=Ext.util.Format.stripTags(this.opener.getValue());text_source=text_source.replace(/ /g,'');if(!text_source){this.opener.setValue(CleanWord(this.editor.getValue()));}else{this.opener.insertAtCursor(CleanWord(this.editor.getValue()));}
this.hide();},doClose:function(w){this.hide();}});function CleanWord(html){var bIgnoreFont=true;var bRemoveStyles=true;html=html.replace(/<o:p>\s*<\/o:p>/g,'');html=html.replace(/<o:p>[\s\S]*?<\/o:p>/g,'&nbsp;');html=html.replace(/\s*mso-[^:]+:[^;"]+;?/gi,'');html=html.replace(/\s*MARGIN: 0(?:cm|in) 0(?:cm|in) 0pt\s*;/gi,'');html=html.replace(/\s*MARGIN: 0(?:cm|in) 0(?:cm|in) 0pt\s*"/gi,"\"");html=html.replace(/\s*TEXT-INDENT: 0(?:cm|in)\s*;/gi,'');html=html.replace(/\s*TEXT-INDENT: 0(?:cm|in)\s*"/gi,"\"");html=html.replace(/\s*TEXT-ALIGN: [^\s;]+;?"/gi,"\"");html=html.replace(/\s*PAGE-BREAK-BEFORE: [^\s;]+;?"/gi,"\"");html=html.replace(/\s*FONT-VARIANT: [^\s;]+;?"/gi,"\"");html=html.replace(/\s*tab-stops:[^;"]*;?/gi,'');html=html.replace(/\s*tab-stops:[^"]*/gi,'');if(bIgnoreFont)
{html=html.replace(/\s*face="[^"]*"/gi,'');html=html.replace(/\s*face=[^ >]*/gi,'');html=html.replace(/\s*FONT-FAMILY:[^;"]*;?/gi,'');}
html=html.replace(/<(\w[^>]*) class=([^ |>]*)([^>]*)/gi,"<$1$3");if(bRemoveStyles){html=html.replace(/<(\w[^>]*) style="([^\"]*)"([^>]*)/gi,"<$1$3");}
html=html.replace(/<STYLE[^>]*>[\s\S]*?<\/STYLE[^>]*>/gi,'');html=html.replace(/<(?:META|LINK)[^>]*>\s*/gi,'');html=html.replace(/\s*style="\s*"/gi,'');html=html.replace(/<SPAN\s*[^>]*>\s*&nbsp;\s*<\/SPAN>/gi,'&nbsp;');html=html.replace(/<SPAN\s*[^>]*><\/SPAN>/gi,'');html=html.replace(/<(\w[^>]*) lang=([^ |>]*)([^>]*)/gi,"<$1$3");html=html.replace(/<SPAN\s*>([\s\S]*?)<\/SPAN>/gi,'$1');html=html.replace(/<FONT\s*>([\s\S]*?)<\/FONT>/gi,'$1');html=html.replace(/<\\?\?xml[^>]*>/gi,'');html=html.replace(/<w:[^>]*>[\s\S]*?<\/w:[^>]*>/gi,'');html=html.replace(/<\/?\w+:[^>]*>/gi,'');html=html.replace(/<\!--[\s\S]*?-->/g,'');html=html.replace(/<(U|I|STRIKE)>&nbsp;<\/\1>/g,'&nbsp;');html=html.replace(/<H\d>\s*<\/H\d>/gi,'');html=html.replace(/<(\w+)[^>]*\sstyle="[^"]*DISPLAY\s?:\s?none[\s\S]*?<\/\1>/ig,'');html=html.replace(/<(\w[^>]*) language=([^ |>]*)([^>]*)/gi,"<$1$3");html=html.replace(/<(\w[^>]*) onmouseover="([^\"]*)"([^>]*)/gi,"<$1$3");html=html.replace(/<(\w[^>]*) onmouseout="([^\"]*)"([^>]*)/gi,"<$1$3");html=html.replace(/<H1([^>]*)>/gi,'<div$1><b><font size="6">');html=html.replace(/<H2([^>]*)>/gi,'<div$1><b><font size="5">');html=html.replace(/<H3([^>]*)>/gi,'<div$1><b><font size="4">');html=html.replace(/<H4([^>]*)>/gi,'<div$1><b><font size="3">');html=html.replace(/<H5([^>]*)>/gi,'<div$1><b><font size="2">');html=html.replace(/<H6([^>]*)>/gi,'<div$1><b><font size="1">');html=html.replace(/<\/H\d>/gi,'<\/font><\/b><\/div>');var re=new RegExp('(<P)([^>]*>[\\s\\S]*?)(<\/P>)','gi');html=html.replace(re,'<div$2<\/div>');html=html.replace(/<([^\s>]+)(\s[^>]*)?>\s*<\/\1>/g,'');html=html.replace(/<([^\s>]+)(\s[^>]*)?>\s*<\/\1>/g,'');html=html.replace(/<([^\s>]+)(\s[^>]*)?>\s*<\/\1>/g,'');return html;};Ext.namespace('CB');Ext.define('CB.FilesConfirmationWindow',{extend:'Ext.Window',autoShow:true,border:false,bodyBorder:false,closable:true,closeAction:'hide',autoHeight:true,maximizable:false,minimizable:false,modal:true,plain:true,resizable:false,stateful:false,title:L.UploadFile,minWidth:550,width:550,bodyStyle:'padding: 10px; border: 0',buttonAlign:'center',data:{single:true,autorenameButton:true},initComponent:function(){this.data=this.config.data;var buttons=[];if(this.data.allow_new_version){buttons.push({text:L.NewVersion,name:'newversion',scope:this,handler:this.onButtonClick});}
buttons.push({text:L.Replace,name:'replace',scope:this,handler:this.onButtonClick});this.renameButton=new Ext.Button({text:L.Rename,name:'rename',scope:this,handler:this.onButtonClick});if(!Ext.isEmpty(this.data.suggestedFilename)){buttons.push(this.renameButton);}
if(this.data.autorenameButton){buttons.push({text:L.AutoRename,name:'autorename',scope:this,handler:this.onButtonClick});}
buttons.push({text:L.Cancel,name:'cancel',scope:this,handler:this.onButtonClick});var items=[{xtype:'label',text:this.data.msg}];if(this.data.single===false){items.push({xtype:'checkbox',boxLabel:L.ApplyForAll,style:'margin-top: 25px',listeners:{change:function(cb,checked){this.forAll=checked;this.renameButton.setDisabled(checked);},scope:this}});}
Ext.apply(this,{items:items,buttons:buttons});this.callParent(arguments);this.response='cancel';},onButtonClick:function(b){this.response=b.name;this.hide();}});;Ext.namespace('CB.plugin');Ext.define('CB.plugin.CustomInterface',{extend:'Ext.plugin.Abstract',init:function(owner){}});;Ext.namespace('CB.plugin.field');Ext.define('CB.plugin.field.DropDownList',{extends:'Ext.util.Observable',alias:'plugin.CBPluginFieldDropDownList',xtype:'CB.plugin.field.DropDownList',constructor:function(config){var defaultConfig={commands:[{prefix:'@',regex:/^([\w\d_\.]+)/i,insertField:'info',handler:this.onAtCommand,scope:this},{prefix:'#',regex:/^(\d+)/i,handler:this.onDiezCommand}],displayTpl:new Ext.XTemplate('<tpl for=".">','<li role="option" class="x-boundlist-item users-list-item">','<div class="thumb">','<img class="i32" src="'+App.config.photoPath+'{id}.jpg?32={[ CB.DB.usersStore.getPhotoParam(values.id) ]}" title="{text}">','</div>','<div class="text">','<span class="info">{[this.replaceLastQuery(values.info)]}</span>','{[this.replaceLastQuery(values.text)]}','<div class="descr">{[this.replaceLastQuery(values.descr)]}</div>','</div>','</li>','</tpl>','<div class="x-clear"></div>',{compiled:true,replaceLastQuery:function(value){if(!Ext.isEmpty(this.lastQuery)){return String(value).replace(this.lastQuery,'<span class="fwB">'+this.lastQuery+'</span>');}
return value;}})};if(config){Ext.apply(defaultConfig,config);}
Ext.apply(this,defaultConfig);this.callParent(arguments);},init:function(owner){this.owner=owner;this.store=new Ext.data.JsonStore({model:'DropDownListItems'});Ext.copyTo(this.owner,Ext.form.field.Picker.prototype,['matchFieldWidth','pickerAlign','openCls','initEvents','expand','onExpand','doAlign','collapse','collapseIf','getPicker','getRefItems','onOtherFocus','alignPicker','beforeDestroy']);Ext.copyTo(this.owner,Ext.form.field.ComboBox.prototype,[,'defaultListConfig','listConfig','childEls','delimiter','getStore','updateBindSelection','onPageChange','onListRefresh','onBeforeSelect','onBeforeDeselect']);Ext.apply(owner,{enableKeyEvents:true,store:this.store,valueField:'id',displayField:'text',displayTpl:this.displayTpl,selectByValue:Ext.emptyFn,onTriggerClick:Ext.emptyFn,syncSelection:Ext.emptyFn,setSelection:Ext.emptyFn,onCollapse:function(){if(this.preventEditComplete!==Ext.EventObject.time){delete this.preventEditComplete;}},onEsc:Ext.emptyFn,bindStore:Ext.emptyFn,assertValue:function(){return'';},select:function(record,index){if(this.fireEvent('beforeselect',this,record,index)!==false){ed.preventEditComplete=true;this.collapse();this.fireEvent('select',this,record,index);}},createPicker:function(){var me=this,picker,pickerCfg=Ext.apply({xtype:'boundlist',pickerField:me,selModel:{mode:me.multiSelect?'SIMPLE':'SINGLE'},floating:true,hidden:true,store:me.store,displayField:me.displayField,preserveScrollOnRefresh:true,pageSize:me.pageSize,tpl:me.displayTpl,navigationModel:'CBboundlist'},me.listConfig,me.defaultListConfig);picker=me.picker=Ext.widget(pickerCfg);if(me.pageSize){picker.pagingToolbar.on('beforechange',me.onPageChange,me);}
me.mon(picker.getSelectionModel(),{beforeselect:me.onBeforeSelect,beforedeselect:me.onBeforeDeselect,scope:me});return picker;}});owner.on('render',this.onRender,this);owner.on('beforeselect',this.setSelectedValue,this);owner.on('beforedestroy',this.onBeforeDestroy,this);},onRender:function(ed){this.owner.wrap=this.owner.getEl();ed.on('keydown',this.onKeyDown,this);ed.on('keyup',this.onKeyUp,this);},onBeforeDestroy:function(ed){ed.un('keydown',this.onKeyDown,this);ed.un('keyup',this.onKeyUp,this);this.owner.un('beforeselect',this.setSelectedValue,this);},onKeyDown:function(ed,e){if(!ed.picker){return;}
var me=this,picker=ed.picker,allItems=picker.all,oldItem=picker.highlightedItem,oldItemIdx,newItemIdx;switch(e.getKey()){case e.ENTER:if(ed.isExpanded){e.stopEvent();ed.onKeyEnter(e);}
break;case e.ESC:if(ed.isExpanded){e.stopEvent();ed.preventEditComplete=true;ed.collapse();}
break;case e.UP:if(ed.isExpanded){e.stopEvent();ed.onKeyUp(e);}
break;case e.DOWN:if(ed.isExpanded){e.stopEvent();ed.onKeyDown(e);}
break;case e.LEFT:case e.RIGHT:break;}},onKeyUp:function(ed,e){var value=ed.getRawValue();if(Ext.isEmpty(value)||e.isSpecialKey()){return;}
var el=ed.inputEl,caretPosition=this.getCaretPosition(el.dom),parts=[value.substring(0,caretPosition),value.substring(caretPosition)];for(var i=0;i<this.commands.length;i++){var cmd=this.commands[i];if(cmd.prefix===' '){parts[0]=parts[0].replace(/[\n\r,]/g,' ');}
var t=parts[0].split(cmd.prefix);if((cmd.prefix!==' ')&&(t.length<2)){continue;}
var leftpart=t[t.length-1];var str=t[t.length-1]+parts[1];var rez=cmd.regex.exec(str);if(Ext.isEmpty(rez)||(rez[1].length<leftpart.length)){continue;}
var handler=cmd.handler||Ext.emptyFn;handler=Ext.Function.bind(handler,Ext.valueFrom(this.commands[i].scope,this));cmd.caretPosition=caretPosition;cmd.query=rez[1];cmd.queryStartIndex=parts[0].length-leftpart.length;this.currentCommand=cmd;handler(cmd,rez[1]);return true;}
this.owner.collapse();},onAtCommand:function(cmdParams,query){if(query==this.lastQuery){return;}
this.lastQuery=query;this.owner.displayTpl.lastQuery=query;CB_Security.searchUserGroups({source:'users',query:query},this.onSearchUsersProcess,this);},onSearchUsersProcess:function(r,e){if(!r||(r.success!==true)){return;}
var items=[];for(var i=0;i<r.data.length;i++){var d=r.data[i];items.push({id:d.id,text:d.name,info:d.user,descr:d.email});}
this.showItems(items);},onDiezCommand:function(cmdParams,query){plog('Diez',arguments,query);},showItems:function(itemsArray){this.store.loadData(itemsArray);this.owner.getPicker().getSelectionModel().deselectAll();this.owner.expand();this.owner.setPosition();},setSelectedValue:function(ed,record,index){var cmd=this.currentCommand,field=Ext.valueFrom(cmd.insertField,'id'),value=ed.getRawValue(),newValue=value.substring(0,cmd.queryStartIndex)+record.get(field),newCaretPosition=newValue.length;newValue+=value.substring(cmd.queryStartIndex+cmd.query.length);if(Ext.EventObject.type!="click"){ed.preventEditComplete=Ext.EventObject.time;}
ed.collapse();ed.setRawValue(newValue);this.setCaretPosition(ed.inputEl.dom,newCaretPosition);},getCaretPosition:function(el){if(typeof(el.selectionStart)==="number"){return el.selectionStart;}else if(document.selection&&el.createTextRange){var range=document.selection.createRange();range.collapse(true);range.moveStart("character",-el.value.length);return range.text.length;}else{throw'getCaretPosition() not supported';}},setCaretPosition:function(el,pos){if(el.setSelectionRange)
{el.focus();el.setSelectionRange(pos,pos);}
else if(el.createTextRange){var range=el.createTextRange();range.collapse(true);range.moveEnd('character',pos);range.moveStart('character',pos);range.select();}}});;Ext.namespace('CB.plugin.field');Ext.define('CB.plugin.field.RemainingCharsHint',{extends:'Ext.util.Observable',alias:'plugin.CBPluginFieldRemainingCharsHint',init:function(owner){this.owner=owner;owner.labelSeparator='.';owner.labelAlign='top';owner.initLabelable();owner.labelClsExtra='remaining-chars-hint';owner.on('boxready',this.onEditorBoxReady,this);owner.on('beforedestroy',this.onBeforeDestroy,this);},onEditorBoxReady:function(ed,e){if(ed.maxLength){ed.on('change',this.onValueChange,this);this.onValueChange(ed,e);}},onBeforeDestroy:function(ed){ed.un('render',this.onEditorBoxReady,this);ed.un('keyup',this.onValueChange,this);},onValueChange:function(ed,e){var value=ed.value,label=L.RemainingCharsHint;if(Ext.isEmpty(value)){label=L.TotalCharsHint;}
ed.setFieldLabel(label.replace('{total}',ed.maxLength).replace('{left}',ed.maxLength-String(value).length));}});;Ext.namespace('Ext.ux');Ext.define('Ext.ux.HtmlEditor',{extend:'Ext.form.field.HtmlEditor',alias:'widget.CBHtmlEditor',xtype:'ExtUxHtmlEditor',itemId:'htmleditor',baseUri:'',border:false,bodyStyle:'border: 0',headerInclude:'',initComponent:function(){this.on('render',this.onRenderEvent,this);this.callParent(arguments);},onRenderEvent:function(){this.addPasteFromWordButton();},addPasteFromWordButton:function(){this.getToolbar().add('-',{cls:'remove-sprites',iconCls:'icon-paste-from-word-text',text:L.PasteFromWord,scope:this,handler:function(b){if(!Ext.isDefined(CB.thePasteFromWordWindow)){CB.thePasteFromWordWindow=new CB.PasteFromWord();}
var pw=CB.thePasteFromWordWindow;Ext.apply(pw,{opener:this});pw.show();}});},getDocMarkup:function(){if(this.iframe){var inc=(this.baseUri?'<base href="'+this.baseUri+'" />':'')+this.headerInclude;var h=Ext.fly(this.iframe).getHeight()-this.iframePad*2;return Ext.String.format('<html><head>'+
inc+'<style type="text/css">body{border: 0; margin: 0; padding: {0}px; height: {1}px; cursor: text}</style></head>'+'<body></body></html>',this.iframePad,h);}}});;Ext.ns('Ext.ux.plugins');Ext.define('Ext.ux.plugins.DefaultButton',{alias:'plugin.defaultButton',init:function(button){button.on('afterRender',this.setupKeyListener,button);},setupKeyListener:function(){var formPanel=this.findParentByType('form');new Ext.KeyMap(formPanel.el,{key:Ext.event.Event.ENTER,shift:false,alt:false,fn:function(keyCode,e){if(e.target.type==='textarea'&&!e.ctrlKey){return true;}
this.el.dom.click();return false;},scope:this});}});;Ext.namespace('CB');Ext.define('CB.TextEditWindow',{extend:'Ext.Window',border:false,bodyBorder:false,closable:true,closeAction:'destroy',hideCollapseTool:true,layout:'fit',maximizable:false,minimizable:false,modal:true,resizable:true,stateful:false,data:{callback:Ext.emptyFn},title:L.EditingValue,width:600,height:400,initComponent:function(){this.data=this.config.data;switch(this.config.editor){case'ace':this.editor=new Ext.ux.AceEditor({border:false});break;default:this.editor=new Ext.form.TextArea({border:false});}
Ext.apply(this,{layout:'fit',items:[this.editor],keys:[{key:Ext.event.Event.ESC,fn:this.doClose,scope:this}],listeners:{scope:this,show:this.onWindowsShow},buttons:[{text:Ext.MessageBox.buttonText.ok,handler:this.doSubmit,scope:this},{text:L.Cancel,handler:this.doClose,scope:this}]});this.callParent(arguments);},onWindowsShow:function(){var title=Ext.valueFrom(this.data.title,this.title);this.setTitle(title);this.getHeader().setTitle(title);this.editor.setValue(Ext.valueFrom(this.data.value,''));this.editor.focus(false,350);},doSubmit:function(){var ed=this.editor.editor?this.editor.editor:this.editor,session=ed.getSession?ed.getSession():null,value=session?session.getValue():ed.getValue(),f=Ext.Function.bind(this.data.callback,Ext.valueFrom(this.data.scope,this),[this,value]);f();this.close();}});;Ext.namespace('CB');Ext.define('CB.HtmlEditWindow',{extend:'Ext.Window',itemId:'htmleditorwindow',bodyBorder:false,border:false,closable:true,closeAction:'hide',hideCollapseTool:true,layout:'fit',maximizable:false,minimizable:false,modal:true,plain:true,resizable:true,stateful:false,data:{callback:Ext.emptyFn},title:L.EditingValue,width:700,height:400,initComponent:function(){this.editor=new Ext.ux.HtmlEditor({border:false});Ext.apply(this,{items:[this.editor],keys:[{key:Ext.event.Event.ESC,fn:this.doClose,scope:this}],buttons:[{text:Ext.MessageBox.buttonText.ok,handler:this.doSubmit,scope:this},{text:L.Cancel,handler:this.doClose,scope:this}]});this.callParent(arguments);this.on('show',this.onShow,this);},onShow:function(){this.editor.setValue(Ext.valueFrom(this.data.value,''));this.editor.focus(true,350);},doSubmit:function(){var f=this.data.callback.bind(Ext.valueFrom(this.data.scope,this),[this,this.editor.getValue()]);f();this.doClose();},doClose:function(){this.hide();}});;Ext.namespace('CB.facet');Ext.define('CB.facet.Base',{xtype:'CBFacetBase',alias:'CB.Facet.Base',extend:'Ext.Panel',title:'facet',autoHeight:true,closable:false,collapsible:true,animCollapse:false,titleCollapse:true,hideCollapseTool:true,cls:'facet',border:false,mode:'OR',modeToggle:false,bodyStyle:'background: none',sorters:{name:{asc:function(o1,o2){var a=o1.name,b=o2.name;if(Ext.isNumeric(a)&&Ext.isNumeric(b)){a=parseFloat(a);b=parseFloat(b);}
if(a<b){return-1;}
if(a>b){return 1;}
return 0;},desc:function(o1,o2){var a=o1.name,b=o2.name;if(Ext.isNumeric(a)&&Ext.isNumeric(b)){a=parseFloat(a);b=parseFloat(b);}
if(a<b){return 1;}
if(a>b){return-1;}
return 0;}},count:{asc:function(o1,o2){var a=o1.count,b=o2.count;return a-b;},desc:function(o1,o2){var a=o1.count,b=o2.count;return b-a;}},items:{asc:function(o1,o2){var a=o1.items,b=o2.items;return a-b;},desc:function(o1,o2){var a=o1.items,b=o2.items;return b-a;}}},initComponent:function(config){Ext.apply(this,config);this.initActions();Ext.apply(this,{tools:this.getToolButtons()});this.callParent(arguments);this.enableBubble(['facetchange','modechange']);},initActions:function(){this.actions={sortByName:new Ext.Action({text:L.SortByName,itemId:'sortname',scope:this,handler:this.onSortByNameClick}),sortByCount:new Ext.Action({text:L.SortByCount,itemId:'sortcount',scope:this,handler:this.onSortByCountClick})};return this.actions;},loadData:function(data){delete this.lastSort;if(this.defaultSort&&this.defaultSort.property){var by=(this.defaultSort.property==='name')?'name':'items',dir=this.defaultSort.direction;data=Ext.Array.sort(data,this.sorters[by][dir]);this.lastSort=by+dir;}
this.rawData=data;},processServerData:function(serverData,options){},getToolButtons:function(){var rez=[];if(this.manualPeriod){rez.push({itemId:'period',name:'period',xtype:'button',callback:this.onPeriodAddClick,scope:this,qtip:'Add period'});}
if(this.modeToggle){rez.push({name:'unchain',itemId:'unchain',cls:'x-tool-unchain',handler:this.onModeToggle,scope:this,qtip:L.searchSwitchModeMessage});}
this.moreMenu=new Ext.menu.Menu({items:[this.actions.sortByName,this.actions.sortByCount]});rez.push({itemId:'points',type:'points',scope:this,callback:this.onPointsTollClick});return rez;},onPointsTollClick:function(b,e){this.moreMenu.showAt(e.getXY());},onSortByNameClick:function(b,e){var sortDir=(this.lastSort!=='nameasc')?'asc':'desc';var data=Ext.Array.sort(this.rawData,this.sorters['name'][sortDir]);this.store.loadData(data);this.lastSort='name'+sortDir;},onSortByCountClick:function(b,e){var sortDir=(this.lastSort!=='countdesc')?'desc':'asc';var data=Ext.Array.sort(this.rawData,this.sorters['items'][sortDir]);this.store.loadData(data);this.lastSort='count'+sortDir;},updateVisibility:function(){this.setVisible(this.store.getCount()>0);},setModeVisible:function(visible){if(!this.rendered){return;}
this.getEl().removeCls('multivalued');if(visible){this.getEl().addCls('multivalued');}},onModeToggle:function(ev,toolEl,panel,tc){var el=tc.el;if(el.hasCls('x-tool-chain')){el.replaceCls('x-tool-chain','x-tool-unchain');this.mode='OR';}else{el.replaceCls('x-tool-unchain','x-tool-chain');this.mode='AND';}
this.fireEvent('modechange',this,ev);}});;Ext.namespace('CB.facet');Ext.define('CB.facet.Text',{extend:'CB.facet.Base',xtype:'CBFacetText',alias:'CB.Facet.Text',autoHeight:true,layout:'fit',bodyStyle:'padding: 5px 5px 0 5px',initComponent:function(){this.editor=new Ext.form.field.Text({emptyText:L.searchText,triggerClass:'x-form-search-trigger',name:'queryText',enableKeyEvents:true,scope:this,anchor:'100%',onTriggerClick:function(ev){this.scope.fireEvent('facetchange',this,ev);},listeners:{scope:this,specialkey:function(ed,ev){if(ev.getKey()==ev.ENTER){ed.onTriggerClick(ev);}}}});Ext.apply(this,{items:this.editor});this.callParent(arguments);},setValue:function(value){this.editor.setValue(value);},getValue:function(){return this.editor.getValue();}});;Ext.namespace('CB.facet');xtemplate_facetList=new Ext.XTemplate('<ul class="filter_list">','<tpl for=".">','<li class="item {[ (xindex > 10) ? \'more\' : ""]}">','<b class="tick {[ (values.active == 1) ? \'active\' : ""]} {cls}"',' style="{[ (values.color) ? \'background-color: \' + values.color : ""]}"','></b>','<span class="{[ (values.active == 1) ? "b" : "t"]}">{items}</span>','<a href="#">{[Ext.valueFrom(values.name, "-")]}</a>','</li>','<tpl if="xcount &gt; 10 && xindex == xcount">','<li class="toggle"><u class="click">'+L.ShowAll+'</u></li>','</tpl>','</tpl></ul>');xtemplate_facetList.compile();Ext.define('CB.facet.List',{extend:'CB.facet.Base',xtype:'CBFacetList',alias:'CB.Facet.List',title:'List facet',autoHeight:true,layout:'fit',listMode:'checklist',itemsTemplate:xtemplate_facetList,initComponent:function(){this.store=new Ext.data.JsonStore({autoDestroy:true,model:'Facet',proxy:{type:'memory'}});if(!Ext.isEmpty(this.data)){this.store.loadData(this.data,false);}
var items=[new Ext.DataView({autoHeight:true,store:this.store,itemSelector:'li.item',tpl:this.itemsTemplate,listeners:{scope:this,itemclick:this.onItemClick,containerclick:this.onContainerClick}})];if(this.config.manualPeriod===true){this.addPeriodPanel=new Ext.form.FieldContainer({height:'auto',hidden:true,layout:'hbox',style:'background-color: transparent; padding-left: 15px',items:[{xtype:'datefield',width:100,height:20,name:'from'},{xtype:'label',width:15,html:' &nbsp;– '},{xtype:'datefield',width:100,name:'to'},{xtype:'button',width:20,iconCls:'i-check-alt',scope:this,handler:this.onAddPeriodClick},{xtype:'button',width:20,iconCls:'i-cancel',scope:this,handler:function(){this.addPeriodPanel.hide();}}]});items.push(this.addPeriodPanel);}
Ext.apply(this,{items:items,cachedNames:{},listeners:{modechange:{scope:this,fn:this.onModeChange}}});this.callParent(arguments);},onModeChange:function(o,ev){var i=this.store.query('active',1);if(i.getCount()<2){ev.stopPropagation();}else{this.fireEvent('facetchange',this,ev);}},loadData:function(data){this.removeCls('facet-expanded');this.callParent(arguments);for(var i=0;i<data.length;i++){this.cachedNames[data[i].id]=data[i].name;}
this.store.loadData(data,false);this.setLastField();this.setModeVisible(this.getValue().values.length>1);},processServerData:function(serverData,options){this.loadData(this.getFacetData(this.facetId,serverData,options));},getFacetData:function(fid,serverData,options){var data=[],values=[],facetField=Ext.valueFrom(this.f,fid);if(options&&options.filters&&options.filters[fid]){Ext.each(options.filters[fid],function(f){if(!Ext.isEmpty(f.f)){facetField=f.f;}
for(var i=0;i<f.values.length;i++){values.push(f.values[i]);}},this);}
this.serverValues=values;switch(facetField){case'task_status':Ext.iterate(serverData,function(k,v){if(!Ext.isEmpty(L['taskStatus'+k])){data.push({id:k,name:L['taskStatus'+k],active:(values.indexOf(k+'')>=0)?1:0,items:v});}},this);break;case'template_type':Ext.iterate(serverData,function(k,v){data.push({id:k,name:L['tt_'+k],active:(values.indexOf(k+'')>=0)?1:0,items:v});},this);break;default:Ext.iterate(serverData,function(k,v){var d={id:k,name:Ext.isPrimitive(v)?k:v['name'],active:(values.indexOf(k+'')>=0)?1:0,items:Ext.isPrimitive(v)?v:v.count};if(!Ext.isEmpty(v.color)){d.color=v.color;}
if(!Ext.isEmpty(v.cls)){d.cls=v.cls;}
data.push(d);},this);}
return data;},setLastField:function(){var lr=false;this.store.each(function(r){r.set('last',0);if(r.get('active')==1){lr=r;}},this);if(lr){lr.set('last',1);}},getValue:function(){var r=[];var si=-1;do{si=this.store.findExact('active',1,si+1);if(si>=0){r.push(this.store.getAt(si).get('id'));}}while(si>-1);if(!Ext.isEmpty(this.serverValues)){for(var i=0;i<this.serverValues.length;i++){si=this.store.findExact('id',this.serverValues[i]);if(si<0){r.push(this.serverValues[i]);}}}
return{f:this.f,mode:this.mode,values:r};},onItemClick:function(cmp,record,item,index,e,eOpts){var r;switch(this.listMode){case'radio':r=this.store.getAt(index);var currentlyChecked=(r.get('active')==1);if(!currentlyChecked){this.reset();r.set('active',1);this.fireEvent('facetchange',this,ev);}
break;default:r=this.store.getAt(index);r.set('active',(r.get('active')==1)?0:1);this.setLastField();this.fireEvent('facetchange',this,e);}},onContainerClick:function(view,e,eOpts){var el=e.getTarget();if(el){if(el.className==='click'){this.addCls('facet-expanded');this.updateLayout();}}},uncheck:function(value){value=String(value);var idx=this.store.findExact('id',value);if(idx>=0){this.store.getAt(idx).set('active',0);}else{if(!Ext.isEmpty(this.serverValues)){this.serverValues.remove(value);}}},reset:function(){this.store.each(function(r){r.set('active',0);},this);},onPeriodAddClick:function(){this.addPeriodPanel.items.getAt(0).setValue(new Date());this.addPeriodPanel.show();},onAddPeriodClick:function(b,e){var from=this.addPeriodPanel.items.getAt(0).getValue();var to=this.addPeriodPanel.items.getAt(1).getValue();var id='';var name='';if(!Ext.isEmpty(from)){id=date_local_to_ISO_string(from);name=Ext.Date.format(from,App.dateFormat);}
id+='~';name+=' - ';if(!Ext.isEmpty(to)){id+=date_local_to_ISO_string(to);name+=Ext.Date.format(to,App.dateFormat);}
if(id==='-'){return;}
this.store.loadData([{id:id,name:name,active:1}],true);this.cachedNames[id]=name;this.addPeriodPanel.hide();this.fireEvent('facetchange',this,e);}});;Ext.namespace('CB.facet');Ext.define('CB.facet.Calendar',{extend:'CB.facet.Base',xtype:'CBFacetCalendar',alias:'CB.Facet.Calendar',autoHeight:true,layout:'fit',bodyStyle:'padding: 0',initComponent:function(){this.editor=new Ext.picker.Date({anchor:'100%',border:false,listeners:{scope:this,select:this.onDateSelect}});Ext.apply(this,{items:this.editor});this.callParent(arguments);this.enableBubble('dateselect');},getToolButtons:function(){return[];},setValue:function(value){this.editor.setValue(value);},getValue:function(){return this.editor.getValue();},updateVisibility:function(){this.setVisible(true);},onDateSelect:function(ed,date,eOpts){this.fireEvent('dateselect',date);}});;Ext.namespace('CB.facet');Ext.define('CB.facet.UsersColor',{extend:'CB.facet.List',xtype:'CBFacetUsersColor',alias:'CB.Facet.UsersColor',initComponent:function(){this.callParent(arguments);}});;Ext.namespace('CB');Ext.define('CB.Clipboard',{extend:'Ext.util.Observable',data:[],action:'copy',constructor:function(config){this.callParent(arguments);},set:function(data,action){this.data=Ext.isArray(data)?data:[data];this.action=Ext.valueFrom(action,'copy');this.fireEvent('change',this);},setAction:function(action){this.action=action;},size:function(){return this.data.length;},isEmpty:function(){return Ext.isEmpty(this.data);},clear:function(){this.data=[];this.fireEvent('change',this);},containShortcutsOnly:function(){var rez=true;Ext.each(this.data,function(i){rez=(i.type==2);return rez;},this);return rez;},paste:function(pid,action,callback,scope){App.DD.execute({action:Ext.valueFrom(action,this.action),confirm:false,targetData:{id:pid},sourceData:this.data},callback,scope);}});;Ext.namespace('CB');Ext.define('CB.FilterPanel',{extend:'Ext.Panel',alias:'widget.CBFilterPanel',xtype:'CBFilterPanel',scrollable:true,bodyStyle:'padding: 10px 0',padding:0,initComponent:function(){this.activeFileterFacet=new CB.FacetActiveFilters({listeners:{scope:this,itemclick:this.onActiveFiltersItemClick}});Ext.apply(this,{items:[this.activeFileterFacet],layout:{type:'vbox',align:'stretch'},listeners:{scope:this,facetchange:this.onFacetChange}});this.callParent(arguments);},hideAllFacets:function(){this.items.each(function(i){i.setVisible(false);},this);},updateFacets:function(data,options){this.hideAllFacets();this.facetIndex=1;Ext.iterate(data,function(key,value,obj){var facet=this.query('panel[facetId="'+key+'"]')[0];if(Ext.isEmpty(facet)){var type=Ext.String.capitalize(Ext.valueFrom(value.type,'List'));facet=Ext.create('CB.facet.'+type,{modeToggle:Ext.valueFrom(value.boolMode,true),facetId:key,title:value.title,f:Ext.isEmpty(value.f)?key:value.f,manualPeriod:value.manualPeriod,defaultSort:value.sort});this.insert(this.facetIndex,facet);}
facet.processServerData(value.items,options);facet.updateVisibility();this.facetIndex++;},this);this.updateActiveFiltersFacet(options);},updateActiveFiltersFacet:function(options){if(Ext.isEmpty(this.activeFileterFacet)){return;}
var af_data=[];Ext.iterate(options.filters,function(key,val,obj){var facet=this.child('[facetId="'+key+'"]');if(!Ext.isEmpty(facet)){var vals=[];Ext.each(val,function(f){for(i=0;i<f.values.length;i++){if(vals.indexOf(f.values[i])<0){vals.push(f.values[i]);}}},this);for(var i=0;i<vals.length;i++){af_data.push({id:Ext.id(),facetId:key,value:vals[i],name:facet.cachedNames[vals[i]]});}}},this);this.activeFileterFacet.loadData(af_data);if(this.activeFileterFacet.store.getCount()>0){this.activeFileterFacet.store.loadData([{id:-1,value:-1,name:L.ResetAll}],true);this.activeFileterFacet.setVisible(true);if(this.bindButton){this.bindButton.setIconCls(this.bindButton.initialConfig.activeIconCls);}}else{if(this.bindButton){this.bindButton.setIconCls(this.bindButton.initialConfig.iconCls);}}},onFacetChange:function(o,e){e.stopPropagation();var p=this.getFacetsValues();this.fireEvent('change',p,e);},getFacetsValues:function(){var rez={};this.items.each(function(fe){if(!Ext.isEmpty(fe.facetId)){var value=fe.getValue();if(value&&!Ext.isEmpty(value.values)){var fid=Ext.valueFrom(fe.facetId,fe.f);if(Ext.isEmpty(rez[fid])){rez[fid]=[];}
rez[fid].push(value);}}},this);return rez;},onActiveFiltersItemClick:function(idx,data,e){if(data.id==-1){return this.fireEvent('change',{});}
var i=this.child('[facetId="'+data.facetId+'"]');if(i){i.uncheck(data.value);var fv=this.getFacetsValues();this.fireEvent('change',fv);}}});Ext.define('CB.FacetActiveFilters',{extend:'Ext.Panel',title:L.ActiveFilters,cls:'facet activeFilters',autoHeight:true,layout:'fit',border:false,style:'border:0',bodyStyle:'background: none',initComponent:function(){this.store=new Ext.data.JsonStore({autoDestroy:true,model:'Filter',proxy:{type:'memory'}});if(!Ext.isEmpty(this.data)){this.store.loadData(this.data,false);}
Ext.apply(this,{items:new Ext.DataView({autoHeight:true,store:this.store,itemSelector:'li',tpl:['<ul class="filter_list">','<tpl for=".">','<li{[ (values.id == -1) ? \' class="reset"\' : ""]}>','<a href="#">{[Ext.valueFrom(values.name, "-")]}</a>','</li>','</tpl></ul>'],listeners:{scope:this,itemclick:function(cmp,record,item,index,e,eOpts){var r=this.store.getAt(index);this.fireEvent('itemclick',index,r.data,e);}}})});this.callParent(arguments);},loadData:function(data){this.store.loadData(data,false);this.doLayout();}});;Ext.namespace('CB.Favorites');Ext.define('CB.Favorites.Panel',{extend:'Ext.panel.Panel',xtype:'CBFavoritesPanel',constructor:function(config){this.store=new Ext.data.DirectStore({autoLoad:true,autoDestroy:true,autoSave:true,model:'FavoriteRecord',proxy:{type:'direct',paramsAsHash:true,directFn:CB_Favorites.read,reader:{type:'json',successProperty:'success',idProperty:'id',rootProperty:'data',messageProperty:'msg'}}});this.callParent(arguments);this.actions={browse:new Ext.Action({text:L.Browse,scope:this,handler:this.onBrowseClick}),edit:new Ext.Action({text:L.Edit,scope:this,handler:this.onEditClick}),unstar:new Ext.Action({text:L.Unstar,iconCls:'i-unstar',scope:this,handler:this.onUnstarClick})};},initComponent:function(){Ext.apply(this,{layout:'fit',border:false,iconCls:'icon-fav',tabConfig:{tooltip:L.Favorites},items:[{xtype:'grid',store:this.store,hideHeaders:true,bodyStyle:'border-width: 0',viewConfig:{loadMask:false},columns:[{text:'Name',dataIndex:'data',flex:1,renderer:function(v,m,r){m.css='icon-grid-column-top '+Ext.valueFrom(v.iconCls,'');App.customRenderers.titleAttribute(v.pathText,m);var rez='<span class="n">'+v.name+'</span>';return rez;}}],listeners:{scope:this,itemcontextmenu:this.onItemContextMenu,itemclick:this.onItemClick}}]});this.callParent(arguments);},isStarred:function(nodeId){var rez=this.store.findExact('node_id',String(nodeId));return(rez>=0);},setStarred:function(data){if(!this.isStarred(data.id)){Ext.Msg.prompt(L.Star,L.SetStarNameMsg,function(b,name){if(b==='ok'){data.name=name;var d={node_id:data.id,data:data};CB_Favorites.create(d,this.processSetStarred,this);}},this,false,data.name);}else{Ext.Msg.alert(L.Star,L.AlreadyStarred);}},processSetStarred:function(r,e){if(!r||(r.success!==true)){return;}
r.data.node_id=String(r.data.node_id);var rec=Ext.create(this.store.getModel().getName(),r.data);this.store.add(rec);this.fireEvent('change',this);},setUnstarred:function(nodeId){if(this.isStarred(nodeId)){CB_Favorites['delete'](nodeId,this.processSetUnstarred,this);}},processSetUnstarred:function(r,e){if(!r||(r.success!==true)){return;}
var s=this.store,idx=s.findExact('node_id',String(r.node_id));s.removeAt(idx);this.fireEvent('change',this);},onItemContextMenu:function(grid,record,item,index,e,eOpts){if(Ext.isEmpty(this.contextMenu)){this.contextMenu=new Ext.menu.Menu({items:[this.actions.browse,this.actions.edit,'-',this.actions.unstar]});}
e.stopEvent();this.contextMenu.record=record;this.actions.edit.setDisabled(Ext.isEmpty(record.data.data.template_id));this.contextMenu.showAt(e.getXY());},onBrowseClick:function(b,e){var r=this.contextMenu.record,d=Ext.clone(r.data.data);d.id=r.data.node_id;App.openPath(d);},onEditClick:function(b,e){var r=this.contextMenu.record,d=Ext.clone(r.data.data);d.id=r.data.node_id;App.openObjectWindow(d);},onUnstarClick:function(b,e){this.setUnstarred(this.contextMenu.record.data.node_id);},onItemClick:function(grid,record,item,index,e,eOpts){var d=Ext.clone(record.data.data);d.id=record.data.node_id;App.openPath(d);}});;Ext.namespace('CB.plugin.dd');Ext.define('CB.plugin.dd.FilesDropZone',{extend:'Ext.util.Observable',alias:'plugin.CBPluginDDFilesDropZone',pidPropety:'nid',constructor:function(config){Ext.apply(this,{dropZoneConfig:{text:L.DropFilesHere}});if(config){Ext.apply(this,config);}},init:function(owner){this.owner=owner;owner.enableBubble(['getdraftid']);owner.on('render',this.onRender,this);if(owner.dropZoneConfig){Ext.apply(this.dropZoneConfig,owner.dropZoneConfig);}},onRender:function(grid){var el=grid.getEl();el.on('dragleave',this.onDragLeave,this);el.on('dragover',this.onDragOver,this);el.on('drop',this.onDrop,this);App.on('dragfilesenter',this.showDropZone,this);App.on('dragfilesover',this.showDropZone,this);App.on('dragfilesleave',this.hideDropZone,this);App.on('filesdrop',this.hideDropZone,this);},onBeforeDestroy:function(){App.un('dragfilesenter',this.showDropZone,this);App.un('dragfilesover',this.showDropZone,this);App.un('dragfilesleave',this.hideDropZone,this);App.un('filesdrop',this.hideDropZone,this);if(this.dropZoneEl){this.dropZoneEl.clearListeners();this.dropZoneEl.remove();}},getTarget:function(e){var te=this.owner.getEl();var ce=e.getTarget('.x-grid-row');if(!Ext.isEmpty(ce)){var rel=this.owner.findTargetByEvent(e),rec=this.owner.getRecord(rel),templateId=rec.data.template_id,acceptChildren=CB.DB.templates.acceptChildren(templateId);if(acceptChildren){ce=Ext.get(ce);if(te.contains(ce)){te=ce;}}}
return te;},getTargetData:function(e){var te=this.getTarget(e);this.targetId=null;this.targetPath=null;if(te.hasCls('x-grid-row')){var rel=this.owner.findTargetByEvent(e);var rec=this.owner.getRecord(rel);if(rec){this.targetId=rec.get(this.pidPropety);this.targetPath=rec.get('path')+rec.get('name')+'/';}}else{var cmp=Ext.getCmp(te.id);if(cmp.grid&&!Ext.isDefined(cmp.getProperty)){cmp=cmp.grid;}
this.targetId=cmp.getProperty(this.pidPropety);this.targetPath=cmp.getProperty('pathtext');}},onDragEnter:function(e){this.getTarget(e).addCls('drop-target');},onDragLeave:function(e){var te=this.getTarget(e);te.removeCls('drop-target');},onDragOver:function(e,el,o){e.browserEvent.dataTransfer.dropEffect='copy';var te=this.getTarget(e);if(Ext.isEmpty(te)){return false;}
te.addCls('drop-target');if(this.lastEl==te){return true;}
if(!Ext.isEmpty(this.lastEl)){this.lastEl.removeCls('drop-target');}
this.lastEl=te;return true;},onDrop:function(e){this.onDragLeave(e);if(this.filesCount(e)<1){return false;}
this.getTargetData(e);e.stopEvent();this.hideDropZone();this.getRecursiveFileList(e);},getRecursiveFileList:function(e){var dt=e.browserEvent.dataTransfer;if(Ext.isEmpty(dt.items)){return this.processGetRecursiveFileList(dt.files);}
var length=dt.items.length;var entries=[];for(var i=0;i<length;i++){entries.push(dt.items[i].webkitGetAsEntry());}
Ext.ux.WebkitEntriesIterator.iterateEntries(entries,this.processGetRecursiveFileList,this);return 0;},processGetRecursiveFileList:function(filesArray){if(isNaN(this.targetId)){this.filesArray=filesArray;this.owner.fireEvent('getdraftid',this.onGetDraftIdCallback,this);return false;}
App.addFilesToUploadQueue(filesArray,{pid:this.targetId,pathtext:this.targetPath});return true;},onGetDraftIdCallback:function(draftId){if(isNaN(draftId)){return;}
this.targetId=draftId;this.processGetRecursiveFileList(this.filesArray);},addFilesToQueue:function(e,targetPid){},filesCount:function(e){var files=e.browserEvent.dataTransfer.files;if(Ext.isEmpty(files)){return 0;}
for(var i=0,f;f=files[i];i++){}
return i;},showDropZone:function(e){var el=this.owner.getEl();if(Ext.isEmpty(el)||Ext.isEmpty(el.dom)){this.onBeforeDestroy();return;}
if(!el.isVisible(true)){return;}
if(!this.dropZoneEl){this.dropZoneEl=this.owner.getEl().appendChild(document.createElement('div'));this.dropZoneEl.addCls('desktop-drop-zone');this.dropZoneEl.update(this.dropZoneConfig.text);this.dropZoneEl.on('dragenter',function(e,el){Ext.get(el).addCls('grid-drop-zone-over');});this.dropZoneEl.on('dragleave',function(e,el){Ext.get(el).removeCls('grid-drop-zone-over');});this.dropZoneEl.addCls('grid-drop-zone');}
this.dropZoneEl.applyStyles("display:block");},hideDropZone:function(e){var a=Ext.query('.desktop-drop-zone');if(!Ext.isEmpty(a)){for(var i=a.length-1;i>=0;i--){a=Ext.get(a);a.applyStyles("display:none");a.removeCls('grid-drop-zone-over');}}}});;Ext.namespace('CB');Ext.define('CB.Uploader',{extend:'Ext.util.Observable',defaultConfig:{autoStart:true,autoShowWindow:true,url:'upload/'},group:0,status:0,stats:{totalSize:0,totalCount:0,totalLoadedSize:0,totalLoadedCount:0,currentFileSize:0,currentLoaded:0},constructor:function(config){this.config=config||{};Ext.applyIf(this.config,this.defaultConfig);this.callParent(arguments);},init:function(){if(!this.browserUploadingSupport()){return false;}
this.store=new Ext.data.JsonStore({model:'UploadRecord',proxy:{type:'memory',reader:{type:'json'}}});this.xhr=new XMLHttpRequest();if(this.xhr.addEventListener){this.xhr.addEventListener("loadstart",this.onFileUploadStart.bind(this),false);this.xhr.upload.addEventListener("progress",this.onFileUploadProgress.bind(this),false);this.xhr.addEventListener("abort",this.onFileUploadAbort.bind(this),false);this.xhr.addEventListener("error",this.onFileUploadError.bind(this),false);this.xhr.addEventListener("load",this.onFileUploadLoad.bind(this),false);this.xhr.addEventListener("timeout",this.onFileUploadTimeout.bind(this),false);this.xhr.addEventListener("loadend",this.onFileUploadLoadEnd.bind(this),false);}else if(this.xhr.attachEvent){this.xhr.attachEvent("loadstart",this.onFileUploadStart.bind(this),false);this.xhr.upload.attachEvent("progress",this.onFileUploadProgress.bind(this),false);this.xhr.attachEvent("abort",this.onFileUploadAbort.bind(this),false);this.xhr.attachEvent("error",this.onFileUploadError.bind(this),false);this.xhr.attachEvent("load",this.onFileUploadLoad.bind(this),false);this.xhr.attachEvent("timeout",this.onFileUploadTimeout.bind(this),false);this.xhr.attachEvent("loadend",this.onFileUploadLoadEnd.bind(this),false);}
this.fileMD5=new Ext.ux.fileMD5();this.fileMD5.on('done',this.onFileMD5Calculated,this);return true;},browserUploadingSupport:function(){return(typeof(FileReader)!=='undefined');},onFileUploadStart:function(e){this.uploadingFile.set('status',1);},onFileUploadProgress:function(e){if(e.lengthComputable){this.uploadingFile.set('loaded',e.loaded);this.stats.currentLoaded=e.loaded;}this.stats.currentLoaded=-1;this.progressChange();},onFileUploadAbort:function(e){this.targetStatus=4;},onFileUploadError:function(e){this.targetStatus=2;},onFileUploadLoad:function(e){},onFileUploadTimeout:function(e){this.targetStatus=3;},onFileUploadLoadEnd:function(e){if(this.uploadingFile){this.stats.totalLoadedSize+=this.uploadingFile.get('size');this.stats.totalLoadedCount++;this.stats.currentLoaded=0;this.stats.currentFileSize=0;this.uploadingFile.set('loaded',this.uploadingFile.get('size'));this.progressChange();var r=Ext.util.JSON.decode(e.target.response);if(r&&(r.success===true)){this.uploadingFile.set('status',this.targetStatus);if(Ext.isEmpty(this.uploadingFile.data.draftPid)){this.updatedPids.push(r.data.pid);}
this.fireEvent('fileuploadend',this.uploadingFile);delete this.uploadingFile;this.uploadNextFile();}else{this.onUploadFailure(r,e);}}},onUploadFailure:function(r,e){if(r.type==='filesexist'){r.count=this.getGroupPendingFilesCount(this.uploadingFile.get('group'));this.serverResponse=r;var w=new CB.FilesConfirmationWindow({title:L.FileExists,icon:Ext.MessageBox.QUESTION,data:{msg:this.serverResponse.msg,single:(this.serverResponse.count==1),allow_new_version:this.serverResponse.allow_new_version,suggestedFilename:this.serverResponse.suggestedFilename,autorenameButton:true},listeners:{scope:this,hide:this.onConfirmResponse}});w.show();}else{this.uploadingFile.set('status',2);App.showException({msg:L.ErrorUploadingFile.replace('{name}',this.uploadingFile.get('name'))});this.uploadNextFile();}},getGroupPendingFilesCount:function(group){var rez=0;this.store.each(function(r){if((r.get('group')==group)&&(r.get('status')<2)){rez++;}},this);return rez;},getStatsForPid:function(pid){var field=Ext.isNumeric(pid)?'pid':'draftPid',rez={total:0,complete:0,pending:0};this.store.each(function(r){if(r.get(field)==pid){rez.total+=1;if(r.get('status')<2){rez.pending+=1;}else{rez['complete']+=1;}}},this);return rez;},onConfirmResponse:function(w){this.uploadingFile.set('response',w.response);if(w.response==='rename'){Ext.Msg.prompt(L.Rename,L.NewFileName,function(btn,text){if((btn==='ok')&&!Ext.isEmpty(text)){CB_Browser.confirmUploadRequest({response:'rename',newName:text},this.onConfirmResponseProcess,this);}else{this.uploadingFile.set('status',4);CB_Browser.confirmUploadRequest({response:'cancel'},this.onConfirmResponseProcess,this);}},this,false,this.serverResponse.suggestedFilename);}else{if(w.forAll){this.store.each(function(r){if((r.get('status')<2)&&(r.get('group')==this.uploadingFile.get('group'))){r.set('response',w.response);}},this);}
CB_Browser.confirmUploadRequest({response:w.response},this.onConfirmResponseProcess,this);}
w.destroy();},onConfirmResponseProcess:function(r,e){if(r&&(r.success===true)){this.uploadingFile.set('status',5);if(Ext.isEmpty(r.data.draftPid)){this.updatedPids.push(r.data.pid);}
this.uploadNextFile();}else{this.onUploadFailure(r,e);}},progressChange:function(){this.fireEvent('progresschange',this,this.status,this.stats);},addFiles:function(FilesList,options){if(this.config.autoShowWindow){}
this.group++;Ext.each(FilesList,function(f){if(f&&(f.size==0)){return Ext.Msg.alert(L.Error,L.BrowserNoFolderUpload);}
var dir=Ext.valueFrom(f.fullPath,f.mozFullPath);if(!Ext.isEmpty(dir)){dir=dir.split('/');dir.pop();dir=dir.join('/');}else{dir='/';}
var name=Ext.util.Format.stripScripts(Ext.util.Format.stripTags(f.name)),record=Ext.create(this.store.getModel().getName(),{id:Ext.id(),group:this.group,name:name,type:f.type,size:f.size,pid:options.pid,draftPid:options.draftPid,dir:dir,pathtext:options.pathtext,file:f,response:options.response,status:0,loaded:0,msg:'',md5:false,md5_verified:0});this.store.add([record]);this.stats.totalSize+=record.get('size');this.stats.totalCount++;},this);this.progressChange();this.calculateFilesMd5();},calculateFilesMd5:function(){var idx=this.store.findExact('md5',false);if(idx>=0){this.md5FileRecord=this.store.getAt(idx);this.fileMD5.getMD5(this.md5FileRecord.get('file'));}else{delete this.md5FileRecord;this.checkExistentContents();}},onFileMD5Calculated:function(fileMD5,result){this.md5FileRecord.set('md5',result);this.calculateFilesMd5();},checkExistentContents:function(){var md5array={},i=0;this.store.each(function(r){if(Ext.isEmpty(r.get('md5'))){r.set('md5_verified',1);}else if(r.get('md5_verified')==0){md5array[r.get('id')]=r.get('md5')+'s'+r.get('size');i++;}},this);if(i>0){CB_Files.checkExistentContents(md5array,this.processCheckExistentContents,this);}else if(this.config.autoStart){this.start();}},processCheckExistentContents:function(r,e){if(!r||(r.success!==true)){return;}
Ext.iterate(r.data,function(k,v,o){var idx=this.store.findExact('id',k);if(idx>=0){r=this.store.getAt(idx);r.set('md5_verified',1);r.set('content_id',v);}},this);if(this.config.autoStart){this.start();}},start:function(){if(this.status==1){return;}
var idx=this.store.findExact('status',0);if(idx<0){return;}
this.status=1;this.updatedPids=[];this.uploadNextFile();},uploadNextFile:function(){if(this.status!=1){return;}
var idx=this.store.findExact('status',0);if(idx<0){this.status=2;this.stats={totalSize:0,totalCount:0,totalLoadedSize:0,totalLoadedCount:0,currentFileSize:0,currentLoaded:0};this.progressChange();if(!Ext.isEmpty(this.updatedPids)){App.fireEvent('filesuploaded',this.updatedPids);}
return;}
var r=this.store.getAt(idx);this.uploadingFile=r;this.stats.currentFileSize=r.get('size');this.stats.currentLoaded=0;this.targetStatus=5;var params={name:encodeURIComponent(r.get('name')),type:r.get('type'),size:r.get('size'),pid:r.get('pid'),draftPid:r.get('draftPid'),dir:r.get('dir'),md5:r.get('md5'),content_id:r.get('content_id'),response:r.get('response')};this.xhr.open("POST",'upload/',true);this.xhr.setRequestHeader("X-FILE-OPTIONS",Ext.util.JSON.encode(params));if(r.get('content_id')>0){this.xhr.send('');}else{this.xhr.send(r.get('file'));}
this.progressChange();},abort:function(){if(this.status!=1){return;}
this.status=3;if(this.xhr.upload){this.xhr.upload.abort();}},showUploadWindow:function(){if(this.uploadWindow&&!this.uploadWindow.isDestroyed){return this.uploadWindow.show();}
this.uploadWindow=new CB.UploadWindow({uploader:this});this.uploadWindow.show();}});Ext.define('CB.UploadWindow',{extend:'Ext.Window',title:L.UploadQueue,closeAction:'destroy',width:640,height:380,layout:'fit',filterIndex:0,initComponent:function(){this.uploader=this.uploader||App.getFileUploader();this.actions={start:new Ext.Action({text:L.Start,iconCls:'i-start',handler:this.onStartClick,scope:this,disabled:true}),stop:new Ext.Action({text:L.Stop,iconCls:'i-stop',handler:this.onStopClick,scope:this,hidden:true}),cancel:new Ext.Action({text:L.Cancel,iconCls:'i-cancel',handler:this.onCancelClick,scope:this,disabled:true}),cancelAll:new Ext.Action({text:L.CancelAll,iconCls:'i-cancel',handler:this.onCancelAllClick,scope:this,disabled:true}),clear:new Ext.Action({text:L.Clear,handler:this.onClearClick,scope:this,hidden:true})};this.statusLabel=new Ext.form.DisplayField({value:L.ReadyToUpload});this.cancelSplitButton=new Ext.SplitButton({xtype:'splitbutton',iconCls:'i-cancel',text:L.Cancel,handler:this.onCancelClick,scope:this,disabled:true,menu:[this.actions.cancelAll]});this.viewButton=new Ext.Button({text:L.Pending,iconCls:'i-list',menu:[{enableToggle:true,allowDepress:false,toggleGroup:'viewMode',pressed:true,text:L.Pending,filterIndex:0,scope:this,handler:this.onChangeViewClick},{enableToggle:true,allowDepress:false,toggleGroup:'viewMode',text:L.AllCompleted,filterIndex:1,scope:this,handler:this.onChangeViewClick},{enableToggle:true,allowDepress:false,toggleGroup:'viewMode',text:L.All,filterIndex:-1,scope:this,handler:this.onChangeViewClick}]});this.storeFilters=[function(r){return(r.get('status')<2);},function(r){return(r.get('status')>1);}];this.optionsButton=new Ext.Button({text:L.Options,iconCls:'i-settings',menu:[{checked:true,text:L.AutoshowUpload,scope:this,name:'autoShowWindow',handler:this.onOptionsClick},{checked:true,text:L.UploadAutoStart,scope:this,name:'autoStart',handler:this.onOptionsClick}]});this.grid=new Ext.grid.GridPanel({store:this.uploader.store,stateful:true,multiSelect:true,stateId:'uploadGrid',border:false,columns:[{header:'Name',width:150,sortable:false,dataIndex:'name',renderer:function(v,meta,r){return Ext.util.Format.htmlEncode(v);}},{header:'Size',width:90,sortable:true,align:'right',renderer:Ext.util.Format.fileSize,dataIndex:'size'},{header:'status',width:75,sortable:true,dataIndex:'status',renderer:function(v,meta,r){return Ext.valueFrom(L['fileUploadStatus'+v],'');}},{header:'Percent',width:75,sortable:true,dataIndex:'loaded',renderer:function(v,meta,r){if(r.get('status')==0){return'';}
if(v==0){return'';}
return Math.round(v*100/r.get('size'))+' %';}},{header:'Path',width:200,sortable:true,dataIndex:'pathtext',renderer:function(v,m,r){return(Ext.valueFrom(v,'')+
Ext.valueFrom(r.get('dir').substr(1),''));}},{header:'msg',width:175,sortable:true,dataIndex:'msg',hidden:true}],viewConfig:{stripeRows:false,markDirty:false},tbar:new Ext.Toolbar({enableOverflow:true,style:{background:'transparent',border:'none',padding:'5px 0'},items:[this.actions.start,this.actions.stop,this.cancelSplitButton,this.actions.clear,'->',this.viewButton,this.optionsButton]}),bbar:[this.statusLabel]});this.grid.getSelectionModel().on('selectionchange',this.onSelectionChange,this);this.uploader.on('progresschange',this.onProgressChange,this);this.uploader.on('fileuploadend',this.filterView,this);Ext.apply(this,{items:[this.grid],listeners:{afterrender:this.onAfterRender,beforedestroy:this.onBeforeDestroy,scope:this}});this.callParent(arguments);},onAfterRender:function(){this.uploader.store.on('add',this.filterView,this);},onBeforeDestroy:function(){this.uploader.store.un('add',this.filterView,this);this.uploader.un('progresschange',this.onProgressChange,this);},onSelectionChange:function(sm){this.cancelSplitButton.setDisabled(!sm.hasSelection());this.actions.cancelAll.setDisabled(!sm.hasSelection());},onProgressChange:function(uploader,status,stats){this.actions.start.setDisabled(status==1);switch(status){case 0:this.statusLabel.setValue(Ext.valueFrom(L.ReadyToUpload,'Ready to upload'));break;case 1:this.statusLabel.setValue(Ext.valueFrom(L.UploadCompleted,'Uploading ... '));if(stats.currentLoaded<0){}else{var percent=stats.totalLoadedSize+stats.currentLoaded;if(percent>0){percent=Math.round(percent*100/stats.totalSize);}
this.statusLabel.setValue(Ext.String.format(Ext.valueFrom(L.UploadCompleted,'Uploading {0}% ({1} out of {2})'),percent,(stats.totalLoadedCount+1),stats.totalCount));}
break;case 2:this.statusLabel.setValue(Ext.valueFrom(L.UploadCompleted,'Upload completed'));break;case 3:this.statusLabel.setValue(Ext.valueFrom(L.UploadCanceled,'Upload canceled'));break;}},onStartClick:function(b,e){this.uploader.start();},onStopClick:function(b,e){},onCancelClick:function(b,e){this.uploader.abort();},onCancelAllClick:function(b,e){this.uploader.status=3;this.uploader.abort();},onClearClick:function(b,e){this.uploader.store.each(function(r){if(r.get('status')>1){this.store.remove(r);}});},onChangeViewClick:function(b,e){this.viewButton.setText(b.text);this.filterView(b.filterIndex);this.actions.clear.setHidden(b.filterIndex==0);},filterView:function(filterIndex){if(!Ext.isNumber(filterIndex)){filterIndex=undefined;}
if(filterIndex!==undefined){this.filterIndex=filterIndex;}else if(!Ext.isDefined(this.filterIndex)){this.filterIndex=-1;}
if(this.filterIndex<0){this.uploader.store.clearFilter();}else{this.uploader.store.filterBy(this.storeFilters[this.filterIndex]);}},onOptionsClick:function(b,e){this.uploader.config[b.name]=!b.checked;}});Ext.define('CB.UploadWindowButton',{extend:'Ext.Button',alias:['widget.uploadwindowbutton'],initComponent:function(){this.uploader=App.getFileUploader();if(!this.uploader){this.hide();this.destroy();return;}
this.resetLabelTask=new Ext.util.DelayedTask(this.resetLabel,this);Ext.apply(this,{text:L.UploadWindow,handler:this.showUploadWindow,scope:this});this.callParent(arguments);this.uploader.on('progresschange',this.onProgressChange,this);},showUploadWindow:function(b,e){this.uploader.showUploadWindow();},onProgressChange:function(uploader,status,stats){this.resetLabelTask.cancel();switch(status){case 0:this.setText(L.UploadQueue);break;case 1:this.setText(L.Uploading+' '+stats.totalLoadedCount+' '+L.outOf+' '+stats.totalCount);var pc=Math.round((stats.totalLoadedSize*100)/stats.totalSize);this.getEl().applyStyles('background-size: '+pc+'% 100%');break;case 2:this.setText(L.UploadComplete);this.resetLabelTask.delay(3000);break;}},resetLabel:function(){this.getEl().applyStyles('background-size: 0% 100%');this.setText(L.UploadQueue);}});;Ext.namespace('CB');Ext.define('CB.SecurityWindow',{extend:'Ext.Window',alias:'CBSecurityWindow',xtype:'CBSecurityWindow',closable:true,initComponent:function(){this.data=Ext.valueFrom(this.config.data,{});this.actions={edit:new Ext.Action({text:L.Edit,scope:this,handler:this.onEditClick}),add:new Ext.Action({text:L.Add,scope:this,handler:this.onAddClick,hidden:true}),del:new Ext.Action({text:L.Delete,scope:this,handler:this.onDeleteClick,hidden:true,disabled:true}),advanced:new Ext.Action({text:L.Advanced,scope:this,disabled:true,handler:this.onAdvancedClick}),save:new Ext.Action({text:L.Save,scope:this,handler:this.onSavePermissionsClick,hidden:true,disabled:true}),apply:new Ext.Action({text:L.Apply,scope:this,handler:this.onApplyPermissionsClick,hidden:true,disabled:true}),cancel:new Ext.Action({text:L.Cancel,scope:this,handler:this.onCancelPermissionsChangeClick,hidden:true,disabled:true}),removeChildPermissions:new Ext.Action({text:L.RemoveChildPermissions,iconCls:'icon-key-minus',scope:this,handler:this.onRemoveChildPermissionsClick})};this.objectLabel=new Ext.form.DisplayField({value:'Object name: ',style:'padding: 10px; background-color: #fff',reg_ion:'north'});this.editLabel=new Ext.form.DisplayField({value:'To change permissions, click Edit'});this.aclStore=new Ext.data.DirectStore({autoSave:false,autoSync:false,model:'AclRecord',proxy:{type:'direct',paramsAsHash:true,extraParams:{id:this.data.id},api:{read:CB_Security.getObjectAcl,create:CB_Security.addObjectAccess,update:CB_Security.updateObjectAccess,destroy:CB_Security.destroyObjectAccess},reader:{type:'json',rootProperty:'data'},writer:new Ext.data.JsonWriter({encode:false,writeAllFields:true,transform:Ext.Function.bind(function(data,request){return{id:this.data.id,data:data};},this)})},listeners:{scope:this,load:this.onAclStoreLoad}});this.aclList=new Ext.list.ListView({store:this.aclStore,singleSelect:true,emptyText:L.noData,reserveScrollOffset:true,hideHeaders:true,boxMinHeight:100,height:300,style:'border: 1px solid #aeaeae',forceFit:true,columns:[{header:'Group or user',dataIndex:'name',renderer:function(v,m,r,ri,ci,s){m.css='icon-grid-column-top '+r.get('iconCls');return v;}}],listeners:{scope:this,selectionchange:this.onAclListSelectionChange}});this.specialPermissionsLabel=new Ext.form.DisplayField({value:'For special permissions or advanced settings,<br /> click Advanced.'});this.permissionsStore=new Ext.data.ArrayStore({fields:['id','name','allow','deny'],accessGroups:{'FullControl':[1,1,1,1,1,1,1,1,1,1,1,1],'Modify':[1,1,1,1,1,1,1,0,1,0,0,1],'Read':[1,0,0,0,0,1,0,0,0,0,0,1],'Write':[0,1,1,1,1,0,1,0,0,0,0,0]}});this.permissionsList=new Ext.list.ListView({store:this.permissionsStore,singleSelect:true,emptyText:L.noData,reserveScrollOffset:true,boxMinHeight:100,height:300,style:'border: 1px solid #aeaeae',columnSort:false,forceFit:true,readOnly:true,columns:[{header:'Permission',width:100,dataIndex:'name'},{header:'Allow',width:50,dataIndex:'allow',renderer:function(v,m,r,ri,ci,s){return(this.readOnly?((v>0)?'<input type="checkbox" disabled="disabled" checked="checked" value="'+v+'">':""):'<input type="checkbox" '+((v==2)?'disabled="disabled" value="2" ':'value="1" ')+((v>0)?'checked="checked" ':"")+" />");},align:'center'},{header:'Deny',dataIndex:'deny',renderer:function(v,m,r,ri,ci,s){return(this.readOnly?((v<0)?'<input type="checkbox" disabled="disabled" checked="checked" value="'+v+'">':""):'<input type="checkbox" '+
((v==-2)?'disabled="disabled" value="-2" ':'value="-1" ')+((v<0)?'checked="checked" ':"")+" />");},align:'center'}],listeners:{scope:this,itemclick:this.onPermissionNodeClick}});this.cbInherit=new Ext.form.Checkbox({checked:true,id:'cb_inherit'+this.data.id,listeners:{scope:this,change:this.onCbInheritClick}});var topToolbar=null;if(App.loginData.admin){topToolbar=[this.actions.removeChildPermissions];}
Ext.apply(this,{title:L.Security,iconCls:'icon-key',autoHeight:true,cls:'x-panel-white',bodyStyle:'background-color: white',tbar:topToolbar,items:[this.objectLabel,{layout:'hbox',border:false,autoHeight:true,scrollable:true,items:[{title:L.GroupOrUserNames,layout:'fit',items:this.aclList,unstyled:true,width:400,padding:10,border:0,buttonAlign:'left',buttons:[this.editLabel,'->',this.actions.edit,this.actions.add,this.actions.del]},{title:L.PermissionsForItem,layout:'fit',items:this.permissionsList,unstyled:true,width:400,padding:10,border:0,style:'margin-left: 50px',buttonAlign:'left',buttons:[this.specialPermissionsLabel,'->',this.actions.save,this.actions.apply,this.actions.cancel,this.actions.advanced]}]},{xtype:'panel',region:'south',layout:'fit',autoHeight:true,border:false,padding:10,items:[{xtype:'fieldcontainer',layout:'hbox',items:[this.cbInherit,{xtype:'label',text:' '+L.InheritPermissionsMsg,style:'margin-top:3px',forId:'cb_inherit'+this.data.id,listeners:{scope:this,click:this.onCbInheritLabelClick}}]}]}],listeners:{scope:this,afterrender:this.onAfterRender}});this.callParent(arguments);},onAfterRender:function(){this.getEl().mask(L.loading,'x-mask-loading');this.aclStore.load();},onAclStoreLoad:function(store,records,options){this.getEl().unmask();var rawData=Ext.valueFrom(store.proxy.reader.rawData,{});this.objectLabel.setValue('Object name: '+Ext.valueFrom(rawData.path,'')+rawData.name);this.setTitle(rawData.name);this.cbInherit.settingValue=true;this.cbInherit.setValue(rawData.inherit_acl==1);delete this.cbInherit.settingValue;},onEditClick:function(b,e){this.setReadOnly(false);},setReadOnly:function(readOnly){this.editLabel.setVisible(readOnly);this.actions.edit.setHidden(!readOnly);this.actions.add.setHidden(readOnly);this.actions.del.setHidden(readOnly);this.updateDeleteAction();this.permissionsList.readOnly=readOnly;this.permissionsList.getView().refresh();this.specialPermissionsLabel.setVisible(readOnly);this.actions.advanced.setHidden(!readOnly);this.actions.save.setHidden(readOnly);this.actions.apply.setHidden(readOnly);this.actions.cancel.setHidden(readOnly);},updateDeleteAction:function(){var canDelete=true,sr=this.aclList.getSelectionModel().getSelection();if(!Ext.isEmpty(sr)){var r=sr[0];canDelete=((r.get('allow').indexOf('2')<0)&&(r.get('deny').indexOf('-2')<0));}
this.actions.del.setDisabled(!canDelete);},onAddClick:function(b,e){var w=new CB.ObjectsSelectionForm({config:{autoLoad:true,source:'usersgroups',renderer:'listObjIcons'},data:{}});w.on('setvalue',function(data){if(Ext.isEmpty(data)){return;}
var sm=this.aclList.getSelectionModel(),d=data[0],rec=this.aclStore.findRecord('user_group_id',d.id,0,false,false,true);if(rec){sm.select([rec]);return;}
var rd={id:null,user_group_id:d.id,name:d.name,iconCls:d.iconCls,allow:'0,0,0,0,0,0,0,0,0,0,0,0',deny:'0,0,0,0,0,0,0,0,0,0,0,0',phantom:true};this.aclStore.beginUpdate();rec=Ext.create(this.aclStore.getModel().getName(),rd);this.aclStore.add([rec]);this.aclStore.endUpdate();this.aclStore.sync();sm.select(this.aclStore.getCount()-1);},this);w.show();},onDeleteClick:function(b,e){var ra=this.aclList.getSelectionModel().getSelection();if(Ext.isEmpty(ra)){return;}
Ext.Msg.confirm(L.Delete,L.DeleteSelectedConfirmationMessage,function(b){if(b==='yes'){this.aclStore.remove(ra);this.aclStore.save();}},this);},onAclListSelectionChange:function(listView,selections){this.permissionsStore.removeAll();if(!Ext.isEmpty(selections)){this.reloadPermissionsStore();}
this.updateDeleteAction();},onPermissionNodeClick:function(list,record,item,index,e,eOpts){var cb=e.getTarget('input');if(Ext.isEmpty(record)||Ext.isEmpty(cb)||cb.disabled){return;}
this.changeAccesses(record,cb.checked?cb.value:0);this.actions.save.setDisabled(false);this.actions.apply.setDisabled(false);this.actions.cancel.setDisabled(false);},accessToGroupsData:function(accessRecord,groups){var rez=[],allow=accessRecord.get('allow'),deny=accessRecord.get('deny');if(!Ext.isArray(allow)){allow=allow.split(',');}
if(!Ext.isArray(deny)){deny=deny.split(',');}
Ext.iterate(groups,function(g,gv,obj){rez.push([g,L[g],this.accessToGroupValue(allow,gv),this.accessToGroupValue(deny,gv)]);},this);return rez;},accessToGroupValue:function(accessArray,groupBitsArray){var lastBit=null,bitsMatch=true,bitsCombinedMatch=false,i=0;while((i<accessArray.length)&&bitsMatch){var currentBit=parseInt(accessArray[i],10);if(groupBitsArray[i]==1){if(Ext.isEmpty(lastBit)){lastBit=currentBit;}else if((currentBit*lastBit)>0){if(currentBit!=lastBit){bitsCombinedMatch=true;}}else{bitsMatch=false;}}
i++;}
return bitsMatch?(bitsCombinedMatch?((lastBit<0)?-1:1):lastBit):0;},changeAccesses:function(groupRecord,newValue){var r=this.aclList.getSelectionModel().getSelection()[0];if(Ext.isEmpty(r)){return;}
var allow=r.get('allow').split(','),deny=r.get('deny').split(','),group=this.permissionsStore.accessGroups[groupRecord.get('id')];if(Ext.isEmpty(group)){return;}
newValue=parseInt(newValue,10);for(var i=0;i<group.length;i++){if(group[i]==1){if(newValue>-1){if((allow[i]>-2)&&(allow[i]<2)){allow[i]=newValue;}
if(deny[i]>-2){deny[i]=0;}}
if(newValue<1){if((deny[i]>-2)&&(deny[i]<2)){deny[i]=newValue;}
if(allow[i]<2){allow[i]=0;}}}}
r.set('allow',allow.join(','));r.set('deny',deny.join(','));this.reloadPermissionsStore();},reloadPermissionsStore:function(){var data=[],sr=this.aclList.getSelectionModel().getSelection();if(!Ext.isEmpty(sr)){data=this.accessToGroupsData(sr[0],this.permissionsStore.accessGroups);}
this.permissionsStore.loadData(data);},onSavePermissionsClick:function(){this.aclStore.sync();this.setReadOnly(true);},onApplyPermissionsClick:function(){this.aclStore.sync();this.actions.save.setDisabled(true);this.actions.apply.setDisabled(true);this.actions.cancel.setDisabled(true);},onCancelPermissionsChangeClick:function(b,e){this.aclStore.rejectChanges();this.reloadPermissionsStore();this.actions.save.setDisabled(true);this.actions.apply.setDisabled(true);this.actions.cancel.setDisabled(true);},onRemoveChildPermissionsClick:function(b,e){Ext.Msg.confirm(L.Confirmation,'Are you sure you want to remove child permissions and inherit all permissions from parent?',function(button){if(button==='yes'){CB_Security.removeChildPermissions({id:this.data.id},function(r,e){Ext.Msg.alert(L.Info,'Child permissions revoked successfully.');});}},this);},onCbInheritLabelClick:function(){cb.setValue(!cb.getValue());},onCbInheritClick:function(cb,checked){if(cb.settingValue){return;}
if(checked){Ext.Msg.confirm(L.Confirmation,'Are you sure you want to remove current rules and inherit all permissions from parent?',this.onCbInheritSet,this);}else{Ext.Msg.show({title:L.Confirmation,msg:'Warning: If you proceed, inheritable parent permissions will no longer propagate to this object.<br />'+'<br />'+'- Click Add to convert and add inherited parent permissions as explicit permissions to this object.<br />'+'- Click Remove to remove inherited parent permissions from this object.<br />'+'- Click Cancel if you do not want to modify inheritance settings at this time.<br />',buttons:Ext.MessageBox.YESNOCANCEL,buttonText:{yes:L.Add,no:L.Remove},scope:this,fn:this.onCbInheritRemove,icon:Ext.MessageBox.WARNING});}},onCbInheritSet:function(button){if(button==='yes'){this.getEl().mask(L.loading,'x-mask-loading');CB_Security.setInheritance({id:this.data.id,inherit:true},this.onSetInheritanceProcess,this);}else{this.cbInherit.settingValue=true;this.cbInherit.setValue(false);delete this.cbInherit.settingValue;}},onCbInheritRemove:function(button,text,cfg){if((button==='yes')||(button==='no')){this.getEl().mask(L.loading,'x-mask-loading');CB_Security.setInheritance({id:this.data.id,inherit:false,copyRules:button},this.onSetInheritanceProcess,this);}else{this.cbInherit.settingValue=true;this.cbInherit.setValue(true);delete this.cbInherit.settingValue;}},onSetInheritanceProcess:function(r,e){this.getEl().unmask();this.aclStore.load();}});;Ext.namespace('CB');Ext.define('CB.AddUserForm',{extend:'Ext.Window',layout:'fit',autoWidth:true,title:L.AddUser,iconCls:'icon-user-gray',data:{},initComponent:function(){var recs=CB.DB.roles.queryBy(function(r){return((r.get('id')!=3)&&(r.get('id')!=1)&&(App.loginData.manage||(r.get('id')!=2)));});var data=[];recs.each(function(r){data.push(r.data);},this);this.rolesStore=new Ext.data.JsonStore({autoLoad:true,autoDestroy:true,model:'Generic2',proxy:{type:'memory'},data:data});data=[];CB.DB.groupsStore.each(function(r){if(parseInt(r.get('system'),10)===0){data.push(r.data);}},this);this.groupsStore=new Ext.data.JsonStore({autoLoad:true,model:'Group',proxy:{type:'memory'},sortInfo:{field:'title',direction:'ASC'},data:data});var items=[{xtype:'textfield',allowBlank:false,fieldLabel:L.Username,name:'name'},{xtype:'textfield',allowBlank:true,fieldLabel:L.FirstName,name:'first_name'},{xtype:'textfield',allowBlank:true,fieldLabel:L.LastName,name:'last_name'},{xtype:'textfield',allowBlank:false,fieldLabel:L.Email,name:'email',vtype:'email'},{xtype:'radiogroup',fieldLabel:L.PasswordSetup,columns:2,vertical:true,name:'psw_setup',items:[{boxLabel:L.EmailInvite,name:'ps',inputValue:'1',checked:true},{boxLabel:L.Manual,name:'ps',inputValue:'2'}],listeners:{scope:this,change:this.onPasswordSetupChange}},{xtype:'textfield',allowBlank:true,fieldLabel:L.Password,inputType:'password',hidden:true,name:'password'},{xtype:'textfield',allowBlank:true,fieldLabel:L.PasswordConfirmation,inputType:'password',hidden:true,name:'confirm_password'},,{xtype:'combo',fieldLabel:L.Group,editable:false,name:'group_id',hiddenName:'group_id',store:this.groupsStore,valueField:'id',displayField:'title',triggerAction:'all',value:null,queryMode:'local'},{xtype:'label',name:'E',hideLabel:true,cls:'cR',text:''}];Ext.apply(this,{buttons:[{text:L.Save,iconCls:'icon-save',disabled:true,handler:this.saveData,scope:this},{text:L.Cancel,iconCls:'icon-cancel',handler:function(b,e){this.destroy();},scope:this}],items:[{xtype:'fieldset',border:false,autoHeight:true,autoWidth:true,labelWidth:150,style:'padding-top: 10px',defaults:{width:250,bubbleEvents:['change']},items:items}],listeners:{scope:this,change:function(e){this.setDirty(true);},show:function(){this.center();}}});this.callParent(arguments);this.on('close',function(){CB.DB.roles.clearFilter();},this);},setDirty:function(value){this._isDirty=value;var required=true,a=this.query('[isFormField=true]');Ext.each(a,function(i){required=required&&i.isValid();if(!i.allowBlank){required=required&&!Ext.isEmpty(i.getValue());return required;}},this);var p=this.down('[name="password"]'),pc=this.down('[name="confirm_password"]'),pm=(p.getValue()!=pc.getValue()),msg=required?'':L.EmptyRequiredFields;this.down('[name="E"]').setText(pm?L.PasswordMissmatch:msg);this.dockedItems.getAt(1).items.getAt(0).setDisabled(!value||!required);},onPasswordSetupChange:function(rg,nv,ov,eOpts){var p=this.down('[name="password"]'),pc=this.down('[name="confirm_password"]');p.setHidden(nv.ps==1);pc.setHidden(nv.ps==1);},saveData:function(){var params={};var a=this.query('[isFormField=true]');Ext.each(a,function(i){params[i.name]=i.getValue();},this);if(this.config.data.callback){this.config.data.callback(params,this.config.ownerCt);}}});Ext.define('CB.UsersGroupsTree',{extend:'Ext.tree.TreePanel',scrollable:true,containerScroll:true,rootVisible:false,animate:false,border:false,enableDD:true,tbarCssClass:'x-panel-white',initComponent:function(){this.actions={addUser:new Ext.Action({text:L.User,iconCls:'icon-user',handler:this.onAddUserClick,scope:this}),addGroup:new Ext.Action({text:L.AddGroup,iconCls:'icon-users',handler:this.onAddGroupClick,scope:this}),del:new Ext.Action({text:L.Delete,iconCls:'im-trash',scale:'medium',disabled:true,handler:this.delNode,scope:this}),remove:new Ext.Action({text:L.Remove,iconCls:'im-cancel',scale:'medium',disabled:true,handler:this.deassociateNode,scope:this}),reload:new Ext.Action({iconCls:'im-refresh',scale:'medium',qtip:L.Reload,scope:this,handler:function(){var rn=this.getRootNode();this.store.reload({node:rn});}}),rename:new Ext.Action({text:L.Rename,scope:this,handler:this.onRenameClick})};this.editor=new Ext.Editor({field:{xtype:'textfield'},allowBlank:false,blankText:L.NameRequired,selectOnFocus:true,ignoreNoChange:true});this.editor.on('beforestartedit',this.onBeforeStartEdit,this);this.editor.on('startedit',this.onStartEdit,this);this.editor.on('beforecomplete',this.onBeforeEditComplete,this);Ext.apply(this,{cls:'x-panel-white',store:Ext.create('Ext.data.TreeStore',{root:{expanded:false,expandable:true,iconCls:'icon-home',leaf:false,nid:'root',text:'root'},proxy:{type:'direct',directFn:CB_UsersGroups.getChildren,paramsAsHash:true,extraParams:{path:'/'}},listeners:{scope:this,beforeload:function(store,record,eOpts){store.proxy.extraParams.path=record.config.node.getPath('nid');},load:function(o,n,r){if(!Ext.isEmpty(this.lastPath)){this.selectPath(this.lastPath,'nid','/');}}}}),tbar:[{text:L.Add,iconCls:'im-create',scale:'medium',menu:[this.actions.addUser,this.actions.addGroup]},this.actions.del,this.actions.remove,'-',this.actions.reload],listeners:{scope:this,nodedragover:function(o){if((o.point!=='append')||(o.target==o.dropNode.parentNode)||(o.target.getDepth()!=1)||(o.target.data.nid<1)){o.cancel=true;return;}},beforenodedrop:function(o){o.cancel=true;o.dropStatus=true;},dragdrop:function(tree,node,dd,e){this.sourceNode=dd.dragOverData.dropNode;this.targetNode=dd.dragOverData.target;CB_UsersGroups.associate(this.sourceNode.data.nid,this.targetNode.data.nid,this.processAssociate,this);},beforeitemappend:function(parent,n){var text=Ext.valueFrom(n.data.title,n.data.name);n.data.title=text;if(parent.getDepth()==1){text+=' <span class="cG">(id:'+n.data.nid+')</span>';if(n.data.enabled!=1){text+=' <span class="cG">'+L.Disabled+'</span>';}
n.data.iconCls='icon-user-'+Ext.valueFrom(n.data.sex,'');}
if(n.data.type==1){n.data.cls=n.data.cls+' fwB';this.getView().addItemCls(n,'fwB');}
if(n.data.cid==App.loginData.id){n.data.cls=n.data.cls+' cDB';this.getView().addItemCls(n,'fwB');}
n.set('text',text);},remove:this.updateChildrenCount,append:this.updateChildrenCount,afterrender:this.onAfterRender,beforeitemcontextmenu:this.onItemContextMenu},selType:'treemodel',selModel:{listeners:{scope:this,selectionchange:function(sm,selection){if(Ext.isEmpty(selection)){this.actions.del.setDisabled(true);this.actions.remove.setDisabled(true);}else{this.actions.del.setDisabled(selection[0].data.system==1);this.actions.remove.setDisabled((selection[0].getDepth()<2)||(selection[0].parentNode.data.nid<1));this.actions.rename.setDisabled(selection[0].data.type!=='1');}}}}});this.callParent(arguments);this.enableBubble(['verify']);},onAfterRender:function(tree,eOpts){new Ext.util.KeyMap({target:this.getEl(),key:Ext.event.Event.F2,alt:false,ctrl:false,stopEvent:true,fn:this.onRenameClick,scope:this});},onRenameClick:function(b,e){var n=this.getSelectionModel().getSelection()[0];if(!n||this.actions.rename.isDisabled()){return;}
this.editor.editNode=n;n.set('text',n.data.title);this.editor.startEdit(this.getView().getSelectedNodes()[0]);},onBeforeStartEdit:function(editor,boundEl,value){var n=this.getSelectionModel().getSelection()[0];if((n.data.type!=1)||(n.data.nid<1)){return false;}},onStartEdit:function(boundEl,value){var n=this.getSelectionModel().getSelection()[0];if(n.data.type!=1){return false;}
value=n.data.title;this.editor.setValue(value);},onBeforeEditComplete:function(editor,newVal,oldVal){var n=this.getSelectionModel().getSelection()[0];oldVal=n.data.title;if(newVal===oldVal){return;}
n=editor.editNode;editor.cancelEdit();this.getEl().mask(L.Processing,'x-mask-loading');CB_UsersGroups.renameGroup({id:n.data.nid,title:newVal},this.processRenameGroup,this);return false;},processRenameGroup:function(r,e){this.getEl().unmask();if(!r||(r.success!==true)){return;}
this.editor.editNode.data.title=r.title;this.updateChildrenCount(this,this.editor.editNode);this.getView().focusNode(this.editor.editNode,100);},onItemContextMenu:function(tree,record,item,index,e,eOpts){e.stopEvent();if(record.data.type==='1'){if(!this.contextMenu){this.contextMenu=new Ext.menu.Menu({items:[this.actions.rename]});}
this.contextMenu.showAt(e.getXY());}
return false;},onAddUserClick:function(b,e){this.addUserForm=new CB.AddUserForm({modal:true,ownerCt:this,data:{callback:this.addUser}});this.addUserForm.show();},addUser:function(params,t){CB_UsersGroups.addUser(params,t.processAddUser,t);},processAddUser:function(r,e){if(!r){return;}
if(r.success!==true){if(!Ext.isEmpty(r.msg)){Ext.Msg.alert(L.Error,r.msg);}
return false;}else if(this.addUserForm){this.addUserForm.destroy();delete this.addUserForm;}
this.lastPath='/root/'+r.data.group_id+'/'+r.data.nid;this.store.clearFilter();this.ownerCt.container.component.searchField.clear();var rn=this.getRootNode();this.store.reload({node:rn});App.mainViewPort.fireEvent('useradded',r.data);},onAddGroupClick:function(b,e){Ext.Msg.prompt(L.Group,L.Name,function(b,text){if((b==='ok')&&!Ext.isEmpty(text)){var rec={name:text,title:text};CB.DB.groupsStore.beginUpdate();CB.DB.groupsStore.add(rec);CB.DB.groupsStore.endUpdate();this.store.reload({node:this.getRootNode()});}},this);},sortTree:function(n1,n2){return(n1.text<n2.text)?-1:1;},deassociateNode:function(){var n=this.getSelectionModel().getSelection()[0];if(!n){return;}
Ext.Msg.confirm(L.ExtractUser,L.ExtractUserMessage.replace('{user}',n.data.name).replace('{group}',n.parentNode.data.text),function(b){if(b==='yes'){CB_UsersGroups.deassociate(n.data.nid,n.parentNode.data.nid,this.processDeassociate,this);}},this);},processDeassociate:function(r,e){if(!r){return;}
if(r.success!==true){if(r.verify){this.fireEvent('verify',this);}
return false;}
var n=this.getSelectionModel().getSelection()[0];var attr=n.data;attr.iconCls='icon-user-gray';this.store.remove(n);if(r.outOfGroup){var p=this.getRootNode().findChild('nid','-1');if(p.loaded){p.appendChild(attr);p.sort(this.sortTree);}else{p.data.users++;p.set('text',p.data.text.split('<')[0]+' <span class="cG">('+p.data.users+')</span>');}}},processAssociate:function(r,e){if(!r){return;}
if(r.success!==true){if(r.verify){this.fireEvent('verify',this);}
return false;}
var attr=Ext.apply({},this.sourceNode.data);if(this.targetNode.loaded){attr.id=Ext.id();this.targetNode.appendChild(attr);this.targetNode.sort(this.sortTree);}else{this.targetNode.data.users++;this.targetNode.set('text',this.targetNode.data.text.split('<')[0]+' <span class="cG">('+this.targetNode.data.users+')</span>');}
if(this.sourceNode.parentNode.data.nid==='-1'){this.sourceNode.remove(true);}},delNode:function(){var n=this.getSelectionModel().getSelection()[0];if(!n){return;}
switch(n.getDepth()){case 2:this.deletedUserData=n.data;Ext.MessageBox.confirm(L.Confirmation,L.DeleteUser+' "'+n.data.text+'"?',function(btn,text){if(btn==='yes'){n=this.getSelectionModel().getSelection()[0];CB_UsersGroups.deleteUser(n.data.nid,this.processDelNode,this);}},this);break;case 1:Ext.MessageBox.confirm(L.Confirmation,L.DeleteGroupConfirmationMessage+' "'+n.data.text+'"?',function(btn,text){if(btn==='yes'){CB_Security.destroyUserGroup(n.data.nid,this.processDestroyUserGroup,this);}},this);break;}},processDestroyUserGroup:function(r,e){if(!r){return;}
if(r.success!==true){if(r.verify){this.fireEvent('verify',this);}
return false;}
this.processDelNode(r,e);CB.DB.groupsStore.reload();},processDelNode:function(r,e){if(!r){return;}
if(r.success!==true){if(r.verify){this.fireEvent('verify',this);}
return false;}
var nid=this.getSelectionModel().getSelection()[0].data.nid,deleteNodes=[];this.getRootNode().cascadeBy({before:function(n){if(n.data.nid==nid){deleteNodes.push(n);}},scope:this});for(var i=0;i<deleteNodes.length;i++){deleteNodes[i].remove(true);}
if(this.deletedUserData){App.mainViewPort.fireEvent('userdeleted',this.deletedUserData);delete this.deletedUserData;}},updateChildrenCount:function(t,p){if(Ext.isEmpty(p)){return;}
if(Ext.isEmpty(p.childNodes)){if(!Ext.isEmpty(p.data)){p.set('text',p.data.title);}
return;}
p.data.users=p.childNodes.length;p.set('text',p.data.title+' <span class="cG">('+p.data.users+')</span>');},filter:function(text,property){var store=this.store;store.clearFilter();if(Ext.isEmpty(text)){return;}
text=text.toLowerCase();store.filterBy(function(record,id){return((record.data.depth<2)||(record.data[property].toLowerCase().indexOf(text)>=0));},this);},clearFilter:function(){this.store.clearFilter();}});Ext.define('CB.UserEditWindow',{extend:'Ext.Window',iconCls:'icon-user',title:L.User,modal:true,closeAction:'destroy',y:150,autoWidth:true,autoHeight:true,layout:'fit',autoShow:true,initComponent:function(){this.data=this.config.data;this.profileForm=new CB.ProfileForm({header:false,data:this.data,autoHeight:true,autoWidth:true,border:false,listeners:{scope:this,savesuccess:function(f,a){this.fireEvent('savesuccess',f,a);App.fireEvent('userprofileupdated',f.data,a);this.destroy();},cancel:this.destroy}});Ext.apply(this,{items:this.profileForm,listeners:{scope:this,afterrender:this.onAfterRender}});this.callParent(arguments);this.enableBubble(['verify']);},onAfterRender:function(){this.getEl().mask(L.LoadingData+' ...');CB_User.getProfileData(this.data.id,this.onLoadProfileData,this);},onLoadProfileData:function(r,e){this.getEl().unmask();if(!r){return;}
if(r.success!==true){if(r.verify){this.fireEvent('verify',this);}
this.destroy();return;}
this.profileForm.loadData(r);}});Ext.define('CB.UsersGroupsForm',{extend:'Ext.form.FormPanel',border:false,disabled:true,fileUpload:true,data:{},initComponent:function(){var bulletRenderer=function(v,m){m.css='taC';return(v==1)?'<span class="icon-padding icon-tick"></span>':'';};this.actions={disableTSV:new Ext.Action({text:L.Disable+' '+L.TSV,scope:this,disabled:true,handler:this.onDisableTSVClick}),enableUser:new Ext.Action({text:L.EnableUser,scope:this,handler:this.onUserToggleEnableClick}),disableUser:new Ext.Action({text:L.DisableUser,scope:this,handler:this.onUserToggleEnableClick})};this.userInfo=new Ext.DataView({tpl:['<img class="fl user-photo-field click icon-user32-{sex}" src="'+App.config.photoPath+'{id}.png?32={[ CB.DB.usersStore.getPhotoParam(values.id) ]}">','<span class="fwB click">{title}</span>{[ (values.enabled != 1) ? \' - \' + L.Disabled : \'\' ]}<br />','<span class="cG">'+L.User+':</span> {name}, <span class="cG">'+L.lastAction+':</span> ','{[ Ext.isEmpty(values.last_action_time) ? "" : values.last_action_time ]}<br />','<span class="cG">'+L.addedByUser+':</span> {owner}, {cdate}<br />','<span class="cG">'+L.TSV+':</span> {tsv}<br />'],itemSelector:'.none',autoHeight:true,listeners:{scope:this,containerclick:this.onUserInfoContainerCLick}});Ext.apply(this,{layout:'border',api:{submit:CB_User.uploadPhoto},border:false,cls:'x-panel-white',tbar:[{text:L.Save,iconCls:'im-save',scale:'medium',disabled:true,handler:this.saveData,scope:this},{text:L.Cancel,iconCls:'im-cancel',scale:'medium',disabled:true,handler:function(b,e){e.stopPropagation();this.loadData();},scope:this},{xtype:'tbseparator',hidden:true},{text:L.Edit,iconCls:'im-edit-obj',scale:'medium',handler:this.onEditUserDataClick,scope:this,hidden:true},{xtype:'tbseparator',hidden:true},{text:L.Options,iconCls:'im-apps',scale:'medium',hidden:true,menu:[{text:L.SendResetPassMail,iconCls:'icon-key',handler:this.onSendResetPassMailClick,scope:this},{text:L.ChangePassword,iconCls:'icon-key',handler:this.onEditUserPasswordClick,scope:this},'-',{text:L.ChangeUsername,iconCls:'icon-pencil',handler:this.onEditUsernameClick,scope:this},'-',this.actions.disableTSV,'-',this.actions.enableUser,this.actions.disableUser]}],items:[{region:'north',height:75,bodyStyle:'padding: 10px',border:false,items:[{xtype:'filefield',name:'photo',cls:'fl',style:'position:absolute;width:1px;height:1px;opacity:0;top:-100px',buttonOnly:true,allowBlank:false,clearOnSubmit:false,listeners:{scope:this,afterrender:function(c){c.button.fileInputEl.on('change',this.onPhotoChanged,this);}}},this.userInfo]},{region:'center',border:false,scrollable:true,bodyStyle:'padding: 0 20px',items:[{border:false,anchor:'100%',minHeight:100,autoHeight:true,xtype:'grid',style:'margin-top: 15px',selType:'cellmodel',store:new Ext.data.JsonStore({autoDestroy:true,model:'Facet'}),columns:[{header:L.Groups,width:150,dataIndex:'name'},{header:L.Active,dataIndex:'active',renderer:bulletRenderer}],viewConfig:{forceFit:true,stripeRows:false,markDirty:false,getRowClass:function(r,index){return(r.get('active')!=1)?'':'fwB';}},listeners:{scope:this,celldblclick:function(cmp,td,cellIndex,record,tr,rowIndex,e,eOpts){switch(cmp.headerCt.columnManager.columns[cellIndex].dataIndex){case'active':record.set('active',(record.get('active')==1)?null:1);break;default:return;}
this.fireEvent('change');}}}]},{region:'south',height:300,split:true,collapseMode:'mini',collapsed:true,tbar:[{xtype:'label',cls:'fwB',text:L.ChangeLog+': '}]}],listeners:{scope:this,change:function(e){this.setDirty(true);},show:function(){var f=function(){var a=this.down('[isFormField=true]');a.focus();};Ext.Function.defer(f,500,this);}}});this.callParent(arguments);this.grid=this.down('grid');},setDirty:function(value){this._isDirty=(value!==false);var ttb=this.dockedItems.getAt(0);ttb.items.getAt(0).setDisabled(!this._isDirty);ttb.items.getAt(1).setDisabled(!this._isDirty);},loadData:function(id){if(!Ext.isEmpty(id)){this.data={id:id};}
this.getEl().mask(L.LoadingData+' ...');CB_UsersGroups.getAccessData(this.data.id,this.processLoadedData,this);},processLoadedData:function(response,e){if(!response){return;}
if(response.success!==true){if(response.verify){this.fireEvent('verify',this);}}else{this.data.title=Ext.valueFrom(response.data.title,response.data.name);this.data.enabled=response.data.enabled;response.data.title=this.data.title;this.data.template_id=response.data.template_id;this.userInfo.data=response.data;this.userInfo.update(response.data);this.grid.setDisabled(response.data.id==App.loginData.id);var accessData=[];CB.DB.groupsStore.each(function(r){if(parseInt(r.get('system'),10)===0){accessData.push({id:r.get('id'),'name':r.get('title'),'active':(response.data.groups.indexOf(String(r.get('id')))>=0)?1:0});}},this);this.grid.getStore().loadData(accessData,false);this.canEditUserData=(App.loginData.admin||(response.data.cid==App.loginData.id)||(response.data.id==App.loginData.id));var ttb=this.dockedItems.getAt(0),eb=ttb.down('[iconCls="im-edit-obj"]'),idx=ttb.items.indexOf(eb),enabled=(response.data.enabled==1);eb.setVisible(this.canEditUserData);ttb.items.getAt(idx-1).setVisible(this.canEditUserData);var visible=(this.canEditUserData||(response.data.id==App.loginData.id));ttb.items.getAt(idx+1).setVisible(visible);ttb.items.getAt(idx+2).setVisible(visible);this.updatePhoto(response.data.photo);this.setDisabled(false);this.actions.disableTSV.setDisabled(!this.canEditUserData||(response.data.tsv==='none'));this.actions.enableUser.setHidden(enabled);this.actions.disableUser.setHidden(!enabled);this.fireEvent('loaded',this.data);}
this.getEl().unmask();this.setDirty(false);},saveData:function(){this.fireEvent('beforesave');this.getEl().mask(L.SavingChanges+' ...');var params={groups:[]};this.grid.getStore().each(function(r){if(r.get('active')==1){params.groups.push(r.get('id'));}},this);params.id=this.data.id;CB_UsersGroups.saveAccessData(params,function(r,e){if(!r){return;}
if(r.success!==true){if(r.verify){this.fireEvent('verify',this);}
return false;}
this.setDirty(false);this.getEl().unmask();this.fireEvent('save');},this);},onUserInfoContainerCLick:function(cmp,e,eOpts){if(e){var target=e.getTarget();if(target.localName=="img"){var el=this.down('[name="photo"]').button.fileInputEl;el.dom.click();}else if(target.classList.contains('click')){this.onEditUserDataClick();}}},onEditUserDataClick:function(cmp,e,eOpts){this.fireEvent('edit');},onPhotoChanged:function(ev,el,o){if(!this.getForm().isValid()){return;}
this.getForm().submit({clientValidation:true,params:{id:this.data.id},scope:this,success:function(form,action){this.updatePhoto(action.result.photo);},failure:App.formSubmitFailure});},updatePhoto:function(name){if(Ext.isEmpty(name)){return;}
var del=this.userInfo.getEl().query('img.user-photo-field')[0];del.src=App.config.photoPath+name;},onEditUsernameClick:function(){Ext.Msg.prompt(L.ChangeUsername,L.ChangeUsernameMessage,function(btn,text){if(btn==='ok'){if(Ext.isEmpty(text)){return Ext.Msg.alert(L.Error,L.UsernameCannotBeEmpty);}
var r=/^[a-z0-9\._]+$/i;if(Ext.isEmpty(r.exec(text))){return Ext.Msg.alert(L.Error,L.UsernameInvalid);}
CB_UsersGroups.renameUser({id:this.data.id,name:text},function(r,e){if(!r){return;}
if(r.success!==true){if(r.verify){this.fireEvent('verify',this);}else{return Ext.Msg.alert(L.Error,Ext.valueFrom(e.msg,L.ErrorOccured));}}
this.data.name=r.name;this.userInfo.data.name=r.name;this.userInfo.update(this.userInfo.data);},this);}},this,false,this.data.name);},onSendResetPassMailClick:function(){CB_UsersGroups.sendResetPassMail(this.data.id,function(r,e){if(r){Ext.Msg.alert(L.Info,r.success?L.EmailSent:L.ErrorOccured);}},this);},onEditUserPasswordClick:function(){var w=new CB.ChangePasswordWindow({data:this.data});w.show();},onDisableTSVClick:function(){Ext.Msg.confirm(L.Disable+' '+L.TSV,L.DisableTSVConfirmation,function(b){if(b==='yes'){CB_UsersGroups.disableTSV(this.data.id,this.processDisableTSV,this);}},this);},processDisableTSV:function(r,e){if(!r||(r.success!==true)){return;}
this.loadData(this.data.id);},onUserToggleEnableClick:function(b,e){var enable=(b.baseAction==this.actions.enableUser);CB_UsersGroups.setUserEnabled({id:this.data.id,enabled:enable},this.processToggleUserEnable,this);},processToggleUserEnable:function(r,e){if(!r||(r.success!==true)){return;}
this.actions.enableUser.setHidden(r.enabled);this.actions.disableUser.setHidden(!r.enabled);var d=Ext.apply(this.userInfo.data,{enabled:r.enabled});this.userInfo.update(d);}});Ext.define('CB.UsersGroups',{extend:'Ext.Window',alias:'CBUsersGroups',xtype:'CBUsersGroups',layout:'border',border:false,closable:true,minimizable:true,iconCls:'icon-users',title:L.UserManagement,width:850,height:600,initComponent:function(){this.tree=new CB.UsersGroupsTree({region:'center',split:true,collapseMode:'mini'});this.tree.getSelectionModel().on('selectionchange',this.onTreeSelectionChange,this);this.tree.getSelectionModel().on('beforeselect',this.onTreeBeforeSelect,this);this.form=new CB.UsersGroupsForm({region:'center',api:{submit:CB_User.uploadPhoto},listeners:{scope:this,beforesave:this.onBeforeFormSave,save:this.onFormSave,loaded:this.onLoadFormData,edit:this.onEditUserData,verify:this.onVerifyEvent}});this.searchField=new CB.search.Field({region:'south',listeners:{scope:this,'search':this.onSearchQuery}});Ext.apply(this,{items:[{layout:'border',region:'west',width:265,border:false,split:true,items:[this.tree,this.searchField]},this.form],listeners:{scope:this,verify:this.onVerifyEvent}});this.callParent(arguments);},onSearchQuery:function(text,e){this.tree.filter(text,'title');},onBeforeFormSave:function(){this.lastPath='';var n=this.tree.getSelectionModel().getSelection()[0];if(n)this.lastPath=n.getPath('nid');},onFormSave:function(){this.tree.store.clearFilter();this.tree.store.reload({node:this.tree.getRootNode(),scope:this,callback:function(){this.tree.filter(this.searchField.getValue(),'title');this.tree.selectPath(this.lastPath,'nid','/',function(success){if(!success){this.form.setDisabled(true);this.tree.getRootNode().cascadeBy({before:function(n){if(n.data.id==this.form.data.id){this.tree.getSelectionModel().select(n);this.form.setDisabled(false);return false;}},scope:this});}}.bind(this));}});},onTreeSelectionChange:function(sm,node){var n=this.tree.getSelectionModel().getSelection()[0];if((!n)||(n.getDepth()!=2)){this.form.setDisabled(true);if(this.loadFormTask){this.loadFormTask.cancel();}
return;}
this.loadId=n.data.nid;this.onLoadFormTask();},onTreeBeforeSelect:function(sm,newNode,oldNode){if(Ext.valueFrom(this._forceSelection,0)){this._forceSelection=0;return true;}
if(oldNode&&this.form._isDirty){this.newNode=newNode;Ext.Msg.show({buttons:Ext.Msg.YESNO,title:L.Confirmation,msg:L.SaveChangesConfirmationMessage,scope:this,fn:function(btn,text){if(btn==='yes'){this.form.saveData();}else{this._forceSelection=1;this.tree.getSelectionModel().select(this.newNode);this.form.setDirty(false);}}});return false;}},onLoadFormTask:function(){if(!this.loadFormTask){this.loadFormTask=new Ext.util.DelayedTask(function(){this.form.loadData(this.loadId);},this);}
this.loadFormTask.delay(500);},onLoadFormData:function(data){this.tree.getRootNode().cascadeBy({before:function(n){if(n.data.nid==data.id){n.set('text',Ext.valueFrom(n.data.title,n.data.name)+' <span class="cG">(id:'+data.id+')</span>'+
((data.enabled!=1)?' <span class="cG">'+L.Disabled+'</span>':''));}},scope:this});},onEditUserData:function(){if(!this.form.canEditUserData){return;}
var data=Ext.apply({},this.form.data);data.id=data.id.split('-').pop();var n=this.tree.getSelectionModel().getSelection()[0],iconCls=n?n.data.iconCls:'icon-user',w=new CB.UserEditWindow({title:data.title,iconCls:iconCls,data:data,listeners:{scope:this,savesuccess:function(){this.form.loadData();},verify:this.onVerifyEvent}});w.show();},onVerifyEvent:function(cmp){this.destroy();Ext.Msg.alert(L.Info,'User management session has expired. Please access it and authenticate again.');}});Ext.define('CB.ChangePasswordWindow',{extend:'Ext.Window',modal:true,title:L.ChangePassword,autoWidth:true,autoHeight:true,border:false,iconCls:'icon-key',initComponent:function(){var items=[];this.data=this.config.data;if(this.data.id==App.loginData.id)
items=[{xtype:'textfield',fieldLabel:L.CurrentPassword,inputType:'password',name:'currentpassword',allowBlank:(this.data.id!=App.loginData.id)}];items.push({xtype:'textfield',fieldLabel:L.Password,inputType:'password',name:'password',allowBlank:false,shouldMatch:true},{xtype:'textfield',fieldLabel:L.ConfirmPassword,inputType:'password',name:'confirmpassword',allowBlank:false,shouldMatch:true},{xtype:'displayfield',hideLabel:true,cls:'cR taC',anchor:'100%',id:'msgTarget',value:'&nbsp;'});Ext.apply(this,{items:{xtype:'form',autoWidth:true,autoHeight:true,border:false,monitorValid:true,extraParams:this.data,api:{submit:CB_UsersGroups.changePassword},items:{xtype:'fieldset',labelWidth:150,autoWidth:true,autoHeight:true,border:false,layout:'anchor',style:'padding-top: 10px',defaults:{anchor:'100%',listeners:{scope:this,invalid:function(field,msg){if(field.getEl().hasCls('x-form-invalid'))this.hasInvalidFields=true;}}},items:items},listeners:{scope:this,clientvalidation:function(form,valid){var label=this.down('[id="msgTarget"]');if(!valid&&this.hasInvalidFields){label.setValue(L.EmptyRequiredFields);return;}
var a=this.query('[shouldMatch=true]');if(a[0].getValue()!=a[1].getValue()){this.down('form').buttons[0].setDisabled(true);label.setValue(L.PasswordMissmatch);return;}
label.setValue('&nbsp;');}},buttons:[{text:Ext.MessageBox.buttonText.ok,iconCls:'icon-tick',formBind:true,type:'submit',scope:this,plugins:'defaultButton',handler:function(){var f=this.down('form');f.getForm().submit({clientValidation:true,params:this.data,scope:this,success:this.onSubmitSuccess});}},{text:L.Cancel,iconCls:'icon-cancel',handler:this.destroy,scope:this}]},listeners:{afterrender:function(){}}});this.callParent(arguments);},onSubmitSuccess:function(r,e){this.fireEvent('passwordchanged');this.destroy();}});;Ext.namespace('CB');Ext.define('CB.Account',{extend:'Ext.Window',alias:'CBAccount',xtype:'CBAccount',title:L.Account,border:false,closable:true,minimizable:true,width:850,height:600,initComponent:function(){this.menu=new Ext.Panel({region:'west',collapsible:false,width:130,animCollapse:false,plain:true,cls:'account-menu',style:'border-right: 1px solid #cacaca',border:false,layout:'anchor',defaults:{enableToggle:true,toggleGroup:'menu',allowDepress:false,scope:this,handler:this.onMenuButtonClick},items:[{xtype:'button',html:L.Profile,anchor:'100%',pressed:true},{xtype:'button',html:L.Security,anchor:'100%'}]});this.cards=new Ext.Panel({region:'center',border:false,tbarCssClass:'x-panel-gray',layout:'card',activeItem:0,items:[{xtype:'CBProfileForm',listeners:{scope:this,change:function(){}}},{xtype:'CBSecurityForm',listeners:{scope:this,change:function(){}}}],deferredRender:true});Ext.apply(this,{iconCls:'icon-user-'+App.loginData.sex,layout:'border',items:[this.menu,this.cards]});this.callParent(arguments);CB_User.getAccountData(this.onGetData,this);},onGetData:function(r,e){if(!r){return;}
if(r.success!==true){if(r.verify===true){var w=new CB.VerifyPassword({listeners:{scope:this,beforeclose:function(cmp){if(w.success!==true){this.destroy();}else{CB_User.getAccountData(this.onGetData,this);}}}});w.show();}else{this.destroy();}
return;}
this.cards.items.getAt(0).loadData(r.profile);this.cards.items.getAt(1).loadData(r.security);},onMenuButtonClick:function(b,e){this.cards.getLayout().setActiveItem(this.menu.items.indexOf(b));}});Ext.define('CB.ProfileForm',{extend:'Ext.form.FormPanel',alias:'widget.CBProfileForm',border:false,fileUpload:true,scrollable:true,bodyPadding:10,data:{},initComponent:function(){this.data=this.config.data;this.objectsStore=new CB.DB.ObjectsStore();this.photoField=new Ext.form.field.File({cls:'fl',style:'position:absolute;width:1px;height:1px;opacity:0;top:-100px',buttonOnly:true,name:'photo',border:false,listeners:{scope:this,afterrender:function(c){c.button.fileInputEl.on('change',this.onPhotoChanged,this);}}});this.photoView=new Ext.DataView({tpl:['<tpl for="."><div>','<img width="70" height="70" class="user-photo-field2 click icon-user70-{sex}" src="'+App.config.photoPath+'{id}.png?{[ Ext.Date.format(new Date(), "His") ]}">','</div>','<div><a name="change" class="click">'+L.Change+'</a> &nbsp; <a name="remove" class="click">'+L.Delete+'</a></div>','</tpl>'],data:[{}],itemSelector:'.none',autoHeight:true,listeners:{scope:this,containerclick:this.onPhotoContainerClick}});var fields=[{xtype:'textfield',name:'first_name',fieldLabel:L.FirstName,listeners:{scope:this,change:this.onChange}},{xtype:'textfield',name:'last_name',fieldLabel:L.LastName,listeners:{scope:this,change:this.onChange}},{xtype:'combo',name:'sex',hiddenName:'sex',fieldLabel:L.Gender,queryMode:'local',triggerAction:'all',editable:false,store:CB.DB.sex,valueField:'id',displayField:'name'},{xtype:'textfield',name:'email',fieldLabel:L.PrimaryEmail,vtype:'email'},{xtype:'combo',name:'country_code',hiddenName:'country_code',fieldLabel:L.Country,queryMode:'local',triggerAction:'all',editable:true,forceSelection:true,typeAhead:true,store:CB.DB.phone_codes,valueField:'code',displayField:'name',value:null,width:250},{xtype:'textfield',name:'phone',fieldLabel:L.Phone,allowDecimals:false,allowNegative:false},{html:'&nbsp;',border:false},{xtype:'combo',name:'language_id',hiddenName:'language_id',fieldLabel:L.Language,queryMode:'local',triggerAction:'all',editable:true,forceSelection:true,typeAhead:true,store:CB.DB.languages,valueField:'id',displayField:'name'},{xtype:'combo',name:'timezone',hiddenName:'timezone',fieldLabel:L.Timezone,queryMode:'local',triggerAction:'all',editable:false,store:CB.DB.timezones,valueField:'id',displayField:'caption',value:null},{xtype:'combo',name:'short_date_format',hiddenName:'short_date_format',fieldLabel:L.DateFormat,queryMode:'local',triggerAction:'all',editable:false,store:CB.DB.shortDateFormats,valueField:'id',displayField:'name',value:null}];if(App.loginData.id!=this.data.id){if(App.loginData.admin||App.loginData.cfg.canAddUsers){fields.push({xtype:'checkbox',name:'canAddUsers',fieldLabel:Ext.valueFrom(L.CanAddUsers,'Can add users'),inputValue:true});}
if(App.loginData.admin||App.loginData.cfg.canAddGroups){fields.push({xtype:'checkbox',name:'canAddGroups',fieldLabel:Ext.valueFrom(L.CanAddGroups,'Can add groups'),inputValue:true});}}
Ext.apply(this,{items:[{border:false,layout:'hbox',layoutConfig:{align:'stretchmax'},autoHeight:true,items:[{autoHeight:true,border:false,width:500,items:{xtype:'fieldset',padding:10,autoHeight:true,labelWidth:140,defaults:{width:250,matchFieldWidth:false,listeners:{scope:this,change:this.onChange,select:this.onChange}},items:fields}},{xtype:'panel',width:300,padding:45,border:false,items:[this.photoField,this.photoView]}]},{xtype:'CBVerticalEditGrid',refOwner:this,width:500,style:'margin-bottom: 50px',autoHeight:true,viewConfig:{forceFit:true,autoFill:true}}],buttonAlign:'left',buttons:[{text:L.Save,scope:this,handler:this.onSaveClick},{text:L.Reset,scope:this,handler:this.onResetClick}],listeners:{scope:this,afterrender:this.onAfterRender,change:this.onChange}});this.callParent(arguments);this.grid=this.items.getAt(1);if(CB.DB.countries.getCount()===0){CB.DB.countries.load();}
if(CB.DB.timezones.getCount()===0){CB.DB.timezones.load();}
this.enableBubble(['verify']);},onAfterRender:function(cmp){},loadData:function(data){if(!Ext.isEmpty(data.assocObjects)&&Ext.isArray(data.assocObjects)){for(var i=0;i<data.assocObjects.length;i++){data.assocObjects[i].iconCls=getItemIcon(data.assocObjects[i]);}
this.objectsStore.loadData(data.assocObjects);delete data.assocObjects;}
if(Ext.isDefined(data.language_id)){data.language_id=parseInt(data.language_id,10);}
this.data=data;this.getForm().setValues(data);this.grid.reload();this.photoView.update([{id:this.data.id}]);this.setDirty(false);},onPhotoContainerClick:function(cmp,e,eOpts){if(!e){return;}
var target=e.getTarget();if((target.localName=="img")||(target.name==='change')){return this.photoField.button.fileInputEl.dom.click();}
if(target.name==='remove'){return this.onPhotoRemoveClick();}},onPhotoChanged:function(ev,el,o){if(Ext.isEmpty(this.photoField.getValue())){return;}
var form=this.getForm();form.api={submit:CB_User.uploadPhoto};form.submit({clientValidation:false,params:{id:this.data.id},scope:this,success:function(form,action){this.photoField.reset();this.photoField.button.fileInputEl.on('change',this.onPhotoChanged,this);this.photoView.update([{id:this.data.id}]);},failure:App.formSubmitFailure});},onPhotoRemoveClick:function(){Ext.Msg.confirm(L.Confirmation,L.RemovePhotoConfirm,function(b,e){if(b==='yes'){CB_User.removePhoto({id:this.data.id},function(){this.photoView.update([{id:this.data.id}]);},this);}},this);},onSaveClick:function(){delete this.data.canAddUsers;delete this.data.canAddGroups;Ext.apply(this.data,this.getForm().getValues());if(this.data.phone==this.down('[name="phone"]').emptyText){this.data.phone=null;}
this.grid.readValues();CB_User.saveProfileData(this.data,this.onSaveProcess,this);},onSaveProcess:function(r,e){if(!r){return;}
if(r.success!==true){if(r.verify){this.fireEvent('verify',this);}else if(!Ext.isEmpty(r.msg)){Ext.Msg.alert(L.Error,r.msg);}
return;}
this.setDirty(false);this.fireEvent('savesuccess',this,e);App.fireEvent('userprofileupdated',this.data,e);},onResetClick:function(){this.getForm().reset();this.loadData(this.data);},onChange:function(){this.setDirty(true);},setDirty:function(dirty){this._isDirty=(dirty!==false);var bbar=this.dockedItems.getAt(0);bbar.items.getAt(0).setDisabled(!this._isDirty);bbar.items.getAt(1).setDisabled(!this._isDirty);}});Ext.define('CB.SecurityForm',{extend:'Ext.form.FormPanel',alias:'widget.CBSecurityForm',border:false,scrollable:true,initComponent:function(){Ext.apply(this,{padding:10,items:[{title:L.Password,componentCls:'x-panel-header panel-header-nobg block-header',border:false,defaults:{style:'padding: 5px 25px'},items:[{xtype:'displayfield',name:'passwordchanged',value:L.PasswordNeverChanged},{xtype:'displayfield',frame:false,value:'<a>'+L.ChangePassword+'</a>',listeners:{scope:this,afterrender:function(cmp,eOpts){cmp.getEl().on('click',this.onChangePasswordClick,this);}}}]},{title:L.RecoveryOptions,componentCls:'x-panel-header panel-header-nobg block-header',border:false,style:'margin-top: 20px',defaults:{style:'padding: 5px 0 15px 25px',border:false},items:[{xtype:'fieldcontainer',layout:'hbox',hidden:true,items:[{xtype:'checkbox',name:'recovery_mobile',listeners:{scope:this}},{xtype:'displayfield',cls:'fwB',value:L.Mobile}]},{hidden:true,name:'recovery_mobile_panel',layout:'form',defaults:{width:200,listeners:{scope:this,change:this.onChange,select:this.onChange}},items:[{xtype:'combo',name:'country_code',hiddenName:'country_code',fieldLabel:L.Country,queryMode:'local',triggerAction:'all',editable:true,forceSelection:true,typeAhead:true,store:CB.DB.phone_codes,valueField:'code',displayField:'name'},{xtype:'numberfield',name:'phone_number',fieldLabel:L.PhoneNumber,allowDecimals:false,allowNegative:false}]},{xtype:'fieldcontainer',layout:'hbox',items:[{xtype:'checkbox',name:'recovery_email',boxLabel:L.Email,inputValue:1,listeners:{scope:this,change:this.onCheckboxCheck}}]},{hidden:true,name:'recovery_email_panel',layout:'form',width:350,items:[{xtype:'textfield',fieldLabel:'Email',name:'email',vtype:'email',width:200,listeners:{scope:this,change:this.onChange}}]},{xtype:'fieldcontainer',layout:'hbox',hidden:true,items:[{xtype:'checkbox',name:'recovery_question',listeners:{scope:this}},{xtype:'displayfield',cls:'fwB',value:L.SecurityQuestion}]},{hidden:true,name:'recovery_question_panel',layout:'form',defaults:{width:200,listeners:{scope:this,change:this.onChange,select:this.onChange}},items:[{xtype:'combo',store:CB.DB.securityQuestions,name:'question_idx',hiddenName:'question_idx',fieldLabel:L.Question,queryMode:'local',triggerAction:'all',editable:false,forceSelection:true,valueField:'id',displayField:'text',width:400},{xtype:'textfield',fieldLabel:L.Answer,name:'answer'}]}],buttonAlign:'left',buttons:[{text:L.Save,itemId:'saveButton',style:'margin-left: 18px',disabled:true,scope:this,handler:this.onSaveClick},{text:L.Reset,itemId:'resetButton',disabled:true,scope:this,handler:this.onResetClick}]},{title:L.TSV,componentCls:'x-panel-header panel-header-nobg block-header',border:false,style:'margin-top: 20px',defaults:{style:'padding: 5px 25px',border:false},buttonAlign:'left',items:[{xtype:'displayfield',itemId:'tsvStatusText',value:L.Status+': <span class="cG">'+L.Disabled+'</span>'}],dockedItems:[{xtype:'toolbar',dock:'bottom',ui:'footer',layout:{type:'hbox',pack:'left'},items:[{xtype:'displayfield',value:'<a>'+L.Enable+'</a>',itemId:'btnEnableTsv',width:50,listeners:{scope:this,afterrender:function(c){c.getEl().on('click',this.enableTSV,this);}}},{xtype:'displayfield',value:'<a>'+L.Disable+'</a>',itemId:'btnDisableTsv',width:50,listeners:{scope:this,afterrender:function(c){c.getEl().on('click',this.disableTSV,this);}},hidden:true},{xtype:'displayfield',value:'<a>'+L.Change+'</a>',itemId:'btnChangeTsv',width:50,listeners:{scope:this,afterrender:function(c){c.getEl().on('click',this.enableTSV,this);}},hidden:true}]}]}]});this.callParent(arguments);this.saveButton=this.down('#saveButton');this.resetButton=this.down('#resetButton');},loadData:function(data){this.data=data;if(!Ext.isEmpty(data.password_change)){this.down('[name="passwordchanged"]').setValue(L.PasswordChanged+': '+data.password_change);}
var cb=this.items.getAt(1).items.first().items.first();cb.setValue(data.recovery_mobile===true);this.down('[name="country_code"]').setValue(Ext.valueFrom(data.country_code,null));this.down('[name="phone_number"]').setValue(Ext.valueFrom(data.phone_number,null));cb=this.items.getAt(1).items.getAt(2).items.first();cb.setValue(data.recovery_email===true);this.down('[name="email"]').setValue(Ext.valueFrom(data.email,null));cb=this.items.getAt(1).items.getAt(4).items.first();cb.setValue(data.recovery_question===true);this.down('[name="question_idx"]').setValue(Ext.valueFrom(data.question_idx,null));this.down('[name="answer"]').setValue(Ext.valueFrom(data.answer,null));this.updateTSVStatus();this.setDirty(false);},onCheckboxCheck:function(cb){var p=this.down('[name="'+cb.name+'_panel"]');p.setVisible(cb.checked);this.setDirty();},onChangePasswordClick:function(b){var pw=new CB.ChangePasswordWindow({data:{id:App.loginData.id},listeners:{scope:this,passwordchanged:this.onPasswordChanged}});pw.show();},onPasswordChanged:function(w){this.down('[name="passwordchanged"]').setValue(L.PasswordChanged+': '+L.today);},onSaveClick:function(){cb=this.items.getAt(1).items.first().items.first();this.data.recovery_mobile=cb.getValue();this.data.country_code=this.down('[name="country_code"]').getValue();this.data.phone_number=this.down('[name="phone_number"]').getValue();cb=this.items.getAt(1).items.getAt(2).items.first();this.data.recovery_email=cb.getValue();this.data.email=this.down('[name="email"]').getValue();cb=this.items.getAt(1).items.getAt(4).items.first();this.data.recovery_question=cb.getValue();this.data.question_idx=this.down('[name="question_idx"]').getValue();this.data.answer=this.down('[name="answer"]').getValue();CB_User.saveSecurityData(this.data,this.onSaveProcess,this);},onSaveProcess:function(r,e){if(!r||(r.success!==true)){return;}
this.setDirty(false);},onResetClick:function(){this.loadData(this.data);},onChange:function(){this.setDirty(true);},setDirty:function(dirty){this._isDirty=(dirty!==false);this.saveButton.setDisabled(!this._isDirty);this.resetButton.setDisabled(!this._isDirty);},enableTSV:function(b,e){var data=Ext.valueFrom(this.data.TSV,{});data.country_code=Ext.valueFrom(data.country_code,this.data.country_code);data.phone_number=Ext.valueFrom(data.phone_number,this.data.phone_number);var w=new CB.TSVWindow({data:data,listeners:{scope:this,tsvchange:this.onTSVChange}});w.show();},onTSVChange:function(w,tsv){if(Ext.isEmpty(this.data['TSV'])){this.data.TSV={};}
this.data.TSV.method=tsv;this.updateTSVStatus();},updateTSVStatus:function(){var text='<span class="cG">'+L.Disabled+'</span>';if(Ext.isEmpty(this.data.TSV)){this.data.TSV={};}
switch(this.data.TSV.method){case'ga':text='Mobile Google Aplication';break;case'sms':text='Google Authentication using SMS';break;case'ybk':text='Yubikey';break;}
this.down('#tsvStatusText').setValue(L.Status+': '+text);this.down('#btnEnableTsv').setVisible(Ext.isEmpty(this.data.TSV.method));this.down('#btnDisableTsv').setVisible(!Ext.isEmpty(this.data.TSV.method));this.down('#btnChangeTsv').setVisible(!Ext.isEmpty(this.data.TSV.method));},disableTSV:function(){Ext.Msg.show({title:L.Confirm,message:L.DisableTSVConfirmation,buttons:Ext.Msg.YESNO,icon:Ext.window.MessageBox.INFO,scope:this,fn:function(b,e){if(b==='yes'){CB_User.disableTSV(function(r,e){if(r&&(r.success===true)){delete this.data.TSV.method;this.updateTSVStatus();}},this);}}});}});Ext.define('CB.TSVWindow',{extend:'Ext.Window',modal:true,title:L.TSV,autoWidth:true,autoHeight:true,border:false,iconCls:'icon-key',layout:'card',initComponent:function(){Ext.apply(this,{activeItem:0,bodyBorder:false,items:[{items:[{xtype:'displayfield',style:'padding: 10px; font-size: 20px;',value:'Select authentication method'},{xtype:'displayfield',value:'<a class="click" name="ga">Google Authenticator</a>',style:'padding:10px',name:'ga',listeners:{scope:this,afterrender:function(c){c.getEl().on('click',this.onTSVMechanismClick,this);}}},{xtype:'displayfield',value:'<a class="click" name="ybk">Yubikey</a>',style:'padding:10px',name:'ybk',listeners:{scope:this,afterrender:function(c){c.getEl().on('click',this.onTSVMechanismClick,this);},loaded:this.onViewLoaded,verifyandsave:this.onVerifyAndSave}}]},{xtype:'TSVgaForm',itemId:'ga',listeners:{scope:this,loaded:this.onViewLoaded,verifyandsave:this.onVerifyAndSave}},{xtype:'TSVybkForm',itemId:'ybk',listeners:{scope:this,loaded:this.onViewLoaded,verifyandsave:this.onVerifyAndSave}}]});this.callParent(arguments);this.form=this.down('form');},onTSVMechanismClick:function(ev,el){this.TSVmethod=el.name;this.getLayout().setActiveItem(el.name);this.getLayout().activeItem.prepareInterface(this.data);},onVerifyAndSave:function(data){this.getEl().mask(L.Processing+' ...','x-mask-loading');CB_User.enableTSV({method:this.TSVmethod,data:data},this.processEnableTSV,this);},onYubikeySaveClick:function(){this.getEl().mask(L.Processing+' ...','x-mask-loading');CB_User.TSVSaveYubikey({code:this.getLayout().activeItem.buttons[1].getValue()},this.processEnableTSV,this);},processEnableTSV:function(r,e){this.getEl().unmask();if(r&&(r.success===true)){this.fireEvent('tsvchange',this,this.TSVmethod);this.destroy();}else{this.getLayout().activeItem.showError(r.msg);}},onViewLoaded:function(){this.center();this.center();}});Ext.define('CB.TSVgaForm',{extend:'Ext.Panel',alias:'widget.TSVgaForm',style:'background-color: #fff',width:500,initComponent:function(){Ext.apply(this,{bodyStyle:'padding: 10px',items:[{xtype:'displayfield',style:'font-size: 20px; padding-bottom:15px',value:'Set up Google Authenticator'},{autoHeight:true,autoWidth:true,border:false,tpl:['<tpl for="data">','<p class="fwB">Install the Google Authenticator app for your phone</p>','<ol class="ol p10">','<li> On your phone, open a web browser. </li>','<li> Go to <span class="fwB">m.google.com/authenticator</span>. </li>','<li> Download and install the Google Authenticator application. </li>','</ol>','<p class="fwB"> Now open and configure Google Authenticator. </p>','<br /><p>Scan following Barcode to register the application automaticly:<p>','<div class="taC p10">','    <img src="{url}" width="100" height="100" />','</div>','<p> Or use the following secret key to register the aplication manually:</p>','<div class="taC p10 bgcY">','    <div class="fs14 fwB" dir="ltr">{sd}</div>','    <div class="fs10 cG">Spaces don\'t matter.</div>','</div><br />','<p> Once you manually entered and saved your key, enter the 6-digit verification code generated<br /> by the Authenticator app. </p>','</tpl>'],data:{}}],buttonAlign:'left',buttons:[{xtype:'displayfield',value:'Code: '},{xtype:'textfield',name:'code',width:'50',enableKeyEvents:true,listeners:{scope:this,keyup:function(field,e){this.down('[name="btnVS"]').setDisabled(Ext.isEmpty(field.getValue()));}}},{xtype:'button',text:L.VerifyAndSave,name:'btnVS',disabled:true,scope:this,handler:this.onVerifyAndSaveClick},{xtype:'displayfield',style:'padding: 0 0 0 20px',name:'errorMsg',cls:'cR',value:'',hidden:true}]});this.callParent(arguments);},prepareInterface:function(data){this.getEl().mask(L.Processing+' ...','x-mask-loading');CB_User.getTSVTemplateData('ga',this.processGetTSVTemplateData,this);},processGetTSVTemplateData:function(r,e){this.getEl().unmask();if(!r||(r.success!==true)){return;}
var p=this.items.getAt(1);p.data=r;p.update(r);this.down('[name="code"]').focus();this.fireEvent('loaded',this,e);},onVerifyAndSaveClick:function(){this.fireEvent('verifyandsave',{code:this.down('[name="code"]').getValue()});},showError:function(msg){if(Ext.isEmpty(msg)){msg='The code is incorrect. Try again';}
msg='<img class="icon icon-exclamation fl" style="margin-right: 15px" src="/css/i/s.gif">'+msg;var t=this.down('[name="errorMsg"]');t.setValue(msg);t.setVisible(true);}});Ext.define('CB.TSVsmsForm',{extend:'Ext.form.FormPanel',monitorValid:true,autoWidth:true,autoHeight:true,labelWidth:120,buttonAlign:'left',cls:'bgcW',initComponent:function(){Ext.apply(this,{items:[{xtype:'displayfield',hideLabel:true,value:L.SpecifyPhone,style:'font-size: 20px'},{xtype:'displayfield',hideLabel:true,value:L.SpecifyPhoneMsg,style:'padding: 15px 0'},{xtype:'combo',name:'country_code',hiddenName:'country_code',fieldLabel:L.Country,queryMode:'local',triggerAction:'all',editable:true,forceSelection:true,typeAhead:true,store:CB.DB.phone_codes,valueField:'code',displayField:'name',width:200,allowBlank:false},{xtype:'numberfield',name:'phone_number',fieldLabel:L.PhoneNumber,allowDecimals:false,allowNegative:false,width:200,allowBlank:false}],buttons:[{text:L.Verify,formBind:true,scope:this,handler:this.onVerifyPhoneClick},{text:L.SendCode,type:'submit',formBind:true,scope:this,handler:this.onSendCodeClick}]});this.callParent(arguments);},prepareInterface:function(data){this.getForm().setValues(data);},onVerifyPhoneClick:function(){if(this.form.getForm().isValid()){this.getEl().mask(L.Processing+' ...','x-mask-loading');CB_User.verifyPhone(this.form.getForm().getValues(),this.processPhoneVerification,this);}},onSendCodeClick:function(b,e){},processPhoneVerification:function(r,e){this.getEl().unmask();},showError:function(msg){}});Ext.define('CB.TSVybkForm',{extend:'Ext.form.FormPanel',alias:'widget.TSVybkForm',xtype:'CBTSVybkForm',monitorValid:true,autoWidth:true,autoHeight:true,labelWidth:70,buttonAlign:'left',cls:'bgcW',initComponent:function(){Ext.apply(this,{bodyStyle:'padding: 10px',items:[{xtype:'displayfield',hideLabel:true,style:'font-size: 20px; padding-bottom:15px',value:'Set up Yubikey Authenticator'},{autoHeight:true,autoWidth:true,border:false,style:'font-size: 13px; padding-bottom:15px',tpl:['<tpl for=".">','<ol>','<li>1. Insert your YubiKey into a USB port.</li>','<li>2. Enter your email in the email field. </li>','<li>3. Select/Click the Code field, and touch the YubiKey button. </li>','<li>4. Click Save.</li>','</ol>','<br />','<p>Note that it may take up until 5 minutes until all validation servers know about your newly generated client.</p>','</tpl>'],data:{}},{xtype:'textfield',vtype:'email',name:'email',fieldLabel:L.Email,width:250,allowBlank:false,value:App.loginData.email},{xtype:'textfield',name:'code',fieldLabel:L.Code,width:250,allowBlank:false},{xtype:'displayfield',style:'padding: 0 0 0 20px; display: block',cls:'cR',value:'',hideLabel:true,hidden:true}],buttonAlign:'left',buttons:[{xtype:'button',text:L.Save,formBind:true,scope:this,handler:this.onSaveClick}]});this.callParent(arguments);},prepareInterface:function(data){this.getForm().setValues(data);},onSaveClick:function(){this.fireEvent('verifyandsave',this.getForm().getValues());},showError:function(msg){if(Ext.isEmpty(msg)){msg='The code is incorrect. Try again';}
msg='<img class="icon icon-exclamation fl" style="margin-right: 15px" src="/css/i/s.gif">'+msg;this.items.getAt(4).setValue(msg);this.items.getAt(4).setVisible(true);}});;Ext.namespace('CB.Validators');CB.Validators.json=function(jsonString){try{var o=JSON.parse(jsonString);if(o&&typeof o==="object"&&o!==null){return true;}}
catch(e){}
return false;};CB.Validators.geoPoint=function(value){var re=/^-?\d+\.?\d*\,-?\d+\.?\d*$/;rez=!Ext.isEmpty(re.exec(value));if(rez){var a=value.split(','),y=parseFloat(a[0]),x=parseFloat(a[1]);rez=((y>=-90)&&(y<=90)&&(x>=-180)&&(x<=180));}
return rez;};;function isEmptyObject(ob){for(var i in ob){if(ob.hasOwnProperty(i)){return false;}}
return true;}
function date_ISO_to_date(date_string){if(Ext.isEmpty(date_string)){return null;}
if(Ext.isDate(date_string)){return date_string;}
var d=Date.parse(date_string);if(Ext.isEmpty(d)){return null;}
return new Date(d);}
function date_ISO_to_local_date(date_string){var d=date_ISO_to_date(date_string);if(Ext.isEmpty(d)){return null;}
if(!isNaN(App.loginData.cfg.gmt_offset)){var localOffset=-d.getTimezoneOffset();var userOffset=App.loginData.cfg.gmt_offset;if(localOffset!=userOffset){d=Ext.Date.add(d,Ext.Date.MINUTE,-localOffset+userOffset);}}
return d;}
function date_local_to_ISO_string(date){if(!Ext.isDate(date)){return null;}
if(!isNaN(App.loginData.cfg.gmt_offset)){var localOffset=-date.getTimezoneOffset();var userOffset=Ext.Number.from(App.loginData.cfg.gmt_offset,0);if(localOffset!=userOffset){date=Ext.Date.add(date,Ext.Date.MINUTE,localOffset-userOffset);}}
return date.toISOString();}
function getUserDisplayName(withEmail){var rez=App.loginData.first_name+' '+App.loginData.last_name;rez=rez.trim();if(Ext.isEmpty(rez)){rez=App.loginData.name;}
if((withEmail===true)&&(!Ext.isEmpty(App.loginData.email))){rez+="\n("+App.loginData.email+")";}
return rez;}
function displayDateTime(date,format){var d=date_ISO_to_local_date(date);if(Ext.isDate(d)){format=Ext.valueFrom(format,App.longDateFormat+' '+App.timeFormat);return Ext.Date.format(d,format);}
return'';}
function dateToDateString(date){var rez=null;if(Ext.isPrimitive(date)){rez=date;}else if(Ext.isDate(date)){rez=Ext.Date.format(date,'Y-m-d')+'T00:00:00Z';}
return rez;}
function getItemIcon(d){var rez=Ext.valueFrom(d.iconCls,'');if(!rez&&Ext.isEmpty(d.template_id)&&d['type']==2){rez='icon-shortcut';}
if(Ext.isEmpty(rez)){rez=CB.DB.templates.getIcon(d.template_id);var type=CB.DB.templates.getType(d.template_id);switch(type){case'file':rez=getFileIcon(d['name']);break;case'task':if(d['task_status']==3){rez='icon-task-completed';}}}
return rez;}
function detectFileEditor(filename){var rez=false;if(Ext.isEmpty(App.config['files.edit'])){return rez;}
var extension=getFileExtension(filename);Ext.iterate(App.config['files.edit'],function(k,v,o){if(v.indexOf(extension)>-1){rez=k;return false;}},this);return rez;}
function getFileExtension(filename)
{var ext=String(filename).split('.');if(ext.length<2){return'';}
ext=ext.pop();ext=ext.trim();return ext.toLowerCase();}
function getFileIcon(filename){if(Ext.isEmpty(filename)){return'file-';}
var a=String(filename).split('.');if(a.length<2){return'file-';}
return'file- file-'+Ext.util.Format.lowercase(a.pop());}
function getFileIcon32(filename){if(Ext.isEmpty(filename)){return'file-unknown32';}
var a=String(filename).split('.');if(a.length<2){return'file-unknown32';}
return'file-unknown32 file-'+Ext.util.Format.lowercase(a.pop())+'32';}
function getStoreTitles(v){if(Ext.isEmpty(v)){return'';}
var ids=String(v).split(','),texts=[];Ext.each(ids,function(id){var r=this.findRecord('id',parseInt(id,10),0,false,false,true);if(r){texts.push(Ext.valueFrom(r.data.title,r.data.name));}},this);return texts.join(',');}
function getStoreNames(v){if(Ext.isEmpty(v)){return'';}
var ids=String(v).split(','),texts=[];Ext.each(ids,function(id){var idx=this.findExact('id',parseInt(id,10));if(idx<0){idx=this.findExact('id',String(id));}
if(idx>=0){var d=this.getAt(idx).data;texts.push(d.name);}},this);return texts.join(',');}
function toNumericArray(v,delimiter){if(Ext.isEmpty(v)){return[];}
if(Ext.isEmpty(delimiter)){delimiter=',';}
if(!Ext.isArray(v)){v=String(v).split(delimiter);}
var rez=[];for(var i=0;i<v.length;i++){var w=String(v[i]).trim(),iw=parseInt(w,10);if(iw==w){rez.push(iw);}else if(!isNaN(iw)){rez.push(parseFloat(w));}}
return rez;}
setsGetIntersection=function(set1,set2){var i,rez=[];if(Ext.isEmpty(set1)||Ext.isEmpty(set2)){return rez;}
if(!Ext.isArray(set1)){set1=String(set1).split(',');}
if(!Ext.isArray(set2)){set2=String(set2).split(',');}
for(i=0;i<set1.length;i++){set1[i]=String(set1[i]);}
for(i=0;i<set2.length;i++){set2[i]=String(set2[i]);}
for(i=0;i<set1.length;i++){if((set2.indexOf(set1[i])>=0)&&(rez.indexOf(set1[i])<0)){rez.push(set1[i]);}}
for(i=0;i<set2.length;i++){if((set1.indexOf(set2[i])>=0)&&(rez.indexOf(set2[i])<0)){rez.push(set2[i]);}}
return rez;};setsHaveIntersection=function(set1,set2){return!Ext.isEmpty(setsGetIntersection(set1,set2));};function getMenuUserItems(handler,scope,excludeId){var rez=[];excludeId=parseInt(excludeId,10);CB.DB.usersStore.each(function(u){var d=u.data;if(d.id!==excludeId){rez.push({text:d.name,iconCls:d.iconCls,userId:d.id,handler:handler,scope:scope});}},this);return rez;}
function updateMenu(menuButton,menuConfig,handler,scope){if(Ext.isEmpty(menuButton)){return;}
menuButton.menu.removeAll();menuConfig=String(menuConfig).split(',');var menu=[];for(var i=0;i<menuConfig.length;i++){switch(menuConfig[i]){case'case':break;case'task':break;case'event':break;case'folder':break;case'-':menu.push('-');break;default:var idx=CB.DB.templates.findExact('id',parseInt(menuConfig[i],10));if(idx>=0){var tr=CB.DB.templates.getAt(idx),title=Ext.valueFrom(tr.get('title'),tr.get('name'));if(['-','- Menu separator -'].indexOf(title)>=0){menu.push('-');}else{var data={template_id:tr.get('id'),title:title};if(!Ext.isEmpty(tr.get('cfg').data)){Ext.apply(data,tr.get('cfg').data);}
menu.push({text:title,iconCls:tr.get('iconCls'),scope:scope,handler:handler,data:data});}}
break;}}
for(i=0;i<menu.length;i++){menuButton.menu.add(menu[i]);}}
function htmlEntityDecode(str){if(Ext.isEmpty(str)){return'';}
if(!document.hedTA){document.hedTA=document.createElement("textarea");}
var ta=document.hedTA;ta.innerHTML=str.replace(/</g,"&lt;").replace(/>/g,"&gt;");return ta.value;};Ext.namespace('CB');Ext.define('CB.DD',{extend:'Ext.util.Observable',data:[],action:'copy',constructor:function(config){this.callParent(arguments);},execute:function(params,callback,scope){if(Ext.isObject(params.action)){params.action=this.detectActionFromEvent(params.action);}
if(callback){this.callback=scope?Ext.Function.bind(callback,scope):callback;}
switch(params.action){case'copy':this.postEvent='copied';break;case'move':this.postEvent='moved';break;case'shortcut':this.postEvent='shortcuted';break;default:return Ext.Msg.alert('Error','CB.DD: Invalid action specified for execute');}
if(!Ext.isArray(params.sourceData)){params.sourceData=[params.sourceData];}
this.params=params;if(params.confirm!==false){var sourceText=(params.sourceData.length==1)?params.sourceData[0].name:params.sourceData.length+' objects',targetName=Ext.valueFrom(params.targetData.name,params.targetData.title);Ext.Msg.confirm(L.Confirmation,L['DDActionMsg_'+params.action].replace('{source}',sourceText).replace('{target}',targetName),this.onConfirmExecution,this);}else{this.onConfirmExecution('yes');}},onConfirmExecution:function(b){if(b!=='yes'){return;}
this.fireEvent('beforeexecute',this.params);CB_Browser_Actions[this.params.action](this.params,this.processExecute,this);},detectActionFromEvent:function(event){if(event.ctrlKey){return'copy';}else if(event.altKey){return'shortcut';}
return'move';},processExecute:function(r,e){if(!r||(r.success!==true)){if(r.confirm===true){Ext.Msg.confirm(L.Confirmation,r.msg,function(b){if(b==='yes'){this.params.confirmedOverwrite=true;this.onConfirmExecution('yes');}},this);}else{Ext.Msg.alert(L.Error,Ext.valueFrom(r.msg,L.ErrorOccured));}}else{Ext.copyTo(r,this.params,'sourceData,targetData');r.targetId=r.targetData.id;App.fireEvent('objectsaction',this.params.action,r,e);}
if(this.callback){this.callback(r.pids);delete this.callback;}}});;Ext.namespace('CB.DD');Ext.define('CB.DD.Tree',{extend:'Ext.tree.plugin.TreeViewDragDrop',alias:'plugin.CBDDTree',idProperty:'id',enableDrag:true,enableDrop:true,appendOnly:true,containerScroll:true,ddGroup:'CBO',constructor:function(config){var idProperty=Ext.valueFrom(config.idProperty,this.idProperty);var defaultConfig={dragZone:{idProperty:idProperty,onBeforeDrag:this.onBeforeDrag},dropZone:{idProperty:idProperty,dropCopy:'drag-drop-copy',dropMove:'drag-drop-move',dropShortcut:'drag-drop-shortcut',onNodeOver:this.onNodeOver,onNodeDrop:this.onNodeDrop,getActionFromEvent:this.getActionFromEvent}};if(config){Ext.apply(defaultConfig,config);}
Ext.apply(this,defaultConfig);this.callParent(defaultConfig);},init:function(treeView){this.treeView=treeView;treeView.on('beforedestroy',this.onBeforeDestroy,this);App.on('objectsaction',this.onObjectsAction,this);this.callParent(arguments);},onBeforeDestroy:function()
{this.treeView.un('beforedestroy',this.onBeforeDestroy,this);App.un('objectsaction',this.onObjectsAction,this);},onObjectsAction:function(action,r,e){switch(action){case'copy':this.reloadNode(r.targetId);break;case'move':if(!Ext.isEmpty(r.processedIds)){for(var i=0;i<r.processedIds.length;i++){this.removeNode(r.processedIds[i]);}
this.reloadNode(r.targetId);}
break;case'create':break;case'update':break;case'delete':break;}},onBeforeDrag:function(data,e){if(Ext.isEmpty(data.records)){return;}
return(data.records[0].data.system!=1);},getActionFromEvent:function(ev){var rez=(ev.ctrlKey||ev.altKey||ev.shiftKey)?App.DD.detectActionFromEvent(ev):Ext.valueFrom(this.defaultAction,'move');return rez;},onNodeOver:function(node,dragZone,e,data){var action=this.getActionFromEvent(e),rez=this['drop'+action.charAt(0).toUpperCase()+action.slice(1)];var i=0;var targetRecord=this.view.getRecord(node),templateId=targetRecord.data.template_id,acceptChildren=CB.DB.templates.acceptChildren(templateId);while((i<data.records.length)&&(rez!=this.dropNotAllowed)){var r=data.records[i];if(!acceptChildren||isNaN(r.data[this.idProperty])||isNaN(targetRecord.data[this.idProperty])||(targetRecord.data[this.idProperty]==r.data[this.idProperty])||(targetRecord.data[this.idProperty]==r.data.pid)||targetRecord.isAncestor(r)){rez=this.dropNotAllowed;}
i++;}
return rez;},onNodeDrop:function(node,dragZone,e,data){if(this.onNodeOver(node,dragZone,e,data)!=this.dropNotAllowed){var d,sourceData=[];d=this.view.getRecord(node).data;var targetData={id:d[this.idProperty],name:d['name'],path:d['path'],template_id:d['template_id']};for(var i=0;i<data.records.length;i++){if(data.records[i].collapse){data.records[i].collapse();}
d=data.records[i].data;sourceData.push({id:d[this.idProperty],name:d['name'],path:d['path'],template_id:d['template_id']});}
App.DD.execute({action:e,targetData:targetData,sourceData:sourceData});return true;}},removeNode:function(nodeId){var st=this.treeView.ownerGrid.store;var recs=st.query(this.idProperty,nodeId,false,false,true);if(recs.getCount()>0){for(var i=0;i<recs.getCount();i++){st.remove(recs.getAt(i));}}},reloadNode:function(nodeId){var st=this.treeView.ownerGrid.store;var recs=st.query(this.idProperty,nodeId,false,false,true);if(Ext.isEmpty(recs)||(recs.getCount()<1)){return false;}
var node=recs.getAt(0);if(node&&!node.isExpanded()){node.expand();}else{st.reload({node:node});}}});;Ext.namespace('CB.DD');Ext.define('CB.DD.Grid',{extend:'Ext.grid.plugin.DragDrop',alias:'plugin.CBDDGrid',ddGroup:'CBO',idProperty:'id',constructor:function(config){var idProperty=Ext.valueFrom(config.idProperty,this.idProperty);var defaultConfig={dragZone:{},dropZone:{idProperty:idProperty,onNodeEnter:this.onNodeEnter,onNodeOver:this.onNodeOver,onNodeOut:this.onNodeOut,onNodeDrop:this.onNodeDrop}};if(config){Ext.apply(defaultConfig,config);if(config.dropZoneConfig){Ext.apply(defaultConfig.dropZone,config.dropZoneConfig);}}
Ext.apply(this,defaultConfig);this.callParent(defaultConfig);},init:function(owner){this.owner=owner;this.idProperty=owner.store.proxy.reader.config.idProperty;var cfg={};if(!Ext.isDefined(this.enableDragDrop)&&!Ext.isDefined(this.enableDrag)&&!Ext.isDefined(this.enableDrop)){this.enableDragDrop=true;}
cfg.enableDrag=this.enableDragDrop||this.enableDrag;cfg.enableDrop=this.enableDragDrop||this.enableDrop;if(cfg.enableDrag&&cfg.enableDrop){cfg.enableDragDrop=true;}
Ext.apply(this,cfg);owner.on('beforedestroy',this.onBeforeDestroy,this);this.callParent(arguments);},onBeforeDestroy:function()
{this.owner.un('beforedestroy',this.onBeforeDestroy,this);},nodeToGenericData:function(record){if(Ext.isEmpty(record)){return{};}
var na=record.data?record.data:record,pid=record.pid?record.pid:null;var data={id:na[this.idProperty],pid:pid,name:na.name,path:na.path,template_id:na.template_id};return data;},onNodeEnter:function(el,source,ev,data){Ext.get(el).addCls('drop-target');},onNodeOver:function(el,source,ev,data){var targetRecord=this.view.getRecord(el),templateId=targetRecord.data.template_id,acceptChildren=CB.DB.templates.acceptChildren(templateId);var rez=this.dropAllowed;if(Ext.isEmpty(targetRecord)||!data||Ext.isEmpty(data.records)||isNaN(data.records[0].get(this.idProperty))){return this.dropNotAllowed;}
var sourceData=Ext.isArray(data.records)?data.records:[data.records];var i=0;while((i<sourceData.length)&&(rez==this.dropAllowed)){if(!acceptChildren||(targetRecord.data[this.idProperty]==sourceData[i].get(this.idProperty))||(targetRecord.data[this.idProperty]==sourceData[i].get('pid'))){rez=this.dropNotAllowed;}
i++;}
return rez;},onNodeOut:function(el,source,ev,data){Ext.get(el).removeCls('drop-target');},onNodeDrop:function(el,source,e,data){if(Ext.isElement(el)){if(this.onNodeOver(el,source,e,data)==this.dropAllowed){var targetRecord=this.view.getRecord(el);if(targetRecord){var d,sourceData=[];for(var i=0;i<data.records.length;i++){d=data.records[i].data;sourceData.push({id:d[this.idProperty],name:d['name'],path:d['path'],template_id:d['template_id']});}
d=targetRecord.data;var targetData={id:d[this.idProperty],name:d['name'],path:d['path'],template_id:d['template_id']};App.DD.execute({action:e,targetData:targetData,sourceData:sourceData});}}}else{var callback=this.scope?this.onScrollerDragDrop.bind(this.scope):this.onScrollerDragDrop;callback(el,source,e,data);}
return true;}});;Ext.namespace('CB.DD');Ext.define('CB.DD.Panel',{extend:'Ext.dd.DropZone',alias:'plugin.CBDDPanel',ddGroup:'CBO',selector:'.files-drop',dropCopy:'drag-drop-copy',dropMove:'drag-drop-move',dropShortcut:'drag-drop-shortcut',showPopup:false,constructor:function(el,config){var idProperty=Ext.valueFrom(config.idProperty,this.idProperty);var defaultConfig={dragZone:{},dropZone:{onNodeEnter:this.onNodeEnter,onNodeOver:this.onNodeOver,onNodeOut:this.onNodeOut,onNodeDrop:this.onNodeDrop}};if(config){Ext.apply(defaultConfig,config);if(config.dropZoneConfig){Ext.apply(defaultConfig.dropZone,config.dropZoneConfig);}}
Ext.apply(this,defaultConfig);this.callParent([el,defaultConfig]);},init:function(owner){this.owner=owner;var cfg={};if(!Ext.isDefined(this.enableDragDrop)&&!Ext.isDefined(this.enableDrag)&&!Ext.isDefined(this.enableDrop)){this.enableDragDrop=true;}
cfg.enableDrag=this.enableDragDrop||this.enableDrag;cfg.enableDrop=this.enableDragDrop||this.enableDrop;if(cfg.enableDrag&&cfg.enableDrop){cfg.enableDragDrop=true;}
Ext.apply(this,cfg);this.callParent(arguments);},getTargetFromEvent:function(e){return e.getTarget(this.selector);},onNodeEnter:function(el,source,ev,data){this.owner.getEl().addCls('drop-target');var id=Ext.valueFrom(this.owner.params.nid,this.owner.params.id);if(Ext.isEmpty(this.getDraftIdTriggered)&&isNaN(id)){var w,wel=ev.getTarget('.x-window');if(wel){w=Ext.getCmp(wel.id);if(w){w.fireEvent('getdraftid',function(id,r){this.owner.params.id=id;this.owner.params.name=r.result.data.name;},this);this.getDraftIdTriggered=true;}}}},getActionFromEvent:function(ev){var rez=(ev.ctrlKey||ev.altKey||ev.shiftKey)?App.DD.detectActionFromEvent(ev):Ext.valueFrom(this.defaultAction,'move');return rez;},onNodeOver:function(el,source,ev,data){var targetData=this.owner.params||{},targetId=Ext.valueFrom(targetData.nid,targetData.id);var action=this.getActionFromEvent(ev),rez=this['drop'+action.charAt(0).toUpperCase()+action.slice(1)];if(Ext.isEmpty(targetId)||!data||Ext.isEmpty(data.records)){return this.dropNotAllowed;}
if(isNaN(Ext.valueFrom(data.records[0].data.nid,data.records[0].data.id))||isNaN(targetId)){return this.dropNotAllowed;}
var sourceData=Ext.isArray(data.records)?data.records:[data.records];var i=0;while((i<sourceData.length)&&(rez!=this.dropNotAllowed)){var id=Ext.valueFrom(sourceData[i].data.nid,sourceData[i].data.id);if((targetId==id)||(targetId==sourceData[i].data.pid)){rez=this.dropNotAllowed;}
i++;}
return rez;},onNodeOut:function(el,source,ev,data){this.owner.getEl().removeCls('drop-target');},onNodeDrop:function(el,source,e,data){if(Ext.isElement(el)){if(this.onNodeOver(el,source,e,data)!=this.dropNotAllowed){var targetData=this.owner.params||{},targetId=Ext.valueFrom(targetData.nid,targetData.id);if(!isNaN(targetId)){var d,sourceData=[];for(var i=0;i<data.records.length;i++){d=data.records[i].data;sourceData.push({id:Ext.valueFrom(d.nid,d.id),name:d['name'],path:d['path'],template_id:d['template_id']});}
d={id:targetId,name:targetData['name'],path:targetData['path'],template_id:targetData['template_id']};App.DD.execute({action:this.getActionFromEvent(e),targetData:d,sourceData:sourceData});}}}else{var callback=this.scope?this.onScrollerDragDrop.bind(this.scope):this.onScrollerDragDrop;callback(el,source,e,data);}}});;Ext.namespace('CB');Ext.define('CB.VerticalEditGridHelperTree',{extend:'Ext.tree.TreePanel',initComponent:function(){this.store=Ext.create('Ext.data.TreeStore',{root:{text:'root',nid:0,expanded:true,leaf:false,value:{}},proxy:{type:'memory',paramsAsHash:true}});Ext.apply(this,{listeners:{scope:this,beforeitemappend:this.onBeforeNodeAppend}});this.callParent(arguments);},onBeforeNodeAppend:function(parent,node){node.set('id',Ext.id());},loadData:function(data,templateStore){this.data=data;this.templateStore=templateStore;var rn=this.getRootNode();rn.removeAll();this.addNodes(rn,this.data);this.updateVisibility();},readValues:function()
{this.data=this.readChilds(this.getRootNode());return this.data;},readChilds:function(parentNode){var rez={};parentNode.eachChild(function(node){var fieldName=node.data.templateRecord.get('name');var value=node.data.value;switch(node.data.templateRecord.get('type')){case'datetime':if(Ext.isDate(value.value)){value.value=date_local_to_ISO_string(value.value);}
break;case'date':if(Ext.isDate(value.value)){value.value=dateToDateString(value.value);}
break;}
value.childs=this.readChilds(node);value=this.simplifyValue(value);if(Ext.isEmpty(value)||(Ext.isObject(value)&&isEmptyObject(value))){}else{if(Ext.isEmpty(rez[fieldName])){rez[fieldName]=[];}
rez[fieldName].push(value);}},this);for(var fieldName in rez){if(rez.hasOwnProperty(fieldName)){if(rez[fieldName].length==1){rez[fieldName]=rez[fieldName][0];}}}
return rez;},simplifyValue:function(value){if(Ext.isEmpty(value.info)&&Ext.isEmpty(value.files)&&(Ext.isEmpty(value.cond)||Ext.isEmpty(value.value))&&isEmptyObject(value.childs)){return value.value;}
if(Ext.isEmpty(value.info)){delete value.info;}
if(Ext.isEmpty(value.files)){delete value.files;}
if(isEmptyObject(value.childs)){delete value.childs;}
if(Ext.isDefined(value.cond)&&Ext.isEmpty(value.value)){delete value.cond;}
return value;},getGenericArrayDataForNodes:function(fieldData){var rez=[{}];if(Ext.isEmpty(fieldData)){return rez;}
if(Ext.isPrimitive(fieldData)||Ext.isDate(fieldData)){rez[0].value=fieldData;return rez;}
if(Ext.isDefined(fieldData.value)||Ext.isDefined(fieldData.info)||Ext.isDefined(fieldData.childs)||Ext.isDefined(fieldData.cond)){rez[0]=fieldData;return rez;}
if(Ext.isArray(fieldData)){for(var i=0;i<fieldData.length;i++){if(Ext.isPrimitive(fieldData[i])){rez[i]={value:fieldData[i]};}
if(Ext.isDefined(fieldData[i].value)||Ext.isDefined(fieldData[i].info)||Ext.isDefined(fieldData[i].childs)||Ext.isDefined(fieldData[i].cond)){rez[i]=fieldData[i];}}}else{rez[0].value=Ext.util.JSON.encode(fieldData);}
return rez;},adjustValueToType:function(value,type){if(Ext.isEmpty(value)){return value;}
switch(type){case'date':if(Ext.isString(value)){value=Ext.Date.parse(value.substr(0,10),'Y-m-d');}
break;case'datetime':value=date_ISO_to_local_date(value);break;}
return value;},addNodes:function(parentNode,data,beforeNode){var pid=parentNode.data.nid;data=data||{};if(Ext.isEmpty(this.templateStore)){return;}
this.templateStore.each(function(record){if(record.get('pid')==pid){var fieldName=record.get('name');var nodeValues=this.getGenericArrayDataForNodes(data[fieldName]);if(Ext.isEmpty(nodeValues[0].value)&&this.newItem&&!Ext.isEmpty(record.get('cfg').value)){var v=record.get('cfg').value;if(v==='now'){v=new Date();}
nodeValues[0].value=v;}
if(Ext.isEmpty(nodeValues[0].cond)&&this.newItem&&!Ext.isEmpty(record.get('cfg').cond)){nodeValues[0].cond=record.get('cfg').cond;}
for(var i=0;i<nodeValues.length;i++){var node=this.addNode(parentNode,record,beforeNode);nodeValues[i].value=this.adjustValueToType(nodeValues[i].value,record.get('type'));node.data.value=nodeValues[i];this.addNodes(node,nodeValues[i].childs);}}},this);},addNode:function(parentNode,templateRecord,beforeNode){return parentNode.insertBefore({nid:templateRecord.get('id'),templateRecord:templateRecord,value:{}},beforeNode);},updateVisibility:function(){var rez=false;do{this.visibilityUpdated=false;this.getRootNode().cascadeBy({before:this.updateNodeVisibility,scope:this});if(this.visibilityUpdated){rez=true;}}while(this.visibilityUpdated);return rez;},updateNodeVisibility:function(node){if(node==this.getRootNode()){return;}
if(Ext.isEmpty(node.data.templateRecord.get('pid'))){if(node.data.visible===false){this.visibilityUpdated=true;}
node.data.visible=true;return true;}
var r=node.data.templateRecord;var pr=node.parentNode.data.templateRecord;if(node.parentNode.data.visible===false){if(node.data.visible!==false){node.data.visible=false;node.data.value.value=null;this.visibilityUpdated=true;}}else{var v='';var va=[];var parentNodeValue=node.parentNode.data.value.value;if(Ext.isDefined(r.get('cfg').dependency)&&!Ext.isEmpty(r.get('cfg').dependency.pidValues)){v=r.get('cfg').dependency.pidValues;va=toNumericArray(v);}
if(pr&&(['H','G'].indexOf(pr.get('type'))>-1)){if(node.parentNode.data.visible!=node.data.visible){node.data.visible=node.parentNode.data.visible;this.visibilityUpdated=true;}}else{if(node.data.visible!==false){if((!Ext.isEmpty(v)&&!setsHaveIntersection(va,parentNodeValue))||((r.get('cfg').thesauriId==='dependent')&&Ext.isEmpty(parentNodeValue))||((r.get('cfg').scope==='variable')&&Ext.isEmpty(parentNodeValue))||(Ext.isDefined(r.get('cfg').dependency)&&Ext.isEmpty(parentNodeValue)&&!Ext.isEmpty(va))){node.data.visible=false;node.data.value.value=null;this.visibilityUpdated=true;}}else{if(!Ext.isEmpty(parentNodeValue)&&(Ext.isEmpty(v)||setsHaveIntersection(va,parentNodeValue))&&((r.get('cfg').thesauriId!=='dependent')||!Ext.isEmpty(parentNodeValue))&&((r.get('cfg').scope!=='variable')||!Ext.isEmpty(parentNodeValue))&&(Ext.isDefined(r.get('cfg').dependency)||!Ext.isEmpty(parentNodeValue))){node.data.visible=true;this.visibilityUpdated=true;}}}}},queryNodeListBy:function(filterFunction){var rez=[];this.getRootNode().cascadeBy({before:function(node){if(filterFunction(node)){rez.push(node);}},scope:this});return rez;},getNode:function(nodeId){return this.getRootNode().findChild('id',nodeId,true);},getNodesByFieldName:function(fieldName){return this.queryNodeListBy(function(n){return(n.data.templateRecord&&(n.data.templateRecord.get('name')==fieldName));});},setFieldValue:function(fieldName,value){var v,rez=null;if(Ext.isPrimitive(value)||Ext.isEmpty(value)){v={value:value};}else{if(Ext.isDefined(value.value)){v=value;}else{v={value:value};}}
this.getRootNode().cascadeBy({before:function(node){if(node.data.templateRecord&&(node.data.templateRecord.get('name')==fieldName)){node.data.value=v;rez=node;return false;}},scope:this});return rez;},getParentValue:function(nodeId,field_id){var node=this.getNode(nodeId);if(node&&node.data.templateRecord){var pn=node.parentNode;while(pn&&pn.data.templateRecord&&(pn.data.templateRecord.get('id')!=field_id)){pn=pn.parentNode;}
if(pn&&pn.data.templateRecord&&(pn.data.templateRecord.get('id')==field_id)){return pn.data.value.value;}}
return null;},resetChildValues:function(nodeId){var node=this.getNode(nodeId);if(node&&node.data.templateRecord){node.cascadeBy({before:function(n){var tr=n.data.templateRecord,cfg=tr.get('cfg');if(tr&&n.isAncestor(node)&&(cfg.thesauriId==='dependent'||Ext.isDefined(cfg.dependency))&&(cfg.scope=='variable')&&(tr.get('pid')==node.data.templateRecord.get('id'))&&(cfg.readOnly!==true)&&(tr.get('type')==='_objects')){n.data.value.value=null;}},scope:this});this.updateVisibility();}},duplicate:function(nodeId){var node=this.getNode(nodeId);if(!node||!node.data.templateRecord){return false;}
var dn=this.addNode(node.parentNode,node.data.templateRecord,node.nextSibling);this.addNodes(dn);node.data.templateRecord.get('cfg').maxInstances--;this.updateVisibility();},deleteDuplicate:function(nodeId){var node=this.getNode(nodeId);if(!node||!node.data.templateRecord){return false;}
node.data.templateRecord.get('cfg').maxInstances++;node.remove(true);},isDuplicate:function(nodeId){if(this.canDuplicate(nodeId)){return true;}
var node=this.getNode(nodeId);if(node){var ps=node.previousSibling;if(ps&&ps.data.templateRecord){if(ps.data.templateRecord.get('id')==node.data.templateRecord.get('id')){return true;}}else{return false;}}
return null;},canDuplicate:function(nodeId){var node=this.getNode(nodeId);if(node&&node.data.templateRecord){return(node.data.templateRecord.get('cfg').maxInstances>1);}
return false;},getDuplicateIndex:function(nodeId){var index=-1;if(!this.isDuplicate(nodeId)){return index;}
var node=this.getNode(nodeId);if(node&&node.data.templateRecord){index=0;var pn=node.previousSibling;while(pn&&pn.data.templateRecord&&pn.data.templateRecord.get('id')==node.data.templateRecord.get('id')){index++;pn=pn.previousSibling;}
return index;}
return index;},getDuplicationIndexes:function(nodeId){var rez={},node=this.getNode(nodeId),idx;while(node){idx=this.getDuplicateIndex(node.data.id);if(idx>-1){rez[node.data.templateRecord.data.name]=idx;}
node=node.parentNode;}
return rez;},isFirstDuplicate:function(nodeId){if(!this.isDuplicate(nodeId)){return false;}
var node=this.getNode(nodeId);if(node&&node.data.templateRecord){var pn=node.previousSibling;if(pn&&pn.data.templateRecord&&pn.data.templateRecord.get('id')!==node.data.templateRecord.get('id')){return true;}}
return false;},isLastDuplicate:function(nodeId){var node=this.getNode(nodeId);if(node&&node.data.templateRecord){var s=node.nextSibling;return(!s||!s.data.templateRecord||(s.data.templateRecord.get('id')!==node.data.templateRecord.get('id')));}
return null;}});;Ext.namespace('CB.DB');Ext.define('CB.DB.ObjectsStore',{extend:'Ext.data.JsonStore',constructor:function(){this.callParent([{model:'ObjectsRecord',proxy:{type:'memory',reader:{type:'json'}}}]);this.getTexts=getStoreNames;},checkRecordExistance:function(data){if(Ext.isEmpty(data)){return false;}
var id=Ext.valueFrom(data.nid,data.id);if(Ext.isEmpty(id)){return false;}
var rec=this.findRecord('id',id,0,false,false,true);if(!rec){data=Ext.apply({},data);data.id=id;var r=Ext.create(this.getModel().getName(),data);r.set('iconCls',getItemIcon(data));this.add(r);}},checkRecordsExistance:function(arr){Ext.each(arr,function(d){this.checkRecordExistance(d);},this);}});;Ext.namespace('CB.DB');Ext.define('CB.DB.DirectObjectsStore',{extend:'Ext.data.DirectStore',autoLoad:false,restful:false,constructor:function(){var params=arguments[0];params=Ext.apply(params,{model:'ObjectsRecord',proxy:{type:'direct',paramsAsHash:true,api:{read:CB_Objects.getAssociatedObjects},reader:{type:'json',successProperty:'success',rootProperty:'data',messageProperty:'msg'},listeners:{load:function(proxy,obj,opt){for(var i=0;i<obj.result.data.length;i++){obj.result.data[i].date=date_ISO_to_local_date(obj.result.data[i].date);if(!Ext.isEmpty(obj.result.data[i].cfg.iconCls)){obj.result.data[i].iconCls=obj.result.data[i].cfg.iconCls;}}}}}});this.callParent([params]);this.getTexts=getStoreNames;}});CB.DB.DirectObjectsStore.borrow(CB.DB.ObjectsStore,['checkRecordExistance','checkRecordsExistance']);;Ext.namespace('CB.DB');Ext.define('CB.DB.TemplateStore',{extend:'Ext.data.JsonStore',defaultParams:{autoLoad:true,model:'Template'},constructor:function(params){Ext.applyIf(params,this.defaultParams);if(Ext.isEmpty(params.proxy)){params.proxy=new Ext.data.MemoryProxy(params.data||[]);}
this.callParent(arguments);}});;Ext.namespace('CB');Ext.define('CB.ViewPort',{extend:'Ext.Viewport',layout:'fit',border:false,initComponent:function(){this.initComponents();Ext.apply(this,{items:{lbar:App.mainLBar,layout:'fit',border:false,items:[{region:'center',layout:'border',border:false,bbar:App.mainStatusBar,items:[App.mainLPanel,{layout:'fit',region:'center',bodyStyle:'border: 0',tbar:App.mainTBar,items:[App.mainTabPanel]}]}]},listeners:{scope:this,login:this.onLogin,fileupload:this.onFileUpload,filedownload:this.onFilesDownload,createobject:this.createObject,deleteobject:this.onDeleteObject,opencalendar:this.openCalendar,useradded:this.onUsersChange,userdeleted:this.onUsersChange}});this.callParent(arguments);},initComponents:function(){this.initButtons();var items=[{xtype:'panel',border:false,style:'border-bottom: 1px solid #5f5f5f',bodyStyle:'background: transparent',height:49,items:[this.buttons.toggleLeftRegion]},this.buttons.create,this.buttons.toggleFilterPanel];if(Ext.isObject(App.config.leftRibbonButtons)){Ext.iterate(App.config.leftRibbonButtons,function(k,cfg){cfg.scale='large';cfg.scope=this;cfg.handler=this.onLeftRibbonButtonClick;items.push(cfg);},this);}
App.mainLBar=new Ext.Toolbar({cls:'ribbon-black',autoWidth:true,dock:'left',items:items,plugins:[]});App.mainLPanel=new Ext.Panel({region:'west',layout:'card',width:250,split:{size:3,collapsible:false},collapsible:true,collapseMode:'mini',hideCollapseTool:true,header:false,animCollapse:false,plain:true,border:false,bodyBorder:false,bodyStyle:'background-color: #F4F4F4',bodyCls:'main-nav',defaults:{border:false,bodyBoder:false,bodyStyle:'background-color: #F4F4F4',lazyrender:true,scrollable:true},stateful:true,stateId:'mAc',stateEvents:['resize'],tbar:Ext.create({xtype:'panel',height:51,border:false,style:'background: #f4f4f4; text-align: center; border-bottom: 1px solid #99bce8 !important',bodyStyle:'background: #f4f4f4',html:'<img src="/logo.png" style="padding: 9px" />'}),getState:function(){var rez={width:this.width};return rez;}});this.breadcrumb=Ext.create({xtype:'CBBreadcrumb',cls:'fs18',flex:1});this.searchField=Ext.create({xtype:'CBSearchField',cls:'mainSearch',emptyText:L.Search+' Casebox',minListWidth:150,width:350});App.mainTBar=new Ext.Toolbar({height:50,style:'background: #f4f4f4; border: 0;',items:[this.breadcrumb,this.searchField,this.buttons.toggleNotificationsView,{scale:'large',arrowVisible:false,cls:'user-menu-button',iconCls:'bgs32',menu:[],name:'userMenu'},{xtype:'tbspacer',width:10}]});App.mainTabPanel=new Ext.TabPanel({tabWidth:205,minTabWidth:100,enableTabScroll:true,resizeTabs:true,activeTab:0,header:false,region:'center',plain:true,bodyStyle:'background-color: #FFF',componentCls:'mainTabPanel',border:false,defaults:{tabConfig:{textAlign:'left'}},items:[]});App.mainStatusBar=new CB.widget.TaskBar({style:'border-top: 1px solid #aeaeae',height:25,trayItems:[{xtype:'uploadwindowbutton'}]});},initActions:function(){this.actions={toggleLeftRegion:new Ext.Action({tooltip:L.Back,itemId:'togglelr',pressed:true,enableToggle:true,iconCls:'im-menu-negative',scale:'large',scope:this,handler:this.toggleLeftRegion}),toggleFilterPanel:new Ext.Action({tooltip:L.Filter,itemId:'togglefp',enableToggle:true,iconCls:'im-filter-negative',scale:'large',scope:this,handler:this.onToggleFilterPanelClick}),toggleNotificationsView:new Ext.Action({tooltip:L.Notifications,itemId:'toggleNotifications',iconCls:'im-notifications',cls:'numbersButton',text:'',scale:'large',scope:this,handler:this.onToggleNotificationsViewClick})};return this.actions;},initButtons:function(){this.initActions();this.buttons={toggleLeftRegion:new Ext.Button(this.actions.toggleLeftRegion),toggleFilterPanel:new Ext.Button(this.actions.toggleFilterPanel),toggleNotificationsView:new Ext.Button(this.actions.toggleNotificationsView),create:new Ext.Button({qtip:L.New,itemId:'create',arrowVisible:false,iconCls:'im-create-negative',disabled:true,scale:'large',menuAlign:'tl-tr',menu:[],listeners:{menushow:this.onButtonMenuShow}})};this.buttons.toggleLeftRegion.on('afterrender',function(b,e){b.toggle(App.mainLPanel.getCollapsed()===false);},this);App.on('notificationsUpdated',this.updateNotificationsCount,this);return this.actions;},toggleLeftRegion:function(b,e){if(b.pressed){App.mainLPanel.expand();}else{App.mainLPanel.collapse();}},onToggleFilterPanelClick:function(b,e){this.buttons.toggleFilterPanel.setPressed(b.pressed);App.mainLPanel.getLayout().setActiveItem(b.pressed?1:0);},updateNotificationsCount:function(counts){var text=(counts.unseen>0)?counts.unseen:'';this.buttons.toggleNotificationsView.setText(text);if(!this.originalDocTitle){this.originalDocTitle=document.title;}
document.title=(Ext.isEmpty(text)?'':'('+text+') ')+this.originalDocTitle;},onToggleNotificationsViewClick:function(b,e){var cpl=App.explorer.containersPanel.getLayout(),hideNotifications=cpl.activeItem.isXType('CBNotificationsView');cpl.setActiveItem(hideNotifications?0:1);if(hideNotifications){var proxy=App.explorer.store.getProxy(),action=Ext.valueFrom(proxy.reader.rawData,{}),options=proxy.extraParams;App.controller.onVCViewLoaded(proxy,action,options);}else{App.mainViewPort.breadcrumb.setValue([{id:-1,name:L.Notifications}]);}},onLogin:function(){var um,umIdx=App.mainTBar.items.findIndex('name','userMenu');if(umIdx>-1){um=App.mainTBar.items.getAt(umIdx);um.setIcon(App.config.photoPath+App.loginData.id+'.jpg?32='+CB.DB.usersStore.getPhotoParam(App.loginData.id));}
var langs=[];CB.DB.languages.each(function(r){langs.push({text:r.get('name'),xtype:'menucheckitem',checked:(r.get('id')==App.loginData.language_id),data:{id:r.get('id')},scope:this,handler:this.setUserLanguage,group:'language'});},this);var themes=[];CB.DB.themes.each(function(r){themes.push({text:r.get('name'),xtype:'menucheckitem',checked:(r.get('id')==App.loginData.theme),data:{id:r.get('id')},scope:this,handler:this.setUserTheme,group:'theme'});},this);um.menu.add({text:L.Account,iconCls:'icon-user-account',handler:function(){App.openWindow({xtype:'CBAccount',id:'accountWnd'});}},'-',{text:L.NotifySettings,scope:this,handler:this.onNotifySettingsClick},{text:L.Theme,menu:themes},{text:L.Language,hideOnClick:false,menu:langs},'-',{text:L.Exit,iconCls:'icon-exit',handler:this.logout,scope:this});var managementItems=[];if(App.loginData.manage){managementItems.push({text:L.Users,iconCls:'icon-users',handler:function(){var w=new CB.VerifyPassword({listeners:{scope:this,beforeclose:function(cmp){if(cmp.success!==true){cmp.destroy();}else{App.openWindow({xtype:'CBUsersGroups',id:'usersGroupsWnd'});}}}});w.show();}});}
if(App.loginData.admin){managementItems.push({text:L.ReloadTemplates,iconCls:'icon-templates',handler:function(){reloadTemplates();}});}
if(!Ext.isEmpty(managementItems)){managementItems.push('-');for(var i=managementItems.length-1;i>=0;i--){um.menu.insert(2,managementItems[i]);}}
this.populateMainMenu();},initCB:function(){if(CB.DB&&CB.DB.templates&&(CB.DB.templates.getCount()>0)){this.onLogin();App.DD=new CB.DD();Ext.Function.defer(this.checkUrlLocate,1500);App.initialized=true;App.fireEvent('cbinit',this);App.explorer.notificationsView.on('deactivate',function(){this.buttons.toggleNotificationsView.toggle(false,true);},this);}else{Ext.Function.defer(this.initCB,500,this);}},checkUrlLocate:function(){var locateId=String(window.location.search.split('locate=')[1]).split('&')[0];if(!Ext.isEmpty(locateId)){App.controller.openObjectWindowById(locateId);}},onLeftRibbonButtonClick:function(b,e){App.openPath(b.path);},logout:function(){return Ext.Msg.show({buttons:Ext.Msg.YESNO,title:L.ExitConfirmation,msg:L.ExitConfirmationMessage,fn:function(btn,text){if(btn==='yes'){CB_User.logout(function(r,e){if(r&&(r.success===true)){App.confirmLeave=false;window.location.reload();}else if(r.msg){Ext.Msg.show({title:'error',msg:r.msg});}});}}});},populateMainMenu:function(){App.mainTree=App.mainLPanel.add({layout:'border',border:false,scrollable:false,items:[{xtype:'CBBrowserTree',region:'center',border:false,bodyStyle:'border: 0',data:{rootNode:App.config.rootNode}},{region:'south',xtype:'tabpanel',tabPosition:'bottom',cls:'left-bottom-tabpanel',split:{size:3,collapsible:true,style:'background-color: #dfe8f6'},stateful:true,stateId:'lpsr',collapseMode:'mini',border:false,bodyBorder:false,bodyStyle:'background-color: transparent',minHeight:100,hidden:true,items:[{xtype:'CBFavoritesPanel'}]}]}).items.getAt(0);App.Favorites=App.mainLPanel.down('CBFavoritesPanel');App.mainLPanel.getLayout().setActiveItem(0);App.mainFilterPanel=App.mainLPanel.add({xtype:'CBFilterPanel',header:false,border:false,cls:'x-panel-gray',tbar:['->',{iconCls:'im-cancel',itemId:'close',scale:'medium',scope:this,handler:function(b,e){this.buttons.toggleFilterPanel.toggle(false);this.onToggleFilterPanelClick(this.buttons.toggleFilterPanel,e);}}]});if(App.mainTree){App.mainTree.getRootNode().data.name='My CaseBox';}
this.openDefaultExplorer();App.mainTabPanel.setActiveTab(0);},selectTreeRootNode:function(){if(App.mainTree&&App.explorer){if(App.mainTree.rendered){var rn=App.mainTree.getRootNode();App.mainTree.selectPath('/'+rn.get('nid'),'nid','/');}}},createObject:function(data,e){App.activateBrowserTab().editObject(data);},onAccordionLinkClick:function(p,animate){p=App.openUniqueTabbedWidget(p.link,null,{iconCls:p.iconCls,title:p.title});return false;},openCalendar:function(ev){if(ev&&ev.stopPropagation){ev.stopPropagation();}
App.openUniqueTabbedWidget('CBCalendarPanel');},openDefaultExplorer:function(rootId){if(Ext.isEmpty(rootId)&&App.mainTree){rootId=Ext.valueFrom(App.mainTree.rootId,'/');}
if(!App.activateTab(App.mainTabPanel,'explorer')){App.explorer=App.addTab(App.mainTabPanel,new CB.browser.ViewContainer({rootId:rootId,data:{id:'explorer'},closable:false}));}},showNotificationsView:function(){if(!App.activateTab(App.mainTabPanel,'notificationsView')){App.addTab(App.mainTabPanel,new CB.notifications.View({data:{id:'notificationsView'},closable:false}));}},openPermissions:function(objectId){if(isNaN(objectId)){return;}
App.openWindow({xtype:'CBSecurityWindow',id:'opw'+objectId,data:{id:objectId}});},onNotifySettingsClick:function(b,e){var w=new CB.notifications.SettingsWindow();w.show();},setUserLanguage:function(b,e){var d=b.config.data;if(d.id==App.loginData.language_id){return;}
Ext.Msg.confirm(L.LanguageChange,L.LanguageChangeMessage,function(pb){if(pb==='yes'){CB_User.setLanguage(d.id,this.processSetUserOption,this);}
if(d.ownerCt){d.ownerCt.items.each(function(i){i.setChecked(i.data.id==App.loginData.language_id);},this);}},this);},setUserTheme:function(b,e){var d=b.config.data;if(d.id==App.loginData.theme){return;}
Ext.Msg.confirm(L.Theme,L.ThemeChangeMessage,function(pb){if(pb==='yes'){CB_User.setTheme(d.id,this.processSetUserOption,this);}
if(d.ownerCt){d.ownerCt.items.each(function(i){i.setChecked(i.data.id==App.loginData.theme);},this);}},this);},processSetUserOption:function(r,e){if(r&&(r.success===true)){App.confirmLeave=false;document.location.reload();}else{Ext.Msg.alert(L.Error,L.ErrorOccured);}},focusLastElement:function(){if(this.lastFocusedElement){this.lastFocusedElement.focus(500);}},onUsersChange:function(){CB.DB.usersStore.reload();},onDeleteObject:function(data){Ext.Msg.confirm(L.DeleteConfirmation,L.DeleteConfirmationMessage+' "'+Ext.valueFrom(data.title,data.name)+'"?',function(btn){if(btn==='yes'){CB_Browser['delete'](data.id,this.onProcessObjectsDeleted,this);}},this);},onProcessObjectsDeleted:function(r,e){if(!r||(r.success!==true)){return;}
if(!Ext.isEmpty(r.ids)){this.fireEvent('objectsdeleted',r.ids,e);}},onFileUpload:function(data,e){if(e&&e.stopEvent){e.stopEvent();}
if(!this.fileField){this.fileField=document.createElement("INPUT");this.fileField.setAttribute("type","file");this.fileField.setAttribute("multiple","true");this.fileField.onchange=Ext.Function.bind(function(ev){if(this.fileField.files.length>0){App.addFilesToUploadQueue(this.fileField.files,this.fileField.data);}},this);}
this.fileField.data=data;this.fileField.value=null;this.fileField.click();},onFileUploaded:function(w,data){this.fireEvent('fileuploaded',{data:data});},onFilesDownload:function(ids,zipped,e){if(e){e.stopPropagation();}
if(zipped!==true){if(!Ext.isArray(ids)){ids=String(ids).split(',');}
Ext.each(ids,function(id){if(isNaN(id)){return false;}
App.downloadFile(id);},this);}else{if(Ext.isArray(ids)){ids=ids.join(',');}
App.downloadFile(ids,true);}},onButtonMenuShow:function(btn,menu,eOpts){menu.showBy(btn,Ext.valueFrom(btn.menuAlign,'tl-tr'),[2,0]);}});;Ext.namespace('CB');Ext.define('CB.plugin.Panel',{extend:'Ext.Panel',alias:'CBPluginPanel',scrollable:true,cls:'plugins-panel',padding:0,initComponent:function(){Ext.apply(this,{layout:{type:'vbox',align:'stretch'}});this.callParent(arguments);App.on('filesuploaded',this.onFilesUploaded,this);App.on('objectsaction',this.onObjectsAction,this);this.delayLoadTask=new Ext.util.DelayedTask(this.doLoad,this);},load:function(params){if(!isNaN(params)){params={id:params};}
var el=this.getEl();if(Ext.isEmpty(el)||!el.isVisible(true)){return;}
this.delayLoadTask.cancel();if(Ext.encode(params)==Ext.encode(this.loadedParams)){return;}
this.delayLoadTask.delay(60,this.doLoad,this,arguments);},doLoad:function(params){if(Ext.isEmpty(this.api)){return;}
if(!isNaN(params)){params={id:params};}
this.clear();if(Ext.isEmpty(params)||(Ext.isEmpty(params.id)&&Ext.isEmpty(params.template_id))){this.fireEvent('loaded',this);return;}
this.loadedParams=params;this.api(params,this.onLoadData,this);},onLoadData:function(r,e){var items=[],params=Ext.valueFrom(this.loadedParams,{});if(!r||(r.success!==true)){this.update('<div class="x-preview-mask">'+L.RecordIdNotFound.replace('{id}','#'+params.id)+'</div>');}else{var commonInfo=r.common?r.common.data:Ext.valueFrom(r.data.systemProperties,{}).data;Ext.apply(params,commonInfo);this.removeAll(true);this.createMenu=r.menu;Ext.iterate(r.data,function(k,v,o){var cls=Ext.valueFrom(v.class,k),cl=Ext.util.Format.capitalize(cls.substr(0,1))+cls.substr(1);cl='CBObjectPlugin'+cl;var c=Ext.create(cl,{params:params});c.createMenu=r.menu;items.push(c);if(!Ext.isDefined(v.data)){c.setVisible(false);}else{c.onLoadData(v);}},this);if(!Ext.isEmpty(items)){this.add(items);}
if(params&&(params.from!=='window')&&!Ext.isEmpty(params.name)){var data=Ext.copyTo({},params,'id,pids,path,name,template_id,status,statusCls,cid,cdate_ago_text,uid,udate_ago_text');var titleView=new CB.object.TitleView({data:data,getContainerToolbarItems:function(){return{};}});this.insert(0,titleView);}
this.doLayout(true,true);}
this.fireEvent('loaded',this,params);},clear:function(){this.removeAll(true);delete this.loadedParams;},onFilesUploaded:function(pids){if(!Ext.isEmpty(this.loadedParams)){if(pids.indexOf(String(this.loadedParams.id))>=0){this.reload();}}},onObjectsAction:function(action,data,e){if(this.loadedParams&&(data.targetId==this.loadedParams.id)){this.reload();}},reload:function(){this.doLoad(this.loadedParams);},getContainerToolbarItems:function(){}});;Ext.namespace('CB.form.view.object');Ext.define('CB.object.view.Preview',{extend:'Ext.Panel',alias:'widget.CBObjectPreview',scrollable:true,html:'',tbarCssClass:'x-panel-white',loadMask:false,padding:0,width:300,layout:'fit',fitImagePreview:true,loader:{autoLoad:false},initComponent:function(){Ext.apply(this,{listeners:{scope:this,afterrender:this.onAfterRender}});this.callParent(arguments);App.on('objectchanged',this.onObjectChanged,this);},onAfterRender:function(){},loadPreview:function(id,versionId){var el=this.getEl();if(Ext.isEmpty(el)||!el.isVisible(true)){return;}
if(this.delayedReloadTask){this.delayedReloadTask.cancel();}
this.newId=id;this.newVersionId=Ext.valueFrom(versionId,'');this.delayReload(100);},delayReload:function(ms){if(!this.delayedReloadTask){this.delayedReloadTask=new Ext.util.DelayedTask(this.reload,this);}
this.delayedReloadTask.delay(Ext.valueFrom(ms,1000),this.reload,this);},reload:function(){var el=this.getEl();if(Ext.isEmpty(this.newId)||isNaN(this.newId)||!el||!el.isVisible(true)){return this.clear();}
this.doLoad(this.newId,this.newVersionId);},doLoad:function(id,vId){this.loader.load({url:'/c/'+App.config.coreName+'/view/'+id+'_'+vId+'/?i=1',callback:this.processLoad,scope:this,discardUrl:false,nocache:true,scripts:false});},processLoad:function(el,success,r,e){this.data={id:this.newId};this.loadedVersionId=this.newVersionId;this.body.scrollTo('top',0);switch(r.responseText){case'<authenticate />':window.location.reload();break;case'&#160':this.update('<div style="margin-top: 40px; text-align:center; color: 555; font-weight: bold">'+'<img src="'+Ext.BLANK_IMAGE_URL+'" class="i16 d-loader" style="vertical-align:middle; margin-right: 5px"> '+L.generatingPreview+' &hellip; </div>');this.delayReload();break;case'PDF':var url='/c/'+App.config.coreName+"/download/"+this.data.id+"/?pw=";this.update('<object data="'+url+'" type="application/pdf" width="100%" height="100%">'+'alt : <a href="'+url+'">'+this.data.name+'</a></object>');break;}
this.attachEvents();this.fireEvent('loaded',this);if(this.params){switch(detectFileEditor(this.params.name)){case'text':hljs.highlightBlock(this.body.dom);break;}}},attachEvents:function(){var a=this.getEl().query('a.locate');Ext.each(a,function(t){Ext.get(t).addListener('click',function(ev,el){App.locateObject(el.attributes.getNamedItem('nid').value,el.attributes.getNamedItem('path').value);},this);},this);a=this.getEl().query('a.taskA');Ext.each(a,function(t){Ext.get(t).addListener('click',function(ev,el){switch(el.attributes.getNamedItem('action').value){case'close':Ext.Msg.show({title:L.CompletingTask,msg:L.Message,width:400,height:200,buttons:Ext.MessageBox.OKCANCEL,multiline:true,fn:function(b,message){if(b==='ok'){this.getEl().mask(L.CompletingTask+' ...','x-mask-loading');CB_Tasks.close(this.data.id,this.onTaskChanged,this);}},scope:this});break;case'reopen':Ext.Msg.confirm(L.ReopeningTask,L.ReopenTaskConfirmationMsg,function(b){if(b==='yes'){this.getEl().mask(L.ReopeningTask+' ...','x-mask-loading');CB_Tasks.reopen(this.data.id,this.onTaskChanged,this);}},this);break;case'complete':Ext.Msg.show({title:L.CompletingTask,msg:L.Message,width:400,height:200,buttons:Ext.MessageBox.OKCANCEL,multiline:true,fn:function(b,message){if(b==='ok'){CB_Tasks.complete({id:this.data.id,message:message},this.onTaskChanged,this);}},scope:this});break;case'markcomplete':this.forUserId=el.attributes.getNamedItem('uid').value;Ext.Msg.show({title:L.SetCompleteStatusFor+' '+CB.DB.usersStore.getName(this.forUserId),msg:L.Message,width:400,height:200,buttons:Ext.MessageBox.OKCANCEL,multiline:true,fn:function(b,message){if(b==='ok'){CB_Tasks.setUserStatus({id:this.data.id,user_id:this.forUserId,status:1,message:message},this.onTaskChanged,this);}},scope:this});break;case'markincomplete':this.forUserId=el.attributes.getNamedItem('uid').value;Ext.Msg.show({title:L.SetIncompleteStatusFor+CB.DB.usersStore.getName(this.forUserId),msg:L.Message,width:400,height:200,buttons:Ext.MessageBox.OKCANCEL,multiline:true,fn:function(b,message){if(b==='ok'){CB_Tasks.setUserStatus({id:this.data.id,user_id:this.forUserId,status:0,message:message},this.onTaskChanged,this);}},scope:this});break;}},this);},this);a=this.getEl().query('a.path');Ext.each(a,function(t){Ext.get(t).addListener('click',function(ev,el){App.locateObject(this.data.id,el.attributes.getNamedItem('path').value);},this);},this);a=this.getEl().query('.file-unknown a');Ext.each(a,function(t){Ext.get(t).addListener('click',function(ev,el){App.mainViewPort.fireEvent('fileopen',{id:el.attributes.getNamedItem('nid').value});},this);},this);this.viewingImage=null;a=this.getEl().query('img.fit-img');Ext.each(a,function(t){this.viewingImage=Ext.get(t);if(!this.fitImagePreview){this.viewingImage.dom.setAttribute('class','');}},this);},onTaskChanged:function(r,e){this.getEl().unmask();this.reload();App.fireEvent('objectchanged',this.data,this);},clear:function(){delete this.data;delete this.loadedVersionId;this.update('<div class="x-preview-mask">'+L.SelectPreviewItem+'</div>');if(this.getEl().isVisible(true)){this.body.scrollTo('top',0);}},getContainerToolbarItems:function(){var rez={tbar:{},menu:{reload:{}}};if(this.params){rez.tbar['openExternal']={};if(CB.DB.templates.getType(this.params.template_id)==='file'){if(this.viewingImage){rez.tbar['fitImage']={allowToggle:true,pressed:this.fitImagePreview};}else if(detectFileEditor(this.params.name)){rez.tbar['edit']={};}
rez.tbar['download']={};rez.tbar['preview']={};rez.menu['delete']={addDivider:'top'};rez.menu['webdavlink']={addDivider:'top'};rez.menu['permalink']={};}}
return rez;},onObjectChanged:function(data,component){if(!isNaN(data)){data={id:data};}
if(!Ext.isEmpty(this.data)){if(data.id==this.data.id){this.reload();}}},onFitImageClick:function(b,e){if(this.viewingImage){if(this.fitImagePreview){this.fitImagePreview=false;this.viewingImage.dom.setAttribute('class','');}else{this.fitImagePreview=true;this.viewingImage.dom.setAttribute('class','fit-img');}}}});;Ext.namespace('CB.form.view.object');Ext.define('CB.object.view.Properties',{extend:'CB.plugin.Panel',alias:'widget.CBObjectProperties',initComponent:function(){this.callParent(arguments);this.on('timespentclick',this.onTimeSpentClick,this);this.on('addtimespentclick',this.onAddTimeSpentClick,this);},getContainerToolbarItems:function(){var rez={tbar:{},menu:{reload:{order:12,addDivider:'top'},rename:{order:13},permalink:{order:14},setOwner:{order:15},permissions:{order:16},'delete':{order:20,addDivider:'top'}}};var objType='';if(!Ext.isEmpty(this.loadedParams)){objType=CB.DB.templates.getType(this.loadedParams.template_id);if((objType!=='file')||detectFileEditor(this.loadedParams.name)){rez.tbar['edit']={};}}
rez.tbar['openExternal']={};if(!Ext.isEmpty(this.loadedParams)){switch(objType){case'file':rez.tbar['download']={};rez.tbar['preview']={};break;case'search':rez.tbar['search']={};break;}}
this.items.each(function(i){var pi=i.getContainerToolbarItems();if(pi.tbar){rez.tbar=Ext.apply(rez.tbar,pi.tbar);}
if(pi.menu){var isFirstItem=true;Ext.iterate(pi.menu,function(key,value){if(isFirstItem){value.addDivider='top';isFirstItem=false;}else{return false;}},this);rez.menu=Ext.apply(rez.menu,pi.menu);}},this);var a=[],sortedMenu={};Ext.iterate(rez.menu,function(k,v,o){var order=Ext.valueFrom(v.order,0);if(!Ext.isDefined(a[order])){a[order]={};}
a[order][k]=v;},this);for(var i=0;i<a.length;i++){Ext.apply(sortedMenu,a[i]);}
rez.menu=sortedMenu;return rez;},setSelectedVersion:function(params){this.items.each(function(i){if(i.setSelectedVersion){i.setSelectedVersion(params);}},this);},onLoadData:function(r,e){this.update('');this.callParent(arguments);var ttp=this.down('CBObjectPluginTimeTracking');if(!Ext.isEmpty(ttp)){ttp.hide();}},clear:function(){this.callParent(arguments);this.update('<div class="x-preview-mask">'+L.SelectPreviewItem+'</div>');},getCommentComponent:function(){return this.down('textarea[cls=comment-input]');},getCommentValue:function(){var ci=this.getCommentComponent();if(Ext.isEmpty(ci)){return'';}
return Ext.valueFrom(ci.getValue(),'');},setCommentValue:function(value){var ci=this.getCommentComponent();if(!Ext.isEmpty(ci)){ci.setValue(value);}},onTimeSpentClick:function(cmp){var ttp=this.down('CBObjectPluginTimeTracking');if(Ext.isEmpty(ttp)){return;}
if(!ttp.getEl().isVisible(true)){ttp.show();this.updateLayout();ttp.getEl().scrollIntoView(this.body,false,false,true);this.body.scrollBy(0,40,false);ttp.focus(false,100);}else{ttp.getEl().scrollIntoView(this.body,false,false,true);}},onAddTimeSpentClick:function(cmp,e){var ttp=this.down('CBObjectPluginTimeTracking');if(Ext.isEmpty(ttp)){return;}
ttp.onAddClick(cmp,e);}});;Ext.namespace('CB.form.edit');Ext.define('CB.object.edit.Form',{extend:'Ext.Panel',alias:'widget.CBEditObject',tbarCssClass:'x-panel-white',padding:0,scrollable:false,layout:'anchor',data:{},initComponent:function(){this.data=Ext.apply({},this.config.data);this.objectsStore=new CB.DB.DirectObjectsStore({listeners:{scope:this,add:this.onObjectsStoreChange,load:this.onObjectsStoreLoad}});this.titleView=new Ext.DataView({autoHeight:true,hidden:(this.hideTitle===true),cls:'obj-plugin-title',tpl:['<tpl for=".">','<div class="obj-header">{[ Ext.util.Format.htmlEncode(Ext.valueFrom(values.name, \'\')) ]}</div>','</tpl>'],itemSelector:'div',data:{}});this.fieldsZone=new Ext.form.FormPanel({title:L.Fields,header:false,border:false,autoHeight:true,labelAlign:'top',bodyStyle:'margin:0; padding: 0 7px',items:[],api:{submit:CB_Objects.save}});Ext.apply(this,{defaults:{anchor:'-1',style:'margin: 0 0 15px 0'},items:[this.titleView,{xtype:'panel',autoHeight:true,border:false,items:[]},this.fieldsZone],listeners:{scope:this,change:this.onChange,afterrender:this.onAfterRender}});this.callParent(arguments);this.enableBubble(['saveobject']);},onChange:function(fieldName,newValue,oldValue){this._isDirty=true;if(!Ext.isEmpty(fieldName)&&Ext.isString(fieldName)){this.fireEvent('fieldchange',fieldName,newValue,oldValue);}
this.fireEvent('changed',this);},onAfterRender:function(c){var map=new Ext.KeyMap(c.getEl(),[{key:"s",ctrl:true,shift:false,stopEvent:true,scope:this,fn:this.onSaveObjectEvent}]);},load:function(objectData){if(Ext.isEmpty(objectData)){return;}
if(!isNaN(objectData)){objectData={id:objectData};}
this.loadData(objectData);},loadData:function(objectData){this.requestedLoadData=objectData;if(this._isDirty){this.confirmDiscardChanges();return;}
this.clear();if(isNaN(objectData.id)){if(Ext.isEmpty(objectData.name)){objectData.name=L.New+' '+CB.DB.templates.getName(objectData.template_id);}
this.processLoadData({success:true,data:objectData});}else{CB_Objects.load({id:objectData.id},this.processLoadData,this);}},processLoadData:function(r,e){this.getEl().unmask();if(!r||(r.success!==true)){return;}
this.data=r.data;if(Ext.isEmpty(this.data.data)){this.data.data={};}
this.titleView.update(this.data);this.objectsStore.proxy.extraParams={id:r.data.id,template_id:r.data.template_id,data:r.data.data};this.startEditAfterObjectsStoreLoadIfNewObject=true;this.objectsStore.reload();var gridType=(CB.DB.templates.getType(this.data.template_id)==='search')?'CBVerticalSearchEditGrid':'CBVerticalEditGrid';if(this.lastgGridType!=gridType){this.items.getAt(1).removeAll(true);this.grid=Ext.create(gridType,{title:L.Details,autoHeight:true,hidden:true,refOwner:this,includeTopFields:true,stateId:'oevg',autoExpandColumn:'value',scrollable:false,keys:[{key:"s",ctrl:true,shift:false,scope:this,stopEvent:true,fn:this.onSaveObjectEvent}],viewConfig:{forceFit:true,autoFill:true},listeners:{scope:this,beforeedit:this.saveScroll,edit:this.restoreScroll,savescroll:this.saveScroll,restorescroll:this.restoreScroll}});this.lastgGridType=gridType;this.items.getAt(1).add(this.grid);}
this.grid.reload();if(this.grid.store.getCount()>0){this.grid.show();if(this.grid.rendered){this.grid.getView().refresh(true);}}
if(this.grid.templateStore){var fields=[];this.grid.templateStore.each(function(r){if(r.get('cfg').showIn==='tabsheet'){var cfg={border:false,title:r.get('title'),isTemplateField:true,name:r.get('name'),value:this.data.data[r.get('name')],height:Ext.valueFrom(r.get('cfg').height,200),anchor:'100%',grow:true,fieldLabel:r.get('title'),labelAlign:'top',labelCls:'fwB ttU',listeners:{scope:this,change:function(field,newValue,oldValue){this.fireEvent('change',field.name,newValue,oldValue);},sync:function(){this.fireEvent('change');}},xtype:(r.get('type')==='html')?'CBHtmlEditor':'textarea'};this.fieldsZone.add(cfg);}},this);}
this._isDirty=false;if(!this.hasLayout&&this.doLayout){this.doLayout();}
this.fireEvent('loaded',this);},saveScroll:function(){this.lastScroll=this.body.getScroll();return this.lastScroll;},restoreScroll:function(){this.body.setScrollLeft(this.lastScroll.left);this.body.setScrollTop(this.lastScroll.top);},focusDefaultCell:function(){if(this.grid&&!this.grid.editing&&this.grid.getEl()&&(this.grid.store.getCount()>0)){var valueCol=this.grid.headerCt.child('[dataIndex="value"]');var colIdx=valueCol.getVisibleIndex();this.grid.getSelectionModel().select({row:0,column:colIdx});this.grid.getNavigationModel().setPosition(0,colIdx);if(this.startEditAfterObjectsStoreLoadIfNewObject&&isNaN(this.data.id)){this.grid.editingPlugin.startEditByPosition({row:0,column:colIdx});}
delete this.startEditAfterObjectsStoreLoadIfNewObject;}},onObjectsStoreLoad:function(store,records,options){this.onObjectsStoreChange(store,records,options);if(!this.grid.editing){this.grid.getView().refresh();if(this.startEditAfterObjectsStoreLoadIfNewObject===true){this.focusDefaultCell();}}},onObjectsStoreChange:function(store,records,options){Ext.each(records,function(r){r.set('iconCls',getItemIcon(r.data));},this);},confirmDiscardChanges:function(){Ext.Msg.show({title:L.Confirmation,msg:L.SavingChangedDataMessage,icon:Ext.Msg.QUESTION,buttons:Ext.Msg.YESNOCANCEL,scope:this,fn:function(b,text,opt){switch(b){case'yes':this.save();break;case'no':this.clear();this.loadData(this.requestedLoadData);break;default:delete this.requestedLoadData;}}});},readValues:function(){this.grid.readValues();this.data.data=Ext.apply(this.data.data,this.fieldsZone.getForm().getFieldValues());return this.data;},setFieldValue:function(fieldName,value){if(this.grid){this.grid.setFieldValue(fieldName,value);}},save:function(callback,scope){if(!this._isDirty){return;}
this.readValues();if(callback){this.saveCallback=callback.bind(scope||this);}
this.getEl().mask(L.Saving+' ...','x-mask-loading');this.fieldsZone.getForm().submit({clientValidation:true,loadMask:false,params:{data:Ext.encode(this.data)},scope:this,success:this.processSave,failure:this.processSave});},processSave:function(form,action){this.getEl().unmask();var r=action.result;if(!r||(r.success!==true)){delete this.saveCallback;return;}
this._isDirty=false;if(this.saveCallback){this.saveCallback(this,form,action);delete this.saveCallback;}
App.fireEvent('objectchanged',r.data,this);},clear:function(){this.data={};this.titleView.update(this.data);if(this.grid){this.grid.hide();}
this.fieldsZone.removeAll(true);this._isDirty=false;this.fireEvent('clear',this);},onSaveObjectEvent:function(key,ev){this.fireEvent('saveobject',this,ev);},getContainerToolbarItems:function(){var rez={tbar:{},menu:{}};if(CB.DB.templates.getType(this.data.template_id)==='search'){rez.tbar['search']={};rez.menu['save']={};}else{rez.tbar['save']={};rez.tbar['cancel']={};rez.tbar['openInTabsheet']={};}
return rez;},isValid:function(){var rez=true;if(this.grid&&this.grid.isValid){rez=this.grid.isValid();}
return rez;}});;Ext.namespace('CB');Ext.define('CB.object.edit.Window',{extend:'Ext.Window',alias:'CBObjectEditWindow',xtype:'CBObjectEditWindow',closable:true,minimizable:true,maximizable:true,layout:'border',border:false,minWidth:200,minHeight:200,width:600,height:450,iconCls:'icon-none',scrollable:false,initComponent:function(){this.data=Ext.apply({},this.config.data);delete this.data.html;this.updateWindowTitle();this.objectsStore=new CB.DB.DirectObjectsStore({listeners:{scope:this,add:this.onObjectsStoreChange,load:this.onObjectsStoreLoad}});this.viewMode=Ext.valueFrom(this.data.view,'preview');this.templateCfg=CB.DB.templates.getProperty(this.data.template_id,'cfg');this.templateType=CB.DB.templates.getType(this.data.template_id);this.initActions();this.initContainerItems();this.titleView=new CB.object.TitleView();this.titleContainer.add(this.titleView);if(this.templateType=='time_tracking'){this.titleContainer.hide();Ext.apply(this,{minimizable:false,maximizable:false,header:false});}
Ext.apply(this,{cls:'x-panel-white',bodyStyle:'border: 0; padding: 0; border-top: 1px solid #99bce8',tbar:this.getToolbarButtons(),items:this.getLayoutItems(),stateful:true,stateId:'oew'+this.data.template_id,listeners:{scope:this,'change':this.onChange,'afterrender':this.onAfterRender,'beforeclose':this.onBeforeClose,'openpreview':this.onOpenPreviewEvent,'openproperties':this.onOpenPreviewEvent,'editobject':this.onEditObjectEvent,'editmeta':this.onEditObjectEvent,'fileupload':this.onFileUploadEvent,'getdraftid':this.onGetDraftId,'show':this.onShowWindow,'beforedestroy':this.onBeforeDestroy}});this.callParent(arguments);Ext.Direct.on('exception',this.onAppException,this);App.Favorites.on('change',this.onFavoritesChange,this);this.doLoad();},onBeforeDestroy:function(){Ext.Direct.un('exception',this.onAppException,this);App.Favorites.un('change',this.onFavoritesChange,this);},initActions:function(){this.actions={edit:new Ext.Action({text:L.Edit,iconCls:'i-edit-obj',hidden:true,scope:this,handler:this.onEditClick}),save:new Ext.Action({text:L.Save,iconCls:'icon-save',hidden:true,scope:this,handler:this.onSaveClick}),cancel:new Ext.Action({text:L.Cancel,iconCls:'i-cancel',hidden:true,scope:this,handler:this.close}),'delete':new Ext.Action({text:L.Delete,scope:this,disabled:!Ext.isNumeric(this.data.id),handler:this.onDeleteClick}),refresh:new Ext.Action({iconCls:'i-refresh',scope:this,handler:this.onRefreshClick}),rename:new Ext.Action({text:L.Rename,scope:this,handler:this.onRenameClick}),star:new Ext.Action({iconCls:'i-star',qtip:L.Star,itemId:'star',hidden:true,scope:this,handler:this.onStarClick}),unstar:new Ext.Action({iconCls:'i-unstar',qtip:L.Unstar,itemId:'unstar',hidden:true,scope:this,handler:this.onUnstarClick}),showInfoPanel:new Ext.Action({iconCls:'i-info',enableToggle:true,pressed:true,scope:this,handler:this.onShowInfoPanelClick}),permalink:new Ext.Action({text:L.Permalink,itemId:'permalink',scope:this,handler:this.onPermalinkClick}),notifyOn:new Ext.Action({text:L.NotifyOn,hidden:true,iconCls:'im-watch',itemId:'notifyOn',scope:this,handler:this.onSubscriptionButtonClick}),notifyOff:new Ext.Action({text:L.NotifyOff,hidden:true,iconCls:'im-ignore',itemId:'notifyOff',scope:this,handler:this.onSubscriptionButtonClick})};},getToolbarButtons:function(){if(this.templateType=='time_tracking'){return[this.actions.edit,this.actions.save,this.actions.cancel,'->',new Ext.Button({qtip:L.More,itemId:'more',arrowVisible:false,iconCls:'i-points',menu:[this.actions['delete']]})];}
return[this.actions.edit,this.actions.save,this.actions.cancel,'->',this.actions.star,this.actions.unstar,this.actions.refresh,new Ext.Button({qtip:L.More,itemId:'more',arrowVisible:false,iconCls:'i-points',menu:[this.actions['delete'],this.actions.rename,this.actions.permalink,'-',this.actions.notifyOn,this.actions.notifyOff]}),this.actions.showInfoPanel];},initContainerItems:function(){this.titleContainer=Ext.create({xtype:'panel',border:false,autoHeight:true,items:[]});this.complexFieldContainer=Ext.create({xtype:'form',border:false,autoHeight:true,scrollable:false,labelAlign:'top',cls:'complex-fieldcontainer',bodyStyle:'margin: 0; padding: 0',api:{submit:CB_Objects.save},items:[]});this.gridContainer=Ext.create('CB.object.plugin.ObjectProperties',{border:false,autoHeight:true,items:[]});this.gridContainer.params=this.data;this.gridContainer.onItemChange=Ext.Function.createSequence(this.gridContainer.onItemChange,Ext.Function.bind(this.loadPreviewData,this),this.gridContainer);this.pluginsContainer=Ext.create({xtype:'CBObjectProperties',api:CB_Objects.getPluginsData,border:false,autoHeight:true,scrollable:false,listeners:{scope:this,loaded:this.onPluginsContainerLoaded}});this.on('timespentclick',this.onTimeSpentClick,this);this.on('addtimespentclick',this.onAddTimeSpentClick,this);},getLayoutItems:function(){var rez=[{region:'center',scrollable:true,border:false,layout:{type:'vbox',align:'stretch'},items:[this.titleContainer,this.gridContainer,this.complexFieldContainer,{itemId:'infoPanel',border:false,bodyStyle:'padding-top: 15px',autoHeight:true,items:[this.pluginsContainer]}]}];this.actions.showInfoPanel.setHidden(true);if((this.templateCfg.layout==='horizontal')||(this.templateType==='file')){this.complexFieldContainer.flex=1;this.complexFieldContainer.layout='fit';this.actions.showInfoPanel.setHidden(false);rez=[{region:'center',border:false,bodyStyle:'border-bottom:0; border-left: 0',scrollable:false,layout:{type:'vbox',align:'stretch'},items:[this.titleContainer,this.complexFieldContainer]},{region:'east',itemId:'infoPanel',header:false,border:false,scrollable:true,layout:{type:'vbox',align:'stretch'},split:{size:2},width:300,items:[,this.gridContainer,this.pluginsContainer]}];}
return rez;},onShowWindow:function(c){this.getEl().focus(10);},onAfterRender:function(c){var map=new Ext.KeyMap(c.getEl(),[{key:'s',ctrl:true,shift:false,stopEvent:true,scope:this,fn:this.onSaveObjectEvent}]);if(this.grid){new Ext.util.KeyMap({target:this.grid.getView().getEl(),binding:[{key:'s',ctrl:true,shift:false,stopEvent:true,scope:this,fn:this.onSaveObjectEvent},{key:Ext.EventObject.ESC,ctrl:false,shift:false,scope:this,stopEvent:true,fn:this.close}]});}},clearContainers:function(){this.complexFieldContainer.removeAll(true);this.complexFieldContainer.update('');this.gridContainer.removeAll(false);this.gridContainer.update('');},doLoad:function(){this.clearContainers();this['load'+Ext.util.Format.capitalize(this.viewMode)+'Data']();},loadPreviewData:function(){if(this.templateType=='time_tracking'){return;}
CB_Objects.getPluginsData({id:this.data.id},this.processLoadPreviewData,this);},loadEditData:function(){var data=this.data;if(isNaN(data.id)){if(Ext.isEmpty(data.name)){data.name=L.New+' '+CB.DB.templates.getName(data.template_id);}
this.processLoadEditData({success:true,data:data});}else{CB_Objects.load({id:this.data.id},this.processLoadEditData,this);}
this.pluginsContainer.doLoad({id:this.data.id,template_id:this.data.template_id,from:'window'});},processLoadPreviewData:function(r,e){if(!r||(r.success!==true)){return;}
var objProperties=Ext.valueFrom(r.data.objectProperties,{}).data,preview=Ext.valueFrom(objProperties,{}).preview;if(preview){delete objProperties.preview;}
this.data=Ext.apply(Ext.valueFrom(this.data,{}),objProperties);this.data.from='window';this.titleView.update(this.data);delete r.data.objectProperties;delete r.data.thumb;if(preview){if(this.gridContainer.rendered){this.gridContainer.update(preview[0]);}else{this.gridContainer.html=preview[0];}
var cfp=Ext.valueFrom(preview[1],'');if(this.complexFieldContainer.rendered){this.complexFieldContainer.update(cfp);}else{this.complexFieldContainer.html=cfp;}}else{this.gridContainer.hide();if(this.complexFieldContainer.rendered){this.complexFieldContainer.update('');}else{this.complexFieldContainer.html='';}}
this.pluginsContainer.loadedParams=this.data;this.pluginsContainer.onLoadData(r,e);this.postLoadProcess();},processLoadEditData:function(r,e){if(!r||(r.success!==true)){return;}
this.data=r.data;if(Ext.isEmpty(this.data.data)){this.data.data={};}
this.titleView.update(this.data);r.data.from='window';this.pluginsContainer.loadedParams=r.data;this.objectsStore.proxy.extraParams={id:r.data.id,template_id:r.data.template_id,data:r.data.data};if(Ext.isEmpty(this.initialConfig.data.comment)){this.startEditAfterObjectsStoreLoadIfNewObject=true;}
this.objectsStore.reload();var gridType=(this.templateType==='search')?'CBVerticalSearchEditGrid':'CBVerticalEditGrid';if(this.lastgGridType!=gridType){this.gridContainer.removeAll(true);this.grid=Ext.create(gridType,{title:L.Details,autoHeight:true,hidden:true,refOwner:this,includeTopFields:true,stateId:'oevg',autoExpandColumn:'value',scrollable:false,viewConfig:{forceFit:true,autoFill:true},listeners:{scope:this,savescroll:this.saveScroll,restorescroll:this.restoreScroll}});this.lastgGridType=gridType;}
this.gridContainer.add(this.grid);this.gridContainer.show();if(!this.objectsStore.isLoaded()){this.grid.addCls('loading');}
this.grid.hideTemplateFields=r.hideTemplateFields;this.grid.reload();if(this.grid.store.getCount()>0){this.grid.show();if(this.grid.rendered){this.grid.getView().refresh(true);}}
this.updateComplexFieldContainer();this._isDirty=false;this.postLoadProcess();},updateComplexFieldContainer:function(){if(this.grid.templateStore){var fields=[];this.grid.templateStore.each(function(r){if(r.get('cfg').showIn==='tabsheet'){var cfg={border:false,isTemplateField:true,name:r.get('name'),value:this.data.data[r.get('name')],height:Ext.valueFrom(r.get('cfg').height,200),anchor:'100%',grow:true,title:r.get('title'),fieldLabel:r.get('title'),labelAlign:'top',labelCls:'fwB ttU',labelSeparator:'',listeners:{scope:this,change:function(field,newValue,oldValue){this.fireEvent('change',field.name,newValue,oldValue);},sync:function(){this.fireEvent('change');}},xtype:(r.get('type')==='html')?'CBHtmlEditor':'textarea'};this.complexFieldContainer.add(cfg);}},this);}
this.complexFieldContainer.setVisible(this.complexFieldContainer.items.getCount()>0);},postLoadProcess:function(){if(!this.hasLayout&&this.updateLayout){this.updateLayout();}
this.updateWindowTitle();this.updateButtons();if(this.gridContainer.rendered){this.gridContainer.attachEvents();}
this.fireEvent('loaded',this);},updateWindowTitle:function(){var templatesStore=CB.DB.templates,templateId=this.data.template_id,d=this.data,title=Ext.valueFrom(d.name,d.title);if(Ext.isEmpty(title)){title=L.New+' '+templatesStore.getProperty(templateId,'name');}
this.setTitle(Ext.String.htmlEncode(title));this.setIconCls(getItemIcon(this.data));},updateButtons:function(){if(this.viewMode==='preview'){this.actions.edit.show();this.actions.save.hide();this.actions.cancel.hide();this.actions.rename.show();}else{this.actions.edit.hide();this.actions.save.show();this.actions.cancel.show();this.actions.rename.hide();}
this.onFavoritesChange();},onChange:function(fieldName,newValue,oldValue){this._isDirty=true;if(!Ext.isEmpty(fieldName)&&Ext.isString(fieldName)){this.fireEvent('fieldchange',fieldName,newValue,oldValue);}
this.fireEvent('changed',this);},onLoaded:function(editForm){var title=Ext.valueFrom(editForm.data.name,'');this.setTitle(Ext.util.Format.htmlEncode(title));this.setIconCls(getItemIcon(editForm.data));this.updateLayout();},onPluginsContainerLoaded:function(cmp,commonParams){var icd=this.initialConfig.data;if(!Ext.isEmpty(icd.comment)){cmp.setCommentValue(icd.comment);var cc=cmp.getCommentComponent();if(cc){var i=this.items.getAt(0);if(!i.scrollable){i=this.items.getAt(1);}
cc.getEl().scrollIntoView(i.body,false,false,true);i.body.scrollBy(0,40,false);cc.focus(false,100);}}
var subscription=Ext.valueFrom(commonParams.subscription,'ignore');this.actions.notifyOn.setHidden(subscription==='watch');this.actions.notifyOff.setHidden(subscription==='ignore');},onSubscriptionButtonClick:function(b,e){var type=(b.itemId==='notifyOn')?'watch':'ignore';CB_Objects.setSubscription({objectId:this.data.id,type:type},function(r,e){if(!r||(r.success!==true)){return;}
this.actions.notifyOn.setHidden(type==='watch');this.actions.notifyOff.setHidden(type==='ignore');},this);},onNotificationsCustomizeClick:function(b,e){var w=new CB.notifications.SettingsWindow();w.show();},onSaveObjectEvent:function(objComp,ev){ev.stopEvent();if(this.actions.save.isDisabled()){return false;}
this.onSaveClick();},onEditClick:function(b,e){this.viewMode='edit';this.doLoad();},onSaveClick:function(b,e){if(!this.isValid()){var i=this.items.getAt(0),g=this.grid,v=g.getView();if(!i.scrollable){i=this.items.getAt(1);}
Ext.get(v.getRow(g.invalidRecord)).scrollIntoView(i.body,null,false);return this.grid.focusInvalidRecord();}
if(!this._isDirty){return this.close();}
this.readValues();this.getEl().mask(L.Saving+' ...','x-mask-loading');this.saving=true;this.complexFieldContainer.getForm().submit({clientValidation:true,loadMask:false,params:{data:Ext.encode(this.data)},scope:this,success:this.processSave,failure:this.processSave});},processSave:function(form,action){this.getEl().unmask();delete this.saving;var r=action.result;if(!r||(r.success!==true)){App.showException(r);}else{this._isDirty=false;App.fireEvent('objectchanged',r.data,this);this.close();}},onAppException:function(){if(this.saving){delete this.saving;this.getEl().unmask();}},onObjectsStoreLoad:function(store,records,options){this.onObjectsStoreChange(store,records,options);if(!this.grid.editing){this.grid.getView().refresh();if(this.startEditAfterObjectsStoreLoadIfNewObject===true){this.focusDefaultCell();}}
this.grid.removeCls('loading');},onObjectsStoreChange:function(store,records,options){Ext.each(records,function(r){r.set('iconCls',getItemIcon(r.data));},this);},focusDefaultCell:function(){if(this.grid&&!this.grid.editing&&this.grid.getEl()&&(this.grid.store.getCount()>0)){var valueCol=this.grid.headerCt.child('[dataIndex="value"]');var colIdx=valueCol.getIndex();this.grid.getSelectionModel().select({row:0,column:colIdx});this.grid.getNavigationModel().setPosition(0,colIdx);if(this.startEditAfterObjectsStoreLoadIfNewObject&&isNaN(this.data.id)){this.grid.editingPlugin.startEditByPosition({row:0,column:colIdx});}
delete this.startEditAfterObjectsStoreLoadIfNewObject;}},readValues:function(){this.grid.readValues();this.data.data=Ext.apply(this.data.data,this.complexFieldContainer.getForm().getFieldValues());return this.data;},setFieldValue:function(fieldName,value){if(this.grid){this.grid.setFieldValue(fieldName,value);}},onBeforeClose:function(){if(this._confirmedClosing||!this._isDirty){return true;}
if(this.isValid()){Ext.Msg.show({title:L.Confirmation,msg:L.SavingChangedDataMessage,icon:Ext.Msg.QUESTION,buttons:Ext.Msg.YESNOCANCEL,scope:this,fn:function(b,text,opt){switch(b){case'yes':this._confirmedClosing=true;this.onSaveClick();break;case'no':this._confirmedClosing=true;this.close();break;}}}).getEl().center(this);}else{Ext.Msg.show({title:L.Confirmation,msg:L.CloseWithChangesConfirmation,icon:Ext.Msg.QUESTION,buttons:Ext.Msg.YESNO,scope:this,fn:function(b,text,opt){switch(b){case'yes':this._confirmedClosing=true;this.close();break;}}}).getEl().center(this);}
return false;},onRefreshClick:function(b,e){this.doLoad();},onShowInfoPanelClick:function(b,e){var ip=this.queryById('infoPanel');if(ip){ip.setVisible(b.pressed);}},onOpenPreviewEvent:function(data,e){if(Ext.isEmpty(data)){data=Ext.clone(this.data);}
if(this.data&&(data.id==this.data.id)){Ext.applyIf(data,this.data);}
App.openObjectWindow(Ext.clone(data),e);},onEditObjectEvent:function(data,e){if(e){e.stopEvent();}
if(Ext.isEmpty(data)){data=this.data;}
var p=Ext.clone(data);p.view='edit';if(p.id==this.data.id){this.viewMode='edit';this.doLoad();}else{App.openObjectWindow(p);}},onDeleteClick:function(b,e){this.getEl().mask(L.Processing+' ...','x-mask-loading');CB.browser.Actions.deleteSelection([this.data],this.processDelete,this);},processDelete:function(r,e){this.getEl().unmask();if(r&&(r.success===true)){this._confirmedClosing=true;this.close();}},saveScroll:function(){var gc=this.gridContainer.ownerCt;this.lastScroll=gc.body.getScroll();return this.lastScroll;},restoreScroll:function(){var gc=this.gridContainer.ownerCt;gc.body.setScrollLeft(this.lastScroll.left);gc.body.setScrollTop(this.lastScroll.top);},onGetDraftId:function(callback,scope){delete this.getDraftIdCallback;if(Ext.isEmpty(callback)){callback=Ext.emptyFn;}
this.getDraftIdCallback=scope?Ext.Function.bind(callback,scope):callback;if(!isNaN(this.data.id)){this.getDraftIdCallback(this.data.id);}else{this.readValues();var data=Ext.apply({},this.data);data.draft=true;CB_Objects.create(data,this.processSaveDraft,this);}},processSaveDraft:function(r,e){if(!r||(r.success!==true)){return;}
var id=r.data.id;this.data.id=id;this.data.pid=r.data.pid;this.pluginsContainer.loadedParams={id:id,template_id:this.data.template_id,from:'window'};this.getDraftIdCallback(id,e);},onFileUploadEvent:function(p,e){this.uploadFieldData={pid:this.data.id};if(isNaN(this.uploadFieldData.pid)){this.onGetDraftId(function(id,e){this.uploadFieldData.pid=id;},this);}
App.mainViewPort.onFileUpload(this.uploadFieldData,e);},isValid:function(){var rez=true;if(this.grid&&this.grid.isValid){rez=this.grid.isValid();}
return rez;},onRenameClick:function(b,e){var d=this.data,data={path:d.id,name:Ext.util.Format.htmlDecode(d.name),scope:this,callback:function(r,e){this.data.name=r.data.newName;this.updateWindowTitle();this.titleView.update(this.data);}};App.promptRename(data);},onPermalinkClick:function(b,e){window.prompt('Copy to clipboard: Ctrl+C, Enter',window.location.origin+'/'+App.config.coreName+'/view/'+this.data.id+'/');},onStarClick:function(b,e){var ld=this.data,d={id:ld.id,name:ld.name,iconCls:ld.iconCls,path:'/'+ld.pids+'/'+ld.id,pathText:ld.path};App.Favorites.setStarred(d);},onUnstarClick:function(b,e){App.Favorites.setUnstarred(this.data.id);},onFavoritesChange:function(){var isStarred=App.Favorites.isStarred(this.data.id);this.actions.star.setHidden(isStarred);this.actions.unstar.setHidden(!isStarred);},onTimeSpentClick:function(cmp){clog('onTimeSpentClick!');this.pluginsContainer.onTimeSpentClick(cmp);},onAddTimeSpentClick:function(cmp,e){clog('onAddTimeSpentClick!');this.pluginsContainer.onAddTimeSpentClick(cmp,e);}});;Ext.namespace('CB.object.widget');Ext.define('CB.object.TitleView',{extend:'Ext.DataView',initComponent:function(){this.tpl=new Ext.XTemplate('<tpl for=".">','<div class="obj-header"><b class="{titleCls}">{[ Ext.String.htmlEncode(Ext.valueFrom(values.name, \'\')) ]}</b> &nbsp;','{[ this.getStatusInfo(values) ]}','<div class="path fs12">','{[ this.getPath(values) ]}','</div>','<div class="info">','{[ this.getTitleInfo(values) ]}','</div>','</div>','</tpl>',{getStatusInfo:this.getStatusInfo,getPath:this.getPath,getTitleInfo:this.getTitleInfo});Ext.apply(this,{autoHeight:true,cls:'obj-plugin-title',itemSelector:'.none',data:Ext.valueFrom(this.config.data,{}),listeners:{scope:this,containerclick:this.onContainerClick}});this.callParent(arguments);},getStatusInfo:function(values){if(Ext.isEmpty(values.status)){return'';}
var rez='<div class="dIB fs12 '+Ext.valueFrom(values.statusCls,'')+'"">'+
values.status+'</div>';return rez;},getPath:function(values){if(Ext.isEmpty(values.path)){return'';}
var rez='<a class="click" title="'+values.path+'">'+
App.shortenStringLeft(values.path,50)+'</a>';return rez;},getTitleInfo:function(values){var rez=[];if(values.id){rez.push('#'+values.id);}
rez.push(CB.DB.templates.getName(values.template_id));if(values.cid){rez.push(L.CreatedBy+' <a class="click">'+CB.DB.usersStore.getName(values.cid)+'</a> '+
Ext.valueFrom(values.cdate_ago_text,''));}
if(values.uid){rez.push(L.UpdatedBy+' <a class="click">'+CB.DB.usersStore.getName(values.uid)+'</a> '+
Ext.valueFrom(values.udate_ago_text,''));}
return rez.join(' &#8226; ');},onContainerClick:function(view,e,eOpts){if(e){var el=e.getTarget('.path');if(el){App.openPath(this.data.pids);}}}});;Ext.namespace('CB');Ext.define('CB.object.ViewContainer',{extend:'Ext.Panel',border:false,layout:'card',activeItem:0,constructor:function(){Ext.apply(this,{loadedData:{}});this.callParent(arguments);},initComponent:function(){this.initButtons();Ext.apply(this,{tbar:new Ext.Toolbar({border:false,style:'background: #ffffff',defaults:{scale:'medium'},items:[this.BC.get('edit'),this.BC.get('fitImage'),this.BC.get('download'),this.BC.get('completetask'),'->',this.BC.get('preview'),this.BC.get('star'),this.BC.get('unstar'),this.BC.get('more'),'-',this.BC.get('openExternal'),this.BC.get('close')]}),defaults:{border:false,header:false},items:[{xtype:'CBObjectProperties',api:CB_Objects.getPluginsData,listeners:{scope:this,openpreview:this.onOpenPreviewEvent,editobject:this.onEditObjectEvent,editmeta:this.onEditObjectEvent,loaded:this.onPluginsContainerLoaded}},{xtype:'CBObjectPreview',listeners:{scope:this,loaded:this.onCardItemLoaded}}],listeners:{scope:this,show:this.onShowEvent,lockpanel:this.onLockPanelEvent,beforedestroy:this.onBeforeDestroy}});this.callParent(arguments);this.topToolbar=this.dockedItems.getAt(0);this.delayedLoadTask=new Ext.util.DelayedTask(this.doLoad,this);this.enableBubble(['changeparams','filedownload','createobject']);App.mainViewPort.on('objectsdeleted',this.onObjectsDeleted,this);App.on('objectchanged',this.onObjectChanged,this);App.on('objectsaction',this.onObjectsAction,this);App.Favorites.on('change',this.onFavoritesChange,this);},initActions:function(){this.actions={edit:new Ext.Action({iconCls:'im-edit-obj',itemId:'edit',text:L.Edit,disabled:true,scale:'medium',scope:this,handler:this.onEditClick}),download:new Ext.Action({text:L.Download,itemId:'download',iconCls:'im-download',hidden:true,scale:'medium',scope:this,handler:this.onDownloadClick}),fitImage:new Ext.Action({iconCls:'im-fit',itemId:'fitImage',hidden:true,enableToggle:true,pressed:true,scale:'medium',scope:this,handler:this.onFitImageClick}),completeTask:new Ext.Action({iconCls:'im-task-complete',itemId:'completetask',text:L.Done,hidden:true,scale:'medium',scope:this,handler:this.onCompleteTaskClick}),preview:new Ext.Action({iconCls:'im-preview',itemId:'preview',enableToggle:true,qtip:L.Preview,hidden:true,scale:'medium',scope:this,handler:this.onPreviewClick}),openExternal:new Ext.Action({iconCls:'im-external',itemId:'openExternal',scale:'medium',hidden:true,scope:this,handler:this.onOpenExternalClick}),close:new Ext.Action({iconCls:'im-cancel',itemId:'close',scale:'medium',scope:this,handler:this.onCloseClick}),star:new Ext.Action({iconCls:'i-star',qtip:L.Star,itemId:'star',scale:'medium',hidden:true,scope:this,handler:this.onStarClick}),unstar:new Ext.Action({iconCls:'i-unstar',qtip:L.Unstar,itemId:'unstar',scale:'medium',hidden:true,scope:this,handler:this.onUnstarClick}),notifyOn:new Ext.Action({text:L.NotifyOn,iconCls:'im-watch',itemId:'notifyOn',scope:this,handler:this.onSubscriptionButtonClick}),notifyOff:new Ext.Action({text:L.NotifyOff,iconCls:'im-ignore',itemId:'notifyOff',scope:this,handler:this.onSubscriptionButtonClick})};},initButtons:function(){this.initActions();this.menuItemConfigs={reload:{iconCls:'i-refresh',itemId:'reload',text:L.Refresh,scope:this,handler:this.onReloadClick},completetask:{iconCls:'im-task-complete',itemId:'completetask',scale:'medium',text:L.Done,scope:this,handler:this.onCompleteTaskClick},closetask:{text:L.ClosingTask,itemId:'closetask',scope:this,handler:this.onCloseTaskClick},reopentask:{text:L.ReopeningTask,itemId:'reopentask',scope:this,handler:this.onReopenTaskClick},rename:{itemId:'rename',text:L.Rename,scope:this,handler:this.onRenameClick},permissions:{itemId:'permissions',text:L.Permissions,scope:this,handler:this.onPermissionsClick},webdavlink:{text:L.WebDAVLink,itemId:'webdavlink',scope:this,handler:this.onWebDAVLinkClick},permalink:{text:L.Permalink,itemId:'permalink',scope:this,handler:this.onPermalinkClick},'setOwner':{text:L.SetOwner,itemId:'setOwner',menu:getMenuUserItems(this.onSetOwnershipClick,this)},'new':{text:L.New,itemId:'newItem',name:'newmenu',menu:[]}};this.BC=new Ext.util.MixedCollection();this.BC.addAll([new Ext.Button(this.actions.edit),new Ext.Button(this.actions.download),new Ext.Button(this.actions.close),new Ext.Button(this.actions.openExternal),new Ext.Button(this.actions.fitImage),new Ext.Button(this.actions.completeTask),new Ext.Button(this.actions.star),new Ext.Button(this.actions.unstar),new Ext.Button(this.actions.preview),new Ext.Button({itemId:'more',arrowVisible:false,iconCls:'im-points',scale:'medium',menu:[]})]);},onShowEvent:function(c){if(this.lastLoadData){this.load(this.lastLoadData);}},onBeforeDestroy:function(c){App.mainViewPort.un('objectsdeleted',this.onObjectsDeleted,this);App.un('objectchanged',this.onObjectChanged,this);App.un('objectsaction',this.onObjectsAction,this);},setActiveView:function(index,autoLoad){var currentItemIndex=this.items.indexOf(this.getLayout().activeItem);if(currentItemIndex==index){return;}
this.clear();this.getLayout().setActiveItem(index);this.onViewChange();if(autoLoad!==false){this.load(this.requestedLoadData);}},onViewChange:function(){var d=this.loadedData;this.actions.edit.setDisabled(isNaN(d.id)||Ext.isEmpty(d.id));this.BC.get('preview').toggle(this.loadedData.viewIndex==1,false);},clear:function(){this.delayedLoadTask.cancel();delete this.locked;delete this.requestedLoadData;this.previousLoadedData=Ext.clone(this.loadedData);this.loadedData={};this.getLayout().activeItem.clear();this.updateToolbarAndMenuItems();},load:function(objectData){var el=this.getLayout().activeItem.getEl();if(!el||!el.isVisible(true)){this.lastLoadData=objectData;return;}
delete this.lastLoadData;if(this.locked){delete this.requestedLoadData;return;}
if(!isNaN(objectData)){objectData={id:objectData};}
if(Ext.isEmpty(objectData)||Ext.isEmpty(objectData.id)||isNaN(objectData.id)){this.clear();return;}
var ai=this.getLayout().activeItem;var cvi=this.items.indexOf(ai);if(Ext.isEmpty(this.requestedLoadData)){if(!objectData.force){if(this.loadedData&&objectData&&(objectData.id==this.loadedData.id)&&(Ext.valueFrom(objectData.viewIndex,cvi)==Ext.valueFrom(this.loadedData.viewIndex,cvi))){return;}}
if(!Ext.isEmpty(ai.body)){this.loadedData.scroll=ai.body.getScroll();}}else{if((objectData.id==this.requestedLoadData.id)&&(Ext.valueFrom(objectData.viewIndex,cvi)==Ext.valueFrom(this.requestedLoadData.viewIndex,cvi))){return;}}
this.clear();this.requestedLoadData=Ext.apply({},objectData);if(this.previousLoadedData&&(CB.DB.templates.getType(this.requestedLoadData.template_id)!=CB.DB.templates.getType(this.previousLoadedData.template_id))){this.setActiveView(0);}
this.delayedLoadTask.delay(3,this.doLoad,this);},doLoad:function(){if(this.locked){delete this.requestedLoadData;return;}
var id=this.requestedLoadData?Ext.valueFrom(this.requestedLoadData.nid,this.requestedLoadData.id):null,params=Ext.apply({id:id},this.requestedLoadData);delete this.requestedLoadData;if(Ext.isDefined(params.viewIndex)){this.setActiveView(params.viewIndex,false);}
var activeItem=this.getLayout().activeItem;params.viewIndex=this.items.indexOf(activeItem);this.loadedData=params;switch(activeItem.getXType()){case'CBObjectPreview':this.topToolbar.setVisible(!Ext.isEmpty(id));this.doLayout();activeItem.params=params;activeItem.loadPreview(id);break;case'CBObjectProperties':case'CBEditObject':activeItem.load(this.loadedData);break;}
this.onViewChange();},onPluginsContainerLoaded:function(cmp,params){this.loadedData.subscription=params.subscription;this.onCardItemLoaded(cmp);},onCardItemLoaded:function(item){this.locked=false;this.updateToolbarAndMenuItems();this.fireEvent('loaded',this,item);if(Ext.isEmpty(this.loadedData)||Ext.isEmpty(this.loadedData.scroll)){return;}
if(item.body){item.body.scrollTo('left',this.loadedData.scroll.left);item.body.scrollTo('top',this.loadedData.scroll.top);}},updateToolbarAndMenuItems:function(){var ai=this.getLayout().activeItem;if(this.menu){this.menu.removeAll(true);this.menu.destroy();}
this.menu=new Ext.menu.Menu({items:[]});this.BC.get('more').setMenu(this.menu,true);this.topToolbar.items.each(function(i){if((['close'].indexOf(i.itemId)<0)&&(['tbfill','tbseparator'].indexOf(i.getXType())<0)){i.hide();}});if(!Ext.isNumeric(this.loadedData.id)){return;}
var ti=ai.getContainerToolbarItems();if(Ext.isEmpty(ti)){return;}
ti.menu['notifyOn']={addDivider:'top'};ti.menu['notifyOff']={};var isFirstItem=true;Ext.iterate(ti.menu,function(k,v,o){if(k==='-'){this.menu.add('-');}else{var b=(this.menuItemConfigs[k])?Ext.clone(this.menuItemConfigs[k]):this.actions[k];if(b){if((!isFirstItem)&&(v.addDivider==='top')){this.menu.add('-');}
this.menu.add(b);isFirstItem=false;}}},this);if(this.menu.items.getCount()>0){ti.tbar['more']={};}
ti.tbar.star={};ti.tbar.unstar={};var subscription=Ext.valueFrom(this.loadedData.subscription,'ignore');this.actions.notifyOn.setHidden(subscription==='watch');this.actions.notifyOff.setHidden(subscription==='ignore');Ext.iterate(ti.tbar,function(k,v,o){var b=this.BC.get(k);if(b){if(b.baseAction){b.baseAction.show();}else{b.show();}}},this);this.onFavoritesChange();this.updateCreateMenu();},updateCreateMenu:function(){if(!this.menu){return;}
var nmb=this.menu.child('[name="newmenu"]');if(nmb){updateMenu(nmb,this.getLayout().activeItem.createMenu,this.onCreateObjectClick,this);nmb.setDisabled(nmb.menu.items.getCount()<1);}},edit:function(objectData,e){objectData.view='edit';this.openObjectWindow(objectData);},openObjectWindow:function(objectData){var data=Ext.apply({},objectData);delete data.html;App.openObjectWindow(data);},onEditClick:function(b,e){var p=Ext.apply({},this.loadedData);switch(detectFileEditor(p.name)){case'webdav':App.openWebdavDocument(p);break;default:p.comment=this.getCommentValue();this.setCommentValue('');this.edit(p,e);break;}},onReloadClick:function(b,e){this.getLayout().activeItem.reload();},onRenameClick:function(b,e){var data={path:this.loadedData.id,name:Ext.util.Format.htmlDecode(this.loadedData.name),scope:this,callback:function(r,e){this.loadedData.name=r.data.newName;}};App.promptRename(data);},onPermissionsClick:function(b,e){App.mainViewPort.openPermissions(this.loadedData.id);},onObjectsDeleted:function(ids,e){if(!Ext.isEmpty(this.loadedData)&&setsHaveIntersection(ids,this.loadedData.id)){this.setActiveView(0,false);this.clear();}},onFitImageClick:function(b,e){var ai=this.getLayout().activeItem;if(ai.onFitImageClick){ai.onFitImageClick(b,e);}},onPreviewClick:function(b,e){var p=Ext.clone(this.loadedData);p.viewIndex=b.pressed?1:0;this.delayedLoadTask.cancel();this.requestedLoadData=p;this.doLoad();},onOpenExternalClick:function(b,e){var d=Ext.apply({},this.loadedData);d.comment=this.getCommentValue();this.setCommentValue('');this.openObjectWindow(d);},onOpenPreviewEvent:function(data,e){if(Ext.isEmpty(data)){data=this.loadedData;}
if(this.loadedData&&(data.id==this.loadedData.id)){Ext.applyIf(data,this.loadedData);}
App.openObjectWindow(Ext.clone(data),e);},onEditObjectEvent:function(data,e){if(e){e.stopEvent();}
if(Ext.isEmpty(data)){data=this.loadedData;}
var p=Ext.clone(data);this.edit(p,e);},onDownloadClick:function(b,e){this.fireEvent('filedownload',[this.loadedData.id],false,e);},onCreateObjectClick:function(b,e){this.goBackOnSave=true;var d=b.config.data;d.pid=this.loadedData.id;d.path=this.loadedData.path;this.fireEvent('createobject',d,e);},onCloseTaskClick:function(b,e){this.getEl().mask(L.CompletingTask+' ...','x-mask-loading');CB_Tasks.close(this.loadedData.id,this.onTaskChanged,this);},onReopenTaskClick:function(b,e){this.getEl().mask(L.ReopeningTask+' ...','x-mask-loading');CB_Tasks.reopen(this.loadedData.id,this.onTaskChanged,this);},onCompleteTaskClick:function(b,e){CB_Tasks.complete({id:this.loadedData.id,message:''},this.onTaskChanged,this);},onTaskChanged:function(r,e){this.getEl().unmask();App.fireEvent('objectchanged',this.loadedData,this);},onSubscriptionButtonClick:function(b,e){var type=(b.itemId==='notifyOn')?'watch':'ignore';CB_Objects.setSubscription({objectId:this.loadedData.id,type:type},function(r,e){if(!r||(r.success!==true)){return;}
this.actions.notifyOn.setHidden(type==='watch');this.actions.notifyOff.setHidden(type==='ignore');},this);},onWebDAVLinkClick:function(b,e){App.openWebdavDocument(this.loadedData,false);},onPermalinkClick:function(b,e){window.prompt('Copy to clipboard: Ctrl+C, Enter',window.location.origin+'/c/'+App.config.coreName+'/view/'+this.loadedData.id+'/');},onLockPanelEvent:function(status){this.locked=status;},setSelectedVersion:function(params){var ai=this.getLayout().activeItem;if(ai.isXType('CBObjectProperties')){ai.setSelectedVersion(params);}},onObjectsAction:function(action,r,e){if(this.loadedData.id==r.targetId){this.onReloadClick();}},onObjectChanged:function(data,component){if(!isNaN(data)){data={id:data};}
if(!Ext.isEmpty(data.isNew)&&(data.type!=='time_tracking')){this.requestedLoadData=data;this.doLoad();return;}
if(!Ext.isEmpty(this.loadedData)){if((data.pid==this.loadedData.id)||(data.id==this.loadedData.id)){this.onReloadClick();}}},onCloseClick:function(){this.collapse();},onSetOwnershipClick:function(b,e){if(!Ext.isEmpty(this.loadedData.id)){CB_Objects.setOwnership({ids:this.loadedData.id,userId:b.userId},this.processSetOwnership,this);}},processSetOwnership:function(r,e){if(r&&r.success){App.fireEvent('objectchanged',this.loadedData,this);}},onStarClick:function(b,e){var ld=this.loadedData,d={id:ld.id,name:ld.name,iconCls:ld.iconCls,path:'/'+ld.pids+'/'+ld.id,pathText:ld.path};App.Favorites.setStarred(d);},onUnstarClick:function(b,e){App.Favorites.setUnstarred(this.loadedData.id);},onFavoritesChange:function(){if(this.loadedData){var isStarred=App.Favorites.isStarred(this.loadedData.id);this.actions.star.setHidden(isStarred);this.actions.unstar.setHidden(!isStarred);}}});CB.object.ViewContainer.borrow(CB.object.view.Properties,['getCommentComponent','getCommentValue','setCommentValue']);;Ext.namespace('CB');Ext.define('CB.search.edit.Panel',{extend:'CB.object.edit.Form',xtype:'CBSearchPanel',hideTitle:true,initComponent:function(){this.actions={search:new Ext.Action({text:L.Search,iconCls:'im-search',itemId:'search',scale:'medium',tooltip:L.Search,scope:this,handler:this.onSearchClick}),tune:new Ext.Action({iconCls:'im-tune',itemId:'tune',scale:'medium',qtip:L.Tune,scope:this,enableToggle:true,handler:this.onTuneClick}),clear:new Ext.Action({iconCls:'im-refresh',itemId:'clear',scale:'medium',qtip:L.Clear,scope:this,handler:this.onClearClick}),save:new Ext.Action({iconCls:'is-tick',itemId:'save',scale:'medium',text:L.Save,disabled:true,scope:this,handler:this.onSaveClick})};this.moreMenu=new Ext.menu.Menu({items:[new Ext.menu.Item(this.actions.save)]});Ext.apply(this,{tbar:[this.actions.search,'->',this.actions.tune,this.actions.clear,{iconCls:'im-points',itemId:'more',scale:'medium',scope:this,handler:function(b,e){this.moreMenu.showBy(b.getEl());}}]});this.on('change',function(){this.actions.save.enable();},this);this.on('clear',function(){this.actions.save.disable();},this);this.enableBubble(['changeparams']);this.callParent(arguments);},onSearchClick:function(){var p=Ext.copyTo({},this.data,'id,template_id');p.data=Ext.apply({},this.readValues().data);var browser=App.activateBrowserTab();browser.changeSomeParams({query:'',search:p,userViewChange:false,forceLoad:true});},processLoadData:function(r,e){if(isNaN(r.data.id)){r.data.name=L.Search+' '+CB.DB.templates.getName(r.data.template_id);}
this.callParent(arguments);},onTuneClick:function(b,e){this.grid.headerCt.child('[dataIndex="cond"]').setHidden(!b.pressed);},onClearClick:function(b,e){var data={template_id:this.data.template_id};this.clear();this.loadData(data);},onSaveClick:Ext.emptyFn});;Ext.namespace('CB');Ext.define('CB.search.edit.Window',{extend:'Ext.Window',alias:'CBSearchEditWindow',xtype:'CBSearchEditWindow',closable:true,minimizable:true,maximizable:true,layout:'fit',border:false,minWidth:200,minHeight:200,width:400,height:450,iconCls:'icon-none',scrollable:true,initComponent:function(){this.data=Ext.apply({},this.config.data);Ext.apply(this,{cls:'x-panel-white',bodyStyle:'border: 0',items:[{xtype:'CBSearchPanel',hideTitle:true,scrollable:true,listeners:{scope:this,loaded:this.onLoaded}}],listeners:{scope:this,'afterrender':this.onAfterRender}});this.callParent(arguments);this.editForm=this.items.getAt(0);},onAfterRender:function(){this.editForm.load(this.data);},onLoaded:function(editForm){var title=Ext.valueFrom(editForm.data.name,'');this.setTitle(Ext.util.Format.htmlEncode(title));this.setIconCls(getItemIcon(editForm.data));this.updateLayout();},onSaveObjectEvent:function(objComp,ev){ev.stopPropagation();ev.preventDefault();if(this.actions.save.isDisabled()){return false;}
this.onSaveClick();},onSaveClick:function(){this.editForm.save(function(component,form,action){var r=action.result;if(!r||(r.success!==true)){App.showException(r);}else{this.actions.save.setDisabled(true);this.close();}},this);},onIconChange:function(f,newIconCls,oldIconCls,eOpts){this.setIconCls(newIconCls);},onBeforeClose:function(){if(this._confirmedClosing||!this.editForm._isDirty){return true;}
Ext.Msg.show({title:L.Confirmation,msg:L.SavingChangedDataMessage,icon:Ext.Msg.QUESTION,buttons:Ext.Msg.YESNOCANCEL,scope:this,fn:function(b,text,opt){switch(b){case'yes':this._confirmedClosing=true;this.editForm.save(this.close,this);break;case'no':this._confirmedClosing=true;this.close();break;}}}).getEl().center(this);return false;}});;Ext.ns('CB');Ext.define('CB.search.Field',{extend:'Ext.form.field.Text',xtype:'CBSearchField',alias:'widget.CBSearchField',emptyText:L.Search,enableKeyEvents:true,style:'background-color: #fff',triggers:{clear:{cls:'x-form-clear-trigger',hidden:true,scope:'this',handler:'onTrigger1Click'},search:{cls:'x-form-search-trigger',scope:'this',handler:'onTrigger2Click'}},initComponent:function(){Ext.apply(this,{listeners:{scope:this,keyup:function(ed,e){if(Ext.isEmpty(this.getValue())){this.triggers.clear.hide();}else{this.triggers.clear.show();}},specialkey:function(ed,e){switch(e.getKey()){case e.ESC:this.onTrigger1Click(e);break;case e.ENTER:this.onTrigger2Click(e);break;}}}});this.callParent(arguments);},afterRender:function(){this.callParent(arguments);},setValue:function(value){this.callParent(arguments);if(Ext.isEmpty(value)){this.triggers.clear.hide();}else{this.triggers.clear.show();}},onTrigger1Click:function(e){if(Ext.isEmpty(this.getValue())){return;}
this.setValue('');this.triggers.clear.hide();this.fireEvent('search','',e);},onTrigger2Click:function(e){this.fireEvent('search',this.getValue(),this,e);},clear:function(){this.setValue('');this.triggers.clear.hide();}});;Ext.namespace('CB.object.plugin');Ext.define('CB.object.plugin.Base',{extend:'Ext.Panel',border:false,header:false,cls:'obj-plugin',initComponent:function(){this.prepareToolbar();this.enableBubble(['openproperties','createobject','objectopen']);this.callParent(arguments);},onLoadData:function(r,e){if(Ext.isEmpty(r.data)){return;}},getLoadedObjectProperties:function(){var pluginsPanel=this.up('panel');return pluginsPanel?pluginsPanel.loadedData:{};},prepareToolbar:function(){if(Ext.isEmpty(this.title)&&Ext.isEmpty(this.actions)){return;}
var tbarItems=[];if(!Ext.isEmpty(this.title)){tbarItems.push({xtype:'label',cls:'title',text:this.title});}
var items=this.getToolbarItems();if(!Ext.isEmpty(items)){tbarItems.push('->');for(var i=0;i<items.length;i++){tbarItems.push(items[i]);}}
this.tbar=tbarItems;},getToolbarItems:function(){return[];},setTitle:function(title){if(this.dockedItems){var tbar=this.dockedItems.items[0],label=tbar.items.get(0);label.setText(title);}else{this.callParent(arguments);}},getContainerToolbarItems:function(){return{};},openObjectProperties:function(data){App.openObjectWindow(data);}});;Ext.namespace('CB.object.plugin');Ext.define('CB.object.plugin.Thumb',{extend:'CB.object.plugin.Base',alias:'CBObjectPluginThumb',initComponent:function(){var tpl=new Ext.XTemplate('<tpl for=".">','<div style="width: 100%; text-align: center; margin: 30px 0">','{[ Ext.isEmpty(values.html) ? "<img class=\\"click preview-thumb " + values.cls + "\\" src=\\"'+Ext.BLANK_IMAGE_URL+'\\" alt=\\"'+L.Preview+'\\" />" : values.html ]}','</div>','</tpl>');this.dataView=new Ext.DataView({tpl:tpl,autoHeight:true,itemSelector:'div',data:[],listeners:{scope:this,itemclick:this.onThumbClick,viewready:this.onViewReady}});Ext.apply(this,{cls:'',items:this.dataView});this.callParent(arguments);this.enableBubble(['openpreview']);},onLoadData:function(r,e){if(this.rendered){this.dataView.update(r.data);this.updateLayout({defer:true});}else{this.dataView.data=r.data;}},onViewReady:function(cmp,eOpts){var images=this.getEl().query('img');if(Ext.isEmpty(images)){return;}
for(var i=images.length-1;i>=0;i--){images[i].onload=Ext.Function.bind(this.updateLayout,this);images[i].onclick=Ext.Function.bind(this.onThumbClick,this);}},onThumbClick:function(e){var te=Ext.get(e.target);if(!te){return;}
if(te.hasCls('click')){this.fireEvent('openpreview',this.params,e);}}});;Ext.namespace('CB.object.plugin');Ext.define('CB.object.plugin.Comments',{extend:'CB.object.plugin.Base',alias:'CBObjectPluginComments',commentFieldConfig:{xtype:'CBFieldComment'},initComponent:function(config){this.actions={edit:new Ext.Action({text:L.Edit,scope:this,handler:this.onEditClick}),remove:new Ext.Action({text:L.Delete,iconCls:'i-trash',scope:this,handler:this.onRemoveClick})};var tpl=new Ext.XTemplate('<table class="block-plugin" style="margin:0">','<div class="load-more click">'+L.MoreCommentsHint,'  <span class="fr cG">{[this.totalText]}</span>','</div>','<tpl for=".">','<tr>','    <td class="obj">','        <img class="i32" src="'+App.config.photoPath+'{cid}.jpg?32={[ CB.DB.usersStore.getPhotoParam(values.cid) ]}" title="{user}">','    </td>','    <td class="comment">','      <div class="comment-text">','        <tpl if="cid == App.loginData.id">','          <span class="i-bullet-arrow-down comment-actions-button">&nbsp;</span>','        </tpl>','        <b class="user">{[ values.user.split("\\n")[0]]}</b>','        {[ Ext.util.Format.nl2br(values.content)]}','      </div>','      <div title="'+L.ShowAll+'" class="show-all click"></div>','      {[values.files ? "<div>" + values.files + "</div>" : "" ]}','      <div class="gr" title="{[ displayDateTime(values.cdate) ]}">{cdate_text}</div>','    </td>','</tr>','</tpl>','</table>');this.dataView=new Ext.DataView({tpl:tpl,store:Ext.create('Ext.data.JsonStore',{fields:[{name:'id',type:'int'},{name:'pid',type:'int'},{name:'template_id',type:'int'},{name:'cid',type:'int'},'user','cdate','cdate_text','content'],proxy:{type:'memory',reader:{type:'json'}}}),region:'center',deferInitialRefresh:true,itemSelector:'tr',listeners:{scope:this,itemclick:this.onItemClick,containerclick:this.onContainerClick,resize:this.onDataViewResize}});var cfg=Ext.apply(this.commentFieldConfig,{params:this.params,listeners:{scope:this,addcomment:this.onAddCommentClick}});this.addCommentLink=Ext.create({xtype:'component',autoEl:{tag:'div',html:L.AddComment,cls:'fwB click icon-padding i-chat-bubble cG'},margin:'3 10 3 10',border:false,listeners:{scope:this,afterrender:function(c,eOpts){c.getEl().on('click',this.onAddCommentLinkClick,this);}}});this.addCommentField=Ext.create(cfg);if(this.initialConfig.header!==false){this.title=L.Comments;}
Ext.apply(this,{cls:'obj-plugin block-plugin-comments',autoHeight:true,anchor:'100%',border:false,bodyStyle:'padding-top: 3px',items:[this.dataView]});if(this.initialConfig.showAddLabel){this.items.push(this.addCommentLink);}else{this.items.push(this.addCommentField);}
this.callParent(arguments);this.enableBubble(['getdraftid']);},onLoadData:function(r,e){this.loadedData=r;if(r.total>r.data.length){this.addCls('have-more-items');}else{this.removeCls('have-more-items');}
this.dataView.tpl.totalText=r.data.length+' '+L.of+' '+r.total;this.dataView.store.loadData(r.data);this.attachElementsEvents();Ext.defer(this.onDataViewResize,1500,this);},attachElementsEvents:function(){var el=this.getEl();if(el){var lm=el.down('div.load-more');if(lm&&!lm.hasListener('click')){lm.on('click',this.onLoadMoreClick,this);}}},onLoadMoreClick:function(e){var params={id:this.params.id};if(this.loadedData&&!Ext.isEmpty(this.loadedData.data)){params.beforeId=this.loadedData.data[0].id;}
CB_Objects_Plugins_Comments.loadMore(params,this.processLoadMore,this);},processLoadMore:function(r,e){if(!r||(r.success!==true)){App.showException(r);return;}
if(Ext.isEmpty(r.data)){return;}
if(Ext.isEmpty(this.loadedData.data)){this.loadedData.data=[];}
this.loadedData.data=r.data.concat(this.loadedData.data);var panel=this.up('panel'),scrollable=false,scrollPosition;while(!scrollable&&panel){scrollable=panel.getScrollable();panel=panel.up('panel');}
if(scrollable){scrollPosition=scrollable.getPosition();}
this.onLoadData(this.loadedData,e);if(scrollable){scrollable.scrollTo(scrollPosition);}},onGetDraftIdCallback:function(draftId){if(isNaN(draftId)){return;}
this.params.id=draftId;this.onAddCommentClick();},onAddCommentClick:function(comment,e){if(isNaN(this.params.id)){this.fireEvent('getdraftid',this.onGetDraftIdCallback,this);return;}
var msg=this.addCommentField.getValue().trim();if(Ext.isEmpty(msg)){return Ext.Msg.alert(L.Error,L.SpecifyComment);}
this.addCommentField.disable();var p={id:this.params.id,msg:msg};if(this.addCommentField.draftCommentId){p.draftId=this.addCommentField.draftCommentId;}
CB_Objects.addComment(p,this.onAddCommentProcess,this);},onAddCommentProcess:function(r,e){this.addCommentField.enable();if(!r||(r.success!==true)){Ext.Msg.alert(L.Error,L.AddCommentError);return;}else{if(Ext.isEmpty(this.loadedData.data)){this.loadedData.data=[];}
this.loadedData.data.push(r.data);this.onLoadData(this.loadedData);this.addCommentField.reset();}},onItemClick:function(dataView,record,item,index,e,eOpts){var el=e.getTarget('.comment-actions-button');if(el){e.stopEvent();this.showActionsMenu(e);return;}
el=e.getTarget('.obj-ref');if(el){e.stopEvent();var name=el.attributes.title?el.attributes.title.value:el.innerText;this.openObjectProperties({id:el.attributes.itemid.value,template_id:el.attributes.templateid.value,name:name});return;}
el=e.getTarget('.show-all');if(el){e.stopEvent();this.onShowAllClick(record,item,index);return;}},onContainerClick:function(view,e,eOpts){var el=e.getTarget('.load-more');if(el){el=Ext.get(el);if(!el.hasListener('click')){e.stopEvent();this.onLoadMoreClick(e);}}},showActionsMenu:function(e){if(!this.actionsMenu){this.actionsMenu=Ext.create('Ext.menu.Menu',{items:[this.actions.edit,this.actions.remove]});}
this.actionsMenu.showAt(e.getXY());Ext.defer(this.actionsMenu.show,10,this.actionsMenu);},onEditClick:function(b,e){var rec=this.dataView.getSelection()[0];if(!rec||(rec.get('cid')!=App.loginData.id)){return;}
CB_Objects.load({id:rec.get('id')},this.processEditComment,this);},processEditComment:function(r,e){if(!r||(r.success!==true)){return;}
var value=(r.data.data&&r.data.data['_title'])?r.data.data['_title']:r.data.name;this.editingCommentId=r.data.id;var ed=new CB.TextEditWindow({data:{value:value,callback:this.onSubmitEditedComment,scope:this}});ed.show();},onSubmitEditedComment:function(editor,value){CB_Objects.updateComment({id:this.editingCommentId,text:value},this.onEditCommentProcess,this);delete this.editingCommentId;},onEditCommentProcess:function(r,e){if(!r||(r.success!==true)){return;}
var rec=this.dataView.store.findRecord('id',r.data.id,0,false,false,true);if(rec){if(Ext.isArray(this.loadedData.data)){var item=Ext.Array.findBy(this.loadedData.data,function(i){return(i.id==rec.data.id);},this);if(item){item.content=r.data.content;}}
rec.set('content',r.data.content);this.dataView.refresh();Ext.defer(this.onDataViewResize,1500,this);}},onRemoveClick:function(b,e){var rec=this.dataView.getSelection()[0];if(!rec||(rec.get('cid')!=App.loginData.id)){return;}
CB_Objects.removeComment({id:rec.get('id')},this.processRemoveComment,this);},processRemoveComment:function(r,e){if(!r||(r.success!==true)){return;}
var rec=this.dataView.getSelection()[0];if(rec){if(Ext.isArray(this.loadedData.data)){var item=Ext.Array.findBy(this.loadedData.data,function(i){return(i.id==rec.data.id);},this);if(item){Ext.Array.remove(this.loadedData.data,item);}}
this.dataView.store.remove(rec);}},onShowAllClick:function(record,item,index){item.children[1].setAttribute('class','comment comment-expanded');this.updateLayout();},onDataViewResize:function(view,width,height,oldWidth,oldHeight,eOpts){var dv=this.dataView,store=dv.store,el=dv.getEl();if(Ext.isEmpty(el)){return;}
var divs=dv.getEl().query('td.comment');for(var i=0;i<divs.length;i++){var txtDiv=divs[i].children[0];if(txtDiv.clientHeight<txtDiv.scrollHeight){divs[i].setAttribute('class','comment comment-big');}}
this.updateLayout();},onAddCommentLinkClick:function(){this.remove(this.addCommentLink);this.add(this.addCommentField);this.addCommentField.reset();}});;Ext.namespace('CB.object.plugin');Ext.define('CB.object.plugin.ContentItems',{extend:'CB.object.plugin.Base',alias:'CBObjectPluginContentItems',initComponent:function(){this.actions={add:new Ext.Action({iconCls:'i-plus',scope:this,handler:this.onAddClick}),permalink:new Ext.Action({text:L.Permalink,itemId:'permalink',scope:this,handler:this.onPermalinkClick})};var tpl=new Ext.XTemplate('<table class="block-plugin">','<tpl for=".">','<tr class="{[ (xindex > this.displayLimit) ? \'more\' : ""]}">','    <td class="obj">','        <img class="i16u {iconCls}" src="'+Ext.BLANK_IMAGE_URL+'">','    </td>','    <td>','        <span class="click">{name}</span><br />','        <span class="gr" title="{[ displayDateTime(values.cdate) ]}">{user}, {ago_text}</span>','    </td>','    <td class="elips">','        <span class="click menu"></span>','    </td>','</tr>','</tpl>','</table>','<tpl if="this.itemCount &gt; this.displayLimit">','<div class="toggle taC"><u class="click">'+L.ShowAll+'</u></div>','</tpl>');this.store=new Ext.data.JsonStore({autoDestroy:true,model:'ContentItem',proxy:new Ext.data.MemoryProxy()});this.dataView=new Ext.DataView({tpl:tpl,store:this.store,autoHeight:true,cls:'limited-list',itemSelector:'tr',listeners:{scope:this,itemclick:this.onItemClick,containerclick:this.onContainerClick}});Ext.apply(this,{title:L.Contents,items:this.dataView,listeners:{scope:this,beforedestroy:this.onBeforeDestroy}});this.callParent(arguments);App.mainViewPort.on('objectsdeleted',this.onObjectsDeleted,this);},onBeforeDestroy:function(c){App.mainViewPort.un('objectsdeleted',this.onObjectsDeleted,this);},onObjectsDeleted:function(ids){this.store.deleteIds(ids);},onLoadData:function(r,e){if(!Ext.isEmpty(r.data)){for(var i=0;i<r.data.length;i++){r.data[i].iconCls=getItemIcon(r.data[i]);}
this.store.loadData(r.data);}
this.dataView.tpl.displayLimit=Ext.valueFrom(r.limit,5);this.dataView.tpl.itemCount=this.store.getCount();if(!Ext.isEmpty(r.title)){this.params.title=r.title;this.updateTitle(r.title);}
if(!Ext.isEmpty(r.menu)){this.createMenu=r.menu;}},updateTitle:function(title){if(!title&&this.params){title=this.params.title;}
if(!Ext.isEmpty(title)){var count=this.store.getCount(),total=(count>0)?'('+count+')':'';title=title.replace('({total})',total);this.setTitle(title);}
return title;},onItemClick:function(cmp,record,item,index,e,eOpts){var te=Ext.get(e.getTarget());if(!te){return;}
if(te.hasCls('menu')){this.clickedItemData=this.store.getAt(index).data;this.showActionsMenu(e.getXY());}else if(te.hasCls('click')){this.openObjectProperties(this.store.getAt(index).data);}},onContainerClick:function(view,e,eOpts){var el=e.getTarget('.toggle');if(el){this.addCls('list-expanded');this.updateLayout();}},showActionsMenu:function(coord){if(Ext.isEmpty(this.puMenu)){this.puMenu=new Ext.menu.Menu({items:[{text:L.Open,scope:this,handler:this.onOpenClick},'-',{text:L.Delete,iconCls:'i-trash',scope:this,handler:this.onDeleteItemClick},this.actions.permalink]});}
this.puMenu.showAt(coord);},onDeleteItemClick:function(b,e){App.mainViewPort.onDeleteObject(this.clickedItemData);},onOpenClick:function(b,e){this.openObjectProperties(this.clickedItemData);},getToolbarItems:function(){return[this.actions.add];},onAddClick:function(b,e){if(this.pmenu){this.pmenu.destroy();}
this.pmenu=new Ext.menu.Menu({items:[]});updateMenu({menu:this.pmenu},this.createMenu,this.onCreateObjectClick,this);this.pmenu.showBy(b.getEl());},onCreateObjectClick:function(b,e){var d=b.config.data;d.pid=this.params.id;d.path=this.params.path;this.fireEvent('createobject',d,e);},onPermalinkClick:function(b,e){window.prompt('Copy to clipboard: Ctrl+C, Enter',window.location.origin+'/c/'+App.config.coreName+'/view/'+this.clickedItemData.id+'/');}});;Ext.namespace('CB.object.plugin');Ext.define('CB.object.plugin.Files',{extend:'CB.object.plugin.Base',alias:'CBObjectPluginFiles',xtype:'CBObjectPluginFiles',cls:'obj-plugin',initComponent:function(){this.actions={add:new Ext.Action({iconCls:'i-plus',scope:this,handler:this.onAddClick}),rename:new Ext.Action({itemId:'rename',text:L.Rename,scope:this,handler:this.onRenameClick}),webdavlink:new Ext.Action({text:L.WebDAVLink,itemId:'webdavlink',scope:this,handler:this.onWebDAVLinkClick}),permalink:new Ext.Action({text:L.Permalink,itemId:'permalink',scope:this,handler:this.onPermalinkClick})};var tpl=new Ext.XTemplate('<table class="block-plugin">','<tpl for=".">','<tr>','    <td class="obj">','        <div><img class="file- {iconCls}" src="'+Ext.BLANK_IMAGE_URL+'"></div>','    </td>','    <td>','        <span class="click">{name}</span><br />','        <span class="gr" title="{[ displayDateTime(values.cdate) ]}">{[ App.customRenderers.filesize(values.size) ]}, {ago_text}</span>','    </td>','    <td class="elips">','        <span class="click menu"></span>','    </td>','</tr>','</tpl>','</table>');this.store=new Ext.data.JsonStore({autoDestroy:true,model:'ContentItem',proxy:new Ext.data.MemoryProxy(),data:[]});this.dataView=new Ext.DataView({tpl:tpl,store:this.store,autoHeight:true,itemSelector:'tr',listeners:{scope:this,itemclick:this.onItemClick}});this.dropPanel=new Ext.Panel({border:false,padding:0,hidden:true,html:'',listeners:{scope:this,afterrender:function(p){var el=this.getEl();el.on('click',this.onDropPanelClick,this);var ddp=new CB.DD.Panel(el,{enableDrop:true,defaultAction:'shortcut'});ddp.onNodeDrop=Ext.Function.createInterceptor(ddp.onNodeDrop,function(){Ext.apply(this.params,this.getLoadedObjectProperties());this.hideDropPanel();},this);ddp.init(this);}}});Ext.apply(this,{title:L.Files,items:[this.dataView,this.dropPanel],listeners:{scope:this,beforedestroy:this.onBeforeDestroy}});this.callParent(arguments);this.enableBubble(['fileupload','lockpanel']);this.dropZoneConfig={pidPropety:'id',dropZoneEl:this.dropPanel.getEl()};this.filesDropPlugin=new CB.plugin.dd.FilesDropZone({pidPropety:'id'});this.filesDropPlugin.init(this);App.mainViewPort.on('objectsdeleted',this.onObjectsDeleted,this);},onBeforeDestroy:function(c){App.mainViewPort.un('objectsdeleted',this.onObjectsDeleted,this);},onObjectsDeleted:function(ids){this.store.deleteIds(ids);},onLoadData:function(r,e){var dropZoneHtml=L.DropZoneMsg;if(this.params&&(this.params.from==='window')){this.dropPanel.show();this.actions.add.setHidden(true);}else{dropZoneHtml+=' <span class="i-cross click close" style="float: right; display: inline-block; height: 16px; width: 16px;"></span>';}
dropZoneHtml='<div class="files-drop">'+dropZoneHtml+'</div>';if(this.dropPanel.rendered){this.dropPanel.update(dropZoneHtml);}else{this.dropPanel.html=dropZoneHtml;}
if(!Ext.isEmpty(r.data)){for(var i=0;i<r.data.length;i++){r.data[i].iconCls=getItemIcon(r.data[i]);}
this.store.loadData(r.data);}},onItemClick:function(cmp,record,item,index,e,eOpts){var te=Ext.get(e.getTarget());if(!te){return;}
if(te.hasCls('menu')){this.clickedItemData=this.store.getAt(index).data;this.showActionsMenu(e.getXY());}else if(te.hasCls('click')){this.openObjectProperties(this.store.getAt(index).data);}},showActionsMenu:function(coord){if(Ext.isEmpty(this.puMenu)){this.puMenu=new Ext.menu.Menu({items:[{text:L.Open,scope:this,handler:this.onOpenClick},{text:L.Download,scope:this,handler:this.onDownloadClick},'-',{text:L.Cut,scope:this,handler:this.onCutItemClick},{text:L.Copy,scope:this,handler:this.onCopyItemClick},{text:L.Delete,iconCls:'i-trash',scope:this,handler:this.onDeleteItemClick},this.actions.rename,this.actions.permalink,this.actions.webdavlink]});}
this.actions.webdavlink.setHidden(detectFileEditor(this.clickedItemData.name)!=='webdav');this.puMenu.showAt(coord);Ext.defer(this.puMenu.show,10,this.puMenu);},onDownloadClick:function(b,e){App.downloadFile(this.clickedItemData.id);},onCutItemClick:function(b,e){App.clipboard.set([this.clickedItemData],'move');},onCopyItemClick:function(b,e){App.clipboard.set([this.clickedItemData],'copy');},onDeleteItemClick:function(b,e){App.mainViewPort.onDeleteObject(this.clickedItemData);},onOpenClick:function(b,e){this.openObjectProperties(this.clickedItemData);},getToolbarItems:function(){return[this.actions.add];},getContainerToolbarItems:function(){var rez={tbar:{},menu:{}};return rez;},onAddClick:function(b,e){this.lockPanel(true);this.dropPanel.show();},onDropPanelClick:function(ev,el){var te=ev.getTarget();if(Ext.isEmpty(te)){return;}
te=Ext.get(te);if(te.hasCls('close')){this.hideDropPanel();}
if(te.hasCls('upload')){this.fireEvent('fileupload',{pid:Ext.valueFrom(this.params.id,this.params.path)},ev);this.hideDropPanel();}},hideDropPanel:function(){if(Ext.isEmpty(this.params)||(this.params.from!=='window')){this.dropPanel.hide();this.lockPanel(false);}},lockPanel:function(status){this.fireEvent('lockpanel',status,this);},getProperty:function(propertyName){return this.params[propertyName];},onRenameClick:function(b,e){var d=this.clickedItemData,data={path:d.id,name:Ext.util.Format.htmlDecode(d.name)};App.promptRename(data);},onWebDAVLinkClick:function(b,e){App.openWebdavDocument(this.clickedItemData,false);},onPermalinkClick:function(b,e){window.prompt('Copy to clipboard: Ctrl+C, Enter',window.location.origin+'/c/'+App.config.coreName+'/view/'+this.clickedItemData.id+'/');}});;Ext.namespace('CB.object.plugin');Ext.define('CB.object.plugin.Html',{extend:'CB.object.plugin.Base',alias:'CBObjectPluginHtml',title:'Html',onLoadData:function(r,e){if(!Ext.isEmpty(r.data)){this.update(r.data);}
this.setTitle(Ext.valueFrom(r.title),this.title);}});;Ext.namespace('CB.object.plugin');Ext.define('CB.object.plugin.ObjectProperties',{extend:'CB.object.plugin.Base',alias:'CBObjectPluginObjectProperties',initComponent:function(){Ext.apply(this,{html:'',cls:'',bodyStyle:'margin-bottom: 30px',listeners:{scope:this,afterrender:this.attachEvents}});this.callParent(arguments);this.enableBubble(['timespentclick','addtimespentclick']);},onLoadData:function(r,e){if(Ext.isEmpty(r.data)){return;}
Ext.apply(this.params,r.data);var html=Ext.isArray(r.data.preview)?r.data.preview.join(' '):r.data.preview[0];if(this.rendered){this.update(html);}else{this.html=html;}},attachEvents:function(){var a=this.getEl().query('a.click');Ext.each(a,function(t){Ext.get(t).addListener('click',function(ev,el){el=Ext.get(el);if(el){if(el.hasCls('link-type-grid')){App.openPath(el.getAttribute('path'));}}},this);},this);a=this.getEl().query('a.obj-ref');Ext.each(a,function(t){Ext.get(t).addListener('click',function(ev,el){this.openObjectProperties({id:el.attributes.itemid.value,template_id:el.attributes.templateid.value});},this);},this);a=this.getEl().query('a.path');Ext.each(a,function(t){Ext.get(t).addListener('click',function(ev,el){App.locateObject(this.params.id,el.attributes.getNamedItem('path').value);},this);},this);a=this.getEl().query('a.item-action');Ext.each(a,function(t){Ext.get(t).addListener('click',this.onItemActionClick,this);},this);a=this.getEl().query('span.time-spent');Ext.each(a,function(t){Ext.get(t).addListener('click',this.onTimeSpentClick,this);},this);a=this.getEl().query('a.add-time-spent');Ext.each(a,function(t){Ext.get(t).addListener('click',this.onAddTimeSpentClick,this);},this);},onTimeSpentClick:function(b,e){this.fireEvent('timespentclick',this);},onAddTimeSpentClick:function(e){this.fireEvent('addtimespentclick',this,e);},onItemActionClick:function(ev,el){var action='onAction'
+Ext.String.capitalize(el.attributes.getNamedItem('action').value)
+'Click';if(this[action]){this[action](ev,el);}},onActionCloseClick:function(ev,el){this.getEl().mask(L.CompletingTask+' ...','x-mask-loading');CB_Tasks.close(this.params.id,this.onItemChange,this);},onActionReopenClick:function(ev,el){this.getEl().mask(L.ReopeningTask+' ...','x-mask-loading');CB_Tasks.reopen(this.params.id,this.onItemChange,this);},onActionCompleteClick:function(ev,el){CB_Tasks.complete({id:this.params.id,message:''},this.onItemChange,this);},onActionMarkcompleteClick:function(ev,el){this.forUserId=el.attributes.getNamedItem('uid').value;CB_Tasks.setUserStatus({id:this.params.id,user_id:this.forUserId,status:1,message:''},this.onItemChange,this);},onActionMarkincompleteClick:function(ev,el){this.forUserId=el.attributes.getNamedItem('uid').value;CB_Tasks.setUserStatus({id:this.params.id,user_id:this.forUserId,status:0,message:''},this.onItemChange,this);},onActionUpdateSolrDataClick:function(ev,el){CB_Templates.updateSolrData(this.params.id,this.onItemChange,this);},onItemChange:function(r,e){this.getEl().unmask();App.fireEvent('objectchanged',this.params,this);},getContainerToolbarItems:function(){var rez={tbar:{},menu:{}};return rez;}});;Ext.namespace('CB.object.plugin');Ext.define('CB.object.plugin.SystemProperties',{extend:'CB.object.plugin.Base',alias:'CBObjectPluginSystemProperties',initComponent:function(){var tpl=new Ext.XTemplate('<tpl for=".">','<table class="item-props">','<tbody><tr><td class="k">Id</td><td>{id}</td></tr>','<tr><td class="k">'+L.Path+'</td><td><a class="click path">{path}</a></td></tr>','{[ Ext.isEmpty(values.size) ?\'\' : \'<tr><td class="k">\' + L.Size + \'</td><td>\' + App.customRenderers.filesize(values.size) + \'</td></tr>\']}','<tr><td class="k">'+L.Template+'</td><td>{template_name} <span class="dttm">(id: {template_id})</span></td></tr>','<tr><td class="k">'+L.Created+'</td><td>{cid_text}<br><span class="dttm" title="{[ displayDateTime(values.cdate) ]}">{cdate_ago_text}</span></td></tr>','<tr><td class="k">'+L.Modified+'</td><td>{uid_text}<br><span class="dttm" title="{[ displayDateTime(values.udate) ]}">{udate_ago_text}</span></td></tr>','{[ Ext.isEmpty(values.did_text) ?\'\' : \'<tr><td class="k">\' + L.Deleted + \'</td><td>\' + values.did_text + \'<br><span class="dttm" title="\' + displayDateTime(values.ddate) + \'">\' + values.ddate_text + \'</span></td></tr>\']}','</tbody></table>','</tpl>');this.dataView=new Ext.DataView({tpl:tpl,data:[],autoHeight:true,itemSelector:'tr',listeners:{scope:this,afterrender:this.attachEvents}});Ext.apply(this,{title:L.Properties,items:this.dataView});this.callParent(arguments);},onLoadData:function(r,e){if(Ext.isEmpty(r.data)){return;}
this.data=r.data;if(this.rendered){this.dataView.apply(r.data);}else{this.dataView.data=r.data;}},attachEvents:function(){var a=this.getEl().query('a.path');Ext.each(a,function(t){Ext.get(t).addListener('click',this.onPathClick,this);},this);},onPathClick:function(ev,el){App.openPath(this.params.path);},getContainerToolbarItems:function(){var rez={tbar:{},menu:{}};if(this.params){if(CB.DB.templates.getType(this.params.template_id)==='file'){rez.menu['metadata']={order:17};rez.menu['webdavlink']={order:18};rez.menu['permalink']={order:19};}}
return rez;}});;Ext.namespace('CB.object.plugin');Ext.define('CB.object.plugin.Meta',{extend:'CB.object.plugin.ObjectProperties',alias:'CBObjectPluginMeta',title:L.Metadata,initComponent:function(){this.actions={edit:new Ext.Action({text:L.Edit,iconCls:'i-edit',scope:this,handler:this.onEditClick})};this.menu=new Ext.menu.Menu({items:[this.actions.edit]});this.prepareToolbar();this.callParent(arguments);Ext.apply(this,{border:false,cls:'obj-plugin'});this.enableBubble(['editmeta']);},getToolbarItems:function(){return[{iconCls:'i-points',scope:this,handler:this.showMenu}];},onEditClick:function(b,e){this.fireEvent('editmeta',this.params,e);},showMenu:function(b,e){this.menu.showBy(b.getEl());}});;Ext.namespace('CB.object.plugin');Ext.define('CB.object.plugin.Tasks',{extend:'CB.object.plugin.Base',alias:'CBObjectPluginTasks',initComponent:function(){this.actions={add:new Ext.Action({iconCls:'i-plus',scope:this,handler:this.onAddClick})};var tpl=new Ext.XTemplate('<table class="block-plugin">','<tpl for=".">','<tr>','    <td class="obj">','        <img class="i32" src="'+App.config.photoPath+'{cid}.jpg?32={[ CB.DB.usersStore.getPhotoParam(values.cid) ]}" title="{user}">','    </td>','    <td>','        <span class="click">{name}</span><br />','        <span class="gr" title="{[ displayDateTime(values.cdate) ]}">{ago_text}</span>','    </td>','    <td class="elips">','        <span class="click menu"></span>','    </td>','</tr>','</tpl>','</table>');this.store=new Ext.data.JsonStore({autoDestroy:true,model:'ContentItem',proxy:new Ext.data.MemoryProxy()});this.dataView=new Ext.DataView({tpl:tpl,store:this.store,autoHeight:true,itemSelector:'tr',listeners:{scope:this,itemclick:this.onItemClick}});Ext.apply(this,{title:L.Tasks,items:this.dataView});this.callParent(arguments);this.enableBubble(['createobject']);},onLoadData:function(r,e){if(Ext.isEmpty(r.data)){return;}
this.store.loadData(r.data);},onItemClick:function(cmp,record,item,index,e,eOpts){var te=Ext.get(e.getTarget());if(!te){return;}
if(te.hasCls('menu')){this.showActionsMenu(e.getXY());}else if(te.hasCls('click')){this.openObjectProperties(this.store.getAt(index).data);}},showActionsMenu:function(coord){if(Ext.isEmpty(this.puMenu)){this.puMenu=new Ext.menu.Menu({items:[{text:L.Close},{text:L.Delete,iconCls:'i-trash'}]});}
this.puMenu.showAt(coord);},getToolbarItems:function(){return[this.actions.add];},getContainerToolbarItems:function(){var rez={tbar:{},menu:{}};if(this.params){rez['menu']['addtask']={order:10};if(CB.DB.templates.getType(this.params.template_id)!=='file'){rez['menu']['new']={order:11};}}
return rez;},onAddClick:function(b,e){this.fireEvent('createobject',{template_id:App.config.default_task_template},e);}});;Ext.namespace('CB.object.plugin');Ext.define('CB.object.plugin.Versions',{extend:'CB.object.plugin.Base',alias:'CBObjectPluginVersions',initComponent:function(){this.actions={restore:new Ext.Action({text:L.Restore,scope:this,handler:this.onRestoreClick})};this.store=new Ext.data.JsonStore({autoDestroy:true,model:'ContentItem',proxy:new Ext.data.MemoryProxy()});this.dataView=new Ext.DataView({tpl:this.getTemplate(),store:this.store,autoHeight:true,itemSelector:'tr',listeners:{scope:this,itemclick:this.onItemClick}});Ext.apply(this,{title:Ext.valueFrom(this.title,L.VersionsHistory),items:[this.dataView]});this.callParent(arguments);this.enableBubble(['openversion']);},getTemplate:function(){return new Ext.XTemplate('<table class="block-plugin versions">','<tpl for=".">','<tr class="{cls}">','    <td class="obj">','        <div><img class="i32" src="'+App.config.photoPath+'{cid}.jpg{[ CB.DB.usersStore.getPhotoParam(values.cid) ]}" title="{user}"></div>','    </td>','    <td>','        <span class="click">{name}</span><br />','        <span class="gr" title="{[ displayDateTime(values.cdate) ]}">{[ App.customRenderers.filesize(values.size) ]}, {ago_text}</span>','    </td>','    <td class="elips">','        <span class="click menu"></span>','    </td>','</tr>','</tpl>','</table>');},onLoadData:function(r,e){if(Ext.isEmpty(r.data)){return;}
for(var i=0;i<r.data.length;i++){r.data[i].iconCls=getItemIcon(r.data[i]);}
this.store.loadData(r.data);},onItemClick:function(cmp,record,item,index,e,eOpts){var te=Ext.get(e.getTarget());if(!te){return;}
if(te.hasCls('menu')){this.selectedRecord=this.store.getAt(index);this.showActionsMenu(e.getXY());}else if(te.hasCls('click')){this.fireEvent('openversion',this.store.getAt(index).data,this);}},showActionsMenu:function(coord){if(Ext.isEmpty(this.puMenu)){this.puMenu=new Ext.menu.Menu({items:[this.actions.restore]});}
this.puMenu.showAt(coord);},onRestoreClick:function(b,e){CB_Files.restoreVersion(this.selectedRecord.get('id'),function(r,e){App.fireEvent('objectchanged',r.data,this);},this);},setSelectedVersion:function(params){this.store.each(function(r){r.set('cls',(r.get('id')==params.versionId)?'sel':'');},this);}});;Ext.namespace('CB.object.plugin');Ext.define('CB.object.plugin.CurrentVersion',{extend:'CB.object.plugin.Versions',alias:'CBObjectPluginCurrentVersion',initComponent:function(){Ext.apply(this,{title:L.CurrentVersion});this.callParent(arguments);},getTemplate:function(){return new Ext.XTemplate('<table class="block-plugin versions">','<tpl for=".">','<tr class="{cls}">','    <td class="obj">','        <div><img class="i32" src="'+App.config.photoPath+'{[this.getUserId(values)]}.jpg?32={[this.getUserName(values)]}" title="{user}"></div>','    </td>','    <td>','        <span class="click">{name}</span><br />','        <span class="gr" title="{[this.getDate(values)]}">{[ App.customRenderers.filesize(values.size) ]}, {ago_text}</span>','    </td>','</tr>','</tpl>','</table>',{getUserId:function(values){return Ext.valueFrom(values.uid,values.cid);},getUserName:function(values){return CB.DB.usersStore.getPhotoParam(this.getUserId(values));},getDate:function(values){return Ext.valueFrom(values.udate,values.cdate);}});},onItemClick:function(cmp,record,item,index,e,eOpts){var te=Ext.get(e.getTarget());if(!te){return;}
if(te.hasCls('click')){this.fireEvent('openversion',{id:null},this);}},setSelectedVersion:function(params){this.store.each(function(r){r.set('cls',Ext.isEmpty(params.versionId)?'sel':'');},this);}});;Ext.namespace('CB.object.plugin');Ext.define('CB.object.plugin.TimeTracking',{extend:'CB.object.plugin.Base',alias:'CBObjectPluginTimeTracking',xtype:'CBObjectPluginTimeTracking',cls:'obj-plugin',initComponent:function(){this.actions={add:new Ext.Action({iconCls:'i-plus',scope:this,handler:this.onAddClick}),start:new Ext.Action({iconCls:'i-start',scope:this,handler:this.onStartClick}),stop:new Ext.Action({iconCls:'i-stop',scope:this,handler:this.onStopClick})};var tpl=new Ext.XTemplate('<table class="block-plugin">','<tpl for=".">','<tr>','    <td style="width:60%">','        <span class="click" title="{[ displayDateTime(values.cdate) ]}">{[ displayDateTime(values.date, App.longDateFormat) ]}</span> &nbsp;','        {user}','    </td>','    <td style="width:20%">','        <span class="click">{time} / {cost}</span>','    </td>','    <td class="elips">','        <span class="click menu"></span>','    </td>','</tr>','</tpl>','</table>');this.store=new Ext.data.JsonStore({autoDestroy:true,model:'ContentItem',proxy:new Ext.data.MemoryProxy()});this.dataView=new Ext.DataView({tpl:tpl,store:this.store,autoHeight:true,itemSelector:'tr',listeners:{scope:this,itemclick:this.onItemClick}});Ext.apply(this,{title:L.TimeSpent,autoHeight:true,anchor:'100%',items:[this.dataView]});this.callParent(arguments);App.mainViewPort.on('objectsdeleted',this.onObjectsDeleted,this);},onObjectsDeleted:function(ids){this.store.deleteIds(ids);},onLoadData:function(r,e){this.store.loadData(r.data);},onItemClick:function(cmp,record,item,index,e,eOpts){var te=Ext.get(e.getTarget());if(!te){return;}
if(te.hasCls('menu')){this.clickedItemData=this.store.getAt(index).data;this.showActionsMenu(e.getXY());}else if(te.hasCls('click')){this.clickedItemData=this.store.getAt(index).data;this.onOpenClick(cmp,e);}},showActionsMenu:function(coord){if(Ext.isEmpty(this.puMenu)){this.puMenu=new Ext.menu.Menu({items:[{text:L.Edit,scope:this,handler:this.onOpenClick},'-',{text:L.Delete,iconCls:'i-trash',scope:this,handler:this.onDeleteItemClick}]});}
this.puMenu.showAt(coord);},onDeleteItemClick:function(b,e){App.mainViewPort.onDeleteObject(this.clickedItemData);},onOpenClick:function(b,e){var data=Ext.clone(this.clickedItemData);data.view='edit';data.modal=true;this.openObjectProperties(data);},getToolbarItems:function(){return[this.actions.add];},onAddClick:function(b,e){var tpl=CB.DB.templates.findRecord('type','time_tracking',0,false,false,true);if(Ext.isEmpty(tpl)){return Ext.Msg.alert(L.Error,'Time tracking template not found.');}
var d={pid:this.params.id,template_id:tpl.get('id'),path:this.params.path,alignWindowTo:e.getXY(),modal:true};App.mainViewPort.fireEvent('createobject',d,e);}});;Ext.namespace('CB');Ext.define('CB.file.edit.Window',{extend:'CB.object.edit.Window',alias:'CBFileEditWindow',xtype:'CBFileEditWindow',width:600,height:550,initComponent:function(){this.callParent(arguments);this.on('openversion',this.onOpenVersionEvent,this);},initActions:function(){this.callParent(arguments);Ext.apply(this.actions,{download:new Ext.Action({text:L.Download,iconCls:'icon-download',scope:this,handler:this.onDownloadClick}),restoreVersion:new Ext.Action({text:L.Restore,iconCls:'i-restore',hidden:true,scope:this,handler:this.onRestoreVersionClick}),webdavlink:new Ext.Action({text:L.WebDAVLink,itemId:'webdavlink',scope:this,handler:this.onWebDAVLinkClick})});},getToolbarButtons:function(){this.callParent(arguments);this.downloadSeparator=Ext.create({xtype:'tbseparator'});return[this.actions.edit,this.actions.restoreVersion,this.actions.save,this.actions.cancel,this.downloadSeparator,this.actions.download,'->',this.actions.star,this.actions.unstar,this.actions.refresh,new Ext.Button({qtip:L.More,itemId:'more',arrowVisible:false,iconCls:'i-points',menu:[this.actions['delete'],this.actions.webdavlink,this.actions.rename,this.actions.permalink,'-',this.actions.notifyOn,this.actions.notifyOff]}),this.actions.showInfoPanel];},initContainerItems:function(){this.callParent(arguments);this.gridContainer.cls='obj-plugin';this.gridContainer.addDocked([{xtype:'toolbar',hidden:true,border:false,items:[{xtype:'label',cls:'title',text:L.Metadata}]}],'top');Ext.destroy(this.complexFieldContainer);this.complexFieldContainer=Ext.create({xtype:'form',border:false,layout:'fit',flex:1,api:{submit:CB_Objects.save},items:[]});Ext.override(this.pluginsContainer,{onLoadData:this.onPluginContainerLoadData});},getLayoutItems:function(){this.templateCfg.layout='horizontal';var rez=[{region:'center',border:false,scrollable:true,layout:{type:'vbox',align:'stretch'},items:[this.titleContainer,this.complexFieldContainer]},{region:'east',itemId:'infoPanel',header:false,border:false,scrollable:true,layout:{type:'vbox',align:'stretch'},split:{size:2},width:300,items:[,this.gridContainer,this.pluginsContainer]}];return rez;},processLoadPreviewData:function(r,e){this.callParent(arguments);var scrollable=(getFileExtension(this.data.name)!=='pdf');this.previewPanel=new CB.object.view.Preview({border:false,scrollable:scrollable,bodyStyle:'padding: 5px'});this.complexFieldContainer.removeAll(true);this.complexFieldContainer.update('');this.complexFieldContainer.add(this.previewPanel);this.previewPanel.loadPreview(this.data.id,this.loadedVersionId);},processLoadEditData:function(r,e){this.gridContainer.getDockedComponent(0).setHidden(false);this.callParent(arguments);},updateComplexFieldContainer:function(){this.editType=detectFileEditor(this.data.name);switch(this.editType){case'text':this.contentEditor=new Ext.ux.AceEditor({border:false});break;case'html':this.contentEditor=new Ext.ux.HtmlEditor({border:false,cls:'editor-no-border',listeners:{scope:this,change:this.onEditorChangeEvent,sync:this.onEditorChangeEvent}});break;}
if(this.contentEditor){this.complexFieldContainer.add(this.contentEditor);this.loadContent();}},loadContent:function(){CB_Files.getContent(this.data.id,this.onLoadContent,this);},onLoadContent:function(r,e){if(!r||(r.success!==true)){plog('Error loading file content ',this.data);return;}
if(this.contentEditor){this.contentEditor.setValue(r.data);}},onPluginContainerLoadData:function(r,e){var w=this.up('window');if(w&&w.viewMode==='edit'){delete r.data.meta;}
this.callParent(arguments);},updateButtons:function(){this.editType=detectFileEditor(this.data.name);this.callParent(arguments);this.downloadSeparator.setHidden(this.actions.cancel.isHidden());this.actions.edit.setHidden((this.viewMode==='edit')||(this.editType===false)||!Ext.isEmpty(this.loadedVersionId));this.actions.webdavlink.setHidden(this.editType!=='webdav');this.actions.save.setDisabled(false);this.actions.restoreVersion.setHidden(Ext.isEmpty(this.loadedVersionId));this.pluginsContainer.setSelectedVersion({id:this.data.id,versionId:this.loadedVersionId});},onEditClick:function(b,e){switch(this.editType){case'text':case'html':this.viewMode='edit';this.doLoad();break;case'webdav':App.openWebdavDocument(this.data);break;}},onSaveClick:function(b,e){this.saveContent();if(!this._isDirty){this.closeOnSaveContent=true;}else{this.readValues();this.getEl().mask(L.Saving+' ...','x-mask-loading');this.complexFieldContainer.getForm().submit({clientValidation:true,loadMask:false,params:{data:Ext.encode(this.data)},scope:this,success:this.processSave,failure:this.processSave});}},saveContent:function(){if(Ext.isEmpty(this.contentEditor)){return;}
var ed=this.contentEditor.editor?this.contentEditor.editor:this.contentEditor,session=ed.getSession?ed.getSession():null;this.getEl().mask(L.Processing+' ...','x-mask-loading');CB_Files.saveContent({id:this.data.id,data:session?session.getValue():ed.getValue()},this.processSaveContent,this);},processSaveContent:function(r,e){this.getEl().unmask();this.actions.save.setDisabled(Ext.isEmpty(this.contentEditor));if(this.closeOnSaveContent){this.close();}},processSave:function(form,action){this.getEl().unmask();var r=action.result;if(!r||(r.success!==true)){App.showException(r);}else{this._isDirty=false;App.fireEvent('objectchanged',r.data,this);this.close();}},onEditorChangeEvent:function(ed){this.actions.save.setDisabled(false);},readValues:function(){this.grid.readValues();this.data.data=Ext.apply(this.data.data,this.complexFieldContainer.getForm().getFieldValues());return this.data;},onDownloadClick:function(b,e){App.downloadFile(this.data.id,false,this.loadedVersionId);},onOpenVersionEvent:function(data,pluginComponent){this.loadedVersionId=data.id;if(!Ext.isEmpty(this.loadedVersionId)){this.viewMode='preview';}
this.doLoad();},onRestoreVersionClick:function(){if(Ext.isEmpty(this.loadedVersionId)){return;}
CB_Files.restoreVersion(this.loadedVersionId,function(r,e){App.mainViewPort.fireEvent('fileuploaded',{data:r.data});delete this.loadedVersionId;this.doLoad();},this);},onWebDAVLinkClick:function(b,e){App.openWebdavDocument(this.data,false);}});;Ext.namespace('CB');Ext.define('CB.WebdavWindow',{extend:'Ext.Window',initComponent:function(){this.data=this.config.data;if(Ext.isEmpty(this.data)){this.data={};}
this.textField=new Ext.form.TextField({value:this.data.link,fieldLabel:'Link',labelWidth:25,selectOnFocus:true,style:'font-size: 10px',width:'100%'});this.cbHideDialog=new Ext.form.Checkbox({xtype:'checkbox',height:20,boxLabel:'Enable cbdav & don\'t show this dialog',checked:(Ext.util.Cookies.get('webdavHideDlg')==1)});Ext.apply(this,{modal:true,width:400,autoHeight:true,border:true,closable:true,cls:'webdav',title:'WebDAV',padding:10,bodyStyle:'padding:10px',items:[this.textField,{xtype:'displayfield',value:'<br />Open this link in your editor (Word, LibreOffice).<br /> You\'ll be asked for your CaseBox username/password.'},{xtype:'displayfield',value:'<br />Install <a href="http://www.casebox.org/dl/cbdav.exe" class="click">cbdav.exe</a> to automatically open the document when you<br />double clicka file or use the edit button.<br /><br />'},this.cbHideDialog,{xtype:'button',style:'margin: auto',scope:this,value:'Ok',text:'Ok',label:'Ok',handler:this.onOkClick}],listeners:{scope:this,afterrender:this.onShow}});this.callParent(arguments);},onShow:function(){this.textField.focus(true,100);this.updateLayout();},onOkClick:function(b,e){Ext.util.Cookies.set('webdavHideDlg',this.cbHideDialog.getValue()?1:0);this.close();}});;Ext.namespace('CB.state');Ext.define('CB.state.DBProvider',{extend:'Ext.state.Provider',constructor:function(config){Ext.apply(this,{api:{read:CB_State_DBProvider.read,write:CB_State_DBProvider.set}});Ext.apply(this,config);this.callParent(arguments);CB.state.DBProvider.superclass.constructor.call(this);this.load();},load:function(){this.api.read(this.onLoad,this);},onLoad:function(r,e){if(!r||(r.success!==true)){return;}
this.state=r.data;},set:function(name,value){var method=Ext.isEmpty(value)?'clear':'set';this.api.write({'name':name,'value':value},function(r,e){if(!r||(r.success!==true)){return;}
CB.state.DBProvider.superclass[method].call(this,name,value);},this);},clear:function(name){this.set(name,null);}});;Ext.namespace('CB');Ext.define('CB.field.Comment',{extend:'Ext.panel.Panel',alias:'CBFieldComment',xtype:'CBFieldComment',layout:{type:'hbox',align:'stretch'},initComponent:function(){this.initChildItems();Ext.apply(this,{autoHeight:true,border:false,listeners:{scope:this,beforedestroy:this.removeUploaderListeners}});this.callParent(arguments);},initChildItems:function(){this.getTextInputField();this.attachFileButton=new Ext.button.Button({qtip:L.AttachFile,text:'',iconCls:'i-attach',hidden:(Ext.isEmpty(this.params)||Ext.isEmpty(this.params.id)),width:24,scope:this,handler:this.onAttachFileClick});this.filesLabel=new Ext.form.field.Display({cls:'click'});this.messageToolbar=new Ext.Toolbar({hidden:false,style:'padding: 0; border: 0; background-color:  transparent;',items:[this.attachFileButton,this.filesLabel,'->',{text:L.Reply,scope:this,handler:this.onAddCommentClick}]});this.items=[{xtype:'label',width:44,html:'<img class="i32" src="'+App.config.photoPath+
App.loginData.id+'.jpg?32='+
CB.DB.usersStore.getPhotoParam(App.loginData.id)+'" title="'+getUserDisplayName(true)+'">'},{xtype:'panel',flex:1,layout:'anchor',padding:'0px 3px 5px 5px',autoHeight:true,boder:false,bodyCls:'x-panel-white',bodyStyle:'border: 0',items:[this.messageField,this.messageToolbar]}];},getTextInputField:function(config){if(Ext.isEmpty(this.messageField)){var cfg={emptyText:L.WriteComment+'...',anchor:'100%',grow:true,growMin:10,enableKeyEvents:true,cls:"comment-input",style:'margin-top: 5px; font-family: arial,sans-serif; font-size: 12px',plugins:[{ptype:'CBPluginFieldDropDownList'}],listeners:{scope:this,keypress:this.onMessageBoxKeyPress,autosize:this.onMessageBoxAutoSize,focus:function(field){field.focused=true;},blur:function(field){delete field.focused;}}};if(config){Ext.apply(cfg,config);}
this.messageField=new Ext.form.TextArea(cfg);}
return this.messageField;},onMessageBoxKeyPress:function(tf,e){if(([10,13].indexOf(e.getKey())>=0)&&e.ctrlKey){this.onAddCommentClick();}},onMessageBoxAutoSize:function(field,width){if(!field.isVisible()){return;}},onAddCommentClick:function(b,e){this.fireEvent('addcomment',this.getValue(),e);},getValue:function(){return this.messageField.getValue();},reset:function(){this.messageField.focus();this.messageField.reset();this.messageField.autoSize();delete this.draftCommentId;this.updateFilesLabel();},onAttachFileClick:function(b,e){if(Ext.isEmpty(this.draftCommentId)){this.draftCommentId=Ext.id();}
this.addUploaderListeners();App.mainViewPort.fireEvent('fileupload',{pid:this.params.id,draftPid:this.draftCommentId,response:'autorename'},e);this.updateFilesLabel();},addUploaderListeners:function(){var fu=App.getFileUploader();if(fu){fu.on('fileuploadend',this.updateFilesLabel,this);fu.on('progresschange',this.updateFilesLabel,this);}},removeUploaderListeners:function(){var fu=App.getFileUploader();if(fu){fu.un('fileuploadend',this.updateFilesLabel,this);fu.un('progresschange',this.updateFilesLabel,this);}},updateFilesLabel:function(){var fu=App.getFileUploader(),label=this.filesLabel;if(Ext.isEmpty(this.draftCommentId)||Ext.isEmpty(fu)){label.setValue('');return;}
var t='',store=fu.store,stats=fu.getStatsForPid(this.draftCommentId);if(stats.pending>0){t=Ext.String.uncapitalize(L.Uploading)+' <span style="color: #555">'+
Ext.String.repeat('●',stats.total-stats.pending)+
Ext.String.repeat('○',stats.pending)+'</span>';label.setValue(t);}else{if(stats.total>0){t=stats.total+' '+Ext.String.uncapitalize(L.Files);label.setValue(t);this.filesCount=stats.total;}else{label.setValue('');}}}});;Ext.namespace('CB');Ext.define('CB.field.CommentLight',{extend:'CB.field.Comment',alias:'CBFieldCommentLight',xtype:'CBFieldCommentLight',initChildItems:function(){this.attachFileButton=new Ext.form.field.File({qtip:L.AttachFile,buttonOnly:true,buttonText:'',buttonConfig:{iconCls:'i-attach'},hidden:(Ext.isEmpty(this.params)||Ext.isEmpty(this.params.id)),width:24,listeners:{scope:this,change:this.onAttachFileClick,render:function(ed){ed.fileInputEl.set({multiple:true});}}});this.getTextInputField();this.filesLabel=new Ext.form.field.Display({cls:'click',hidden:true});this.items=[{xtype:'label',width:50,padding:'2px 0',html:'<img class="i32" src="'+App.config.photoPath+
App.loginData.id+'.jpg?32='+
CB.DB.usersStore.getPhotoParam(App.loginData.id)+'" title="'+getUserDisplayName(true)+'">'},{xtype:'panel',padding:0,border:0,flex:1,layout:{type:'vbox',align:'stretch'},items:[this.messageField,this.filesLabel]}];},getTextInputField:function(config){if(Ext.isEmpty(this.messageField)){var cfg={flex:1,grow:true,growMin:10,minHeight:10,enableKeyEvents:true,cls:"comment-input",triggers:{attach:{cls:'comment-trigger-attach',scope:this,handler:this.onAttachFileClick},reply:{cls:'comment-trigger-reply',scope:this,handler:this.onAddCommentClick}},plugins:[{ptype:'CBPluginFieldDropDownList'}],listeners:{scope:this,keypress:this.onMessageBoxKeyPress,autosize:this.onMessageBoxAutoSize}};if(config){Ext.apply(cfg,config);}
this.messageField=new Ext.form.TextArea(cfg);}
return this.messageField;},updateFilesLabel:function(){var f=this.filesLabel;this.callParent(arguments);f.setHidden(Ext.isEmpty(f.getValue()));}});;Ext.namespace('CB');Ext.define('CB.widget.Breadcrumb',{extend:'Ext.view.View',alias:'CB.Breadcrumb',xtype:'CBBreadcrumb',border:false,autoWidth:true,initComponent:function(){var store=new Ext.data.JsonStore({proxy:{type:'memory',reader:{type:'json'}},fields:['id','name','iconCls']});var dir=(App.config.rtl===true)?'l':'r';var tpl=new Ext.XTemplate('<div class="breadcrumb" role="navigation" style="right: auto">','<tpl for=".">','<div class="item" role="listitem">{[ (xindex < xcount) ? \'<span class="im-arr-'+dir+' f'+dir+'"></span>\': \'\']}{name}</div>','</tpl>','</div>');Ext.apply(this,{tpl:tpl,itemSelector:'.item',store:store,listeners:{scope:this,resize:this.onViewResize,itemclick:this.onItemClick}});this.callParent(arguments);},setValue:function(pathArray){this.store.loadData(pathArray);},onViewResize:function(view,width,height,oldWidth,oldHeight,eOpts){var node,nodesWidth=0,minNodeWidth=50,parentNodesWidth,parentNodesMaxWidth,parentNodesWidthLimit,widthDelta,smallerNodesDelta=0,store=this.store,lastRecord=store.last(),lastNode=view.getNode(lastRecord);store.each(function(r){var node=view.getNode(r);nodesWidth+=node.scrollWidth;},this);if(nodesWidth>width){parentNodesMaxWidth=width-lastNode.scrollWidth;parentNodesWidthLimit=parentNodesMaxWidth/(store.getCount()-1);parentNodesWidth=nodesWidth-lastNode.scrollWidth;if(parentNodesWidthLimit>=minNodeWidth){store.each(function(r){if(r!=lastRecord){node=view.getNode(r);if(node.scrollWidth<parentNodesWidthLimit){smallerNodesDelta+=node.scrollWidth;}}},this);}
parentNodesWidthLimit+=smallerNodesDelta;store.each(function(r){if(r!=lastRecord){node=view.getNode(r);if(parentNodesWidthLimit<minNodeWidth){node.setAttribute('style','width: 0; padding: 0');}else{if(node.scrollWidth>parentNodesWidthLimit){node.setAttribute('style','width: '+parentNodesWidthLimit+'px');}else{node.removeAttribute('style');}}}},this);}else{store.each(function(r){node=view.getNode(r);node.removeAttribute('style');},this);}}});;Ext.define('CB.widget.DataSorter',{extend:'Ext.window.Window',requires:['Ext.button.Button','Ext.grid.Panel'],alias:'widget.DataSorter',xtype:'CBDataSorter',alwaysOnTop:true,modal:true,closable:true,closeAction:'destroy',minimizable:false,minWidth:250,minHeight:300,width:350,height:400,initComponent:function(){var me=this;this.store=new Ext.data.JsonStore({model:'Generic',proxy:{type:'memory',reader:{type:'json'}}});this.grid=Ext.create('Ext.grid.Panel',{border:false,store:this.store,columns:[{text:L.Name,dataIndex:'name',sortable:false,flex:true,renderer:function(v,m,r,ri,ci,s){m.css='icon-grid-column-top '+r.get('iconCls');v='<span class="order-arrows"><b class="click arrow-up">&nbsp;</b><b class="click arrow-down">&nbsp;</b></span><span class="n">'+v+'</span>';return v;}}],viewConfig:{plugins:{ptype:'gridviewdragdrop',dragText:L.ReorderDDText},listeners:{scope:this,itemclick:this.onGridItemClick}}});Ext.apply(me,{title:L.SortValue,border:false,layout:'fit',cls:'x-panel-white',tbar:Ext.create('Ext.panel.Panel',{autoHeight:true,border:false,bodyPadding:3,html:L.ReorderItemsMsg}),items:[this.grid],buttons:['->',{text:Ext.MessageBox.buttonText.ok,scope:this,handler:this.onOkClick},{text:L.Cancel,scope:this,handler:this.destroy}],listeners:{scope:this,afterrender:this.onAfterRender}});me.callParent(arguments);},onAfterRender:function(){var map=new Ext.util.KeyMap({target:this.grid.getView().getEl(),binding:[{key:[10,13],scope:this,fn:this.onOkClick},{key:Ext.event.Event.UP,ctrl:true,shift:false,scope:this,fn:this.onMoveUpClick},{key:Ext.event.Event.DOWN,ctrl:true,shift:false,scope:this,fn:this.onMoveDownClick}]});var r=this.store.getAt(0),v=this.grid.getView();if(r){v.getSelectionModel().select([r]);v.getNavigationModel().setPosition(0,0);v.focus(10);v.focusRow(r,100);}},onMoveUpClick:function(key,e){var v=this.grid.getView(),s=v.getSelection(),idx;if(!Ext.isEmpty(s)){idx=this.store.indexOf(s[0]);if(idx>0){v.plugins[0].dropZone.handleNodeDrop({records:s,view:v},this.store.getAt(idx-1),'before');}}},onMoveDownClick:function(key,e){var v=this.grid.getView(),s=v.getSelection(),idx;if(!Ext.isEmpty(s)){idx=this.store.indexOf(s[0]);if((idx+1)<this.store.getCount()){v.plugins[0].dropZone.handleNodeDrop({records:s,view:v},this.store.getAt(idx+1),'after');}}},onGridItemClick:function(view,record,item,index,e,eOpts){var el=e.getTarget('.arrow-down');if(el){this.onMoveDownClick();}else{el=e.getTarget('.arrow-up');if(el){this.onMoveUpClick();}}},onOkClick:function(b,e){var st=this.store,rez=st.collect('id');this.fireEvent('change',this,rez);}});;Ext.namespace('CB');Ext.define('CB.widget.LeafletPanel',{extend:'Ext.Panel',alias:'CB.LeafletPanel',xtype:'CBLeafletPanel',initComponent:function(){Ext.apply(this,{border:false,listeners:{scope:this,boxready:this.onBoxReady}});this.callParent(arguments);},onBoxReady:function(panel){if(!window.LL){return alert('No Leaflet library');}
var map=LL.map(this.body.id),osmUrl='https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',osm=new LL.TileLayer(osmUrl,{minZoom:0,maxZoom:18});this.map=map;map.addLayer(osm);this.fireEvent('mapready',this);map.on('click',this.onMapClick,this);},onMapClick:function(e){this.fireEvent('mapclick',this,e);},setViewConfig:function(cfg){var dl=Ext.valueFrom(cfg.defaultLocation,{}),lat=Ext.valueFrom(dl.lat,0),lng=Ext.valueFrom(dl.lng,0),zoom=Ext.valueFrom(dl.zoom,3);if(!Ext.isEmpty(cfg.url)){this.map.eachLayer(function(l){if(l&&l.setUrl){l.setUrl(cfg.url);}});}
this.map.setView(new LL.LatLng(lat,lng),zoom,{reset:true});},setView:function(ll,z,o){this.map.setView(ll,z,o);}});;Ext.namespace('CB');Ext.define('CB.widget.LeafletWindow',{extend:'Ext.Window',alias:'CB.LeafletWindow',xtype:'CBLeafletWindow',height:400,width:700,maximizable:true,minimizable:true,initComponent:function(){this.actions={save:new Ext.Action({text:L.Save,iconCls:'icon-save',disabled:true,scope:this,handler:this.onSaveClick}),cancel:new Ext.Action({text:L.Cancel,iconCls:'i-cancel',scope:this,handler:this.close}),set:new Ext.Action({text:L.Set,scope:this,handler:this.onSetClick})};this.mapPanel=Ext.create('CB.LeafletPanel',{listeners:{scope:this,mapready:this.onMapReady,mapclick:this.onMapClick}});this.latEd=new Ext.form.TextField({enableKeyEvents:true,fieldLabel:L.Latitude,labelWidth:50,width:120,maskRe:/[\-\d\.]/,listeners:{specialkey:this.onEditorEnterPress,scope:this}});this.longEd=new Ext.form.TextField({enableKeyEvents:true,fieldLabel:L.Longitude,labelWidth:55,width:125,maskRe:/[\-\d\.]/,listeners:{specialkey:this.onEditorEnterPress,scope:this}});Ext.apply(this,{layout:'fit',border:false,cls:'x-panel-white',tbar:[this.actions.save,this.actions.cancel,'->',this.latEd,{xtype:'tbspacer',width:10},this.longEd,this.actions.set],items:[this.mapPanel],bbar:[{xtype:'label',text:'Location'}]});this.callParent(arguments);},onMapReady:function(p){var d=this.initialConfig.data,cfg=Ext.valueFrom(d.cfg,{});if(!Ext.isEmpty(d.value)){var a=d.value.split(','),lat=a[0],lng=a[1];cfg.defaultLocation={lat:lat,lng:lng};this.latEd.setValue(lat);this.longEd.setValue(lng);this.getMarker().setLatLng(new LL.LatLng(lat,lng));}
p.setViewConfig(cfg);},onMapClick:function(p,e){var ll=e.latlng.wrap(),lat=ll.lat.toFixed(4),lng=ll.lng.toFixed(4),marker=this.getMarker();this.latEd.setValue(lat);this.longEd.setValue(lng);marker.setLatLng(ll);this.actions.save.setDisabled(false);},onSaveClick:function(){var d=this.initialConfig.data;if(d.callback){var f=Ext.Function.bind(d.callback,Ext.valueFrom(d.scope,this),[this,this.latEd.getValue()+','+this.longEd.getValue()]);f();}
this.close();},getMarker:function(ll){if(!this.marker){this.marker=LL.marker(new LL.LatLng(0,0),{icon:LL.icon({iconUrl:'/css/i/marker.png',iconSize:[25,41],'marker-color':'ff8888'}),draggable:true});this.marker.on('dragend',this.onMarkerDragEnd,this);this.marker.addTo(this.mapPanel.map);}
return this.marker;},onMarkerDragEnd:function(e){var ll=e.target.getLatLng().wrap(),lat=ll.lat.toFixed(4),lng=ll.lng.toFixed(4);this.latEd.setValue(lat);this.longEd.setValue(lng);this.actions.save.setDisabled(false);},onEditorEnterPress:function(ed,e){if(e.getKey()==e.ENTER){this.onSetClick();}},onSetClick:function(b,e){var lat=this.latEd.getValue(),lng=this.longEd.getValue();if(!Ext.isEmpty(lat)&&!Ext.isEmpty(lng)){var ll=new LL.LatLng(lat,lng);this.getMarker().setLatLng(ll);this.mapPanel.map.setView(ll);}}});;Ext.define('CB.widget.TaskBar',{extend:'Ext.toolbar.Toolbar',requires:['Ext.button.Button','Ext.resizer.Splitter','Ext.menu.Menu'],alias:'widget.taskbar',cls:'cb-taskbar',alwaysOnTop:true,initComponent:function(){var me=this;me.windowBar=new Ext.toolbar.Toolbar(me.getWindowBarConfig());me.tray=new Ext.toolbar.Toolbar(me.getTrayConfig());me.items=[me.windowBar,'-',me.tray];me.windowMenu=new Ext.menu.Menu({defaultAlign:'br-tr',items:[{text:L.Restore,handler:me.onWindowMenuRestore,scope:me},{text:L.Minimize,handler:me.onWindowMenuMinimize,scope:me},{text:L.Maximize,handler:me.onWindowMenuMaximize,scope:me},'-',{text:L.Close,handler:me.onWindowMenuClose,scope:me}],listeners:{scope:me,beforeshow:me.onWindowMenuBeforeShow,hide:me.onWindowMenuHide}});me.callParent();},afterLayout:function(){var me=this;me.callParent();me.windowBar.el.on('contextmenu',me.onButtonContextMenu,me);},getTrayConfig:function(){var ret={items:this.trayItems};delete this.trayItems;return ret;},getWindowBarConfig:function(){return{flex:1,cls:'cb-windowbar',items:['&#160;'],layout:{overflowHandler:'Scroller'}};},getWindowBtnFromEl:function(el){var c=this.windowBar.getChildByElement(el);return c||null;},onButtonContextMenu:function(e){var me=this,t=e.getTarget(),btn=me.getWindowBtnFromEl(t);if(btn){e.stopEvent();me.windowMenu.theWin=btn.win;me.windowMenu.showBy(t);}},onWindowMenuBeforeShow:function(menu){var items=menu.items.items,win=menu.theWin;items[0].setDisabled(win.maximized!==true&&win.hidden!==true);items[1].setDisabled(win.minimized===true);items[2].setDisabled(win.maximized===true||win.hidden===true);},onWindowMenuHide:function(menu){Ext.defer(function(){menu.theWin=null;},1);},onWindowMenuRestore:function(){var me=this,win=me.windowMenu.theWin;me.restoreWindow(win);},onWindowMenuMinimize:function(){var me=this,win=me.windowMenu.theWin;win.minimize();},onWindowMenuMaximize:function(){var me=this,win=me.windowMenu.theWin;win.maximize();win.toFront();},onWindowMenuClose:function(){var me=this,win=me.windowMenu.theWin;win.close();},onWindowBtnClick:function(btn){var win=btn.win;if(win.minimized||win.hidden){btn.disable();win.show(null,function(){btn.enable();});}else if(win.active){btn.disable();win.on('hide',function(){btn.enable();},null,{single:true});win.minimize();}else{win.toFront();}},addTaskButton:function(win){var config={iconCls:win.iconCls,textAlign:'left',enableToggle:true,toggleGroup:'all',width:140,margin:'0 2 0 3',text:Ext.util.Format.ellipsis(win.title,20),listeners:{toggle:this.onWindowBtnClick,scope:this},win:win};var cmp=this.windowBar.add(config);this.setActiveButton(cmp);win.on('activate',this.markActive,this);win.on('beforeshow',this.markActive,this);win.on('deactivate',this.markInactive,this);win.on('minimize',this.minimizeWin,this);win.on('beforedestroy',this.removeWin,this);win.on('titlechange',this.onWindowTitleChange,this);win.on('iconclschange',this.onWindowIconChange,this);return cmp;},removeTaskButton:function(btn){var found,me=this;me.windowBar.items.each(function(item){if(item===btn){found=item;}
return!found;});if(found){me.windowBar.remove(found);}
return found;},setActiveButton:function(btn){this.windowBar.items.each(function(item){if(item.isButton){item.toggle(false,true);}});if(btn){btn.toggle(true,true);btn.win.active=true;}},markActive:function(win){if(this.activeWindow&&this.activeWindow!=win){this.markInactive(this.activeWindow);}
this.setActiveButton(win.taskButton);this.activeWindow=win;win.minimized=false;win.active=true;},markInactive:function(win){if(win==this.activeWindow){this.activeWindow=null;if(win.taskButton.el){win.taskButton.toggle(false,true);}
delete win.active;}},minimizeWin:function(win){win.minimized=true;win.hide();this.markInactive(win);},removeWin:function(win){this.removeTaskButton(win.taskButton);},restoreWindow:function(win){if(win.isVisible()){win.restore();win.toFront();}else{win.show();}
return win;},onWindowTitleChange:function(win,newTitle,oldTitle,eOpts){win.taskButton.setText(newTitle);},onWindowIconChange:function(win,newIconCls,oldIconCls,eOpts){win.taskButton.setIconCls(newIconCls);}});;Ext.namespace('CB');Ext.define('CB.widget.block.Base',{extend:'Ext.Panel',alias:'CBWidgetBlockBase',xtype:'CBWidgetBlockBase',initComponent:function(){Ext.apply(this,{border:false,cls:'panel-header-nobg'});this.callParent(arguments);}});;Ext.namespace('CB');Ext.define('CB.widget.block.Chart',{extend:'CB.widget.block.Base',alias:'CBWidgetBlockChart',xtype:'CBWidgetBlockChart',width:300,height:300,minWidth:200,minHeight:200,initComponent:function(){Ext.apply(this,{border:false,autoHeight:true,layout:{type:'vbox',pack:'top'},listeners:{scope:this,afterrender:this.onAfterRender}});this.callParent(arguments);this.initSeriesStyles();this.initChartConfigs();},initSeriesStyles:function(){this.seriesStyles=[];for(var i=0;i<App.colors.length;i++){this.seriesStyles.push({color:App.colors[i]});}},initChartConfigs:function(){this.chartDataStore=new Ext.data.JsonStore({autoDestroy:false,model:'GenericCount'});var tipsCfg={trackMouse:true,style:'background: #FFF; overflow: visible',height:20,width:200,renderer:function(storeItem,item){this.setTitle(storeItem.get('name')+': '+storeItem.get('count'));}};this.chartConfigs={'bar':{width:'100%',store:this.chartDataStore,colors:App.colors,axes:[{type:'numeric',position:'bottom',fields:'count',grid:true},{type:'category',position:'left',fields:'shortname',grid:true}],series:[{type:'bar',axis:'bottom',xField:'shortname',yField:'count',style:{opacity:0.80,minGapWidth:10},highlight:{fillStyle:'rgba(249, 204, 157, 1.0)',strokeStyle:'black',radius:10},label:{field:'count',display:'insideEnd'},tips:tipsCfg,listeners:{scope:this,itemclick:this.onChartItemClick}}]},'column':{width:'100%',store:this.chartDataStore,colors:App.colors,axes:[{type:'numeric',position:'left',adjustByMajorUnit:true,fields:['count'],grid:true},{type:'category',position:'bottom',fields:['shortname'],grid:true,label:{rotate:{degrees:-90}}}],series:[{type:'column',xField:'shortname',yField:['count'],stacked:true,highlight:{fillStyle:'yellow'},label:{field:'count',display:'insideEnd'},tips:tipsCfg,listeners:{scope:this,itemclick:this.onChartItemClick}}]},'pie':{width:'100%',store:this.chartDataStore,series:[{type:'pie',donut:0,angleField:'count',label:{field:'shortname',display:'outside',calloutLine:true},showInLegend:true,highlight:true,highlightCfg:{'stroke-width':1,stroke:'#fff'},tips:tipsCfg,listeners:{scope:this,itemclick:this.onChartItemClick}}]}};return this.chartConfigs;},onAfterRender:function(p){if(!Ext.isEmpty(this.config.data)){this.loadData(this.config.data);}},loadData:function(data,overrides){var rez={data:{},charts:[]},d=rez.data;Ext.apply(rez,overrides);if(data.view){var vp=data.view;if(Ext.isEmpty(rez.charts)&&vp.chartType){rez.charts=Ext.isString(vp.chartType)?[vp.chartType]:vp.chartType;}
if(Ext.isEmpty(rez.facet)&&vp.rows&&!Ext.isEmpty(vp.rows.facet)){rez.facet=vp.rows.facet;}}
Ext.iterate(data.facets,function(key,val,o){d[key]=CB.facet.List.prototype.getFacetData(key,val.items);if(Ext.isEmpty(rez.facet)){rez['facet']=key;}
for(var i=0;i<d[key].length;i++){if(Ext.isObject(d[key][i].items)){d[key][i].name=d[key][i].items.name;d[key][i].count=d[key][i].items.count;}else{d[key][i].count=d[key][i].items;}
d[key][i].shortname=htmlEntityDecode(App.shortenString(d[key][i].name,30));}
if(data.sorter){d[key]=Ext.Array.sort(d[key],data.sorter);}},this);if(d[rez.facet]){this.chartDataStore.loadData(Ext.clone(d[rez.facet]));}else{this.chartDataStore.removeAll();}
if(Ext.isEmpty(rez.charts)){rez.charts=['pie'];}
this.chartData=rez;this.changeCharts(rez.charts);return rez;},changeCharts:function(charts){this.removeAll(true);var cfg=Ext.clone(this.chartConfigs[charts[0]]);if(!Ext.isEmpty(cfg)){cfg.height=this.body.getHeight()-20;cfg.insetPadding=(charts[0]==='pie')?75:35;cfg.legend=(this.showLegend!==false)?{position:'right',boxStrokeWidth:0}:false;this.chart=Ext.create('Ext.chart.Chart',cfg);this.add(this.chart);}
this.updateLayout();},onChartItemClick:function(o,e){this.fireEvent('itemclick',o,e);},setLegendVisible:function(visible){this.showLegend=visible;}});;Ext.namespace('CB');Ext.define('CB.widget.block.Grid',{extend:'CB.widget.block.Base',alias:'CBWidgetBlockGrid',xtype:'CBWidgetBlockGrid',minHeight:100,initComponent:function(){this.store=new Ext.data.JsonStore({autoDestroy:true,remoteSort:false,model:'FieldObjects',proxy:{type:'memory',reader:{type:'json'}}});this.grid=new CB.browser.view.Grid({border:false,refOwner:this,store:this.store,getProperty:Ext.emptyFn,saveGridState:Ext.emptyFn,hideBottomBar:true});Ext.apply(this,{layout:'fit',items:[this.grid],listeners:{scope:this,afterrender:this.onAfterRender}});this.callParent(arguments);},onAfterRender:function(){var ic=this.initialConfig,s=this.store;if(!Ext.isEmpty(ic.data)){for(var i=0;i<ic.data.length;i++){ic.data[i].iconCls=getItemIcon(ic.data[i]);}
s.proxy.reader.rawData=ic.data;s.loadData(ic.data.data);s.fireEvent('manualload',s,s.data.items,true,{});}}});;Ext.namespace('CB');Ext.define('CB.widget.block.Map',{extend:'CB.widget.block.Base',alias:'CBWidgetBlockMap',xtype:'CBWidgetBlockMap',initComponent:function(){this.mapPanel=Ext.create('CB.LeafletPanel',{listeners:{scope:this,mapready:this.onMapReady}});Ext.apply(this,{minWidth:300,minHeight:200,layout:'fit',items:this.mapPanel});this.callParent(arguments);},onMapReady:function(p){p.setViewConfig(this.initialConfig.params);}});;Ext.namespace('CB');Ext.define('CB.widget.block.Pivot',{extend:'CB.widget.block.Chart',alias:'CBWidgetBlockPivot',xtype:'CBWidgetBlockPivot',width:400,height:400,loadData:function(data,overrides){var rez={data:{},titles:[],xField:'',yField:'',charts:[],refs:{}},d={};this.selectedStat=null;if(overrides){Ext.apply(rez,overrides);}
if(data.pivot){var key='',arr;if(Ext.isEmpty(rez.xField)||Ext.isEmpty(rez.yField)){Ext.iterate(data.pivot,function(k,v){key=k;},this);var q=key.split(',');rez.xField=q[0];rez.yField=q[1];}
if(data.pivot[key]){Ext.copyTo(rez,data.pivot[key],'data,titles,stats');}}
if(data.view){var vp=data.view;rez.view=vp;this.selectedStat=vp.selectedStat;if(Ext.isEmpty(rez.charts)&&vp.pivotType){rez.charts=Ext.isString(vp.pivotType)?[vp.pivotType]:vp.pivotType;}
if(Ext.isEmpty(rez.xField)&&vp.rows&&!Ext.isEmpty(vp.rows.facet)){rez.xField=vp.rows.facet;}
if(Ext.isEmpty(rez.xField)&&vp.cols&&!Ext.isEmpty(vp.cols.facet)){rez.yField=vp.cols.facet;}}
Ext.iterate(data.facets,function(key,val,o){d[key]=CB.facet.List.prototype.getFacetData(key,val.items);for(var i=0;i<d[key].length;i++){if(Ext.isObject(d[key][i].items)){d[key][i].name=d[key][i].items.name;d[key][i].count=d[key][i].items.count;}
d[key][i].name=App.shortenString(d[key][i].name,30);}},this);if(!Ext.isEmpty(data.pivot)){var i,j,f1,f2,value,f1t;d=data.pivot[rez.xField+','+rez.yField];if(d&&d.data){for(i=0;i<d.data.length;i++){f1=d.data[i];f1t=0;if(!Ext.isEmpty(f1.pivot)){for(j=0;j<f1.pivot.length;j++){f2=f1.pivot[j];value=this.getFacetCount(f2);if(value>0){rez.refs[f1.value+'_'+f2.value]=value;if(Ext.isEmpty(rez.refs['t_'+f2.value])){rez.refs['t_'+f2.value]=0;}
if(Ext.isNumeric(value)){rez.refs['t_'+f2.value]+=value;f1t+=value;}}}}
if(f1t>0){rez.refs[f1.value+'_t']=f1t;}}}}
if(Ext.isEmpty(rez.charts)){rez.charts=['table'];}
this.chartData=rez;this.changeCharts(rez.charts);return rez;},changeCharts:function(charts){var data=this.chartData;this.removeAll(true);if(charts.indexOf('table')>-1){var columns=[{text:'#',locked:true,tdCls:'fwB',width:200,renderer:this.cellRenderer,dataIndex:'title'}],fields=[{name:'fid',type:'number'},{name:'title'},{name:'total',type:'number'},],recs=[];Ext.iterate(data.titles[1],function(k,v,o){columns.push({text:v,width:50,cls:'fwB',align:'right',renderer:this.cellRenderer,dataIndex:'f_'+k});fields.push({name:'f_'+k,type:'number'});},this);columns.push({text:L.Total,width:50,align:'right',cls:'fwB cG',tdCls:'fwB cG',dataIndex:'total'});Ext.iterate(data.titles[0],function(k,v,o){if(Ext.isEmpty(data.refs[k+'_t'])){return;}
var r={fid:k,title:v};Ext.iterate(data.titles[1],function(q,z,y){r['f_'+q]=Ext.valueFrom(data.refs[k+'_'+q],'');},this);r['total']=Ext.util.Format.number(Ext.valueFrom(data.refs[k+'_t'],''),'0.##');recs.push(r);},this);var total=0;var r={fid:'total',title:L.Total};Ext.iterate(data.titles[1],function(q,z,y){var nr=Ext.valueFrom(data.refs['t_'+q],'');r['f_'+q]=Ext.util.Format.number(nr,'0.##');if(Ext.isNumeric(nr)){total+=nr;}},this);var value=this.getFacetCount(data);r['total']=Ext.util.Format.number(value?value:total,'0.##');recs.push(r);var table=this.add({xtype:'grid',flex:1,width:'99%',padding:10,store:Ext.create('Ext.data.JsonStore',{fields:fields,data:recs}),columnLines:true,columns:columns,viewConfig:{stripeRows:true},listeners:{scope:this,celldblclick:this.onCellDblClick}});}
if(charts.indexOf('stackedBars')>-1){this.addChart('bar');}
if(charts.indexOf('stackedColumns')>-1){this.addChart('column');}
this.updateLayout();},addChart:function(chartType){var d=this.chartData;var tipsCfg={trackMouse:true,style:'background: #FFF; overflow: visible',height:20,width:200,renderer:function(storeItem,item){this.setTitle(item.value.join(': '));}},series=[{xField:d.xField,yField:[],title:[],tips:tipsCfg},{xField:d.yField,yField:[],title:[],tips:tipsCfg}],data=[[],[]];Ext.iterate(d.titles[0],function(k,v,o){series[1].yField.push('f'+k);series[1].title.push(v);var r={};r[d.xField]=htmlEntityDecode(v);Ext.iterate(d.titles[1],function(q,z,y){var w=Ext.valueFrom(d.refs[k+'_'+q],'');r['f'+q]=Ext.isEmpty(w)?0:w;},this);data[0].push(r);},this);Ext.iterate(d.titles[1],function(k,v,o){series[0].yField.push('f'+k);series[0].title.push(v);var r={};r[d.yField]=htmlEntityDecode(v);Ext.iterate(d.titles[0],function(q,z,y){var w=Ext.valueFrom(d.refs[q+'_'+k],'');r['f'+q]=Ext.isEmpty(w)?0:w;},this);data[1].push(r);},this);var chartItems=[],i=0;var serie=series[i];var cfg={height:Math.max(data[i].length*25,400),width:'100%',store:new Ext.data.JsonStore({fields:[serie.xField].concat(serie.yField),proxy:{type:'memory',reader:{type:'json'}},data:data[i]}),items:[{type:'text',text:' ',x:40,y:12}],axes:[{type:'category',position:(chartType==='bar')?'left':'bottom',fields:serie.xField,grid:true,label:{rotate:{degrees:(chartType==='bar')?0:270}},minimum:0},{type:'numeric',position:(chartType==='column')?'left':'bottom',fields:serie.yField,grid:true}],legend:(this.showLegend!==false)?{position:'right',boxStrokeWidth:0}:false,seriesStyles:this.seriesStyles,series:[Ext.apply(serie,{type:chartType,stacked:true,style:{opacity:0.80},highlight:{'stroke-width':2,stroke:'#fff'}})]};chartItems.push(Ext.create('Ext.chart.Chart',cfg));return this.add(chartItems);},cellRenderer:function(value,metaData,record){if(value===0){return'';}
if(record.get('title')==L.Total){metaData.tdCls='fwB cG';}
return value;},onCellDblClick:function(grid,td,cellIndex,record,tr,rowIndex,e,eOpts){var row=record.get('fid'),col=grid.headerCt.visibleColumnManager.getHeaderAtIndex(cellIndex).dataIndex,filter=[isNaN(row)?null:row,(col=='total')?null:col.substr(2)];this.fireEvent('filterclick',filter);},getFacetCount:function(f){var rez=0,sf=this.selectedStat;if(sf&&sf.field&&f.stats&&f.stats.stats_fields&&f.stats.stats_fields[sf.field]){if(f.stats.stats_fields[sf.field][sf.type]){rez=f.stats.stats_fields[sf.field][sf.type];}}else if(f.count){rez=f.count;}
return rez;},getHtml:function(){var rez='',data=this.chartData,hr='<th> &nbsp; </th>';Ext.iterate(data.titles[1],function(k,v,o){hr+='<th title="'+Ext.String.htmlEncode(v)+'">'+v+'</th>';},this);rez+='<tr>'+hr+'<th>'+L.Total+'</th></tr>';Ext.iterate(data.titles[0],function(k,v,o){if(Ext.isEmpty(data.refs[k+'_t'])){return;}
var r='<th style="text-align:left" title="'+Ext.String.htmlEncode(v)+'">'+
Ext.String.htmlEncode(App.shortenString(v,25))+'</th>';Ext.iterate(data.titles[1],function(q,z,y){r+='<td f="'+k+'|'+q+'">'+Ext.valueFrom(data.refs[k+'_'+q],'')+'</td>';},this);rez+='<tr>'+r+'<td class="total" f="'+k+'|">'+Ext.util.Format.number(Ext.valueFrom(data.refs[k+'_t'],''),'0.##')+'</td></tr>';},this);var total=0;var r='<th>'+L.Total+'</th>';Ext.iterate(data.titles[1],function(q,z,y){var nr=Ext.valueFrom(data.refs['t_'+q],'');r+='<td class="total" f="|'+q+'">'+Ext.util.Format.number(nr,'0.##')+'</td>';if(Ext.isNumeric(nr)){total+=nr;}},this);var value=this.getFacetCount(data);rez+='<tr>'+r+'<td class="total">'+Ext.util.Format.number(value?value:total,'0.##')+'</td></tr>';rez='<table class="pivot" border="1" style="border-collapse: collapse">'+rez+'</table>';return rez;},setLegendVisible:function(visible){this.showLegend=visible;}});;Ext.namespace('CB');Ext.define('CB.widget.block.Template',{extend:'CB.widget.block.Base',alias:'CBWidgetBlockTemplate',xtype:'CBWidgetBlockTemplate',minHeight:100,initComponent:function(){Ext.apply(this,{tpl:this.config.params.tpl,data:this.config.data});this.callParent(arguments);}});