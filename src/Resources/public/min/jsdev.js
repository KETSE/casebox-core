Ext.namespace('App');Ext.BLANK_IMAGE_URL='/css/i/s.gif';var clog=function(){if(typeof(console)!=='undefined'){console.log(arguments);}},plog=clog,App;Ext.onReady(function(){App=new Ext.util.Observable();App.controller=Ext.create({xtype:'browsingcontroller'});App.locateObject=Ext.Function.bind(App.controller.locateObject,App.controller);App.openPath=Ext.Function.bind(App.controller.openPath,App.controller);App.colors=["#3A84CB","#94ae0a","#115fa6","#a61120","#ff8809","#ffd13e","#a61187","#24ad9a","#7c7474","#a66111"];App.historyController=Ext.create({xtype:'historycontroller'});initApp();Ext.Date.use24HourTime=true;Ext.direct.Manager.addProvider(Ext.app.REMOTING_API);Ext.state.Manager.setProvider(new CB.state.DBProvider());Ext.Direct.on('login',function(r,e){Ext.Msg.alert(L.Error,L.SessionExpired);});Ext.Direct.on('exception',App.showException);Ext.QuickTips.init();Ext.apply(Ext.QuickTips.getQuickTip(),{showDelay:1500});setTimeout(function(){Ext.get('loading').remove();},10);CB_User.getLoginInfo(function(r,e){if(!r||(r.success!==true)){return;}
App.sid='&qq='+Date.parse(new Date());App.config=r.config;App.loginData=r.user;App.loginData.iconCls='icon-user-account';if(App.loginData.cfg.short_date_format){App.dateFormat=App.loginData.cfg.short_date_format;}
if(App.loginData.cfg.long_date_format){App.longDateFormat=App.loginData.cfg.long_date_format;}
if(App.loginData.cfg.time_format){App.timeFormat=App.loginData.cfg.time_format;}
App.mainViewPort=new CB.ViewPort({rtl:(App.config.rtl===true)});App.mainViewPort.doLayout();App.mainViewPort.initCB(r,e);});App.mouseDown=0;document.body.onmousedown=function(ev){App.lastMouseButton=ev.button;++App.mouseDown;};document.body.onmouseup=function(){--App.mouseDown;};});function initApp(){App.dateFormat='d.m.Y';App.longDateFormat='j F Y';App.timeFormat='H:i';App.shortenString=function(st,maxLen){if(Ext.isEmpty(st)){return'';}
st=Ext.util.Format.stripTags(st);return Ext.util.Format.ellipsis(st,maxLen);};App.shortenStringLeft=function(st,maxLen){if(Ext.isEmpty(st)){return'';}
st=Ext.util.Format.stripTags(st);st=st.split('').reverse().join('');st=Ext.util.Format.ellipsis(st,maxLen);return st.split('').reverse().join('');};App.PromtLogin=function(e){if(!this.loginWindow||this.loginWindow.isDestroyed){this.loginWindow=new CB.Login({});}
this.loginWindow.show();};App.formSubmitFailure=function(form,action){var msg;if(App.hideFailureAlerts){return;}
switch(action.failureType){case Ext.form.Action.CLIENT_INVALID:msg='Form fields may not be submitted with invalid values';break;case Ext.form.Action.CONNECT_FAILURE:msg='Ajax communication failed';break;case Ext.form.Action.SERVER_INVALID:msg=Ext.valueFrom(action.msg,action.result.msg);msg=Ext.valueFrom(msg,L.ErrorOccured);}
Ext.Msg.alert(L.Error,msg);};App.includeJS=function(file){if(document.createElement&&document.getElementsByTagName){var head=document.getElementsByTagName('head')[0];var script=document.createElement('script');script.setAttribute('type','text/javascript');script.setAttribute('src',file);head.appendChild(script);}else{alert('Your browser can\'t deal with the DOM standard. That means it\'s old. Go fix it!');}};App.xtemplates={cell:new Ext.XTemplate('<ul class="thesauri_set"><tpl for="."><li>{.}</li></tpl></ul>'),object:new Ext.XTemplate('<ul class="clean"><tpl for="."><li class="case_object" object_id="{id}">{[Ext.isEmpty(values.name) ? \'&lt;'+L.noName+'&gt; (id: \'+values.id+\')\' : values.name]}</li></tpl></ul>')};App.xtemplates.cell.compile();App.xtemplates.object.compile();App.customRenderers={thesauriCell:function(v,metaData,record,rowIndex,colIndex,store,grid){if(Ext.isEmpty(v)){return'';}
var va=v.split(',');var vt=[],thesauriId=grid.helperTree.getNode(record.get('id')).data.templateRecord.get('cfg').thesauriId;if(Ext.isEmpty(thesauriId)&&store.thesauriIds){thesauriId=store.thesauriIds[record.id];}
if(!Ext.isEmpty(thesauriId)){var ts=getThesauriStore(thesauriId),idx;for(var i=0;i<va.length;i++){idx=ts.findExact('id',parseInt(va[i],10));if(idx>=0){vt.push(ts.getAt(idx).get('name'));}}}
return App.xtemplates.cell.apply(vt);},relatedCell:function(v,metaData,record,rowIndex,colIndex,store){},combo:function(v,metaData,record,rowIndex,colIndex,store){if(Ext.isEmpty(v)){return'';}
var ed=this.editor,r=ed.store.findRecord(ed.valueField,v,0,false,false,true);if(!r){return'';}
return r.get(ed.displayField);},objectsField:function(v,metaData,record,rowIndex,colIndex,store,grid){if(Ext.isEmpty(v)){return'';}
store=null;var rec,row,ri,r=[],va=toNumericArray(v),cfg=grid.helperTree.getNode(record.get('id')).data.templateRecord.get('cfg'),source=(Ext.isEmpty(cfg.source))?'tree':cfg.source;if(Ext.isEmpty(va)&&Ext.isPrimitive(v)){va=[v];}
switch(source){case'thesauri':store=isNaN(cfg.thesauriId)?CB.DB.thesauri:getThesauriStore(cfg.thesauriId);break;case'users':store=CB.DB.usersStore;break;case'groups':store=CB.DB.groupsStore;break;default:var cw=null;if(grid&&grid.findParentByType){cw=grid.refOwner||grid.findParentByType(CB.Objects);}
if(!cw||!cw.objectsStore){return'';}
store=cw.objectsStore;}
switch(cfg.renderer){case'listGreenIcons':for(i=0;i<va.length;i++){row=store.findRecord('id',va[i],0,false,false,true);if(row){r.push('<li class="lh16 icon-padding icon-element">'+row.get('name')+'</li>');}}
return'<ul class="clean">'+r.join('')+'</ul>';case'listObjIcons':for(i=0;i<va.length;i++){row=store.findRecord('id',va[i],0,false,false,true);if(row){var icon=row.get('cfg');if(!Ext.isEmpty(icon)){icon=icon.iconCls;}
if(Ext.isEmpty(icon)){icon=row.get('iconCls');}
r.push('<li class="lh16 icon-padding '+icon+'">'+row.get('name')+'</li>');}}
return'<ul class="clean">'+r.join('')+'</ul>';default:for(i=0;i<va.length;i++){rec=store.findRecord('id',va[i],0,false,false,true);if(rec){r.push(rec.get('name'));}else{r.push(va[i]);}}
return r.join(', ');}},languageCombo:function(v,metaData,record,rowIndex,colIndex,store,grid){if(Ext.isEmpty(v)){return'';}
var ri=CB.DB.languages.findExact('id',parseInt(v,10));if(ri<0){return'';}
return CB.DB.languages.getAt(ri).get('name');},sexCombo:function(v,metaData,record,rowIndex,colIndex,store,grid){if(Ext.isEmpty(v)){return'';}
var ri=CB.DB.sex.findExact('id',v);if(ri<0){return'';}
return CB.DB.sex.getAt(ri).get('name');},shortDateFormatCombo:function(v,metaData,record,rowIndex,colIndex,store,grid){if(Ext.isEmpty(v)){return'';}
var ri=CB.DB.shortDateFormats.findExact('id',v);if(ri<0){return'';}
return CB.DB.shortDateFormats.getAt(ri).get('name');},thesauriCombo:function(v,metaData,record,rowIndex,colIndex,store,grid){if(Ext.isEmpty(v)){return'';}
var node=grid.helperTree.getNode(record.get('id')),tr=node.data.templateRecord,th=tr.get('cfg').thesauriId;if(th==='dependent'){th=grid.helperTree.getParentValue(node,tr.get('pid'));}
var ts=getThesauriStore(th),ri=ts.findExact('id',parseInt(v,10));if(ri<0){return'';}
return ts.getAt(ri).get('name');},checkbox:function(v){if(v==1){return L.yes;}
if(v==-1){return L.no;}
return'';},date:function(v){var rez='';if(Ext.isEmpty(v)){return rez;}
rez=Ext.Date.format(Ext.isPrimitive(v)?Ext.Date.parse(v.substr(0,10),'Y-m-d'):v,App.dateFormat);return rez;},datetime:function(v,showZeroTime){var rez='';if(Ext.isEmpty(v)){return rez;}
rez=Ext.isPrimitive(v)?date_ISO_to_local_date(v):v;var s=rez.toISOString();if(s.substr(-14)==='T00:00:00.000Z'){rez=Ext.Date.clearTime(rez,true);}
rez=Ext.Date.format(rez,App.dateFormat+' '+App.timeFormat);if(Ext.isEmpty(rez)){return'';}
if(showZeroTime===false){if(rez.substr(-5,5)==='00:00'){rez=rez.substr(0,rez.length-6);}}
return rez;},time:function(v,meta){if(Ext.isEmpty(v)){return'';}
if(Ext.isPrimitive(v)){v=Ext.Date.parse(v,'H:i:s');}
var format=(meta.fieldConfig&&meta.fieldConfig.format)?meta.fieldConfig.format:App.timeFormat;return Ext.Date.format(v,format);},filesize:function(v){if(isNaN(v)||Ext.isEmpty(v)||(v==='0')||(v<=0)){return'';}
if(v<=0){return'0 KB';}else if(v<1024){return'1 KB';}else if(v<1024*1024){return(Math.round(v/1024)+' KB');}else{var n=v/(1024*1024);return(n.toFixed(2)+' MB');}},tags:function(v,m,r,ri,ci,s){if(Ext.isEmpty(v)){return'';}
var rez=[];Ext.each(v,function(i){rez.push(i.name);},this);rez=rez.join(', ');m.attr='name="'+rez.replace(/"/g,'&quot;')+'"';return rez;},tagIds:function(v){if(Ext.isEmpty(v)){return'';}
var rez=[];v=String(v).split(',');Ext.each(v,function(i){rez.push(CB.DB.thesauri.getName(i));},this);rez=rez.join(', ');return rez;},importance:function(v){if(Ext.isEmpty(v)){return'';}
return CB.DB.importance.getName(v);},timeUnits:function(v){if(Ext.isEmpty(v)){return'';}
return CB.DB.timeUnits.getName(v);},taskStatus:function(v,m,r,ri,ci,s){if(Ext.isEmpty(v)){return'';}
return'<span class="taskStatus'+v+'">'+L['taskStatus'+parseInt(v,10)]+'</span>';},text:function(v,m,r,ri,ci,s){if(Ext.isEmpty(v)){return'';}
return'<pre style="white-space: pre-wrap">'+v+'</pre>';},titleAttribute:function(v,m,r,ri,ci,s){m.tdAttr=Ext.isEmpty(v)?'':'title="'+Ext.util.Format.stripTags(v).replace(/"/g,"&quot;")+'"';return v;},userName:function(v){return CB.DB.usersStore.getName(v);},iconcombo:function(v){if(Ext.isEmpty(v)){return'';}
return'<img src="/css/i/s.gif" class="icon '+v+'" /> '+v;}};App.getCustomRenderer=function(fieldType){switch(fieldType){case'checkbox':return App.customRenderers.checkbox;case'date':return App.customRenderers.date;case'datetime':return App.customRenderers.datetime;case'time':return App.customRenderers.time;case'_objects':return App.customRenderers.objectsField;case'combo':case'_language':return App.customRenderers.languageCombo;case'_sex':return App.customRenderers.sexCombo;case'importance':return App.customRenderers.importance;case'timeunits':return App.customRenderers.timeUnits;case'_templateTypesCombo':return Ext.Function.bind(CB.DB.templateTypes.getName,CB.DB.templateTypes);case'_fieldTypesCombo':return Ext.Function.bind(CB.DB.fieldTypes.getName,CB.DB.fieldTypes);case'_short_date_format':return App.customRenderers.shortDateFormatCombo;case'memo':case'text':return App.customRenderers.text;default:return null;}};App.getTemplatesXTemplate=function(template_id){template_id=String(template_id);if(!Ext.isDefined(App.templatesXTemplate)){App.templatesXTemplate={};}
if(App.templatesXTemplate[template_id]){return App.templatesXTemplate[template_id];}
var idx=CB.DB.templates.findExact('id',template_id);if(idx>=0){var r=CB.DB.templates.getAt(idx),it=r.get('info_template');if(!Ext.isEmpty(it)){App.templatesXTemplate[template_id]=new Ext.XTemplate(it);App.templatesXTemplate[template_id].compile();return App.templatesXTemplate[template_id];}}
return App.xtemplates.object;};App.findTab=function(tabPanel,id,xtype){var tabIdx=-1,i=0;if(!Ext.isEmpty(id)){while((tabIdx==-1)&&(i<tabPanel.items.getCount())){var o=tabPanel.items.get(i);if(Ext.isEmpty(xtype)||(o.isXType&&o.isXType(xtype))){if(Ext.isDefined(o.params)&&Ext.isDefined(o.params.id)&&(o.params.id==id)){tabIdx=i;}else{if(!Ext.isEmpty(o.data)&&!Ext.isEmpty(o.data.id)&&(o.data.id==id)){tabIdx=i;}}}
i++;}}
return tabIdx;};App.findTabByType=function(tabPanel,type){var tabIdx=-1,i=0;if(!Ext.isEmpty(type)){while((tabIdx==-1)&&(i<tabPanel.items.getCount())){var o=tabPanel.items.get(i);if(Ext.isDefined(o.isXType)&&o.isXType(type)){tabIdx=i;}
i++;}}
return tabIdx;};App.activateTab=function(tabPanel,id,xtype){if(Ext.isEmpty(tabPanel)){tabPanel=App.mainTabPanel;}
var tabIdx=App.findTab(tabPanel,id,xtype);if(tabIdx<0){return false;}
tabPanel.setActiveTab(tabIdx);return tabPanel.items.getAt(tabIdx);};App.addTab=function(tabPanel,o){if(Ext.isEmpty(tabPanel)){tabPanel=App.mainTabPanel;}
var c=tabPanel.add(o);o.show();tabPanel.setActiveTab(c);return c;};App.getHtmlEditWindow=function(config){if(!App.htmlEditWindow){App.htmlEditWindow=new CB.HtmlEditWindow();}
App.htmlEditWindow=Ext.apply(App.htmlEditWindow,config);return App.htmlEditWindow;};App.openObjectWindow=function(config){if(Ext.isEmpty(config)){return;}
if(Ext.isEmpty(config.template_id)){return Ext.Msg.alert('Error opening object','Template should be specified for object window to load.');}
config.id=Ext.valueFrom(config.target_id,config.id);var templateType=CB.DB.templates.getType(config.template_id),wndCfg={xtype:(templateType==='file'?'CBFileEditWindow':'CBObjectEditWindow'),data:config};wndCfg.id='oew-'+
(Ext.isEmpty(config.id)?Ext.id():config.id);var w=App.openWindow(wndCfg),winHeight=window.innerHeight;if(w){if((winHeight>0)&&(w.getHeight()>winHeight)){w.setHeight(winHeight-20);}
if(templateType==='file'){w.center();if(config.name&&(detectFileEditor(config.name)!==false)){w.maximize();}}else if(!w.existing){App.alignWindowNext(w);}
delete w.existing;}};App.openWindow=function(wndCfg){var w=Ext.getCmp(wndCfg.id);if(w){App.mainStatusBar.setActiveButton(w.taskButton);App.mainStatusBar.restoreWindow(w);w.existing=true;}else{w=Ext.create(wndCfg);w.show();w.taskButton=App.mainStatusBar.addTaskButton(w);}
return w;};App.alignWindowNext=function(w){w.alignTo(App.mainViewPort.getEl(),'br-br?');var pos=w.getXY();pos[0]-=15;pos[1]-=5;var x=pos[0];App.mainStatusBar.windowBar.items.each(function(btn){if(btn.win&&(btn.win!=w)&&btn.win.isVisible()&&!btn.win.maximized&&(btn.win.xtype!=='CBSearchEditWindow')){var wx=btn.win.getX()-btn.win.el.getWidth()-15;if(x>wx){x=wx;}}},this);if(x<15){x=15;}
pos[0]=x;w.setXY(pos);};App.isFolder=function(template_id){return(App.config.folder_templates.indexOf(String(template_id))>=0);};App.isWebDavDocument=function(name){if(!Ext.isPrimitive(name)||Ext.isEmpty(name)||Ext.isEmpty(App.config['files.edit'].webdav)){return false;}
var ext=name.split('.').pop();return(App.config['files.edit'].webdav.indexOf(ext)>=0);};App.openWebdavDocument=function(data,checkCookie){var url=window.location.origin+'/dav/'+App.config.coreName+'/';url+='edit-'+Ext.valueFrom(data.id,data.nid);url+='/'+data.name;App.confirmLeave=false;if((checkCookie!==false)&&(Ext.util.Cookies.get('webdavHideDlg')==1)){window.open('cbdav:'+url,'_self');}else{var w=new CB.WebdavWindow({data:{link:url}});w.show();w.center();}};App.activateBrowserTab=function(){var tab=App.mainTabPanel.getActiveTab();if(tab.isXType('CBBrowserViewContainer')){return tab;}
App.mainTabPanel.setActiveTab(App.explorer);return App.explorer;};App.downloadFile=function(fileId,zipped,versionId){if(Ext.isElement(fileId)){fileId=fileId.id;zipped=false;}
var url='/c/'+App.config.coreName+'/download/'+fileId;if(!Ext.isEmpty(versionId)){url+='&v='+versionId;}
if(zipped){url+='&z=1';}
window.open(url,'cbfd'+fileId);};App.getTypeEditor=function(type,e){var editorCfg={enableKeyEvents:true};var objData={ownerCt:e.ownerCt,record:e.record,fieldRecord:e.fieldRecord,objFields:e.objFields,grid:e.grid,pidValue:e.pidValue,objectId:e.objectId,path:e.path};var w,th,ed,rez=null;var tr=e.fieldRecord;var cfg=tr.get('cfg');var objectWindow=e.ownerCt?e.ownerCt:(e.grid?(e.grid.refOwner?e.grid.refOwner:e.grid.findParentByType(CB.Objects)):null);switch(type){case'_objects':switch(cfg.editor){case'form':if(e&&e.grid){e.cancel=true;e.value=e.record.get('value');var formEditor=new CB.object.field.editor.Form({data:objData,value:e.record?e.value:Ext.valueFrom(e.value,null),listeners:{scope:e,setvalue:function(value,editor){var objStore=(this.grid)?this.grid.refOwner.objectsStore:null;if(objStore&&editor.selectedRecordsData){objStore.checkRecordsExistance(editor.selectedRecordsData);}
this.originalValue=this.value;this.value=editor.getValue().join(',');this.record.set('value',this.value);if(this.grid.onAfterEditProperty){this.grid.onAfterEditProperty(editor,this);}else{this.grid.fireEvent('change',this);}},destroy:function(ed){if(this.grid){this.grid.focus(false,100);}}}});formEditor.show();}else{rez=new CB.ObjectsTriggerField({enableKeyEvents:true,data:objData});}
break;case'text':ed=new Ext.form.Text({data:objData,plugins:[{ptype:'CBPluginFieldDropDownList',commands:[{prefix:' ',regex:/^([\w\d_\.]+)/i,insertField:'info',handler:CB.plugin.field.DropDownList.prototype.onAtCommand}]}]});ed._setValue=ed.setValue;ed._getValue=ed.getValue;ed.setValue=function(value){var v=toNumericArray(value);for(var i=0;i<v.length;i++){v[i]=CB.DB.usersStore.getUserById(v[i]);}
this._setValue(v.join(', '));};ed.getValue=function(){var value=this._getValue();value=Ext.util.Format.trim(String(value).replace(/[\n\r,]/g,' '));if(Ext.isEmpty(value)){return'';}
var rez=[];var v=value.split(' ');for(var i=0;i<v.length;i++){if(!Ext.isEmpty(v[i])){var id=CB.DB.usersStore.getIdByUser(v[i]);if(!Ext.isEmpty(id)&&(rez.indexOf(id)<0)){rez.push(id);}}}
return rez.join(',');};return ed;case'tagField':ed=new CB.object.field.editor.Tag({objData:objData,valueField:'id',displayField:'name',forceSelection:true,typeAhead:true,queryMode:'remote',autoLoadOnValue:true,autoSelect:false,multiSelect:true,minChars:2,pinList:false,filterPickList:true});return ed;default:return new CB.ObjectsComboField({enableKeyEvents:true,data:objData});}
break;case'checkbox':rez=new Ext.form.ComboBox({enableKeyEvents:true,triggerAction:'all',queryMode:'local',editable:false,store:CB.DB.yesno,displayField:'name',valueField:'id'});break;case'timeunits':rez=new Ext.form.ComboBox({enableKeyEvents:true,forceSelection:true,triggerAction:'all',lazyRender:true,queryMode:'local',editable:false,store:CB.DB.timeUnits,displayField:'name',valueField:'id'});break;case'importance':rez=new Ext.form.ComboBox({enableKeyEvents:true,forceSelection:true,triggerAction:'all',lazyRender:true,queryMode:'local',editable:false,store:CB.DB.importance,displayField:'name',valueField:'id'});break;case'date':rez=new Ext.form.DateField({enableKeyEvents:true,format:App.dateFormat,width:100});break;case'datetime':rez=new Ext.form.DateField({enableKeyEvents:true,format:App.dateFormat+' '+App.timeFormat,width:130});break;case'time':rez=new Ext.form.field.Time({enableKeyEvents:true,format:App.timeFormat});break;case'int':rez=new Ext.form.NumberField({enableKeyEvents:true,allowDecimals:false,width:90});break;case'float':var fieldCfg={enableKeyEvents:true,allowDecimals:true,width:90};Ext.copyTo(fieldCfg,cfg,'decimalPrecision');rez=new Ext.form.NumberField(fieldCfg);break;case'combo':th=cfg.thesauriId;if(th==='dependent'){th=e.pidValue;}
rez=new Ext.form.ComboBox({enableKeyEvents:true,forceSelection:true,typeAhead:true,triggerAction:'all',lazyRender:true,queryMode:'local',store:getThesauriStore(th),displayField:'name',valueField:'id'});break;case'iconcombo':th=cfg.thesauriId;if(th==='dependent'){th=e.pidValue;}
rez=new Ext.form.ComboBox({enableKeyEvents:true,forceSelection:false,typeAhead:true,triggerAction:'all',lazyRender:true,queryMode:'local',store:getThesauriStore(th),displayField:'name',valueField:'id',iconClsField:'name'});break;case'_language':rez=new Ext.form.ComboBox({enableKeyEvents:true,forceSelection:true,typeAhead:true,triggerAction:'all',lazyRender:true,queryMode:'local',store:CB.DB.languages,displayField:'name',valueField:'id'});break;case'_sex':rez=new Ext.form.ComboBox({enableKeyEvents:true,forceSelection:true,typeAhead:true,triggerAction:'all',lazyRender:true,queryMode:'local',store:CB.DB.sex,displayField:'name',valueField:'id'});break;case'_templateTypesCombo':rez=new Ext.form.ComboBox({enableKeyEvents:true,forceSelection:true,typeAhead:true,triggerAction:'all',lazyRender:true,queryMode:'local',store:CB.DB.templateTypes,displayField:'name',valueField:'id'});break;case'_fieldTypesCombo':rez=new Ext.form.ComboBox({enableKeyEvents:true,autoSelect:true,forceSelection:true,typeAhead:true,triggerAction:'all',lazyRender:true,queryMode:'local',store:CB.DB.fieldTypes,displayField:'name',valueField:'id'});break;case'_short_date_format':rez=new Ext.form.ComboBox({enableKeyEvents:true,forceSelection:true,typeAhead:true,triggerAction:'all',lazyRender:true,queryMode:'local',store:CB.DB.shortDateFormats,displayField:'name',valueField:'id'});break;case'memo':var height=Ext.valueFrom(cfg.height,50);height=parseInt(height,10);if(e.grid){var rowEl=e.grid.getView().getRow(e.row);if(rowEl){var rowHeight=Ext.get(rowEl).getHeight()-12;if(height<rowHeight){height=rowHeight;}}}
var edConfig={enableKeyEvents:true,height:height};if(cfg.mentionUsers){edConfig.plugins=[{ptype:'CBPluginFieldDropDownList'}];}
rez=new Ext.form.TextArea(edConfig);break;case'text':e.cancel=true;rez=new CB.TextEditWindow({title:tr.get('title'),editor:tr.get('cfg').editor,mode:tr.get('cfg').mode,data:{value:e.record.get('value'),scope:e,callback:function(w,v){this.originalValue=this.record.get('value');this.value=v;this.record.set('value',v);if(this.grid.onAfterEditProperty){this.grid.onAfterEditProperty(this,this);}}}});rez.on('destory',e.grid.gainFocus,e.grid);rez.show();break;case'html':e.cancel=true;rez=App.getHtmlEditWindow({title:tr.get('title'),data:{value:e.record.get('value'),scope:e,callback:function(w,v){this.originalValue=this.record.get('value');this.value=v;this.record.set('value',v);if(this.grid.onAfterEditProperty){this.grid.onAfterEditProperty(this);}
this.grid.fireEvent('change');}}});if(!Ext.isEmpty(e.grid)){w.on('hide',e.grid.gainFocus,e.grid);}
rez.show();break;case'geoPoint':if(tr&&(tr.get('cfg').editor==='form')){e.cancel=true;rez=Ext.create('CB.LeafletWindow',{title:L.Map,data:{value:e.record.get('value'),cfg:tr.get('cfg'),scope:e,callback:function(w,v){this.originalValue=this.record.get('value');this.value=v;this.record.set('value',v);if(this.grid.onAfterEditProperty){this.grid.onAfterEditProperty(this,this);}}}});rez.on('destory',e.grid.gainFocus,e.grid);rez.show();}else{rez=new Ext.form.TextField({enableKeyEvents:true,maskRe:/[\-\d\.,]/});}
break;default:rez=new Ext.form.TextField({enableKeyEvents:true});}
return rez;};App.successResponse=function(r){if(r&&(r.success===true)){return true;}
Ext.Msg.alert(L.Error,Ext.valueFrom(r.msg,L.ErrorOccured));return false;};App.showTestingWindow=function(){if(!App.testWindow){App.testWindow=new CB.TestingWindow({closeAction:'hide'});}
App.testWindow.show();};App.openUniqueTabbedWidget=function(type,tabPanel,options){if(Ext.isEmpty(tabPanel)){tabPanel=App.mainTabPanel;}
var tabIdx=App.findTabByType(tabPanel,type);if(Ext.isEmpty(options)){options={};}
var rez=null;if(tabIdx<0){rez=Ext.create(type,options);App.addTab(tabPanel,rez);}else{rez=tabPanel.get(tabIdx);}
tabPanel.setActiveTab(rez);return rez;};App.showException=function(e){App.hideFailureAlerts=true;var msg='';if(e){msg=e.msg;}
if(Ext.isEmpty(msg)&&e.message){msg=e.message;}
if(Ext.isEmpty(msg)&&e.result){msg=e.result.msg;}
if(Ext.isEmpty(msg)&&e.result){msg=L.ErrorOccured;}
if(!App.errorMsgDiv){App.errorMsgDiv=App.getNotificationDiv();}
App.errorMsgDiv.update('<div class="content">'+msg+'</div>');App.errorMsgDiv.show();App.errorMsgDiv.getEl().fadeIn();App.errorMsgDiv.task.delay(5000);var dhf=function(){delete App.hideFailureAlerts;};Ext.Function.defer(dhf,1500);};App.hideException=function(){App.errorMsgDiv.fadeOut();};App.getNotificationDiv=function(){var rez=Ext.create('Ext.Component',{html:'',padding:5,floating:true,y:1,hideMode:'offsets',width:'100%',shadow:false,cls:'error-msg-div',style:{textAlign:'center'},renderTo:Ext.getBody()});rez.task=new Ext.util.DelayedTask(rez.getEl().fadeOut,rez.getEl());return rez;};App.clipboard=new CB.Clipboard();var o=Ext.isIE?document:window;o.onkeydown=function(e,t){if(Ext.isEmpty(t)){t=e.target;}
if((e.keyCode==Ext.event.Event.BACKSPACE)&&e.stopEvent&&((!/^input$/i.test(t.tagName)&&!/^textarea$/i.test(t.tagName))||t.disabled||t.readOnly)){e.stopEvent();}};App.getFileUploader=function(){if(this.Uploader)return this.Uploader;this.Uploader=new CB.Uploader({listeners:{}});if(this.Uploader.init()===false){delete this.Uploader;return null;}
return this.Uploader;};App.addFilesToUploadQueue=function(FileList,options){var fu=App.getFileUploader();if(fu){fu.addFiles(FileList,options);}else{Ext.Msg.alert(L.Info,L.BrowserNoDDUpload);}};App.onComponentActivated=function(component){plog('component activated',arguments,this);};App.promptRename=function(p){App.promptRenameData=p;Ext.Msg.prompt(L.Rename,L.Name,function(btn,text,opt){if(btn!=='ok'){return;}
CB_BrowserView.rename({path:App.promptRenameData.path,name:text},function(r,e){if(!r||(r.success!==true)){return;}
App.fireEvent('objectchanged',{id:parseInt(r.data.id,10),pid:r.data.pid},e);var rd=App.promptRenameData;if(rd.callback){if(rd.scope){rd.callback=Ext.Function.bind(rd.callback,rd.scope);}
rd.callback(r,e);}},this);},this,false,App.promptRenameData.name).setWidth(400).center();};}
window.onbeforeunload=function(){if(App.confirmLeave===false){delete App.confirmLeave;}else{return"You work will be lost.";}};window.ondragstart=function(e){window.dragFromWindow=true;return true;};window.ondragenter=function(e){e.dataTransfer.dropEffect='copy';e.preventDefault();if(!window.dragFromWindow){App.fireEvent('dragfilesenter',e);}
return false;};window.ondragover=function(e){e.dataTransfer.dropEffect='copy';e.preventDefault();return false;};window.ondrop=function(e){e.stopPropagation();e.preventDefault();if(!window.dragFromWindow){App.fireEvent('filesdrop',e);}
return false;};window.ondragleave=function(e){if(!window.dragFromWindow&&((e.pageX==='0')&&(e.pageY==='0'))){App.fireEvent('dragfilesleave',e);}
return false;};window.ondragend=function(e){delete window.dragFromWindow;};;Ext.namespace('CB');Ext.define('CB.controller.Browsing',{extend:'Ext.util.Observable',xtype:'browsingcontroller',constructor:function(){this.callParent(arguments);App.on('cbinit',this.onAppInit,this);},onAppInit:function(){var vp=App.mainViewPort,bc=vp.breadcrumb,sf=vp.searchField,tree=App.mainTree,vc=App.explorer,op=vc.objectPanel,fp=App.mainFilterPanel;this.tree=tree;this.VP=vp;this.SF=sf;this.breadcrumb=bc;this.VC=vc;this.OP=op;this.FP=fp;tree.getSelectionModel().on('selectionchange',this.onTreeSelectionChange,this);tree.on('itemclick',this.onTreeItemClick,this);tree.on('afterrename',this.onTreeRenameItem,this);sf.on('search',this.onSFSearch,this);bc.on('itemclick',this.onBreadcrumbItemClick,this);vc.on('viewloaded',this.onVCViewLoaded,this);vc.on('selectionchange',this.onVCSelectionChange,this);var nv=vc.notificationsView;nv.on('selectionchange',this.onNVSelectionChange,this);fp.on('change',this.onFiltersChange,this);fp.on('dateselect',this.onFilterPanelDateSelect,this);op.on('expand',this.onOPExpand,this);},onTreeSelectionChange:function(sm,selection){if(this.syncingTreePathWithViewContainer||Ext.isEmpty(selection)||Ext.isEmpty(selection[0].getPath)){return;}
if(!this.isCommentInputEmpty()){this.confirmDiscardComent(this.onTreeSelectionChange,arguments);return;}
var node=selection[0];var params={id:node.get('nid'),from:'tree'};App.openPath(node.getPath('nid'),params);this.updatePreview(node.data);},onTreeItemClick:function(tree,record,item,index,e,eOpts){if(Ext.isEmpty(item)||Ext.isEmpty(record.getPath)){return;}
if(!this.isCommentInputEmpty()){this.confirmDiscardComent(this.onTreeItemClick,arguments);return;}
if(tree.getSelectionModel().isSelected(record)){this.onTreeSelectionChange(null,[record]);}
this.updatePreview(record.data);},onTreeRenameItem:function(tree,r,e){var node=tree.getSelectionModel().getSelection()[0];if(Ext.isEmpty(node)||Ext.isEmpty(node.getPath)){return;}
if(!this.isCommentInputEmpty()){this.confirmDiscardComent(this.onTreeRenameItem,arguments);return;}
this.VC.onReloadClick();this.updatePreview(node.data);},onVCViewLoaded:function(proxy,action,options){var bvalue=Ext.valueFrom(action.pathtext,''),fp=Ext.valueFrom(action.folderProperties,{}),path=fp.path,total=Ext.valueFrom(action.total,0);if(options.search&&!isNaN(options.search.template_id)){bvalue=L.SearchResultsTitleTemplate;bvalue=bvalue.replace('{name}',CB.DB.templates.getName(options.search.template_id));bvalue=bvalue.replace('{count}',total);path='/'+App.config.rootNode.nid;}else if(!Ext.isEmpty(options.query)){bvalue=L.SearchResultsTitleTemplate;bvalue=bvalue.replace('{name}',options.query);bvalue=bvalue.replace('{count}',total);}
this.updateBreadcrumbData(path,bvalue);this.VC.updateCreateMenuItems(this.VP.buttons.create);if(fp.path&&Ext.isEmpty(this.VC.params.query)){this.tree.updateCreateMenu(fp.menu);var p=String(fp.path).split('/');if(!Ext.isEmpty(fp.path)&&(['/','/0','/'+App.config.rootNode.nid].indexOf(fp.path)<0)){this.syncingTreePathWithViewContainer=true;App.mainTree.selectPath(p.join('/'),'nid','/',function(){delete this.syncingTreePathWithViewContainer;},this);}}},onVCSelectionChange:function(objectsDataArray){if(!this.isCommentInputEmpty()){this.confirmDiscardComent(this.onVCSelectionChange,arguments);return;}
if(!Ext.isEmpty(this.VC.params.query)&&Ext.isEmpty(objectsDataArray)){this.updatePreview({});return;}
if(!this.VC.params.locatingObject){this.updatePreview();}},onNVSelectionChange:function(object){var data={id:object.id,force:!object.read};this.updatePreview(data);},onFiltersChange:function(filters){this.VC.changeSomeParams({filters:filters});},onFilterPanelDateSelect:function(date){var c=this.VC.getActiveView().calendar,av=c.getActiveView(),dt=date.toISOString(),sameDate=(c.lastClickedDate==dt);if(!sameDate||(av.xtype!=='dayview')){c.onDayClick();c.setStartDate(date);}else{c.onWeekClick();c.setStartDate(date);}
c.lastClickedDate=dt;},onSFSearch:function(query,editor,event){if(!this.isCommentInputEmpty()){this.confirmDiscardComent(this.onSFSearch,arguments);return;}
editor.clear();query=String(query).trim();if(Ext.isEmpty(query)){return;}
if(query.substr(0,1)==='#'){query=query.substr(1).trim();if(!isNaN(query)){this.openObjectWindowById(query);return;}}
this.VC.setParams({query:query,descendants:!Ext.isEmpty(query)});this.updatePreview({});},onBreadcrumbItemClick:function(view,record,item,index,e,eOpts){var store=this.breadcrumb.store,path=[],id;for(var i=0;i<=index;i++){id=store.getAt(i).data.id;if(!Ext.isEmpty(id)&&(id!=-1)){path.push(id);}}
if(!Ext.isEmpty(path)){this.VC.changeSomeParams({'path':'/'+path.join('/')});}},updateBreadcrumbData:function(pathIds,pathText){var ids,texts,data=[],item;ids=Ext.isArray(pathIds)?pathIds:String(pathIds).split('/');while((ids.length>0)&&Ext.isEmpty(ids[0])){ids.shift();}
while((ids.length>0)&&Ext.isEmpty(ids[ids.length-1])){ids.pop();}
while(Ext.String.startsWith(pathText,'/')){pathText=pathText.substr(1);}
while(Ext.String.endsWith(pathText,'/')){pathText=pathText.substr(0,pathText.length-1);}
texts=pathText.split('/');for(var i=0;i<ids.length;i++){item={id:ids[i],name:texts[i]};data.push(item);}
this.breadcrumb.setValue(data);},onOPExpand:function(){this.updatePreview();},updatePreview:function(customParams){var vc=this.VC,fp=vc.folderProperties;var data=customParams;if(Ext.isEmpty(data)){var s=vc.cardContainer.getLayout().activeItem.currentSelection;data=Ext.isEmpty(s)?{id:fp.id,name:fp.name,template_id:fp.template_id}:{id:Ext.valueFrom(Ext.valueFrom(s[0].target_id,s[0].nid),s[0].id),name:s[0].name,template_id:s[0].template_id,can:s[0].can};}else{data={id:Ext.valueFrom(Ext.valueFrom(data.target_id,data.nid),data.id),name:data.name,template_id:data.template_id,can:data.can,force:data.force};}
this.OP.load(data);},locateObject:function(params){if(!Ext.isObject(params)){params={id:params};}
if(Ext.isEmpty(params.path)&&!Ext.isEmpty(arguments[1])){params.path=arguments[1];}
if(Ext.isEmpty(params.path)){CB_Path.getPidPath(params.id,function(r,e){if(!r||(r.success!==true)){return;}
this.locateObject(r);},this);return;}
this.updatePreview(params);var path=params.path.split('/');path=Ext.Array.difference(path,[String(params.id)]);params.path=path.join('/');Ext.apply(params,{locatingObject:params.id,descendants:false,query:'',filters:{}});this.openPath(params);},openObjectWindowById:function(id){if(!Ext.isNumeric(id)){return;}
CB_Objects.getBasicInfoForId(id,function(r,e){if(!r||(r.success!==true)){Ext.Msg.alert(L.Error,L.RecordIdNotFound.replace('{id}','#'+r.id));return;}
App.openObjectWindow(r.data);},this);},openPath:function(params){if(!Ext.isObject(params)){var path=Ext.valueFrom(Ext.clone(arguments[0]),'/');params=Ext.valueFrom(Ext.clone(arguments[1]),{});params.path=path;}else{params=Ext.valueFrom(params,{});}
params.locatingObject=Ext.valueFrom(params.locatingObject,false);params.query=null;params.start=0;params.page=1;this.updatePreview(params);this.VC.setParams(params);},isCommentInputEmpty:function(){var cv=this.OP.getCommentValue();return Ext.isEmpty(cv);},confirmDiscardComent:function(callback,args){Ext.Msg.show({title:L.Confirm,message:L.DiscardCommentConfirmation,buttons:Ext.Msg.YESNO,icon:Ext.window.MessageBox.INFO,scope:this,fn:function(b,e){if(b==='yes'){this.OP.down('textarea[cls=comment-input]').reset();callback.apply(this,args);}}});}});;Ext.namespace('CB');Ext.define('CB.controller.History',{extend:'Ext.util.Observable',xtype:'historycontroller',constructor:function(){this.callParent(arguments);App.on('cbinit',this.onAppInit,this);},onAppInit:function(){this.VC=App.explorer;Ext.History.init();window.addEventListener('hashchange',Ext.Function.bind(this.onHashChange,this));this.VC.store.on('beforeload',this.onStoreBeforeLoad,this);},onHashChange:function(event){if(this.settingHash){delete this.settingHash;return;}
if(this.closingWindow){delete this.closingWindow;return;}
var activeWindow=this.getActiveWindow();if(!Ext.isEmpty(activeWindow)){this.closingWindow=true;window.location=event.oldURL;activeWindow.close();}else{var hash=event.newURL.split('#')[1],p;if(Ext.isEmpty(hash)){this.settingHash=true;window.location=event.oldURL;return;}
p=Ext.Object.fromQueryString(hash);this.restoreParams=true;this.VC.setParams(p);}},getActiveWindow:function(){var rez=null,el=Ext.Element.getActiveElement();if(el){el=Ext.get(el);if(el){var parent=el.findParent('.x-window',true);if(parent){rez=Ext.getCmp(parent.id);}}}
return rez;},onStoreBeforeLoad:function(store,operation,eOpts){if(this.restoreParams){delete this.restoreParams;return;}
var ep=store.proxy.extraParams,p={'path':Ext.valueFrom(ep.path,ep.id),'page':Ext.valueFrom(ep.page,1),'query':ep.query,'lastQuery':ep.lastQuery,'descendants':ep.descendants};if(Ext.isEmpty(p.query)){delete p.query;}
if(Ext.isEmpty(p.lastQuery)){delete p.lastQuery;}
if(p.descendants!==true){delete p.descendants;}
this.settingHash=true;Ext.History.add(Ext.Object.toQueryString(p));}});;Ext.namespace('CB.object.field.editor');Ext.define('CB.object.field.editor.Form',{extend:'Ext.Window',xtype:'CBObjectFieldEditorForm',height:500,width:600,minHeight:400,minWidth:600,modal:true,layout:'border',title:L.Associate,closeAction:'destroy',selectedRecordsData:[],constructor:function(config){this.data=config.data;this.folderProperties=this.data;this.cfg=this.data.fieldRecord?Ext.apply({},Ext.valueFrom(this.data.fieldRecord.data.cfg,{})):Ext.applyIf(Ext.valueFrom(config.config,{}),{multiValued:false});this.callParent(arguments);this.setValue(config.value);},initComponent:function(){this.detectStore();this.actions={showSelection:new Ext.Action({text:L.ShowSelection,enableToggle:true,disabled:true,scope:this,handler:this.onShowSelectionClick}),sortValue:new Ext.Action({text:L.SortValue,disabled:true,hidden:true,scope:this,handler:this.onSortValueClick})};if(this.data.fieldRecord){this.title=Ext.valueFrom(this.data.fieldRecord.get('title'),this.title);}
this.gridView=new CB.browser.view.Grid({border:false,region:'center',refOwner:this,store:this.store,getProperty:this.getProperty.bind(this),saveGridState:Ext.emptyFn,selModel:{selType:'checkboxmodel',injectCheckbox:'first',allowDeselect:true,toggleOnClick:true,mode:(this.cfg.multiValued?'SIMPLE':'SINGLE'),listeners:{scope:this,select:this.onRowSelect,deselect:this.onRowDeselect}}});Ext.apply(this,{defaults:{border:false},border:false,buttonAlign:'left',layout:'fit',items:[{xtype:'panel',region:'center',layout:'border',cls:'x-panel-white',items:[{xtype:'panel',region:'north',autoHeight:true,layout:'hbox',border:false,items:[{xtype:'textfield',anchor:'100%',flex:1,emptyText:L.Search,triggers:{search:{cls:'x-form-search-trigger',scope:this,handler:this.onGridReloadTask}},enableKeyEvents:true,listeners:{scope:this,specialkey:function(ed,ev){if(ev.getKey()==ev.ENTER){this.onGridReloadTask();}}}}]},this.gridView]}],listeners:{scope:this,show:function(){this.store.removeAll();this.resetPage=true;if((!Ext.isDefined(this.cfg.autoLoad))||(this.cfg.autoLoad===true)){this.onGridReloadTask();}
this.triggerField.focus(false,400);},change:this.onChange},buttons:[,this.actions.showSelection,this.actions.sortValue,'->',{text:Ext.MessageBox.buttonText.ok,scope:this,handler:this.onOkClick},{text:L.Cancel,scope:this,handler:this.destroy}]});this.callParent(arguments);this.gridView.addCls('view-loading');this.store.on('load',this.onLoad,this);this.triggerField=this.query('textfield')[0];this.actions.sortValue.setHidden(this.cfg.allowValueSort!==true);},detectStore:function(){var source=Ext.valueFrom(this.cfg.source,'tree');switch(source){case'users':case'groups':case'usersgroups':this.store=CB.DB.usersGroupsSearchStore;break;default:this.store=new Ext.data.DirectStore({autoLoad:false,autoDestroy:true,restful:false,remoteSort:true,model:'FieldObjects',proxy:{type:'direct',paramsAsHash:true,limitParam:'rows',api:{read:CB_Browser.getObjectsForField},reader:{type:'json',successProperty:'success',rootProperty:'data',messageProperty:'msg'},listeners:{load:function(proxy,obj,opt){for(var i=0;i<obj.result.data.length;i++){obj.result.data[i].date=date_ISO_to_local_date(obj.result.data[i].date);}}}},sortInfo:{field:'name',direction:'ASC'},listeners:{scope:this,beforeload:function(store,o){if(this.data){if(!Ext.isEmpty(this.data.fieldRecord)){store.proxy.extraParams.fieldId=this.data.fieldRecord.get('id');}
if(!Ext.isEmpty(this.data.objectId)){store.proxy.extraParams.objectId=this.data.objectId;}
if(!Ext.isEmpty(this.data.pidValue)){store.proxy.extraParams.pidValue=this.data.pidValue;}
if(!Ext.isEmpty(this.data.path)){store.proxy.extraParams.path=this.data.path;}
store.proxy.extraParams.objFields=this.data.objFields;}},load:function(store,recs,options){Ext.each(recs,function(r){r.set('iconCls',getItemIcon(r.data));},this);}}});}
if(Ext.isEmpty(this.store)){this.store=new Ext.data.ArrayStore({idIndex:0,model:'Generic',data:[]});}
if(Ext.isEmpty(this.store.getTexts)){this.store.getTexts=getStoreNames;}
if(this.cfg.sort){var field='order',dir='asc';switch(this.cfg.sort){case'asc':field='name';break;case'desc':field='name';dir='desc';break;}
this.store.sort(field,dir);}
return this.store;},getProperty:function(propertyName){if(propertyName==='nid'){propertyName='id';}
if(this.data&&this.data[propertyName]){return this.data[propertyName];}
return null;},setValue:function(value){this.value=toNumericArray(value);this.value=Ext.Array.difference(this.value,[0,'0']);this.fireEvent('change',this,this.value);},getValue:function(){return this.value;},onRowSelect:function(selModel,record,index,eOpts){var id=record.get('id');if(this.cfg.multiValued!==true){this.value=[];this.selectedRecordsData=[];}
if(this.value.indexOf(id)<0){this.value.push(id);this.fireEvent('change',this,this.value);this.selectedRecordsData[id]=Ext.apply({},record.data);}},onRowDeselect:function(selModel,record,index,eOpts){var id=record.get('id'),idx=this.value.indexOf(id);if(idx>-1){this.value.splice(idx,1);this.fireEvent('change',this,this.value);}},onChange:function(ed,value){this.actions.showSelection.setDisabled(Ext.isEmpty(value));this.actions.sortValue.setDisabled(Ext.isEmpty(value));},onGridReloadTask:function(){if(!this.gridReloadTask){this.gridReloadTask=new Ext.util.DelayedTask(this.doReloadGrid,this);}
this.gridReloadTask.delay(500);},doReloadGrid:function(params){if(Ext.isEmpty(params)){params=this.getSearchParams();}
params.from='formEditor';var resetPage=this.resetPage||(this.store.proxy.extraParams.query!==params.query);delete this.resetPage;this.store.setPageSize(Ext.valueFrom(params.limit,25));this.store.proxy.extraParams=params;if(resetPage){this.store.loadPage(1,params);}else{this.store.reload(params);}},getSearchParams:function(){var rez=Ext.apply({},this.cfg);rez.query=this.triggerField.getValue();rez.value=this.getValue();if(!Ext.isEmpty(this.data.objectId)){rez.objectId=this.data.objectId;}
if(!Ext.isEmpty(this.data.path)){rez.path=this.data.path;}
return rez;},onLoad:function(store,records,options){if(Ext.isEmpty(records)){this.gridView.getEl().mask(L.noData);}else{var el=this.gridView.getEl();if(el){this.gridView.getEl().unmask();}
var selectedRecords=[];Ext.each(records,function(r){r.set('iconCls',getItemIcon(r.data));if(this.value.indexOf(r.get('id'))>=0){selectedRecords.push(r);}},this);if(!Ext.isEmpty(selectedRecords)){this.gridView.grid.getSelectionModel().select(selectedRecords);}}
this.gridView.removeCls('view-loading');},onShowSelectionClick:function(b,e){var params=this.getSearchParams();if(b.pressed){delete params.query;params.ids=this.value;}
this.doReloadGrid(params);},onSortValueClick:function(b,e){if(this.data.grid){var value=this.getValue(),store=this.data.grid.refOwner.objectsStore,data=[],i,r,sorter=new CB.widget.DataSorter({listeners:{scope:this,change:this.onSortChanged}});if(store&&!Ext.isEmpty(this.selectedRecordsData)){store.checkRecordsExistance(this.selectedRecordsData);}
for(i=0;i<value.length;i++){r=store.findRecord('id',value[i],0,false,false,true);if(r){data.push({'id':value[i],'name':r.get('name'),'iconCls':r.get('iconCls')});}}
sorter.store.loadData(data);sorter.show();}},onSortChanged:function(sorter,value){this.value=value;sorter.destroy();},onOkClick:function(){this.fireEvent('setvalue',this.value,this);this.close();}});;Ext.namespace('CB.object.field.editor');Ext.define('CB.object.field.editor.Tag',{extend:'Ext.form.field.Tag',xtype:'CBObjectFieldEditorTag',layout:'border',constructor:function(config){this.objData=config.objData;this.cfg=this.objData.fieldRecord?Ext.apply({},Ext.valueFrom(this.objData.fieldRecord.data.cfg,{})):Ext.applyIf(Ext.valueFrom(config.config,{}),{multiValued:false});this.detectStore();this.callParent(arguments);},initComponent:function(){Ext.apply(this,{listeners:{scope:this,destroy:function(){Ext.destroy(this.store);}}});this.callParent(arguments);},detectStore:function(){var source=Ext.valueFrom(this.cfg.source,'tree');switch(source){case'users':case'groups':case'usersgroups':this.store=CB.DB.usersGroupsSearchStore;break;default:this.store=new Ext.data.DirectStore({autoLoad:false,restful:false,remoteSort:true,model:'FieldObjects',pageSize:200,proxy:{type:'direct',paramsAsHash:true,api:{read:CB_Browser.getObjectsForField},reader:{type:'json',successProperty:'success',rootProperty:'data',messageProperty:'msg'},listeners:{load:function(proxy,obj,opt){for(var i=0;i<obj.result.data.length;i++){obj.result.data[i].date=date_ISO_to_local_date(obj.result.data[i].date);}}}},sortInfo:{field:'name',direction:'ASC'},listeners:{scope:this,beforeload:function(store,o){var d=this.objData;if(d){if(!Ext.isEmpty(d.fieldRecord)){store.proxy.extraParams.fieldId=d.fieldRecord.get('id');}
if(!Ext.isEmpty(d.objectId)){store.proxy.extraParams.objectId=d.objectId;}
if(!Ext.isEmpty(d.pidValue)){store.proxy.extraParams.pidValue=d.pidValue;}
if(!Ext.isEmpty(d.path)){store.proxy.extraParams.path=d.path;}
store.proxy.extraParams.objFields=d.objFields;}},load:function(store,recs,options){Ext.each(recs,function(r){r.set('iconCls',getItemIcon(r.data));},this);}}});}
if(Ext.isEmpty(this.store)){this.store=new Ext.data.ArrayStore({idIndex:0,model:'Generic',data:[]});}
if(Ext.isEmpty(this.store.getTexts)){this.store.getTexts=getStoreNames;}
if(this.cfg.sort){var field='order',dir='asc';switch(this.cfg.sort){case'asc':field='name';break;case'desc':field='name';dir='desc';break;}
this.store.sort(field,dir);}
return this.store;},collapse:function(){var ev=Ext.EventObject,eventTime=ev.getTime();switch(ev.type){case'mousedown':if(!ev.within(this.getEl(),false,true)&&(!this.picker||(this.picker&&!ev.within(this.picker.getEl(),false,true)))){delete this.preventEditComplete;}else{this.preventEditComplete=true;}
break;case'keydown':switch(ev.getKey()){case ev.ESC:case ev.ENTER:if(this.isExpanded){this.collapsedTime=eventTime;this.preventEditComplete=true;}else{if(this.collapsedTime!==eventTime){delete this.preventEditComplete;}}}
break;}
this.callParent(arguments);}});;Ext.define('CB.view.BoundListKeyNav',{extend:'Ext.view.BoundListKeyNav',alias:'view.navigation.CBboundlist',initKeyNav:function(view){var me=this,field=me.view.pickerField;if(!view.pickerField){return;}
if(!field.rendered){field.on('render',Ext.Function.bind(me.initKeyNav,me,[view],0),me,{single:true});return;}
me.keyNav=new Ext.util.KeyNav({target:field.inputEl,forceKeyDown:true});Ext.apply(field,{onKeyUp:Ext.Function.bind(this.onKeyUp,this),onKeyDown:Ext.Function.bind(this.onKeyDown,this),onKeyEnter:Ext.Function.bind(this.onKeyEnter,this),onKeyTab:Ext.Function.bind(this.onKeyTab,this),onKeyEsc:Ext.Function.bind(this.onKeyEsc,this),setPosition:Ext.Function.bind(this.setPosition,this)});}});;Ext.namespace('CB.notifications');Ext.define('CB.notifications.View',{extend:'Ext.Panel',alias:'widget.CBNotificationsView',border:false,layout:'fit',initComponent:function(){this.actions={markAllAsRead:new Ext.Action({iconCls:'im-assignment',itemId:'markAllAsRead',scale:'medium',text:L.MarkAllAsRead,scope:this,handler:this.onMarkAllAsReadClick}),reload:new Ext.Action({iconCls:'im-refresh',itemId:'reload',scale:'medium',tooltip:L.Refresh,scope:this,handler:this.onReloadClick}),preview:new Ext.Action({itemId:'preview',scale:'medium',iconCls:'im-preview',scope:this,hidden:true,handler:this.onPreviewClick})};this.defineStore();this.tbar=new Ext.Toolbar({border:false,style:'background: #ffffff',defaults:{scale:'medium'},items:[this.actions.markAllAsRead,'->',this.actions.reload,this.actions.preview]});Ext.apply(this,{items:[this.getGridConfig()],listeners:{scope:this,activate:this.onActivateEvent}});this.callParent(arguments);this.grid=this.items.getAt(0);this.checkNotificationsTask=new Ext.util.DelayedTask(this.onCheckNotificationsTask,this);this.selectionDelayTask=new Ext.util.DelayedTask(this.onSelectionDelayTask,this);App.on('cbinit',this.onLogin,this,{delay:3000,single:true});},defineStore:function(){this.store=new Ext.data.DirectStore({autoLoad:false,autoDestroy:true,extraParams:{},pageSize:200,model:'Notification',sorters:[{property:'action_id',direction:'DESC'}],proxy:new Ext.data.DirectProxy({paramsAsHash:true,directFn:CB_Notifications.getList,reader:{type:'json',successProperty:'success',idProperty:'ids',rootProperty:'data',messageProperty:'msg'}}),listeners:{scope:this,load:this.onStoreLoad}});},onStoreLoad:function(store,records,successful,eOpts){var rd=store.proxy.reader.rawData;if(rd&&(rd.success===true)){this.lastSeenActionId=rd.lastSeenActionId;this.updateSeenRecords();}},updateSeenRecords:function(){var visible=this.getEl().isVisible(true);this.store.each(function(r){var seen=visible||(r.get('action_id')<=this.lastSeenActionId);r.set('seen',seen);},this);this.fireNotificationsUpdated();},fireNotificationsUpdated:function(){var readRecs=this.store.queryBy('read',false,false,false,true),seenRecs=this.store.queryBy('seen',false,false,false,true),params={total:this.store.getCount(),unread:readRecs.getCount(),unseen:seenRecs.getCount()};App.fireEvent('notificationsUpdated',params);},getGridConfig:function(){var columns=[{header:'ID',width:80,sortable:false,dataIndex:'ids',hidden:true},{header:L.Action,flex:1,sortable:false,dataIndex:'text',renderer:this.actionRenderer}];var sm=new Ext.selection.RowModel({mode:'SINGLE',allowDeselect:true});var rez={xtype:'grid',loadMask:false,border:false,bodyStyle:{border:0},store:this.store,columns:columns,selModel:sm,viewConfig:{forceFit:true,loadMask:false,stripeRows:false,emptyText:L.NoData},listeners:{scope:this,rowclick:this.onRowClick,selectionchange:this.onSelectionChange}};return rez;},actionRenderer:function(v,m,r,ri,ci,s){var uid=r.get('user_id'),rez='<table cellpadding="0" cellspacing="0" border="0">'+'<tr><td style="padding: 3px"><img class="i32" src="'+
App.config.photoPath+
uid+'.jpg?32='+
CB.DB.usersStore.getPhotoParam(uid)+'"></td><td style="padding-top: 3px" class="pl7 vaT notif">'+v+'</td></tr></table>';m.tdCls=r.get('read')?'':'notification-record-unread';return rez;},onRowClick:function(grid,record,tr,rowIndex,e,eOpts){var el=e.getTarget('.obj-ref');if(el){App.openObjectWindow({id:el.getAttribute('itemid'),template_id:el.getAttribute('templateid'),name:el.getAttribute('title')});}
if(this.lastSelectedRecord==record){this.onSelectionChange(grid,[record],eOpts);}},onSelectionChange:function(grid,selected,eOpts){this.lastSelectedRecord=selected[0];this.selectionDelayTask.delay(3);if(!Ext.isEmpty(selected)){var d=selected[0].data;this.fireEvent('selectionchange',{id:d.object_id,read:d.read});}},onSelectionDelayTask:function(){var recs=this.grid.getSelectionModel().getSelection();if(Ext.isEmpty(recs)||(recs[0].get('read'))){return;}
CB_Notifications.markAsRead({id:recs[0].get('id'),ids:recs[0].get('ids')},this.onMarkAsRead,this);},onMarkAsRead:function(r,e){if(!r||(r.success!==true)){return;}
var rec=this.store.findRecord('id',r.data.id);if(rec){rec.set('read',true);}
this.fireNotificationsUpdated();},onActivateEvent:function(){var fr=this.store.first(),lastId=(fr&&fr.get)?fr.get('action_id'):0;this.grid.getView().refresh();this.grid.view.scrollTo(0,0);if(this.lastSeenActionId!=lastId){CB_Notifications.updateLastSeenActionId(lastId,function(r,e){if(r&&(r.success===true)){this.lastSeenActionId=lastId;this.updateSeenRecords();}},this);}},onLogin:function(){this.store.load();this.checkNotificationsTask.delay(1000*60*1);var op=App.explorer.objectPanel;this.actions.preview.setHidden(op.getCollapsed()===false);op.on('expand',function(){this.actions.preview.setHidden(true);},this);op.on('collapse',function(){this.actions.preview.setHidden(false);},this);},onCheckNotificationsTask:function(){var rec=this.store.first(),params={};if(rec){params.fromId=rec.get('action_id');}
CB_Notifications.getNew(params,this.processGetNew,this);this.checkNotificationsTask.delay(1000*60*1);},processGetNew:function(r,e){if(!r||(r.success!==true)){return;}
if(!Ext.isEmpty(r.data)){var oldRec,modelName=this.store.getModel().getName();for(var i=0;i<r.data.length;i++){oldRec=this.store.findRecord('ids',r.data[i].ids,0,false,false,true);if(oldRec){this.store.remove(oldRec);}
this.store.addSorted(Ext.create(modelName,r.data[i]));}
this.grid.getView().refresh();this.grid.view.scrollTo(0,0);if(this.getEl().isVisible(true)){this.onActivateEvent();}else{this.updateSeenRecords();}}
if(r.lastSeenId&&(r.lastSeenId>this.lastSeenActionId)){this.lastSeenActionId=r.lastSeenId;this.updateSeenRecords();}},onMarkAllAsReadClick:function(b,e){CB_Notifications.markAllAsRead(this.onReloadClick,this);},onReloadClick:function(b,e){this.store.reload();},onPreviewClick:function(b,e){App.explorer.objectPanel.expand();this.actions.preview.hide();}});;Ext.namespace('CB.notifications');Ext.define('CB.notifications.SettingsWindow',{extend:'Ext.Window',alias:'widget.CBNotificationsSettingsWindow',border:false,modal:true,autoHeight:true,autoWidth:true,layout:'fit',minWidth:250,minHeight:150,width:300,initComponent:function(){Ext.apply(this,{title:L.NotificationsSettings,items:{xtype:'form',forceLayout:true,bodyPadding:10,defaults:{labelAlign:'top'},items:[{xtype:'displayfield',cls:'fs20',value:'Push notifications'},{xtype:'combo',itemId:'cbNotifyFor',fieldLabel:'Send me email notifications for',anchor:'100%',store:CB.DB.notifyFor,lazyRender:true,forceSelection:true,triggerAction:'all',queryMode:'local',editable:false,displayField:'name',valueField:'id',listeners:{scope:this,change:this.updateAvailability}},{xtype:'displayfield',cls:'fs20 pt10',itemId:'dfTimings',disabled:true,value:'Push notifications timing'},{xtype:'radiogroup',itemId:'rgTimings',columns:1,vertical:true,items:[{boxLabel:'Send instantly',name:'rb',inputValue:1},{boxLabel:'After being idle for:',name:'rb',inputValue:2,checked:true}],listeners:{scope:this,change:this.updateAvailability}},{xtype:'combo',anchor:'100%',itemId:'cbTimings',disabled:true,editable:false,store:CB.DB.idleTimings,lazyRender:true,forceSelection:true,triggerAction:'all',queryMode:'local',displayField:'name',valueField:'id',value:2,listeners:{scope:this,change:this.updateAvailability}}],buttons:[{text:'Ok',itemId:'btnOk',disabled:true,formBind:true,scope:this,handler:this.onOkClick}]}});this.callParent(arguments);this.notifyCombo=this.down('[itemId="cbNotifyFor"]');this.timingsHeader=this.down('[itemId="dfTimings"]');this.timingsRadio=this.down('[itemId="rgTimings"]');this.timingsCombo=this.down('[itemId="cbTimings"]');this.reload();},reload:function(){CB_User.getNotificationSettings(this.processGetNotificationSettings,this);},processGetNotificationSettings:function(r,e){if(!r||(r.success!==true)){return;}
var d=r.data;this.notifyCombo.originalValue=d.notifyFor;this.notifyCombo.setValue(d.notifyFor);this.timingsRadio.originalValue=d.delay;this.timingsRadio.setValue({'rb':d.delay});this.timingsCombo.originalValue=d.delaySize;this.timingsCombo.setValue(d.delaySize);this.updateAvailability();var okb=this.down('[itemId="btnOk"]');Ext.Function.defer(okb.disable,10,okb);},updateAvailability:function(){var enableDelay=(this.notifyCombo.getValue()!=='none'),enableDelaySize=(this.timingsRadio.getValue().rb==2);this.timingsHeader.setDisabled(!enableDelay);if(enableDelay){this.timingsRadio.setDisabled(false);var r=this.timingsRadio.items.getAt(0);if(r&&r.el){r.unmask();this.timingsRadio.items.getAt(1).unmask();}}else{this.timingsRadio.setDisabled(true);}
this.timingsCombo.setDisabled(!enableDelay||!enableDelaySize);this.down('[itemId="btnOk"]').setDisabled(!this.items.getAt(0).isDirty());},onOkClick:function(b,e){var rez={notifyFor:this.notifyCombo.getValue(),delay:this.timingsRadio.getValue().rb,delaySize:this.timingsCombo.getValue()};CB_User.setNotificationSettings(rez,this.close,this);}});